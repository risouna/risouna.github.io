<!doctype html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>《Erlang程序设计》 - 理想奈的博客</title><link rel="apple-touch-icon" href="/images/favicons/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/images/favicons/favicon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="/images/favicons/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/images/favicons/manifest.json">
<link rel="icon" href="/images/favicons/favicon.ico">
<meta name="keywords" content="" />
<meta name="description" content="" /><meta itemprop="name" content="《Erlang程序设计》">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2025-01-02T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2025-01-02T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="79539">
<meta itemprop="keywords" content=",,," /><meta property="og:title" content="《Erlang程序设计》" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/tech/media-erlang/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-01-02T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2025-01-02T00:00:00&#43;00:00" /><meta property="og:site_name" content="理想奈的博客" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="《Erlang程序设计》"/>
<meta name="twitter:description" content=""/>
<meta data-name="palette" content="blue"><link rel=stylesheet href="/css/bundle.min.d63d5781d5b3b2441c3e0c8ba081eb171c0ae292f799670fe6d38f68e3a2816d.css" integrity="sha256-1j1XgdWzskQcPgyLoIHrFxwK4pL3mWcP5tOPaOOigW0=" crossorigin="anonymous"><script src="/js/bundle.min.1c471eeba442e80350b91324d765b69b27af83f0de35d552aa2a410bac6ee793.js" integrity="sha256-HEce66RC6ANQuRMk12W2myevg/DeNdVSqipBC6xu55M=" crossorigin="anonymous"></script>
<script type="text/javascript">
	document.addEventListener("DOMContentLoaded", function() {
  renderMathInElement(document.body, {
    delimiters: [
      {left: "$$", right: "$$", display: true},
      {left: "$", right: "$", display: false}
    ],
    macros: {
      "\\ge": "\\geqslant",
      "\\le": "\\leqslant",
      "\\geq": "\\geqslant",
      "\\leq": "\\leqslant"
	}
  });
}); 
</script>
<meta property="og:type" content="index"/>
<meta property="og:title" content="Unzybaryl`s Sekai" />
<meta property="og:image" content="https://eustia.me/images/profile1.jpg" />
<meta property="og:url" content="https://eustia.me/" />





<script type="text/javascript" src="/js/Valine.min.js"></script>
<script type="text/javascript" src="/js/cave-draw.min.js"></script>
<link rel="stylesheet" type="text/css" href="/js/katex.min.css">
<script type="text/javascript" src="/js/katex.min.js"></script>
<script type="text/javascript" src="/js/auto-render.min.js"></script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" type="text/css" href="/js/font.css">

</head><body><header><nav class="navbar navbar-expand-xl fixed-top">
  <div class="container">
    <a class="navbar-brand" href="/">
      
      
      さぁ、君、取りたまえ
      
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-1 mb-2 mb-lg-0"><form class="search-bar d-flex ms-1" action="/search">
  <div class="input-group input-group-sm">
    <button class="btn btn-search disabled position-absolute left-0" type="submit"><i class="fas fa-fw fa-search"></i></button>
    <input class="form-control rounded-pill" id="searchQuery" name="q" type="search" aria-label="Search">
  </div>
</form></ul><ul class="navbar-nav me-1 mb-2 mb-lg-0 me-1 ms-auto"><li class="nav-item">
          <a class="nav-link" href="/archives">
            <i class="fas fa-fw fa-file-archive"></i>归档
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/about/">
            <i class="fas fa-fw fa-info-circle"></i>关于
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/bin/">
            <i class="fas fa-fw fa-bookmark"></i>废案
          </a>
        </li><li class="nav-item">
  <a class="nav-link" data-bs-toggle="offcanvas" href="#offcanvasSettings" role="button"
    aria-controls="offcanvasSettings">
    <i class="fas fa-fw fa-sliders-h"></i> 设置
  </a>
</li>

<div class="offcanvas offcanvas-end surface h-100" tabindex="-1" id="offcanvasSettings"
  aria-labelledby="offcanvasSettingsLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" w id="offcanvasSettingsLabel"><i class="fas fa-fw fa-sliders-h"></i> 设置</h5>
    <a role="button" data-bs-dismiss="offcanvas" aria-label="Close">
      <span class="fas fa-2x fa-fw fa-times"></span>
    </a>
  </div>
  <div class="offcanvas-body"><section class="setting">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-adjust"></i> 模式</label>
    </div>
    <div class="col-auto ms-auto">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="modeSwitcher">
      </div>
    </div>
  </form>
</section>
<section class="setting">
  <form class="font-size-switcher-form row">
    <div class="col-auto">
      <label for="fontSize" class="form-label"><i class="fas fa-fw fa-font"></i> 字体大小</label>
    </div>
    <div class="col-auto ms-auto">
      <input type="range" class="form-range" min="-2" max="2" id="fontSize">
    </div>
  </form>
</section>

</div>
</div></ul>
    </div>
  </div>
</nav>
</header>
<main role="main" class="container">
      <div class="row content">
<div class="col-lg-8">
  <div class="container"><nav class="row" aria-label="breadcrumb">
  <ol class="breadcrumb surface"><li class="breadcrumb-item"><a href="/">主页</a></li><li class="breadcrumb-item"><a href="/posts/">文章</a></li><li class="breadcrumb-item"><a href="/posts/tech/">Tech</a></li><li class="breadcrumb-item active">《Erlang程序设计》</li></ol>
</nav><article class="post row surface"><div class="post-panel-wrapper">
  <div class="post-panel d-flex flex-column">
    <a id="sidebarToggler" class="action d-none d-lg-block" role="button">
  <i class="fas fa-fw fa-expand-alt fa-rotate-45"></i>
</a>
  
    

    
    <a class="action" data-bs-container="body" data-bs-toggle="popover" data-bs-html="true" data-bs-placement="bottom"
  data-bs-trigger="focus" tabindex="0"
  data-bs-content="&lt;a target=&#34;_blank&#34; rel=&#34;license&#34; href=&#34;https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh&#34;&gt;CC BY-NC-ND 4.0 &lt;i class=&#34;fab fa-fw fa-creative-commons&#34;&gt;&lt;/i&gt;&lt;i class=&#34;fab fa-fw fa-creative-commons-by&#34;&gt;&lt;/i&gt;&lt;i class=&#34;fab fa-fw fa-creative-commons-nc&#34;&gt;&lt;/i&gt;&lt;i class=&#34;fab fa-fw fa-creative-commons-nd&#34;&gt;&lt;/i&gt;&lt;/a&gt;
">
  <i class="fas fa-fw fa-copyright"></i>
</a>
    <a id="btnTOC" class="fas fa-fw fa-list-alt" data-bs-toggle="offcanvas" href="#offcanvasTOC" aria-controls="offcanvasTOC" role="button">
</a>
  </div>
</div>
<h1 class="post-title my-3">《Erlang程序设计》
</h1><div class="post-meta mb-3">
  <span class="post-date me-2">
    <i class="fas fa-fw fa-calendar-alt"></i>2025-01-02
  </span>
  <span class="post-reading-time me-2">
    <i class="fas fa-fw fa-coffee"></i>159 分钟阅读
  </span>
<a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" class="post-taxonomy">#计算机</a><a href="/series/%E5%AA%92%E4%BD%93%E5%BC%80%E5%8F%91/" class="post-taxonomy">#媒体开发</a></div>



                
                <div class="addthis_inline_share_toolbox"></div>
            <div class="offcanvas offcanvas-end surface" tabindex="-1" id="offcanvasTOC" aria-labelledby="offcanvasTOCLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasTOCLabel">目录</h5>
    <a role="button" data-bs-dismiss="offcanvas" aria-label="Close">
      <span class="fas fa-2x fa-fw fa-times"></span>
    </a>
  </div>
  <div class="offcanvas-body">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#学习感悟">学习感悟</a></li>
    <li><a href="#第1章-什么是并发">第1章 什么是并发</a>
      <ul>
        <li><a href="#并发建模">并发建模</a></li>
        <li><a href="#创建进程">创建进程</a></li>
        <li><a href="#发送消息">发送消息</a></li>
        <li><a href="#接收消息">接收消息</a></li>
        <li><a href="#并发程序和并行计算机">并发程序和并行计算机</a></li>
        <li><a href="#顺序和并发编程语言">顺序和并发编程语言</a></li>
      </ul>
    </li>
    <li><a href="#第2章-erlang速览">第2章 Erlang速览</a>
      <ul>
        <li><a href="#shell初探">Shell初探</a></li>
        <li><a href="#编译与调用">编译与调用</a></li>
        <li><a href="#并发实例">并发实例</a></li>
        <li><a href="#练习">练习</a></li>
      </ul>
    </li>
    <li><a href="#第3章-基本概念">第3章 基本概念</a>
      <ul>
        <li><a href="#erlang-shell">Erlang shell</a></li>
        <li><a href="#整数运算">整数运算</a></li>
        <li><a href="#变量">变量</a></li>
        <li><a href="#浮点数">浮点数</a></li>
        <li><a href="#原子">原子</a></li>
        <li><a href="#元组">元组</a></li>
        <li><a href="#列表">列表</a></li>
        <li><a href="#字符串">字符串</a></li>
        <li><a href="#模式匹配再探">模式匹配再探</a></li>
        <li><a href="#练习-1">练习</a></li>
      </ul>
    </li>
    <li><a href="#第4章-模块与函数">第4章 模块与函数</a>
      <ul>
        <li><a href="#模块介绍">模块介绍</a></li>
        <li><a href="#结算程序">结算程序</a></li>
        <li><a href="#基本的抽象单元fun">基本的抽象单元fun</a></li>
        <li><a href="#优化结算程序">优化结算程序</a></li>
        <li><a href="#列表推导">列表推导</a></li>
        <li><a href="#内置函数">内置函数</a></li>
        <li><a href="#关卡">关卡</a></li>
        <li><a href="#case和if表达式">case和if表达式</a></li>
        <li><a href="#构建列表的方式">构建列表的方式</a></li>
        <li><a href="#归集器">归集器</a></li>
        <li><a href="#练习-2">练习</a></li>
      </ul>
    </li>
    <li><a href="#第5章-记录与映射组">第5章 记录与映射组</a>
      <ul>
        <li><a href="#映射组记录的选择">映射组/记录的选择</a></li>
        <li><a href="#记录的使用">记录的使用</a></li>
        <li><a href="#映射组的使用">映射组的使用</a></li>
        <li><a href="#练习-3">练习</a></li>
      </ul>
    </li>
    <li><a href="#第6章-顺序程序的错误处理">第6章 顺序程序的错误处理</a>
      <ul>
        <li><a href="#书本内容">书本内容</a></li>
        <li><a href="#练习-4">练习</a></li>
      </ul>
    </li>
    <li><a href="#第7章-二进制型与位语法">第7章 二进制型与位语法</a>
      <ul>
        <li><a href="#二进制型">二进制型</a></li>
        <li><a href="#位语法">位语法</a></li>
        <li><a href="#位串">位串</a></li>
        <li><a href="#练习-5">练习</a></li>
      </ul>
    </li>
    <li><a href="#第8章-erlang顺序编程补遗">第8章 Erlang顺序编程补遗</a>
      <ul>
        <li><a href="#书本内容-1">书本内容</a></li>
        <li><a href="#练习-6">练习</a></li>
      </ul>
    </li>
    <li><a href="#第9章-类型">第9章 类型</a>
      <ul>
        <li><a href="#erlang-的类型表示法">Erlang 的类型表示法</a></li>
        <li><a href="#dialyzer">dialyzer</a></li>
        <li><a href="#类型推断过程">类型推断过程</a></li>
        <li><a href="#练习-7">练习</a></li>
      </ul>
    </li>
    <li><a href="#第10章-编译和运行程序">第10章 编译和运行程序</a>
      <ul>
        <li><a href="#设置载入代码的搜索路径">设置载入代码的搜索路径</a></li>
        <li><a href="#在系统启动时执行一组命令">在系统启动时执行一组命令</a></li>
        <li><a href="#程序运行的三种方式">程序运行的三种方式</a></li>
        <li><a href="#带命令行参数程序的运行">带命令行参数程序的运行</a></li>
        <li><a href="#使用make使编译自动化">使用make使编译自动化</a></li>
        <li><a href="#一个makefile模板">一个makefile模板</a></li>
        <li><a href="#精简makefile模板">精简makefile模板</a></li>
      </ul>
    </li>
    <li><a href="#第11章-现实世界中的并发">第11章 现实世界中的并发</a></li>
    <li><a href="#第12章-并发编程">第12章 并发编程</a>
      <ul>
        <li><a href="#基本并发函数">基本并发函数</a></li>
        <li><a href="#选择mfa还是fun进行分裂">选择MFA还是Fun进行分裂</a></li>
        <li><a href="#简单进程示例">简单进程示例</a></li>
        <li><a href="#客户端-服务器示例">客户端-服务器示例</a></li>
        <li><a href="#计算进程平均创建时间">计算进程平均创建时间</a></li>
        <li><a href="#超时的接收">超时的接收</a></li>
        <li><a href="#receive的工作方式">receive的工作方式</a></li>
        <li><a href="#注册进程">注册进程</a></li>
        <li><a href="#尾递归">尾递归</a></li>
        <li><a href="#并发程序模板">并发程序模板</a></li>
        <li><a href="#练习-8">练习</a></li>
      </ul>
    </li>
    <li><a href="#第13章-并发程序中的错误">第13章 并发程序中的错误</a>
      <ul>
        <li><a href="#错误处理的理念">错误处理的理念</a></li>
        <li><a href="#错误处理的术语">错误处理的术语</a></li>
        <li><a href="#基本错误处理函数">基本错误处理函数</a></li>
        <li><a href="#容错式编程示例">容错式编程示例</a></li>
        <li><a href="#练习-9">练习</a></li>
      </ul>
    </li>
    <li><a href="#第14章-分布式编程">第14章 分布式编程</a>
      <ul>
        <li><a href="#分布式优势">分布式优势</a></li>
        <li><a href="#分布式erlang示例">分布式Erlang示例</a></li>
        <li><a href="#两种分布式模型">两种分布式模型</a></li>
        <li><a href="#一分布式编程的库和内置函数">一、分布式编程的库和内置函数</a></li>
        <li><a href="#远程分裂示例">远程分裂示例</a></li>
        <li><a href="#cookie-保护系统">cookie 保护系统</a></li>
        <li><a href="#二lib_chan模块">二、lib_chan模块</a></li>
        <li><a href="#基于套接字的分布式模型示例">基于套接字的分布式模型示例</a></li>
        <li><a href="#练习-10">练习</a></li>
        <li><a href="#附录lib_chan模块实现原理">附录：lib_chan模块实现原理</a></li>
      </ul>
    </li>
    <li><a href="#第15章-接口技术">第15章 接口技术</a>
      <ul>
        <li><a href="#端口概述">端口概述</a></li>
        <li><a href="#创建端口">创建端口</a></li>
        <li><a href="#端口api">端口Api</a></li>
        <li><a href="#用端口建立外部c程序接口">用端口建立外部C程序接口</a></li>
        <li><a href="#在-erlang-里调用-shell-脚本">在 Erlang 里调用 shell 脚本</a></li>
        <li><a href="#高级接口技术">高级接口技术</a></li>
        <li><a href="#练习-11">练习</a></li>
      </ul>
    </li>
    <li><a href="#第16章-文件编程">第16章 文件编程</a>
      <ul>
        <li><a href="#操作文件的模块">操作文件的模块</a></li>
        <li><a href="#读取文件">读取文件</a></li>
        <li><a href="#写入文件">写入文件</a></li>
        <li><a href="#目录和文件操作">目录和文件操作</a></li>
        <li><a href="#一个查找工具函数">一个查找工具函数</a></li>
        <li><a href="#其他信息">其他信息</a></li>
        <li><a href="#练习-12">练习</a></li>
      </ul>
    </li>
    <li><a href="#第17章-套接字编程">第17章 套接字编程</a>
      <ul>
        <li><a href="#tcp的使用">TCP的使用</a></li>
        <li><a href="#udp">UDP</a></li>
        <li><a href="#案例一个-shoutcast-服务器">案例：一个 SHOUTcast 服务器</a></li>
        <li><a href="#练习-13">练习</a></li>
      </ul>
    </li>
    <li><a href="#第18章-用websocket和erlang进行浏览">第18章 用WebSocket和Erlang进行浏览</a>
      <ul>
        <li><a href="#一个数字时钟">一个数字时钟</a></li>
        <li><a href="#单方聊天框">单方聊天框</a></li>
        <li><a href="#浏览器里的-erlang-shell">浏览器里的 Erlang shell</a></li>
        <li><a href="#一个聊天小部件">一个聊天小部件</a></li>
        <li><a href="#简化版-irc">简化版 IRC</a></li>
        <li><a href="#浏览器里的图形">浏览器里的图形</a></li>
        <li><a href="#浏览器-服务器协议">浏览器-服务器协议</a></li>
        <li><a href="#练习-14">练习</a></li>
      </ul>
    </li>
    <li><a href="#第19章-用ets和dets存储数据">第19章 用ETS和DETS存储数据</a>
      <ul>
        <li><a href="#基本概念">基本概念</a></li>
        <li><a href="#基本操作">基本操作</a></li>
        <li><a href="#影响-ets-表效率的因素">影响 ETS 表效率的因素</a></li>
        <li><a href="#练习-15">练习</a></li>
      </ul>
    </li>
    <li><a href="#第20章-mnesiaerlang数据库">第20章 Mnesia：Erlang数据库</a>
      <ul>
        <li><a href="#练习-16">练习</a></li>
      </ul>
    </li>
    <li><a href="#第21章-性能分析调试与跟踪">第21章 性能分析、调试与跟踪</a>
      <ul>
        <li><a href="#练习-17">练习</a></li>
      </ul>
    </li>
    <li><a href="#第22章-otp介绍">第22章 OTP介绍</a>
      <ul>
        <li><a href="#引入otp">引入OTP</a></li>
        <li><a href="#gen_server回调结构">gen_server回调结构</a></li>
        <li><a href="#gen_server案例">gen_server案例</a></li>
        <li><a href="#练手小项目">练手小项目</a></li>
        <li><a href="#练习-18">练习</a></li>
      </ul>
    </li>
    <li><a href="#第23章-用otp构建系统">第23章 用OTP构建系统</a>
      <ul>
        <li><a href="#通用事件处理程序">通用事件处理程序</a></li>
        <li><a href="#错误记录器">错误记录器</a></li>
        <li><a href="#警报管理">警报管理</a></li>
        <li><a href="#应用程序服务器">应用程序服务器</a></li>
        <li><a href="#监控树">监控树</a></li>
        <li><a href="#启动系统">启动系统</a></li>
        <li><a href="#应用程序">应用程序</a></li>
        <li><a href="#应用程序监视器">应用程序监视器</a></li>
        <li><a href="#练习-19">练习</a></li>
      </ul>
    </li>
    <li><a href="#第24章-编程术语">第24章 编程术语</a>
      <ul>
        <li><a href="#练习-20">练习</a></li>
      </ul>
    </li>
    <li><a href="#第25章-第三方程序">第25章 第三方程序</a>
      <ul>
        <li><a href="#rebar">rebar</a></li>
        <li><a href="#练习-21">练习</a></li>
      </ul>
    </li>
    <li><a href="#第26章-多核cpu编程">第26章 多核CPU编程</a>
      <ul>
        <li><a href="#多核高效运行">多核高效运行</a></li>
        <li><a href="#并行的map函数及测试">并行的map函数及测试</a></li>
        <li><a href="#mapreduce">mapreduce</a></li>
        <li><a href="#练习-22">练习</a></li>
      </ul>
    </li>
    <li><a href="#第27章-福尔摩斯的最后一案">第27章 福尔摩斯的最后一案</a></li>
  </ul>
</nav>
  </div>
</div><div class="post-content mb-3" ><h1 id="erlang程序设计">《Erlang程序设计》</h1>
<blockquote>
<p>越精简的代码, 越复杂, erlang语言是精简中的精简.</p>
<p>就由这本书作为我的Erlang入门吧！</p>
</blockquote>
<p>配置Erlang环境看这里：https://blog.csdn.net/weixin_38044597/article/details/118194771</p>
<p>另外我选用IDEA作为开发环境。</p>
<p>这本书有非常多未填的坑，等待机会以后填。</p>
<h2 id="学习感悟">学习感悟</h2>
<ol>
<li>学习这本书时领会到笔记应该和书有所区别，笔记的结构应当是消化后的结构，而不是按照书上来，<strong>做笔记的时机至少应当等到一章的结束，甚至可以一本书的结束</strong>，这样才有全局的结构感。才方便作复习用笔记，而不是一个精简版书目。书目是循序渐进的，而笔记应当是全面的，大体上有顺序的。而且这么做有助于提高阅读效率和知识印象。</li>
<li>笔记不是查阅全书</li>
</ol>
<h2 id="第1章-什么是并发">第1章 什么是并发</h2>
<h3 id="并发建模">并发建模</h3>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">person</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">init</span><span class="p">(</span><span class="nv">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">...</span>
</code></pre></div><p>第1行<code>-module(person)</code>.的意思是此文件包含用于person模块的代码。它应该与文件名一致（除了.erl这个文件扩展名）
。模块名必须以一个小写字母开头。从技术上说，模块名是一个原子（atom）。</p>
<p>模块声明之后是一条导出声明。导出声明指明了模块里哪些函数可以从模块外部进行调用。它们类似于许多编程语言里的public声明。没有包括在导出声明里的函数是私有的，无法在模块外调用</p>
<p><code>-export([init/1])</code>.语法的意思是带有<strong>一个参数</strong>（/1指的就是这个意思，而不是除以1）的函数init可以在模块外调用。如果想要导出多个函数，就应该使用下面这种语法：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="nv">FuncName1</span><span class="o">/</span><span class="nv">N1</span><span class="p">,</span> <span class="nv">FuncName2</span><span class="o">/</span><span class="nv">N2</span><span class="p">,</span> <span class="p">...])</span>
</code></pre></div><p>方括号[ &hellip; ]的意思是“列表”，因此这条声明的意思是我们想要从模块里导出一个函数列表。</p>
<h3 id="创建进程">创建进程</h3>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">world</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>	<span class="nv">Joe</span>	     <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="p">[</span><span class="s">&#34;Joe&#34;</span><span class="p">]),</span>
<span class="ln"> 6</span>	<span class="nv">Susannah</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="p">[</span><span class="s">&#34;Susannah&#34;</span><span class="p">]),</span>
<span class="ln"> 7</span>	<span class="nv">Dave</span>	 <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="p">[</span><span class="s">&#34;Dave&#34;</span><span class="p">]),</span>
<span class="ln"> 8</span>	<span class="nv">Andy</span>	 <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="p">[</span><span class="s">&#34;Andy&#34;</span><span class="p">]),</span>
<span class="ln"> 9</span>	<span class="nv">Rover</span>	 <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="n">dog</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="p">[</span><span class="s">&#34;Rover&#34;</span><span class="p">]),</span>
<span class="ln">10</span>	<span class="p">...</span>
<span class="ln">11</span>	<span class="nv">Rabbit1</span>	 <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="n">rabbit</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="p">[</span><span class="s">&#34;Flopsy&#34;</span><span class="p">]),</span>
<span class="ln">12</span>	<span class="p">...</span>
<span class="ln">13</span>
</code></pre></div><p>spawn是一个Erlang基本函数，它会创建一个并发进程并返回一个进程标识符。spawn可以这样调用：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nb">spawn</span><span class="p">(</span><span class="nv">ModName</span><span class="p">,</span> <span class="nv">FuncName</span><span class="p">,</span> <span class="p">[</span><span class="nv">Arg1</span><span class="p">,</span> <span class="nv">Arg2</span><span class="p">,</span> <span class="p">...,</span> <span class="nv">ArgN</span><span class="p">])</span>
</code></pre></div><p>当Erlang运行时系统执行spawn时，它会创建一个新进程（不是操作系统的进程，而是一个由Erlang系统管理的轻量级进程）。当进程创建完毕后，它便开始执行参数所指定的代码。ModName是包含想要执行代码的模块名。FuncName是模块里的函数名，而[Arg1, Arg2, &hellip;]是一个列表，包含了想要执行的函数参数。因此，下面这个调用的意思是启动一个执行函数person:init(&ldquo;Joe&rdquo;)的进程：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nb">spawn</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="p">[</span><span class="s">&#34;Joe&#34;</span><span class="p">])</span>
</code></pre></div><p>spawn的返回值是一个进程标识符（PID，Process IDentifier），可以用来与新创建的进程交互。</p>
<p>Erlang里的模块类似于面向对象编程语言（OOPL，Object-Oriented Programming Language）里的类，进程则类似于OOPL里的对象（或者说类实例）。在Erlang里，spawn通过运行某个模块里定义的函数创建一个新进程。而在Java里，new通过运行某个类中定义的方法创建一个新对象。在OOPL里可以用一个类创建数千个类实例。类似地，在Erlang里我们可以用一个模块创建数千甚至数百万个执行模块代码的进程。</p>
<h3 id="发送消息">发送消息</h3>
<p>启动模拟之后，我们希望在程序的不同进程之间发送消息。在Erlang里，各个进程不共享内存，只能通过发送消息来与其他进程交互。</p>
<p>Joe想要对Susannah说些什么。在程序里我们会编写这样一行代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nv">Susannah</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="s">&#34;Hope the dogs dont chase the rabbits&#34;</span><span class="p">}</span>
</code></pre></div><p><code>Pid ! Msg</code> 语法的意思是发送消息Msg到进程Pid。大括号里的<code>self()</code>参数标明了发送消息的进程（在此处是Joe）。</p>
<h3 id="接收消息">接收消息</h3>
<p>为了让Susannah的进程接收来自Joe的消息，要这样写：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="k">receive</span>
<span class="ln">2</span>	<span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Message</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">3</span>		<span class="p">...</span>
<span class="ln">4</span><span class="k">end</span>
</code></pre></div><p>当Susannah的进程接收到一条消息时，变量From会绑定为Joe，这样Susannah就知道消息来自何处，变量Message则会包含此消息。</p>
<h3 id="并发程序和并行计算机">并发程序和并行计算机</h3>
<p>Erlang里的并发程序是由互相通信的多组顺序进程组成的。一个Erlang进程就是一个小小的虚拟机，可以执行单个Erlang函数。别把它和操作系统的进程相混淆。</p>
<h3 id="顺序和并发编程语言">顺序和并发编程语言</h3>
<p>在Erlang里，并发性由Erlang虚拟机提供，而非操作系统或任何的外部库。在大多数顺序编程语言里，并发性都是以接口的形式提供，指向主机操作系统的内部并发函数。区分基于操作系统的并发和基于语言的并发很重要，因为如果使用基于操作系统的并发，那么程序在不同的操作系统上就会有不同的工作方式。Erlang的并发在所有操作系统上都有着相同的工作方式。要用Erlang编写并发程序，只需掌握Erlang，而不必掌握操作系统的并发机制。在Erlang里，进程和并发是我们可以用来定型和解决问题的工具。这让细粒度控制程序的并发结构成为可能，而用操作系统的进程是很难做到的。</p>
<h2 id="第2章-erlang速览">第2章 Erlang速览</h2>
<h3 id="shell初探">Shell初探</h3>
<p>Erlang shell以横幅信息和计数提示符1&gt;作为响应。然后输入一个表达式，并得到了执行和显示。请注意每一条表达式都必须以一个句号后接一个空白字符结尾。在这个上下文环境里，空白是指空格、制表（Tab）或者回车符。</p>
<ul>
<li>可以用=操作符给变量赋值（严格来说是给变量绑定一个值）。不能重新绑定变量。Erlang是一种函数式语言，所以一旦定义了X = 123，那么X永远就是123，不允许改变！=不是一个赋值操作符，它实际上是一个模式匹配操作符。与其他函数式编程语言一样，Erlang的变量只能绑定一次。绑定变量的意思是给变量一个值，一旦这个值被绑定，以后就不能改动了。</li>
<li>Erlang的<strong>变量以大写字母开头</strong>。所以X、This和A_long_name都是变量。以小写字母开头的名称（比如monday或friday）不是变量，而是<strong>符号常量</strong>，它们被称为<strong>原子</strong>（atom）。</li>
</ul>
<h3 id="编译与调用">编译与调用</h3>
<p>Erlang程序是由许多并行的进程构成的。进程负责执行模块里定义的函数。模块则是扩展名为.erl的文件，运行前必须先编译它们。编译某个模块之后，就可以在shell或者直接从操作系统环境的命令行里执行该模块中的函数了。</p>
<p>1.shell编译hello.erl文件</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">hello</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">5</span>	<span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Hellow world</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">)</span><span class="o">/</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="sc">$e</span><span class="n">rl</span>
<span class="ln">2</span><span class="o">&gt;</span><span class="n">c</span><span class="p">(</span><span class="n">hello</span><span class="p">).</span>
<span class="ln">3</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">hello</span><span class="p">}</span>
<span class="ln">4</span><span class="o">&gt;</span><span class="nn">hello</span><span class="p">:</span><span class="nf">start</span><span class="p">().</span>
<span class="ln">5</span><span class="nv">Hello</span> <span class="n">world</span>
<span class="ln">6</span><span class="n">ok</span>
<span class="ln">7</span><span class="o">&gt;</span><span class="n">halt</span><span class="p">().</span>
</code></pre></div><p><code>c(hello)</code>命令<strong>编译</strong>了hello.erl文件里的代码。{ok, hello}的意思是编译成功。现在代码已准备好运行了。第2行里<strong>执行</strong>了<code>hello:start()</code>函数。第3行里<strong>停止</strong>了Erlang shell。</p>
<p>在shell里进行操作的优点是只要平台为Erlang所支持，这种编译和运行程序的方法就一定可用。在操作系统的命令行里的操作可能会因平台的不同而有所差别。</p>
<p>2.shell外编译</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="sc">$ </span><span class="n">erlc</span> <span class="n">hello</span><span class="p">.</span><span class="n">erl</span>
<span class="ln">2</span><span class="sc">$ </span><span class="n">erl</span> <span class="o">-</span><span class="n">noshell</span> <span class="o">-</span><span class="n">s</span> <span class="n">hello</span> <span class="n">start</span> <span class="o">-</span><span class="n">s</span> <span class="n">init</span> <span class="n">stop</span>
<span class="ln">3</span><span class="nv">Hello</span> <span class="n">world</span>
</code></pre></div><p>erlc 从命令行启动了Erlang编译器。编译器编译了 hello.erl 里的代码并生成一个名为hello.beam的目标代码文件。</p>
<p>$erl -noshell &hellip;命令加载了 hello模块并执行 hello:start()函数。随后，它执行了init:stop()，这个表达式终止了Erlang会话。</p>
<p>在Erlang shell之外运行Erlang编译器（erlc）是编译Erlang代码的首选方式。可以在Erlang shell里编译模块，但要这么做必须首先启动Erlang shell。使用erlc的优点在于自动化。我们可以在rakefile或makefile内运行erlc来自动化构建过程。</p>
<h3 id="并发实例">并发实例</h3>
<p>1.文件服务器进程</p>
<p>afile_server.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">afile_server</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">loop</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">spawn</span><span class="p">(</span><span class="n">afile_server</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="p">[</span><span class="nv">Dir</span><span class="p">]).</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>	<span class="k">receive</span>
<span class="ln"> 8</span>		<span class="p">{</span><span class="nv">Client</span><span class="p">,</span> <span class="n">list_dir</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>			<span class="nv">Client</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nn">file</span><span class="p">:</span><span class="nf">list_dir</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)};</span>
<span class="ln">10</span>		<span class="p">{</span><span class="nv">Client</span><span class="p">,</span> <span class="p">{</span><span class="n">get_file</span><span class="p">,</span> <span class="nv">File</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">11</span>            <span class="c">% 获取绝对路径
</span><span class="ln">12</span><span class="c"></span>			<span class="nv">Full</span> <span class="o">=</span> <span class="nn">filename</span><span class="p">:</span><span class="nf">join</span><span class="p">(</span><span class="nv">Dir</span><span class="p">,</span> <span class="nv">File</span><span class="p">),</span>
<span class="ln">13</span>            <span class="c">% 调用read_file读文件
</span><span class="ln">14</span><span class="c"></span>			<span class="nv">Client</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="nv">Full</span><span class="p">)}</span>
<span class="ln">15</span>	<span class="k">end</span><span class="p">,</span>
<span class="ln">16</span>	<span class="n">loop</span><span class="p">(</span><span class="nv">Dir</span><span class="p">).</span>
</code></pre></div><ul>
<li>
<p>Erlang编写无限循环的方法：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="k">receive</span>
<span class="ln">3</span>      <span class="nv">Command</span> <span class="o">-&gt;</span>
<span class="ln">4</span>          <span class="p">.....</span>
<span class="ln">5</span>	<span class="k">end</span><span class="p">,</span>
<span class="ln">6</span>	<span class="n">loop</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)</span>
</code></pre></div><p>不用担心最后的自身调用，这不会耗尽栈空间。Erlang对代码采用了一种所谓“尾部调用”的优化，意思是此函数的运行空间是固定的。这是用Erlang编写循环的标准方式，只要在最后调用自身即可。</p>
</li>
<li>
<p>模式匹配：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="k">receive</span>
<span class="ln">2</span>	<span class="nv">Pattern1</span> <span class="o">-&gt;</span>
<span class="ln">3</span>      <span class="nv">Actions1</span><span class="p">;</span>
<span class="ln">4</span>	<span class="nv">Pattern2</span> <span class="o">-&gt;</span>
<span class="ln">5</span>      <span class="nv">Actions2</span> <span class="o">-&gt;</span>
<span class="ln">6</span>      <span class="p">...</span>
<span class="ln">7</span>	<span class="p">...</span>
<span class="ln">8</span><span class="k">end</span>
</code></pre></div><p>Erlang编译器和运行时系统会正确推断出如何在收到消息时运行适当的代码。不需要编写任何的if-then-else或switch语句来设定该做什么。</p>
</li>
<li>
<p>shell测试：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">(</span><span class="n">afile_server</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">afile_server</span><span class="p">}</span>
<span class="ln"> 3</span><span class="c">% 编译afile_server.erl文件所包含的afile_server模块。
</span><span class="ln"> 4</span><span class="c"></span>  
<span class="ln"> 5</span><span class="mi">2</span><span class="o">&gt;</span> <span class="nv">FileServer</span> <span class="o">=</span> <span class="nn">afile_server</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="s">&#34;.&#34;</span><span class="p">).</span>
<span class="ln"> 6</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">47</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="ln"> 7</span><span class="c">% afile_server:start(Dir)调用spawn(afile_server, loop, [Dir])。
</span><span class="ln"> 8</span><span class="c">% 这就创建出一个新的并行进程来执行函数afile_server:loop(Dir)并返回一个进程标识符
</span><span class="ln"> 9</span><span class="c">% &lt;0.47.0&gt;是文件服务器进程的进程标识符。它的显示方式是尖括号内由句号分隔的三个整数。
</span><span class="ln">10</span><span class="c"></span>  
<span class="ln">11</span><span class="mi">3</span><span class="o">&gt;</span> <span class="nv">FileServer</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="n">list_dir</span><span class="p">}.</span>
<span class="ln">12</span><span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">31</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list_dir</span><span class="p">}.</span>
<span class="ln">13</span><span class="c">% 这里给文件服务器进程发送了一条{self(), list_dir}消息。Pid ! 
</span><span class="ln">14</span><span class="c">% Message的返回值被规定为Message，因此shell打印出{self(),list_dir}的值，即{&lt;0.31.0&gt;, list_dir} 
</span><span class="ln">15</span><span class="c"></span>  
<span class="ln">16</span><span class="mi">4</span><span class="o">&gt;</span> <span class="k">receive</span> <span class="nv">X</span> <span class="o">-&gt;</span> <span class="nv">X</span> <span class="k">end</span><span class="p">.</span>
<span class="ln">17</span><span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">47</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span> 
<span class="ln">18</span>	<span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">[</span><span class="s">&#34;afile_server.beam&#34;</span><span class="p">,</span> <span class="p">...]}</span>
<span class="ln">19</span><span class="p">}</span>
<span class="ln">20</span><span class="c">% receive X -&gt; X end接收文件服务器发送的回复。它返回元组{&lt;0.47.0&gt;, {ok, ...}。
</span><span class="ln">21</span><span class="c">% 该元组的第一个元素&lt;0.47.0&gt;是文件服务器的进程标识符。
</span><span class="ln">22</span><span class="c">% 第二个参数是file:list_dir(Dir)函数的返回值
</span></code></pre></div></li>
</ul>
<p>2.客户端代码</p>
<p>afile_client.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">afile_client</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">ls</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">get_file</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">ls</span><span class="p">(</span><span class="nv">Server</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>	<span class="nv">Server</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="n">list_dir</span><span class="p">},</span>
<span class="ln"> 6</span>	<span class="k">receive</span>
<span class="ln"> 7</span>		<span class="p">{</span><span class="nv">Server</span><span class="p">,</span> <span class="nv">FileList</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>			<span class="nv">FileList</span>
<span class="ln"> 9</span>	<span class="k">end</span><span class="p">.</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="nf">get_file</span><span class="p">(</span><span class="nv">Server</span><span class="p">,</span> <span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">12</span>	<span class="nv">Server</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="p">{</span><span class="n">get_file</span><span class="p">,</span> <span class="nv">File</span><span class="p">}},</span>
<span class="ln">13</span>	<span class="k">receive</span>
<span class="ln">14</span>		<span class="p">{</span><span class="nv">Server</span><span class="p">,</span> <span class="nv">Content</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">15</span>			<span class="nv">Content</span>
<span class="ln">16</span>	<span class="k">end</span><span class="p">.</span>
</code></pre></div><p>3.测试</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">(</span><span class="n">afile_server</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">afile_server</span><span class="p">}</span>
<span class="ln"> 3</span><span class="mi">2</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">(</span><span class="n">afile_client</span><span class="p">).</span>
<span class="ln"> 4</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">afile_client</span><span class="p">}</span>
<span class="ln"> 5</span><span class="mi">3</span><span class="o">&gt;</span> <span class="nv">FileServer</span> <span class="o">=</span> <span class="nn">afile_server</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="s">&#34;.&#34;</span><span class="p">).</span>
<span class="ln"> 6</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">43</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="ln"> 7</span><span class="mi">4</span><span class="o">&gt;</span> <span class="nn">afile_client</span><span class="p">:</span><span class="nf">get_file</span><span class="p">(</span><span class="nv">FileServer</span><span class="p">,</span> <span class="s">&#34;missing&#34;</span><span class="p">).</span>
<span class="ln"> 8</span><span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">enoent</span><span class="p">}</span>
<span class="ln"> 9</span><span class="mi">5</span><span class="o">&gt;</span> <span class="nn">afile_client</span><span class="p">:</span><span class="nf">get_file</span><span class="p">(</span><span class="nv">FileServer</span><span class="p">,</span> <span class="s">&#34;afile_server.erl&#34;</span><span class="p">).</span>
<span class="ln">10</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&#34;-modle(afile_server).</span><span class="se">\n</span><span class="s">-export....&#34;</span><span class="p">}</span>
</code></pre></div><h3 id="练习">练习</h3>
<p><strong>(4)</strong></p>
<blockquote>
<p>运行文件客户端和服务器代码。加入一个名为put_file的命令。你需要添加何种消息？学习如何查阅手册页。查阅手册页里的file模块。</p>
</blockquote>
<p><code>write_file/2</code>：https://www.erlang.org/doc/apps/kernel/file.html#write_file/2</p>
<p>客户端应发送文件名及文件内容：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">afile_client</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">ls</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">get_file</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">put_file</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">ls</span><span class="p">(</span><span class="nv">Server</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>	<span class="nv">Server</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="n">list_dir</span><span class="p">},</span>
<span class="ln"> 6</span>	<span class="k">receive</span>
<span class="ln"> 7</span>		<span class="p">{</span><span class="nv">Server</span><span class="p">,</span> <span class="nv">FileList</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>			<span class="nv">FileList</span>
<span class="ln"> 9</span>	<span class="k">end</span><span class="p">.</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="nf">get_file</span><span class="p">(</span><span class="nv">Server</span><span class="p">,</span> <span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">12</span>	<span class="nv">Server</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="p">{</span><span class="n">get_file</span><span class="p">,</span> <span class="nv">File</span><span class="p">}},</span>
<span class="ln">13</span>	<span class="k">receive</span>
<span class="ln">14</span>		<span class="p">{</span><span class="nv">Server</span><span class="p">,</span> <span class="nv">Content</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">15</span>			<span class="nv">Content</span>
<span class="ln">16</span>	<span class="k">end</span><span class="p">.</span>
<span class="ln">17</span>
<span class="ln">18</span><span class="nf">put_file</span><span class="p">(</span><span class="nv">Server</span><span class="p">,</span> <span class="nv">FileName</span><span class="p">,</span> <span class="nv">Content</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">19</span>    <span class="nv">Server</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="p">{</span><span class="nv">FileName</span><span class="p">,</span> <span class="nv">Content</span><span class="p">}},</span>
<span class="ln">20</span>    <span class="k">receive</span>
<span class="ln">21</span>        <span class="p">{</span><span class="nv">Server</span><span class="p">,</span> <span class="n">response</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">22</span>            <span class="n">response</span>
<span class="ln">23</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>对应的Server接收文件名和内容，写入文件，并返回操作结果：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">afile_server</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">loop</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">spawn</span><span class="p">(</span><span class="n">afile_server</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="p">[</span><span class="nv">Dir</span><span class="p">]).</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>	<span class="k">receive</span>
<span class="ln"> 8</span>		<span class="p">{</span><span class="nv">Client</span><span class="p">,</span> <span class="n">list_dir</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>			<span class="nv">Client</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nn">file</span><span class="p">:</span><span class="nf">list_dir</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)};</span>
<span class="ln">10</span>		<span class="p">{</span><span class="nv">Client</span><span class="p">,</span> <span class="p">{</span><span class="n">get_file</span><span class="p">,</span> <span class="nv">File</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">11</span>			<span class="nv">Full</span> <span class="o">=</span> <span class="nn">filename</span><span class="p">:</span><span class="nf">join</span><span class="p">(</span><span class="nv">Dir</span><span class="p">,</span> <span class="nv">File</span><span class="p">),</span>
<span class="ln">12</span>			<span class="nv">Client</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="nv">Full</span><span class="p">)};</span>
<span class="ln">13</span>        <span class="p">{</span><span class="nv">Client</span><span class="p">,</span> <span class="p">{</span><span class="nv">FileName</span><span class="p">,</span> <span class="nv">Content</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">14</span>            <span class="nv">Full</span> <span class="o">=</span> <span class="nn">filename</span><span class="p">:</span><span class="nf">join</span><span class="p">(</span><span class="nv">Dir</span><span class="p">,</span> <span class="nv">FileName</span><span class="p">),</span>
<span class="ln">15</span>           	<span class="n">response</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">write_file</span><span class="p">(</span><span class="nv">Full</span><span class="p">,</span> <span class="nb">list_to_binary</span><span class="p">(</span><span class="nv">Content</span><span class="p">)),</span>
<span class="ln">16</span>            <span class="nv">Client</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="n">response</span><span class="p">}</span>
<span class="ln">17</span>	<span class="k">end</span><span class="p">,</span>
<span class="ln">18</span>	<span class="n">loop</span><span class="p">(</span><span class="nv">Dir</span><span class="p">).</span>
</code></pre></div><p>测试失败：目前暂时不去解决，不过要写的文件还是写上去了。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">(</span><span class="n">afile_server</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="n">afile_server</span><span class="p">}</span>
<span class="ln"> 3</span><span class="mi">2</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">(</span><span class="n">afile_client</span><span class="p">).</span>
<span class="ln"> 4</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="n">afile_client</span><span class="p">}</span>
<span class="ln"> 5</span><span class="mi">3</span><span class="o">&gt;</span> <span class="nv">FileServer</span> <span class="o">=</span> <span class="nn">afile_server</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="s">&#34;.&#34;</span><span class="p">).</span>
<span class="ln"> 6</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">94</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="ln"> 7</span><span class="mi">4</span><span class="o">&gt;</span> <span class="nn">afile_client</span><span class="p">:</span><span class="nf">put_file</span><span class="p">(</span><span class="nv">FileServer</span><span class="p">,</span> <span class="s">&#34;test.txt&#34;</span><span class="p">,</span> <span class="s">&#34;Erlang file test&#34;</span><span class="p">).</span>
<span class="ln"> 8</span><span class="o">=</span><span class="nv">ERROR</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">4</span><span class="o">-</span><span class="nv">Dec</span><span class="o">-</span><span class="mi">2024</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">33</span><span class="p">.</span><span class="mi">629142</span> <span class="o">===</span>
<span class="ln"> 9</span><span class="nv">Error</span> <span class="n">in</span> <span class="n">process</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">94</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">with</span> <span class="nb">exit</span> <span class="nn">value</span><span class="p">:</span>
<span class="ln">10</span><span class="p">{{</span><span class="n">badmatch</span><span class="p">,</span><span class="n">ok</span><span class="p">},[{</span><span class="n">afile_server</span><span class="p">,</span><span class="n">loop</span><span class="p">,</span><span class="mi">1</span><span class="p">,[{</span><span class="n">file</span><span class="p">,</span><span class="s">&#34;afile_server.erl&#34;</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="mi">14</span><span class="p">}]}]}</span>
</code></pre></div><h2 id="第3章-基本概念">第3章 基本概念</h2>
<h3 id="erlang-shell">Erlang shell</h3>
<p>退出：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>ctrl+c
<span class="ln">2</span>
<span class="ln">3</span>a 可能导致数据损坏
<span class="ln">4</span>q() 是init:stop()命令在shell里的别名。以一种受控的方式停止了系统。所有打开的文件都被刷入缓存并关闭，数据库（如果正在运行的话）会被停止，所有的应用程序都以有序的方式关停
<span class="ln">5</span>erlang:halt() 立即停止系统
</code></pre></div><p>编写命令快捷键：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>^A 行首
<span class="ln">2</span>^D 删除当前字符
<span class="ln">3</span>^E 行尾
<span class="ln">4</span>^F或右箭头键 向前的字符
<span class="ln">5</span>^B或左箭头键 向后的字符
<span class="ln">6</span>^P或上箭头键 前一行
<span class="ln">7</span>^N或下箭头键 下一行
<span class="ln">8</span>^T 调换最近两个字符的位置
<span class="ln">9</span>Tab 尝试扩展当前模块或函数的名称
</code></pre></div><h3 id="整数运算">整数运算</h3>
<p>16进制乘32进制：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="mi">16#cafe</span> <span class="o">*</span> <span class="mi">32#sugar</span><span class="p">.</span>
</code></pre></div><h3 id="变量">变量</h3>
<ul>
<li>所有变量名都必须以大写字母开头。</li>
<li>想知道一个变量的值，只需要输入变量名。</li>
<li>如果试图给变量X指派一个不同的值，就会得到一条错误消息。</li>
<li>在Erlang里怎样表达X = X + 1这类概念？Erlang的方式是创建一个名字未被使用过的新变量（比方说X1），然后编写X1 = X + 1。</li>
</ul>
<p>Erlang的变量是一次性赋值变量（single-assignment variable）。已被指派一个值的变量称为绑定变量，否则称为未绑定
变量。=是一个<strong>模式匹配操作符</strong>，它在X为未绑定变量时的表现类似于赋值。</p>
<p>第一次说X=SomeExpression时，Erlang对自己说：“我要做些什么才能让这条语句为真？”因为X还没有值，它可以绑定X到SomeExpression这个值上，这条语句就成立了。如果后期我们说X=AnotherExpression，那么只有在SomeExpression和Another-Expression<strong>相等的情况下匹配才会成功</strong>：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="mi">1</span><span class="o">&gt;</span> <span class="nv">X</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="p">).</span>
<span class="ln">2</span><span class="mi">6</span>
<span class="ln">3</span><span class="mi">2</span><span class="o">&gt;</span> <span class="nv">Y</span> <span class="o">=</span> <span class="mi">10</span><span class="p">.</span>
<span class="ln">4</span><span class="mi">10</span>
<span class="ln">5</span><span class="c">% 在计算这个表达式之前，X等于6，因此匹配成功
</span><span class="ln">6</span><span class="c"></span><span class="mi">3</span><span class="o">&gt;</span> <span class="nv">X</span> <span class="o">=</span> <span class="mi">6</span><span class="p">.</span>
<span class="ln">7</span><span class="mi">6</span>
<span class="ln">8</span><span class="mi">4</span><span class="o">&gt;</span> <span class="nv">X</span> <span class="o">=</span> <span class="nv">Y</span><span class="p">.</span>
<span class="ln">9</span><span class="n">exception</span><span class="p">...</span>
</code></pre></div><p><strong>变量的作用域是它定义时所处的语汇单元</strong>。因此，如果X被用在一条单独的函数子句之内，它的值就不会“逃出”这个子句。没有同一函数的不同子句共享全局或私有变量这种说法。如果X出现在许多不同的函数里，那么所有这些X的值都是不相干的。(这一点让编程变得非常困难)</p>
<h3 id="浮点数">浮点数</h3>
<ul>
<li>用/给两个整数做除法时，结果会自动转换成浮点数。</li>
<li>要从除法里获得整数结果，我们必须使用操作符div和rem：N div M是让N除以M然后舍去余数。N rem M是N除以M后剩下的余数。</li>
<li>Erlang在内部使用64位的IEEE 754-1985浮点数，因此使用浮点数的程序会存在和C等语言一样的浮点数取整与精度问题。</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="mi">1</span><span class="o">&gt;</span> <span class="mi">5</span><span class="o">/</span><span class="mi">3</span><span class="p">.</span>
<span class="ln">2</span><span class="mi">1</span><span class="p">.</span><span class="mi">666666666666666667</span>
<span class="ln">3</span><span class="mi">2</span><span class="o">&gt;</span> <span class="mi">4</span><span class="o">/</span><span class="mi">2</span><span class="p">.</span>
<span class="ln">4</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span>
<span class="ln">5</span><span class="mi">3</span><span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">div</span> <span class="mi">3</span><span class="p">.</span>
<span class="ln">6</span><span class="mi">1</span>
<span class="ln">7</span><span class="mi">4</span><span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">rem</span> <span class="mi">3</span><span class="p">.</span>
<span class="ln">8</span><span class="mi">2</span>
</code></pre></div><h3 id="原子">原子</h3>
<ul>
<li>
<p>原子以小写字母开头，后接一串字母、数字、下划线（_）或at（@）符号，例如：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>red
<span class="ln">2</span>december
<span class="ln">3</span>cat
<span class="ln">4</span>meters
<span class="ln">5</span>yards
<span class="ln">6</span>joe@somehost
<span class="ln">7</span>a_long_name
</code></pre></div></li>
<li>
<p><strong>原子还可以放在单引号（'）内</strong>。可以用这种引号形式创建以大写字母开头（否则会被解释成变量）或包含字母数字以外字符的原子，例如<code>'Monday'</code>、<code>'Tuesday'</code>、<code>'+'</code>、<code>'*'</code>和<code>'an atomwith spaces'</code>。甚至可以给无需引号的原子加上引号，因此&rsquo;a&rsquo;和a的意思完全一致。</p>
</li>
<li>
<p>在某些语言里，单引号和双引号可以互换使用。Erlang里不是这样。单引号的用法如前面所示，<strong>双引号用于给字符串字面量（string literal）定界</strong>。</p>
</li>
<li>
<p><strong>一个原子的值就是它本身</strong>。可以充当全局常量的效果，只不过不需要再定义数字了，它本身就有含义。</p>
</li>
<li>
<p><code>true</code>和<code>false</code>也是原子</p>
</li>
</ul>
<h3 id="元组">元组</h3>
<p>1.创建：</p>
<ul>
<li>Erlang没有类型声明，元组里的字段没有名字。</li>
<li>为了更容易记住元组的用途，一种常用的做法是将原子作为元组的第一个元素，用它来表示元组是什么。</li>
<li>元组还可以嵌套。</li>
<li>元组用于保存固定数量的元素。</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span><span class="nv">P</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">45</span><span class="p">}.</span>
<span class="ln">2</span><span class="o">&gt;</span><span class="nv">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">point</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">45</span><span class="p">}.</span>
<span class="ln">3</span><span class="o">&gt;</span><span class="nv">Person</span> <span class="o">=</span> <span class="p">{</span><span class="n">person</span><span class="p">,</span> <span class="p">{</span><span class="n">name</span><span class="p">,</span> <span class="n">job</span><span class="p">},</span> <span class="p">{</span><span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">82</span><span class="p">},</span> <span class="p">{</span><span class="n">footsize</span><span class="p">,</span> <span class="mi">42</span><span class="p">},</span> <span class="p">{</span><span class="n">eyecolour</span><span class="p">,</span> <span class="n">brown</span><span class="p">}}.</span>
</code></pre></div><ul>
<li>如果在构建新元组时用到变量，那么新的元组会共享该变量所引用数据结构的值；</li>
<li>如果试图用未定义的变量创建数据结构，就会得到一个错误。</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span><span class="nv">F</span> <span class="o">=</span> <span class="p">{</span><span class="n">firstName</span><span class="p">,</span> <span class="n">joe</span><span class="p">}.</span>
<span class="ln">2</span><span class="p">{</span><span class="n">firstName</span><span class="p">,</span> <span class="n">joe</span><span class="p">}</span>
<span class="ln">3</span><span class="o">&gt;</span><span class="nv">L</span> <span class="o">=</span> <span class="p">{</span><span class="n">lastName</span><span class="p">,</span> <span class="n">armstrong</span><span class="p">}.</span>
<span class="ln">4</span><span class="p">{</span><span class="n">lastName</span><span class="p">,</span> <span class="n">armstrong</span><span class="p">}</span>
<span class="ln">5</span><span class="o">&gt;</span><span class="nv">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">person</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">L</span><span class="p">}.</span>
<span class="ln">6</span><span class="p">{</span><span class="n">person</span><span class="p">,</span> <span class="p">{</span><span class="n">firstName</span><span class="p">,</span> <span class="n">joe</span><span class="p">},</span> <span class="p">{</span><span class="n">firstName</span><span class="p">,</span> <span class="n">joe</span><span class="p">}}</span>
<span class="ln">7</span>
<span class="ln">8</span><span class="o">&gt;</span><span class="p">{</span><span class="n">true</span><span class="p">,</span> <span class="nv">Q</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="nv">Costs</span><span class="p">}</span>
<span class="ln">9</span><span class="o">**</span> <span class="mi">1</span><span class="p">.</span><span class="n">variable</span> <span class="n">&#39;Q&#39;</span> <span class="n">is</span> <span class="n">unbound</span><span class="o">**</span>
</code></pre></div><p>2.提取元组的值：</p>
<ul>
<li>如果想从某个元组里提取一些值，就会使用模式匹配操作符=。在待提取值的位置加入<strong>未绑定变量</strong>来提取该元组的值。</li>
<li>等号两侧的元组必须有相同数量的元素，而且两侧的对应元素必须绑定为相同的值。原子对应原子。</li>
<li>可以用匿名变量表示不感兴趣的值。</li>
<li>将_作为占位符，用于表示不感兴趣的那些变量。符号_被称为匿名变量。与正规变量不同，同一模式里的多个_不必绑定相同的值。</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="o">&gt;</span><span class="nv">P</span> <span class="o">=</span> <span class="p">{</span><span class="n">point</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">45</span><span class="p">}.</span>
<span class="ln"> 2</span><span class="p">{</span><span class="n">point</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">45</span><span class="p">}.</span>
<span class="ln"> 3</span><span class="o">&gt;</span><span class="p">{</span><span class="n">point</span><span class="p">,</span> <span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Point</span><span class="p">.</span>
<span class="ln"> 4</span><span class="p">{</span><span class="n">point</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">45</span><span class="p">}</span>
<span class="ln"> 5</span><span class="o">&gt;</span><span class="nv">X</span><span class="p">.</span>
<span class="ln"> 6</span><span class="mi">10</span>
<span class="ln"> 7</span><span class="o">&gt;</span><span class="nv">Y</span><span class="p">.</span>
<span class="ln"> 8</span><span class="mi">45</span>
<span class="ln"> 9</span><span class="c">% X绑定了10，Y绑定了45。根据规定，表达式Lhs = Rhs的值是Rhs，因此shell打印出{point,10,45}。
</span><span class="ln">10</span><span class="c"></span>
<span class="ln">11</span><span class="o">&gt;</span><span class="p">{</span><span class="n">point</span><span class="p">,</span> <span class="nv">C</span><span class="p">,</span> <span class="nv">C</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Point</span><span class="p">.</span>
<span class="ln">12</span><span class="o">**</span> <span class="n">exception</span> <span class="n">error</span><span class="p">....</span>
<span class="ln">13</span><span class="c">% 模式{point, C, C}与{point, 10, 45}不匹配，因为C不能同时是10和45。因此，这次模式匹配失败，系统打印出了错误消息。
</span><span class="ln">14</span><span class="c"></span>
<span class="ln">15</span><span class="o">&gt;</span><span class="nv">Person</span><span class="o">=</span><span class="p">{</span><span class="n">person</span><span class="p">,</span> <span class="p">{</span><span class="n">firstName</span><span class="p">,</span> <span class="n">joe</span><span class="p">},</span> <span class="p">{</span><span class="n">firstName</span><span class="p">,</span> <span class="n">joe</span><span class="p">}}.</span>
<span class="ln">16</span><span class="o">&gt;</span><span class="p">{_,{_,</span><span class="nv">First</span><span class="p">}.{_,_}}</span> <span class="o">=</span> <span class="nv">Person</span><span class="p">.</span>
<span class="ln">17</span><span class="o">&gt;</span><span class="nv">First</span><span class="p">.</span>
<span class="ln">18</span><span class="n">joe</span>
<span class="ln">19</span><span class="c">% 如果有一个复杂的元组，就可以编写一个与该元组形状（结构）相同的模式，并在待提取值的位置加入未绑定变量来提取该元组的值。
</span></code></pre></div><h3 id="列表">列表</h3>
<ul>
<li>列表（list）被用来存放任意数量的事物。创建列表的方法是用中括号把列表元素括起来，并用逗号分隔它们。</li>
<li>列表里的各元素可以是任何类型</li>
<li>列表的第一个元素被称为列表头（head）。假设把列表头去掉，剩下的就被称为列表尾（tail）。</li>
<li>无论何时，只要用[&hellip;|T]语法构建一个列表，就应该确保T是列表。可以给T的开头添加不止一个元素，写法是[E1,E2,..,En|T]。</li>
<li>列表用于保存可变数量的元素。</li>
</ul>
<p>1.定义列表：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span> <span class="n">hello</span><span class="p">,</span> <span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">cost</span><span class="p">,</span> <span class="n">apple</span><span class="p">,</span> <span class="mi">30</span><span class="o">-</span><span class="mi">20</span><span class="p">},</span> <span class="mi">3</span><span class="p">].</span>
<span class="ln">2</span><span class="nv">ThingsToBuy</span> <span class="o">=</span> <span class="p">[{</span><span class="n">apples</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="n">pears</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span> <span class="p">{</span><span class="n">milk</span><span class="p">,</span> <span class="mi">3</span><span class="p">}].</span>
<span class="ln">3</span><span class="nv">ThingsToBuy1</span> <span class="o">=</span> <span class="p">[{</span><span class="n">oranges</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="n">newspaper</span><span class="p">,</span><span class="mi">1</span><span class="p">}|</span><span class="nv">ThingsToBuy</span><span class="p">].</span>
</code></pre></div><p>2.提取列表元素：</p>
<p>可以用模式匹配操作来提取某个列表里的元素。如果有一个非空列表L，那么表达式[X|Y] = L（X和Y都是未绑定变量）会提取列表头作为X，列表尾作为Y。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">[</span><span class="nv">Buy1</span><span class="p">|</span><span class="nv">ThingsToBuy2</span><span class="p">]</span> <span class="o">=</span> <span class="nv">ThingsToBuy1</span><span class="p">.</span>
<span class="ln">2</span><span class="c">% 操作成功，绑定如下：Buy1 = {oranges,4} ，ThingsToBuy2 = [{newspaper,1},然后可以继续拆出{apples,10}, {pears,6}, {milk,3}]。于是我们先去买橙子（oranges）下一对商品。
</span></code></pre></div><h3 id="字符串">字符串</h3>
<p>1.用字符串字面量来创建一个列表</p>
<ul>
<li>严格来说，Erlang里没有字符串。要在Erlang里表示字符串，可以选择一个由整数组成的列表或者一个二进制型。当字符串表示为一个整数列表时，列表里的每个元素都代表了一个Unicode代码点（codepoint）。
<ul>
<li>可以把“美元符号语法”用于这个目的。举个例子，$a实际上就是代表字符a的整数</li>
</ul>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="o">&gt;</span><span class="nv">Name</span> <span class="o">=</span> <span class="s">&#34;Hello&#34;</span><span class="p">.</span>
<span class="ln"> 2</span><span class="s">&#34;Hello&#34;</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="o">&gt;</span> <span class="nv">I</span> <span class="o">=</span> <span class="sc">$s</span><span class="p">.</span>
<span class="ln"> 6</span><span class="mi">115</span>
<span class="ln"> 7</span><span class="o">&gt;</span> <span class="p">[</span><span class="nv">I</span><span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="sc">$u</span><span class="p">,</span> <span class="sc">$r</span><span class="p">,</span> <span class="sc">$p</span><span class="p">,</span> <span class="sc">$r</span><span class="p">,</span> <span class="sc">$i</span><span class="p">,</span> <span class="sc">$s</span><span class="p">,</span> <span class="sc">$e</span><span class="p">].</span>
<span class="ln"> 8</span><span class="s">&#34;Surprise&#34;</span>
<span class="ln"> 9</span><span class="c">% 可以把“美元符号语法”用于这个目的。举个例子，$a实际上就是代表字符a的整数
</span><span class="ln">10</span><span class="c"></span>
<span class="ln">11</span><span class="o">&gt;</span> <span class="nv">X</span> <span class="o">=</span> <span class="s">&#34;a</span><span class="se">\x{221e}</span><span class="s">b&#34;</span>
<span class="ln">12</span><span class="o">&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;~ts</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">X</span><span class="p">]).</span>
<span class="ln">13</span><span class="n">a</span><span class="err">。。</span><span class="n">b</span>
<span class="ln">14</span><span class="c">% 用列表来表示字符串时，它里面的各个整数都代表Unicode字符。必须使用特殊的语法才能输入某些字符，在打印列表时也要选择正确的格式惯例。
</span><span class="ln">15</span><span class="c">% 在第1行里，我们创建了一个包含三个整数的列表。第一个整数97是字符a的ASCII和Unicode编码。\x{221e}这种记法的作用是输入一个代表Unicode无穷大字符的十六进制整数。98是字符b的ASCII和Unicode编码。
</span><span class="ln">16</span><span class="c">% 在第2行里，我们用一个格式化I/O语句打印出这个字符串，里面使用了代表无穷大字符的正确字符图案。
</span></code></pre></div><p>2.整数列表的打印：</p>
<ul>
<li>如果列表内的所有整数都代表可打印字符，它就会将其打印成字符串字面量</li>
<li>否则，打印成列表记法</li>
<li>如果shell将某个整数列表打印成字符串，而你其实想让它打印成一列整数，那就必须使用格式化的写语句</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="o">&gt;</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="ln"> 2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="ln"> 3</span><span class="o">&gt;</span><span class="p">[</span><span class="mi">83</span><span class="p">,</span><span class="mi">117</span><span class="p">]</span>
<span class="ln"> 4</span><span class="s">&#34;Su&#34;</span>
<span class="ln"> 5</span><span class="o">&gt;</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mi">117</span><span class="p">]</span>
<span class="ln"> 6</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">83</span><span class="p">,</span><span class="mi">117</span><span class="p">]</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="c">% 列表[1,2,3]在打印时未做转换。这是因为1、2和3不是可打印字符。
</span><span class="ln"> 9</span><span class="c">% 列表里的所有项目都是可打印字符，因此它被打#这个列表以1开头，而1不是可打印字符。因此，这个列表在打印时未做转换。印成字符串字面量。
</span><span class="ln">10</span><span class="c">% 这个列表以1开头，而1不是可打印字符。因此，这个列表在打印时未做转换。
</span><span class="ln">11</span><span class="c"></span>
<span class="ln">12</span>
<span class="ln">13</span><span class="o">&gt;</span><span class="nv">X</span> <span class="o">=</span> <span class="p">[</span><span class="mi">97</span><span class="p">,</span><span class="mi">98</span><span class="p">,</span><span class="mi">99</span><span class="p">].</span>
<span class="ln">14</span><span class="s">&#34;abc&#34;</span>
<span class="ln">15</span><span class="o">&gt;</span><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;</span><span class="si">~w~n</span><span class="s">,[&#34;</span><span class="n">abc</span><span class="s">&#34;]).
</span><span class="ln">16</span><span class="s">[97,98,99]
</span></code></pre></div><h3 id="模式匹配再探">模式匹配再探</h3>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">[</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">C</span><span class="p">,</span><span class="nv">D</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">f</span><span class="p">]</span> 
<span class="ln">2</span><span class="c">% 成功
</span></code></pre></div><p>f()命令让shell忘记现有的任何绑定。在这个命令之后，所有变量都会变成未绑定状态。</p>
<p>help()命令提示一些函数。</p>
<h3 id="练习-1">练习</h3>
<p><strong>(3)</strong></p>
<blockquote>
<p>试着用一个元组来表示一座房子，再用一个房子列表来表示一条街道。请确保你能向这些结构中加入数据或从中取出数据。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="mi">4</span><span class="o">&gt;</span> <span class="nv">House1</span> <span class="o">=</span> <span class="p">{</span><span class="n">house</span><span class="p">,</span> <span class="p">{</span><span class="n">location</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">},</span> <span class="p">{</span><span class="n">owner</span><span class="p">,</span> <span class="n">joe</span><span class="p">}}.</span>
<span class="ln"> 2</span><span class="p">{</span><span class="n">house</span><span class="p">,{</span><span class="n">location</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">},{</span><span class="n">owner</span><span class="p">,</span><span class="n">joe</span><span class="p">}}</span>
<span class="ln"> 3</span><span class="mi">5</span><span class="o">&gt;</span> <span class="nv">House2</span> <span class="o">=</span> <span class="p">{</span><span class="n">house</span><span class="p">,</span> <span class="p">{</span><span class="n">location</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">40</span><span class="p">},</span> <span class="p">{</span><span class="n">owner</span><span class="p">,</span> <span class="n">peter</span><span class="p">}}.</span>
<span class="ln"> 4</span><span class="p">{</span><span class="n">house</span><span class="p">,{</span><span class="n">location</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">40</span><span class="p">},{</span><span class="n">owner</span><span class="p">,</span><span class="n">peter</span><span class="p">}}</span>
<span class="ln"> 5</span><span class="mi">6</span><span class="o">&gt;</span> <span class="nv">Street</span> <span class="o">=</span> <span class="p">[</span><span class="nv">House1</span><span class="p">,</span> <span class="nv">House2</span><span class="p">].</span>
<span class="ln"> 6</span><span class="p">[{</span><span class="n">house</span><span class="p">,{</span><span class="n">location</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">},{</span><span class="n">owner</span><span class="p">,</span><span class="n">joe</span><span class="p">}},</span>
<span class="ln"> 7</span> <span class="p">{</span><span class="n">house</span><span class="p">,{</span><span class="n">location</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">40</span><span class="p">},{</span><span class="n">owner</span><span class="p">,</span><span class="n">peter</span><span class="p">}}]</span>
<span class="ln"> 8</span><span class="mi">7</span><span class="o">&gt;</span> <span class="p">[{_,_,{_,</span><span class="nv">House1Owner</span><span class="p">}},_]</span> <span class="o">=</span> <span class="nv">Street</span><span class="p">.</span>
<span class="ln"> 9</span><span class="p">[{</span><span class="n">house</span><span class="p">,{</span><span class="n">location</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">},{</span><span class="n">owner</span><span class="p">,</span><span class="n">joe</span><span class="p">}},</span>
<span class="ln">10</span> <span class="p">{</span><span class="n">house</span><span class="p">,{</span><span class="n">location</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">40</span><span class="p">},{</span><span class="n">owner</span><span class="p">,</span><span class="n">peter</span><span class="p">}}]</span>
<span class="ln">11</span><span class="mi">8</span><span class="o">&gt;</span> <span class="nv">House1Owner</span><span class="p">.</span>
<span class="ln">12</span><span class="n">joe</span>
</code></pre></div><h2 id="第4章-模块与函数">第4章 模块与函数</h2>
<h3 id="模块介绍">模块介绍</h3>
<p>1.示例程序</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">geometry</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">area</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">area</span><span class="p">({</span><span class="n">rectangle</span><span class="p">,</span> <span class="nv">Width</span><span class="p">,</span> <span class="nv">Height</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="nv">Width</span> <span class="o">*</span> <span class="nv">Height</span><span class="p">;</span>
<span class="ln">5</span><span class="nf">area</span><span class="p">({</span><span class="n">circle</span><span class="p">,</span> <span class="nv">Radius</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="mi">3</span><span class="p">.</span><span class="mi">14159</span> <span class="o">*</span> <span class="nv">Radius</span> <span class="o">*</span> <span class="nv">Radius</span><span class="p">;</span>
<span class="ln">6</span><span class="nf">area</span><span class="p">({</span><span class="n">square</span><span class="p">,</span> <span class="nv">Side</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="nv">Side</span> <span class="o">*</span> <span class="nv">Side</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span><span class="n">c</span><span class="p">(</span><span class="n">geometry</span><span class="p">).</span>
<span class="ln">2</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="n">geometry</span><span class="p">}</span>
<span class="ln">3</span><span class="o">&gt;</span><span class="nn">geometry</span><span class="p">:</span><span class="nf">area</span><span class="p">({</span><span class="n">rectangle</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">}).</span>
<span class="ln">4</span><span class="mi">50</span>
<span class="ln">5</span><span class="o">&gt;</span><span class="nn">geometry</span><span class="p">:</span><span class="nf">area</span><span class="p">({</span><span class="n">square</span><span class="p">,</span> <span class="mi">3</span><span class="p">}).</span>
<span class="ln">6</span><span class="mi">9</span>
</code></pre></div><ul>
<li>第一行是<strong>模块声明</strong>。声明里的模块名必须与存放该模块的主文件名相同。</li>
<li>第二行是<strong>导出声明</strong>。Name/N这种记法是指一个带有N个参数的函数Name，N被称为函数的元数（arity）。export的参数是由Name/N项目组成的一个列表。</li>
<li>未从模块里导出的函数只能在模块内调用。</li>
<li>area函数有三个子句。这些<strong>子句由一个分号隔开</strong>，最后的子句以句号加空白结束。每条子句都有一个头部和一个主体，两者用箭头（-&gt;）分隔。头部包含一个函数名，后接零个或更多个模式，主体则包含一列表达式，它们会在头部里的模式与调用参数<strong>成功匹配时执行</strong>。这些子句会根据它们在函数定义里出现的顺序进行匹配。</li>
<li>命令c(geometry)，它的作用是<strong>编译</strong>geometry.erl文件里的代码。编译器返回了{ok,geometry}，意思是编译成功，而且geometry模块已被编译和加载。编译器会在当前目录创建一个名为geometry.beam的目标代码模块。</li>
<li>在第2行和第3行调用了geometry模块里的函数。请注意，需要<strong>给函数名附上模块名</strong>，这样才能准确标明想调用的是哪个函数。</li>
<li>我们的函数并不处理模式匹配失败的情形，程序会以一个运行时错误结束。这是有意而为的，是在Erlang里编程的方式。</li>
<li>Erlang代码里，我们只需要编写模式，Erlang编译器就会生成最佳的模式匹配代码，用它来选择正确的程序入口点。</li>
<li>逗号（,）分隔函数调用、数据构造和模式中的参数。</li>
<li>分号（ ; ）分隔子句。我们能在很多地方看到子句，例如函数定义，以及 case 、 if 、try..catch和receive表达式</li>
<li>句号（.）（后接空白）分隔函数整体，以及shell里的表达式。</li>
</ul>
<p>2.Erlang shell内建命令</p>
<ul>
<li>pwd()打印当前工作目录。</li>
<li>ls()列出当前工作目录里所有的文件名。</li>
<li>cd(Dir)修改当前工作目录至Dir。</li>
</ul>
<h3 id="结算程序">结算程序</h3>
<p>shop.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">shop</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">cost</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">cost</span><span class="p">(</span><span class="n">oranges</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">5</span><span class="p">;</span>
<span class="ln">5</span><span class="nf">cost</span><span class="p">(</span><span class="n">newspaper</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="ln">6</span><span class="nf">cost</span><span class="p">(</span><span class="n">apples</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="p">;</span>
<span class="ln">7</span><span class="nf">cost</span><span class="p">(</span><span class="n">pears</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">9</span><span class="p">;</span>
<span class="ln">8</span><span class="nf">cost</span><span class="p">(</span><span class="n">milk</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">7</span><span class="p">;</span>
</code></pre></div><p>shop1.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">shop1</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">total</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">total</span><span class="p">([</span><span class="nv">What</span><span class="p">,</span> <span class="nv">N</span><span class="p">]|</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">shop</span><span class="p">:</span><span class="nf">cost</span><span class="p">(</span><span class="nv">What</span><span class="p">)</span> <span class="o">*</span> <span class="nv">N</span> <span class="o">+</span> <span class="n">total</span><span class="p">(</span><span class="nv">T</span><span class="p">);</span>
<span class="ln">5</span><span class="nf">total</span><span class="p">([])</span> <span class="o">-&gt;</span> <span class="mi">0</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span><span class="n">c</span><span class="p">(</span><span class="n">shop</span><span class="p">).</span>
<span class="ln">2</span><span class="o">&gt;</span><span class="n">c</span><span class="p">(</span><span class="n">shop1</span><span class="p">).</span>
<span class="ln">3</span><span class="o">&gt;</span><span class="nn">shop1</span><span class="p">:</span><span class="nf">total</span><span class="p">([</span><span class="n">milk</span><span class="p">,</span><span class="mi">3</span><span class="p">]).</span>
<span class="ln">4</span><span class="mi">21</span>
<span class="ln">5</span><span class="o">&gt;</span><span class="nn">shop1</span><span class="p">:</span><span class="nf">total</span><span class="p">([{</span><span class="n">pears</span><span class="p">,</span><span class="mi">6</span><span class="p">},{</span><span class="n">milk</span><span class="p">,</span><span class="mi">3</span><span class="p">}]).</span>
<span class="ln">6</span><span class="mi">75</span>
</code></pre></div><p>有点像递归调用地处理列表中的每个元组，其他的没有什么知识。这样可以创造for循环</p>
<h3 id="基本的抽象单元fun">基本的抽象单元fun</h3>
<ul>
<li>函数式编程语言表示函数可以被用作其他函数的<strong>参数</strong>，也可以<strong>返回函数</strong>。操作其他函数的函数被称为高阶函数（higher-order function），而在Erlang中用于代表<strong>函数的数据类型</strong>被称为<strong>fun</strong>。</li>
<li>funs是“匿名的”函数。其他编程语言称它们为lambda抽象。</li>
<li>fun可以有多个不同的子句。</li>
<li>括号里的东西就是返回值。也可以说-&gt;后面的东西。</li>
</ul>
<p>1.基本概念</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="o">&gt;</span> <span class="nv">Double</span> <span class="o">=</span> <span class="k">fun</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="nv">X</span> <span class="k">end</span><span class="p">.</span>
<span class="ln"> 2</span><span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">erl_eval</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">56006584</span><span class="o">&gt;</span>
<span class="ln"> 3</span><span class="o">&gt;</span> <span class="nv">Double</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span>
<span class="ln"> 4</span><span class="mi">4</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="o">&gt;</span> <span class="nv">Hypot</span> <span class="o">=</span> <span class="k">fun</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">math</span><span class="p">:</span><span class="nf">sqrt</span><span class="p">(</span><span class="nv">X</span><span class="o">*</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="o">*</span><span class="nv">Y</span><span class="p">)</span> <span class="k">end</span><span class="p">.</span>
<span class="ln"> 7</span><span class="o">&gt;</span> <span class="nv">Hypot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">).</span>
<span class="ln"> 8</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span>	
<span class="ln"> 9</span><span class="o">&gt;</span> <span class="nv">Hypot</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span>
<span class="ln">10</span><span class="o">**</span> <span class="n">exception</span> <span class="err">元数不正确</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="o">&gt;</span> <span class="nv">TempConvert</span> <span class="o">=</span> <span class="k">fun</span><span class="p">({</span><span class="n">c</span><span class="p">,</span><span class="nv">C</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">f</span><span class="p">,</span> <span class="mi">32</span> <span class="o">+</span> <span class="nv">C</span><span class="o">*</span><span class="mi">9</span><span class="o">/</span><span class="mi">5</span><span class="p">};</span>
<span class="ln">13</span>				   <span class="p">({</span><span class="n">f</span><span class="p">,</span><span class="nv">F</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="nv">F</span><span class="o">-</span><span class="mi">32</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="o">/</span><span class="mi">9</span><span class="p">}</span>
<span class="ln">14</span>				<span class="k">end</span><span class="p">.</span>
<span class="ln">15</span><span class="o">&gt;</span><span class="nv">TempConvert</span><span class="p">({</span><span class="n">c</span><span class="p">,</span><span class="mi">100</span><span class="p">}).</span>
<span class="ln">16</span><span class="p">{</span><span class="n">f</span><span class="p">,</span><span class="mi">212</span><span class="p">.</span><span class="mi">0</span><span class="p">}</span>
</code></pre></div><p>2.以fun作为参数的函数示例</p>
<ul>
<li><code>lists:map(F,L)</code>。这个函数返回的是一个列表，它通过给列表L里的各个元素应用fun F生成。</li>
<li><code>lists:filter(P, L)</code>，它返回一个新的列表，内含L中所有符合条件的元素（条件是对元素E而言P(E)为true）。</li>
<li><code>=:=</code>用来测试是否相等。</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span> <span class="nv">L</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">].</span>
<span class="ln">2</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">map</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="nv">X</span> <span class="k">end</span><span class="p">,</span> <span class="nv">L</span><span class="p">).</span>
<span class="ln">3</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>
<span class="ln">4</span>
<span class="ln">5</span><span class="o">&gt;</span> <span class="nv">Even</span> <span class="o">=</span> <span class="k">fun</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nv">X</span> <span class="ow">rem</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">0</span> <span class="k">end</span><span class="p">.</span>
<span class="ln">6</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">filter</span><span class="p">(</span><span class="nv">Even</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">]).</span>
<span class="ln">7</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>
</code></pre></div><p>3.返回fun的函数示例</p>
<p>对于给定列表，生成函数，用于判断单个变量是否在这个列表里面：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span> <span class="nv">Fruit</span> <span class="o">=</span> <span class="p">[</span><span class="n">apple</span><span class="p">,</span><span class="n">pear</span><span class="p">,</span><span class="n">orange</span><span class="p">].</span>
<span class="ln">2</span><span class="o">&gt;</span> <span class="nv">MakeTest</span> <span class="o">=</span> <span class="k">fun</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">member</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span><span class="nv">L</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span> <span class="k">end</span><span class="p">.</span>
<span class="ln">3</span><span class="o">&gt;</span> <span class="nv">IsFruit</span> <span class="o">=</span> <span class="nv">MakeTest</span><span class="p">(</span><span class="nv">Fruit</span><span class="p">).</span>
<span class="ln">4</span><span class="o">&gt;</span> <span class="nv">IsFruit</span><span class="p">(</span><span class="n">pear</span><span class="p">).</span>
<span class="ln">5</span><span class="n">true</span>
<span class="ln">6</span><span class="o">&gt;</span> <span class="nv">IsFruit</span><span class="p">(</span><span class="n">dog</span><span class="p">).</span>
<span class="ln">7</span><span class="n">false</span>
</code></pre></div><p>指定倍数生成一个函数，这个函数的返回值是参数的指定倍数：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span> <span class="nv">Mult</span> <span class="o">=</span> <span class="k">fun</span><span class="p">(</span><span class="nv">Times</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="k">fun</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">X</span> <span class="o">*</span> <span class="nv">Times</span> <span class="k">end</span><span class="p">)</span> <span class="k">end</span><span class="p">.</span>
<span class="ln">2</span><span class="o">&gt;</span> <span class="nv">Triple</span> <span class="o">=</span> <span class="nv">Mult</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span>
<span class="ln">3</span><span class="o">&gt;</span> <span class="nv">Triple</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span>
<span class="ln">4</span><span class="mi">15</span>
</code></pre></div><p>4.自定义for循环</p>
<ul>
<li>创建自己的控制结构能大大降低程序的大小，有时还能让它们更加清晰。这是因为你能精确地创建出解决问题所需要的控制结构，同时还不受编程语言自带的少量固定控制结构所限。</li>
</ul>
<p>lib_misc.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="c">% 执行for(1,10,F)会创建列表[F(1), F(2), ..., F(10)]
</span><span class="ln">2</span><span class="c"></span><span class="nf">for</span><span class="p">(</span><span class="nv">Max</span><span class="p">,</span> <span class="nv">Max</span><span class="p">,</span> <span class="nv">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">F</span><span class="p">(</span><span class="nv">Max</span><span class="p">)];</span>
<span class="ln">3</span><span class="nf">for</span><span class="p">(</span><span class="nv">I</span><span class="p">,</span> <span class="nv">Max</span><span class="p">,</span> <span class="nv">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">F</span><span class="p">(</span><span class="nv">I</span><span class="p">)|</span><span class="n">for</span><span class="p">(</span><span class="nv">I</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">Max</span><span class="p">,</span> <span class="nv">F</span><span class="p">)].</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nn">lib_misc</span><span class="p">:</span><span class="nf">for</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="k">fun</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">I</span> <span class="k">end</span><span class="p">).</span>
<span class="ln">2</span><span class="nn">lib_misc</span><span class="p">:</span><span class="nf">for</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="k">fun</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">I</span><span class="o">*</span><span class="nv">I</span> <span class="k">end</span><span class="p">).</span>
</code></pre></div><h3 id="优化结算程序">优化结算程序</h3>
<p>mylists.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">mylists</span><span class="p">)</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">map</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">sum</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">sum</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nv">H</span> <span class="o">+</span> <span class="n">sum</span><span class="p">(</span><span class="nv">T</span><span class="p">);</span>
<span class="ln">5</span><span class="nf">sum</span><span class="p">([])</span> <span class="o">-&gt;</span> <span class="mi">0</span><span class="p">.</span>
<span class="ln">6</span>
<span class="ln">7</span><span class="nf">map</span><span class="p">(_,[])</span> <span class="o">-&gt;</span><span class="p">[];</span>
<span class="ln">8</span><span class="nf">map</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">F</span><span class="p">(</span><span class="nv">H</span><span class="p">)|</span><span class="n">map</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span><span class="nv">T</span><span class="p">)].</span>
</code></pre></div><p>shop2.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">shop2</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">total</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">3</span><span class="p">-</span><span class="ni">import</span><span class="p">(</span><span class="n">mylists</span><span class="p">,</span> <span class="p">[</span><span class="n">map</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">sum</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">4</span>
<span class="ln">5</span><span class="nf">total</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">6</span>	<span class="n">sum</span><span class="p">(</span><span class="n">map</span><span class="p">(</span><span class="k">fun</span><span class="p">({</span><span class="nv">What</span><span class="p">,</span><span class="nv">N</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="nn">shop</span><span class="p">:</span><span class="nf">cost</span><span class="p">(</span><span class="nv">What</span><span class="p">)</span> <span class="o">*</span> <span class="nv">N</span> <span class="k">end</span><span class="p">,</span> <span class="nv">L</span><span class="p">)).</span>
</code></pre></div><h3 id="列表推导">列表推导</h3>
<p>1.基础概念</p>
<ul>
<li>
<p>列表推导（list comprehension）是无需使用fun、map或filter就能创建列表的表达式。它让程序变得更短，更容易理解。</p>
</li>
<li>
<p>列表推导最常规的形式是下面这种表达式：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">[</span><span class="nv">X</span> <span class="p">||</span> <span class="nv">Qualifier1</span><span class="p">,</span> <span class="nv">Qualifier2</span><span class="p">,</span> <span class="p">...]</span>
</code></pre></div><p>X是任意一条表达式，后面的限定符（Qualifier）可以是生成器、位串生成器或过滤器。</p>
<ul>
<li>生成器（generator）的写法是<code>Pattern &lt;- ListExpr</code>，其中的ListExp必须是一个能够得出列表的表达式。</li>
<li>位 串 （ bitstring ）生成器的写法是 <code>BitStringPattern &lt;= BitStringExpr</code> ， 其 中 的<code>BitStringExpr</code>必须是一个能够得出位串的表达式。</li>
<li>过滤器（filter）既可以是判断函数（即返回true或false的函数），也可以是布尔表达式。</li>
</ul>
</li>
<li>
<p>这个限定符的运算顺序是从左往右的。</p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="o">&gt;</span> <span class="nv">L</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">].</span>
<span class="ln"> 2</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">map</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="nv">X</span> <span class="k">end</span><span class="p">,</span> <span class="nv">L</span><span class="p">).</span>
<span class="ln"> 3</span><span class="o">&gt;</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="nv">X</span> <span class="p">||</span> <span class="nv">X</span> <span class="o">&lt;-</span> <span class="nv">L</span><span class="p">].</span>
<span class="ln"> 4</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="c">% 列表推导的购物结算程序
</span><span class="ln"> 7</span><span class="c"></span><span class="o">&gt;</span> <span class="nv">Buy</span><span class="o">=</span><span class="p">[{</span><span class="n">oranges</span><span class="p">,</span><span class="mi">4</span><span class="p">}.{</span><span class="n">newspaper</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">apples</span><span class="p">,</span><span class="mi">10</span><span class="p">},{</span><span class="n">pears</span><span class="p">,</span><span class="mi">6</span><span class="p">},{</span><span class="n">milk</span><span class="p">,</span><span class="mi">3</span><span class="p">}].</span>
<span class="ln"> 8</span><span class="o">&gt;</span> <span class="p">[{</span><span class="nv">Name</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="nv">Number</span><span class="p">}</span> <span class="p">||</span> <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Number</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Buy</span><span class="p">].</span>
<span class="ln"> 9</span><span class="p">[{</span><span class="n">oranges</span><span class="p">,</span><span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="n">newspaper</span><span class="p">,</span><span class="mi">2</span><span class="p">},{</span><span class="n">apples</span><span class="p">,</span><span class="mi">20</span><span class="p">},{</span><span class="n">pears</span><span class="p">,</span><span class="mi">12</span><span class="p">},{</span><span class="n">milk</span><span class="p">,</span><span class="mi">6</span><span class="p">}]</span>
<span class="ln">10</span><span class="c">% ||符号右侧的元组{Name, Number}是一个模式
</span><span class="ln">11</span><span class="c">% 左侧的元组{Name, 2*Number}则是一个构造器（constructor）。
</span><span class="ln">12</span><span class="c"></span><span class="o">&gt;</span> <span class="p">[{</span><span class="nn">shop</span><span class="p">:</span><span class="nf">cost</span><span class="p">(</span><span class="nv">A</span><span class="p">)</span><span class="o">*</span> <span class="nv">B</span><span class="p">}</span> <span class="p">||</span> <span class="p">{</span><span class="nv">A</span><span class="p">,</span> <span class="nv">B</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Buy</span><span class="p">].</span>
<span class="ln">13</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span>
<span class="ln">14</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sum</span><span class="p">([</span><span class="nn">shop</span><span class="p">:</span><span class="nf">cost</span><span class="p">(</span><span class="nv">A</span><span class="p">)</span> <span class="o">*</span> <span class="nv">B</span> <span class="p">||</span> <span class="p">{</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Buy</span><span class="p">]).</span>
<span class="ln">15</span><span class="mi">123</span>
</code></pre></div><p>2.几个例子：</p>
<p>归并排序：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">qsort</span><span class="p">([])</span> <span class="o">-&gt;</span> <span class="p">[];</span>
<span class="ln">2</span><span class="nf">qsort</span><span class="p">([</span><span class="nv">Pivot</span><span class="p">|</span><span class="nv">T</span><span class="p">])</span> <span class="o">-&gt;</span>
<span class="ln">3</span>		<span class="n">qsort</span><span class="p">([</span><span class="nv">X</span> <span class="p">||</span> <span class="nv">X</span> <span class="o">&lt;-</span> <span class="nv">T</span><span class="p">,</span> <span class="nv">X</span> <span class="o">&lt;</span> <span class="nv">Pivot</span><span class="p">])</span>
<span class="ln">4</span>		<span class="o">++</span> <span class="p">[</span><span class="nv">Pivot</span><span class="p">]</span> <span class="o">++</span>
<span class="ln">5</span>		<span class="n">qsort</span><span class="p">([</span><span class="nv">X</span> <span class="p">||</span> <span class="nv">X</span> <span class="o">&lt;-</span> <span class="nv">T</span><span class="p">,</span> <span class="nv">X</span> <span class="o">&gt;=</span> <span class="nv">Pivot</span><span class="p">]).</span>
</code></pre></div><ul>
<li><code>++</code>是中缀插入操作符。</li>
<li>将T分成两个列表，一个包含T里所有小于Pivot（中位数）的元素，另一个包含所有大于或等于Pivot的元素。所以这里第二个限定符就是过滤器。</li>
</ul>
<p>查找勾股数（暴力遍历）：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">pythag</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="p">[</span> <span class="p">{</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">C</span><span class="p">}</span> <span class="p">||</span>
<span class="ln">3</span>		<span class="nv">A</span> <span class="o">&lt;-</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">N</span><span class="p">),</span>
<span class="ln">4</span>		<span class="nv">B</span> <span class="o">&lt;-</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">N</span><span class="p">),</span>
<span class="ln">5</span>		<span class="nv">C</span> <span class="o">&lt;-</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">N</span><span class="p">),</span>
<span class="ln">6</span>		<span class="nv">A</span><span class="o">+</span><span class="nv">B</span><span class="o">+</span><span class="nv">C</span> <span class="o">=&lt;</span> <span class="nv">N</span><span class="p">,</span>
<span class="ln">7</span>		<span class="nv">A</span><span class="o">*</span><span class="nv">A</span><span class="o">+</span><span class="nv">B</span><span class="o">*</span><span class="nv">B</span> <span class="o">=:=</span> <span class="nv">C</span><span class="o">*</span><span class="nv">C</span>
<span class="ln">8</span>	<span class="p">].</span>
</code></pre></div><ul>
<li><code>lists:seq(1, N)</code>返回一个包含从1到N所有整数的列表。</li>
</ul>
<p>单词字母的所有组合：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">perms</span><span class="p">([])</span> <span class="o">-&gt;</span> <span class="p">[[]];</span>
<span class="ln">2</span><span class="nf">perms</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[[</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">]</span> <span class="p">||</span> <span class="nv">H</span> <span class="o">&lt;-</span> <span class="nv">L</span><span class="p">,</span> <span class="nv">T</span> <span class="o">&lt;-</span> <span class="n">perms</span><span class="p">(</span><span class="nv">L</span><span class="o">--</span><span class="p">[</span><span class="nv">H</span><span class="p">])].</span>
</code></pre></div><ul>
<li><code>X -- Y</code>是列表移除操作符，它从X里移除Y中的元素。</li>
<li>穷尽一切可能从L里提取H（单个字母），然后穷尽一切可能从perms(L &ndash; [H])（即列表L移除H后的所有排列形式）里提取T，最后返回[H|T]。</li>
</ul>
<h3 id="内置函数">内置函数</h3>
<ul>
<li>
<p>内置函数简称为BIF（built-in function），是那些作为Erlang语言定义一部分的函数。有些内置函数是用Erlang实现的，但大多数是用Erlang虚拟机里的底层操作实现的。</p>
</li>
<li>
<p>所有内置函数都表现得像是属于 erlang模块，但那些最常用的内置函数（例如 <code>list_to_tuple</code>）是自动导入的</p>
</li>
<li>
<p>内置函数文档：http://www.erlang.org/doc/man/erlang.html</p>
<p>(在erts/erlang模块里面)</p>
</li>
<li>
<p>内置函数<code>list_to_tuple/1</code>能将一个列表转换成元组</p>
</li>
<li>
<p><code>time/0</code>以{时，分，秒}的格式返回当前的时间。</p>
</li>
</ul>
<h3 id="关卡">关卡</h3>
<ul>
<li>关卡（guard）是一种结构，可以用它来增加模式匹配的威力。通过使用关卡，可以对某个模式里的变量执行简单的测试和比较。</li>
<li>关卡序列（guard sequence）是指单一或一系列的关卡，用分号（;）分隔。对于关卡序列G1;G2; &hellip;; Gn，只要其中有一个关卡（G1、G2……）的值为true，它的值就为true。</li>
<li>关卡由一系列关卡表达式组成，用逗号（,）分隔。关卡GuardExpr1, GuardExpr2, &hellip; ,GuardExprN只有在所有的关卡表达式（GuardExpr1、GuardExpr2……）都为true时才为true。</li>
<li>合法的关卡表达式是所有合法Erlang表达式的一个子集。</li>
<li>关卡不能调用用户定义的函数，因为要确保它们没有副作用并能正常结束。</li>
<li>合法的关卡表达式：
<ul>
<li>原子true；</li>
<li>其他常量（各种数据结构和已绑定变量）它们在关卡表达式里都会成为false；</li>
<li>调用后面表1里的关卡判断函数和表2里的内置函数；</li>
<li>数据结构比较（参见表6）；</li>
<li>算术表达式（参见表3）；</li>
<li>布尔表达式（参见8.7节）；</li>
<li>短路布尔表达式（参见8.23节）。</li>
</ul>
</li>
<li>短路布尔表达式：orelse和andalso</li>
<li><code>orelse</code>和<code>andalso</code>操作符存在的原因是布尔操作符and/or原本的定义是两侧参数都需要求值。在关卡里，（and与andalso）之间和（or与orelse）之间可能会存在差别。</li>
<li>原子true可以被当作“来者不拒”的关卡</li>
</ul>
<p>表1 关卡判断函数:</p>
<table>
<thead>
<tr>
<th style="text-align:left">判断函数</th>
<th style="text-align:left">意思</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">is_atom(X)</td>
<td style="text-align:left">X是一个原子</td>
</tr>
<tr>
<td style="text-align:left">is_binary(X)</td>
<td style="text-align:left">X是一个二进制型</td>
</tr>
<tr>
<td style="text-align:left">is_constant(X)</td>
<td style="text-align:left">X是一个常量</td>
</tr>
<tr>
<td style="text-align:left">is_float(X)</td>
<td style="text-align:left">X是一个浮点数</td>
</tr>
<tr>
<td style="text-align:left">is_function(X)</td>
<td style="text-align:left">X是一个fun</td>
</tr>
<tr>
<td style="text-align:left">is_function(X, N)</td>
<td style="text-align:left">X是一个带有N个参数的fun</td>
</tr>
<tr>
<td style="text-align:left">is_integer(X)</td>
<td style="text-align:left">X是一个整数</td>
</tr>
<tr>
<td style="text-align:left">is_list(X)</td>
<td style="text-align:left">X是一个列表</td>
</tr>
<tr>
<td style="text-align:left">is_map(X)</td>
<td style="text-align:left">X是一个映射组</td>
</tr>
<tr>
<td style="text-align:left">is_number(X)</td>
<td style="text-align:left">X是一个整数或浮点数</td>
</tr>
<tr>
<td style="text-align:left">is_pid(X)</td>
<td style="text-align:left">X是一个进程标识符</td>
</tr>
<tr>
<td style="text-align:left">is_pmod(X)</td>
<td style="text-align:left">X是一个参数化模块的实例</td>
</tr>
<tr>
<td style="text-align:left">is_port(X)</td>
<td style="text-align:left">X是一个端</td>
</tr>
<tr>
<td style="text-align:left">is_reference(X)</td>
<td style="text-align:left">X是一个引用</td>
</tr>
<tr>
<td style="text-align:left">is_tuple(X)</td>
<td style="text-align:left">X是一个元组</td>
</tr>
<tr>
<td style="text-align:left">is_record(X,Tag)</td>
<td style="text-align:left">X是一个类型为Tag的记录</td>
</tr>
<tr>
<td style="text-align:left">is_record(X,Tag,N)</td>
<td style="text-align:left">X是一个类型为Tag、大小为N的记录</td>
</tr>
</tbody>
</table>
<p>表2 关卡内置函数：</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>意思</th>
</tr>
</thead>
<tbody>
<tr>
<td>abs(X)</td>
<td>X的绝对值</td>
</tr>
<tr>
<td>byte_size(X)</td>
<td>X的字节数，X必须是一个位串或二进制型</td>
</tr>
<tr>
<td>element(N, X)</td>
<td>X里的元素N，注意X必须是一个元组</td>
</tr>
<tr>
<td>float(X)</td>
<td>将X转换成一个浮点数，X必须是一个数字</td>
</tr>
<tr>
<td>hd(X)</td>
<td>列表X的列表头</td>
</tr>
<tr>
<td>length(X)</td>
<td>列表X的长度</td>
</tr>
<tr>
<td>node()</td>
<td>当前的节点</td>
</tr>
<tr>
<td>node(X)</td>
<td>创建X的节点，X可以是一个进程、标识符、引用或端口</td>
</tr>
<tr>
<td>round(X)</td>
<td>将X转换成一个整数，X必须是一个数字</td>
</tr>
<tr>
<td>self()</td>
<td>当前进程的进程标识符</td>
</tr>
<tr>
<td>size(X)</td>
<td>X的大小，它可以是一个元组或二进制型</td>
</tr>
<tr>
<td>trunc(X)</td>
<td>将X去掉小数部分取整，X必须是一个数字</td>
</tr>
<tr>
<td>tl(X)</td>
<td>列表X的列表尾</td>
</tr>
<tr>
<td>tuple_size(T)</td>
<td>元组T的大小</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">max</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">)</span> <span class="k">when</span> <span class="nv">X</span> <span class="o">&gt;</span> <span class="nv">Y</span> <span class="o">-&gt;</span> <span class="nv">X</span><span class="p">;</span>
<span class="ln"> 2</span><span class="nf">max</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Y</span><span class="p">.</span>
<span class="ln"> 3</span><span class="c">% 子句1会在X大于Y时匹配，结果是X。如果子句1不匹配，系统就会尝试子句2。
</span><span class="ln"> 4</span><span class="c">% 子句2总是返回第二个参数Y。Y必然是大于或等于X的，否则子句1就已经匹配了。
</span><span class="ln"> 5</span><span class="c"></span>
<span class="ln"> 6</span><span class="nf">f</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">T</span><span class="p">),</span> <span class="nv">X</span><span class="o">&gt;</span><span class="nv">Y</span><span class="p">,</span> <span class="nv">Y</span><span class="o">&lt;</span><span class="mi">6</span> <span class="o">-&gt;</span> <span class="p">...</span>
<span class="ln"> 7</span><span class="c">% 当X是一个整数，X大于Y并且Y小于6时
</span><span class="ln"> 8</span><span class="c"></span><span class="nb">is_tuple</span><span class="p">(</span><span class="nv">T</span><span class="p">),</span> <span class="nb">tuple_size</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">element</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nv">T</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">5</span>
<span class="ln"> 9</span><span class="c">% T是一个包含六个元素的元组，并且T中第三个元素的绝对值大于5
</span><span class="ln">10</span><span class="c"></span><span class="nb">element</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="nv">X</span><span class="p">)</span> <span class="o">=:=</span> <span class="nb">hd</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span>
<span class="ln">11</span><span class="c">% 元组X的第4个元素与列表L的列表头相同
</span><span class="ln">12</span><span class="c"></span><span class="nv">A</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="ow">andalso</span> <span class="nv">A</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;</span><span class="nv">B</span>
<span class="ln">13</span><span class="nb">is_atom</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="ow">orelse</span> <span class="p">(</span><span class="nb">is_list</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="n">andalse</span> <span class="nb">length</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="ln">14</span>                                      
<span class="ln">15</span><span class="nf">f</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="k">when</span> <span class="p">(</span><span class="nv">X</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nv">X</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">...</span>
<span class="ln">16</span><span class="nf">g</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="k">when</span> <span class="p">(</span><span class="nv">X</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">orelse</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nv">X</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">...</span>
<span class="ln">17</span><span class="c">% 当X为0时，f(X)里的关卡会失败，但g(X)里的关卡会成功。
</span></code></pre></div><h3 id="case和if表达式">case和if表达式</h3>
<ul>
<li>
<p><code>case</code>表达式的语法如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="k">case</span> <span class="nv">Expression</span> <span class="k">of</span>
<span class="ln">2</span>	<span class="nv">Pattern1</span> <span class="p">[</span><span class="k">when</span> <span class="nv">Guard1</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="nv">Expr_seq1</span><span class="p">;</span>
<span class="ln">3</span>	<span class="nv">Pattern2</span> <span class="p">[</span><span class="k">when</span> <span class="nv">Guard2</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="nv">Expr_seq2</span><span class="p">;</span>
<span class="ln">4</span>	<span class="p">...</span>
<span class="ln">5</span><span class="k">end</span>
</code></pre></div><p>首先，Expression被执行，假设它的值为Value。随后，Value轮流与Pattern1（带有可选的关卡Guard1）、Pattern2等模式进行匹配，直到匹配成功。一旦发现匹配，相应的表达式序列就会执行，而表达式序列执行的结果就是case表达式的值。如果所有模式都不匹配，就会发生异常错误（exception）。</p>
</li>
<li>
<p>条件句式<code>if</code>，语法如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="k">if</span> <span class="nv">Guard1</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="nv">Expr_seq1</span><span class="p">;</span>
<span class="ln">3</span>   <span class="nv">Guard2</span> <span class="o">-&gt;</span>
<span class="ln">4</span>      <span class="nv">Expr_seq2</span><span class="p">;</span>
<span class="ln">5</span>   <span class="p">...</span>
<span class="ln">6</span><span class="k">end</span>
</code></pre></div><p>首先执行Guard1。如果得到的值为true，那么if的值就是执行表达式序列Expr_seq1所得到的值。如果Guard1不成功，就会执行Guard2，以此类推，直到某个关卡成功为止。if表达式必须至少有一个关卡的执行结果为true，否则就会发生异常错误。</p>
</li>
<li>
<p><code>if</code>是一种表达式，而所有的表达式都应该有值。为了避免可能的异常错误，Erlang程序员经常会在if表达式的最后添加一个true关卡。当然，如果他们想让异常错误生成，就会省略额外的true关卡。</p>
</li>
<li>
<p>if的最后一个分支不需要加符号.</p>
</li>
</ul>
<p>使用case定义filter:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">filter</span><span class="p">(</span><span class="nv">P</span><span class="p">,</span> <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">])</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="k">case</span> <span class="nv">P</span><span class="p">(</span><span class="nv">H</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">3</span>		<span class="n">true</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="n">filter</span><span class="p">(</span><span class="nv">P</span><span class="p">,</span><span class="nv">T</span><span class="p">)];</span>
<span class="ln">4</span>		<span class="n">false</span> <span class="o">-&gt;</span> <span class="n">filter</span><span class="p">(</span><span class="nv">P</span><span class="p">,</span><span class="nv">T</span><span class="p">)</span>
<span class="ln">5</span>	<span class="k">end</span><span class="p">;</span>
<span class="ln">6</span>	
<span class="ln">7</span><span class="nf">filter</span><span class="p">(</span><span class="nv">P</span><span class="p">,</span> <span class="p">[])</span> <span class="o">-&gt;</span>
<span class="ln">8</span>	<span class="p">[].</span>
</code></pre></div><p>只使用模式匹配定义filter:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">filter</span><span class="p">(</span><span class="nv">P</span><span class="p">,</span> <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">filter1</span><span class="p">(</span><span class="nv">P</span><span class="p">(</span><span class="nv">H</span><span class="p">),</span> <span class="nv">H</span><span class="p">,</span> <span class="nv">P</span><span class="p">,</span> <span class="nv">T</span><span class="p">);</span>
<span class="ln">2</span><span class="nf">filter</span><span class="p">(</span><span class="nv">P</span><span class="p">,</span> <span class="p">[])</span> <span class="o">-&gt;</span> <span class="p">[].</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">filter1</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="nv">H</span><span class="p">,</span> <span class="nv">P</span><span class="p">,</span> <span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="n">filter</span><span class="p">(</span><span class="nv">P</span><span class="p">,</span><span class="nv">T</span><span class="p">)];</span>
<span class="ln">5</span><span class="nf">filter1</span><span class="p">(</span><span class="n">false</span><span class="p">,</span><span class="nv">H</span><span class="p">,</span> <span class="nv">P</span><span class="p">,</span> <span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">filter</span><span class="p">(</span><span class="nv">P</span><span class="p">,</span> <span class="nv">T</span><span class="p">);</span>
</code></pre></div><p>if例子:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="k">if</span>
<span class="ln">2</span>	<span class="nv">A</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">-&gt;</span>
<span class="ln">3</span>		<span class="n">do_this</span><span class="p">();</span>
<span class="ln">4</span>	<span class="n">true</span> <span class="o">-&gt;</span>
<span class="ln">5</span>		<span class="n">do_that</span><span class="p">();</span>
<span class="ln">6</span><span class="k">end</span>
</code></pre></div><h3 id="构建列表的方式">构建列表的方式</h3>
<ul>
<li>
<p>构建列表最有效率的方式是向某个现成列表的头部添加元素，因此经常能看到包含以下模式的代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">some_function</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],...,</span><span class="nv">Result</span><span class="p">,...)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="nv">H1</span> <span class="o">=</span> <span class="p">...</span> <span class="nv">H</span> <span class="p">...,</span>
<span class="ln">3</span>	<span class="n">some_function</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="p">...,</span> <span class="p">[</span><span class="nv">H1</span><span class="p">|</span><span class="nv">Result</span><span class="p">],</span> <span class="p">...);</span>
<span class="ln">4</span><span class="nf">some_function</span><span class="p">([],</span> <span class="p">...,</span> <span class="nv">Result</span><span class="p">,</span> <span class="p">...)</span> <span class="o">-&gt;</span>
<span class="ln">5</span>	<span class="p">{...,</span> <span class="nv">Result</span><span class="p">,</span> <span class="p">...}.</span>
</code></pre></div><p>这段代码会遍历一个列表，提取出列表头H并根据函数的算法计算出某个值（可以称之为H1），然后把H1添加到输出列表Result里。当输入列表被穷尽后，最后的子句匹配成功，函数返回输出变量Result。</p>
</li>
<li>
<p>建议：</p>
<ul>
<li>总是向列表头添加元素。</li>
<li>从输入列表的头部提取元素，然后把它们添加到输出列表的头部，形成的结果是与输入列表顺序相反的输出列表。</li>
<li>如果顺序很重要，就调用<code>lists:reverse/1</code>这个高度优化过的函数。</li>
</ul>
</li>
</ul>
<h3 id="归集器">归集器</h3>
<p>两种将列表中的元素分为奇数和偶数的代码：</p>
<p>1.列表推导</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">odds_and_evens1</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="nv">Odds</span> <span class="o">=</span> <span class="p">[</span><span class="nv">X</span> <span class="p">||</span> <span class="nv">X</span> <span class="o">&lt;-</span> <span class="nv">L</span><span class="p">,</span> <span class="p">(</span><span class="nv">X</span> <span class="ow">rem</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">1</span><span class="p">],</span>
<span class="ln">3</span>    <span class="nv">Evens</span> <span class="o">=</span> <span class="p">[</span><span class="nv">X</span> <span class="p">||</span> <span class="nv">X</span> <span class="o">&lt;-</span> <span class="nv">L</span><span class="p">,</span> <span class="p">(</span><span class="nv">X</span> <span class="ow">rem</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">0</span><span class="p">],</span>
<span class="ln">4</span>    <span class="p">{</span><span class="nv">Odds</span><span class="p">,</span> <span class="nv">Evens</span><span class="p">}.</span>
</code></pre></div><p>2.归集器</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">odds_and_evens2</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="n">odds_and_evens_acc</span><span class="p">(</span><span class="nv">L</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">odds_and_evens_acc</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">Odds</span><span class="p">,</span> <span class="nv">Evens</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="k">case</span> <span class="p">(</span><span class="nv">H</span> <span class="ow">rem</span> <span class="mi">2</span><span class="p">)</span> <span class="k">of</span>
<span class="ln"> 6</span>        <span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">odds_and_evens_acc</span><span class="p">(</span><span class="nv">T</span><span class="p">,[</span><span class="nv">H</span><span class="p">|</span><span class="nv">Odds</span><span class="p">],</span><span class="nv">Even</span><span class="p">);</span>
<span class="ln"> 7</span>        <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">odds_and_evens_acc</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span><span class="nv">Odds</span><span class="p">,[</span><span class="nv">H</span><span class="p">|</span><span class="nv">Even</span><span class="p">])</span>
<span class="ln"> 8</span>    <span class="k">end</span><span class="p">;</span>
<span class="ln"> 9</span><span class="nf">odds_and_evens_acc</span><span class="p">([],</span><span class="nv">Odds</span><span class="p">,</span><span class="nv">Evens</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">10</span>    <span class="p">{</span><span class="nv">Odds</span><span class="p">,</span> <span class="nv">Evens</span><span class="p">}.</span>
</code></pre></div><ul>
<li>第一段代码遍历了两次</li>
<li>第二段程序只遍历列表一次，把奇偶参数分别添加到合适的列表里。这些列表被称为归集器（accumulator）。</li>
<li>这段代码还有一个不太明显的额外的优点：带归集器的版本比[H || filter(H)]类型结构的版本更节省空间。</li>
<li>第二段奇偶列表里的元素顺序是反转的。这是列表的构建方式所导致的结果。</li>
</ul>
<h3 id="练习-2">练习</h3>
<p><strong>(1)</strong></p>
<blockquote>
<p>扩展geometry.erl。添加一些子句来计算圆和直角三角形的面积。添加一些子句来计算各种几何图形的周长。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">geometry</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">area</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">perimeter</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="c">% 面积
</span><span class="ln"> 5</span><span class="c"></span><span class="nf">area</span><span class="p">({</span><span class="n">rectangle</span><span class="p">,</span> <span class="nv">Width</span><span class="p">,</span> <span class="nv">Height</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="nv">Width</span> <span class="o">*</span> <span class="nv">Height</span><span class="p">;</span>
<span class="ln"> 6</span><span class="nf">area</span><span class="p">({</span><span class="n">circle</span><span class="p">,</span> <span class="nv">Radius</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="mi">3</span><span class="p">.</span><span class="mi">14159</span> <span class="o">*</span> <span class="nv">Radius</span> <span class="o">*</span> <span class="nv">Radius</span><span class="p">;</span>
<span class="ln"> 7</span><span class="nf">area</span><span class="p">({</span><span class="n">square</span><span class="p">,</span> <span class="nv">Side</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="nv">Side</span> <span class="o">*</span> <span class="nv">Side</span><span class="p">;</span>
<span class="ln"> 8</span><span class="nf">area</span><span class="p">({</span><span class="n">right_triangle</span><span class="p">,</span> <span class="nv">Width</span><span class="p">,</span> <span class="nv">Height</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="o">*</span> <span class="nv">Width</span> <span class="o">*</span> <span class="nv">Height</span><span class="p">.</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="c">% 周长
</span><span class="ln">11</span><span class="c"></span><span class="nf">perimeter</span><span class="p">({</span><span class="n">rectangle</span><span class="p">,</span> <span class="nv">Width</span><span class="p">,</span> <span class="nv">Height</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nv">Width</span> <span class="o">+</span> <span class="nv">Height</span><span class="p">);</span>
<span class="ln">12</span><span class="nf">perimeter</span><span class="p">({</span><span class="n">circle</span><span class="p">,</span> <span class="nv">Radius</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">3</span><span class="p">.</span><span class="mi">14159</span> <span class="o">*</span> <span class="nv">Radius</span><span class="p">;</span>
<span class="ln">13</span><span class="nf">perimeter</span><span class="p">({</span><span class="n">square</span><span class="p">,</span> <span class="nv">Side</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="nv">Side</span><span class="p">;</span>
<span class="ln">14</span><span class="nf">perimeter</span><span class="p">({</span><span class="n">right_triangle</span><span class="p">,</span> <span class="nv">Width</span><span class="p">,</span> <span class="nv">Height</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="nv">Width</span> <span class="o">+</span> <span class="nv">Height</span> <span class="o">+</span> <span class="nn">math</span><span class="p">:</span><span class="nf">sqrt</span><span class="p">(</span><span class="nv">Width</span><span class="o">*</span><span class="nv">Width</span> <span class="o">+</span> <span class="nv">Height</span><span class="o">*</span><span class="nv">Height</span><span class="p">).</span>
</code></pre></div><p><strong>(2)</strong></p>
<blockquote>
<p>内置函数 tuple_to_list(T) 能将元组 T 里的元素转换成一个列表。请编写一个名为my_tuple_to_list(T)的函数来做同样的事，但不要使用相同功能的内置函数。</p>
</blockquote>
<p>erlang程序看似人畜无害, 实则非常难以编写.</p>
<ul>
<li><a href="https://www.erlang.org/doc/apps/erts/erlang.html#delete_element/2" target="_blank">delete_element(Index, Tuple1)</a>
 : Returns a new tuple with element at <code>Index</code> removed from tuple <code>Tuple1</code>.</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">mylist</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">my_tuple_to_list</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">my_tuple_to_list</span><span class="p">({})</span> <span class="o">-&gt;</span> <span class="p">[];</span>
<span class="ln">5</span><span class="nf">my_tuple_to_list</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">6</span>    <span class="p">[</span><span class="nb">element</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">T</span><span class="p">)|</span><span class="n">my_tuple_to_list</span><span class="p">(</span><span class="nn">erlang</span><span class="p">:</span><span class="nf">delete_element</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">T</span><span class="p">))].</span>
</code></pre></div><p><strong>(3)</strong></p>
<blockquote>
<p>查看 erlang:now/0 、 erlang:date/0 和 erlang:time/0 的定义 。 编写一个名为my_time_func(F)的函数，让它执行fun F并记下执行时间。编写一个名为my_date_string()的函数，用它把当前的日期和时间改成整齐的格式。</p>
</blockquote>
<ul>
<li><code>erlang:now/0</code>已经过期, 使用<code>erlang:timestamp/0</code>替代, 获取当前Erlang系统时间。</li>
<li><code>erlang:date/0</code>将当前日期返回为{年、月、日}。</li>
<li><code>erlang:time/0</code>将当前时间返回为｛小时、分钟、秒｝。</li>
</ul>
<p>由于找不到如何处理时间差, 这个问题暂时就不处理了.</p>
<p><strong>(4)</strong></p>
<blockquote>
<p>高级练习：查找Python datetime模块的手册页。找出Python的datetime类里有多少方法可以通过erlang模块里有关时间的内置函数实现。在erlang的手册页里查找等价的函数。如果有明显的遗漏，就实现它。</p>
</blockquote>
<p>时间开销太大, 留在这以后说.</p>
<p><strong>(5)</strong></p>
<blockquote>
<p>编写一个名为math_functions.erl的模块，并导出函数even/1和odd/1。even(X)函数应当在X是偶整数时返回true，否则返回false。odd(X)应当在X是奇整数时返回true。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">math_functions</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">even</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">odd</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">even</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="k">if</span> 
<span class="ln"> 6</span>        <span class="p">(</span><span class="nv">T</span> <span class="ow">rem</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">0</span> <span class="ow">andalso</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>            <span class="n">true</span><span class="p">;</span>
<span class="ln"> 8</span>        <span class="n">true</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>            <span class="n">false</span>
<span class="ln">10</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">11</span>
<span class="ln">12</span>
<span class="ln">13</span><span class="nf">odd</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">14</span>    <span class="k">if</span>
<span class="ln">15</span>        <span class="p">(</span><span class="nv">T</span> <span class="ow">rem</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">1</span> <span class="ow">andalso</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">16</span>            <span class="n">true</span><span class="p">;</span>
<span class="ln">17</span>        <span class="n">true</span> <span class="o">-&gt;</span>
<span class="ln">18</span>            <span class="n">false</span>
<span class="ln">19</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p><strong>(6)</strong></p>
<blockquote>
<p>向math_functions.erl添加一个名为filter(F, L)的高阶函数，它返回L里所有符合条件的元素X（条件是F(X)为true）。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">math_functions</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">even</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">odd</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">filter</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">even</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="k">if</span> 
<span class="ln"> 6</span>        <span class="p">(</span><span class="nv">T</span> <span class="ow">rem</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">0</span> <span class="ow">andalso</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>            <span class="n">true</span><span class="p">;</span>
<span class="ln"> 8</span>        <span class="n">true</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>            <span class="n">false</span>
<span class="ln">10</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">11</span>
<span class="ln">12</span>
<span class="ln">13</span><span class="nf">odd</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">14</span>    <span class="k">if</span>
<span class="ln">15</span>        <span class="p">(</span><span class="nv">T</span> <span class="ow">rem</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">1</span> <span class="ow">andalso</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">16</span>            <span class="n">true</span><span class="p">;</span>
<span class="ln">17</span>        <span class="n">true</span> <span class="o">-&gt;</span>
<span class="ln">18</span>            <span class="n">false</span>
<span class="ln">19</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">20</span>
<span class="ln">21</span><span class="nf">filter</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span><span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> 
<span class="ln">22</span>    <span class="p">[</span><span class="nv">X</span> <span class="p">||</span> <span class="nv">X</span> <span class="o">&lt;-</span> <span class="nv">L</span><span class="p">,</span> <span class="nv">F</span><span class="p">(</span><span class="nv">X</span><span class="p">)].</span>
</code></pre></div><p><strong>(7)</strong></p>
<blockquote>
<p>向math_functions.erl添加一个返回{Even, Odd}的split(L)函数，其中Even是一个包含L里所有偶数的列表，Odd是一个包含L里所有奇数的列表。请用两种不同的方式编写这个函数，一种使用归集器，另一种使用在练习6中编写的filter函数。</p>
</blockquote>
<p>由于归集器在教材中的写法已经满足了本题的需要, 故只编写第二种.</p>
<p>注意分号;是用来分隔子句的.</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">math_functions</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">filter</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">split</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="nf">filter</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span><span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> 
<span class="ln"> 6</span>    <span class="p">[</span><span class="nv">X</span> <span class="p">||</span> <span class="nv">X</span> <span class="o">&lt;-</span> <span class="nv">L</span><span class="p">,</span> <span class="nv">F</span><span class="p">(</span><span class="nv">X</span><span class="p">)].</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="nf">split</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>    <span class="nv">Even</span> <span class="o">=</span> <span class="k">fun</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">10</span>    	<span class="k">if</span> 
<span class="ln">11</span>        	<span class="p">(</span><span class="nv">T</span> <span class="ow">rem</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">0</span> <span class="ow">andalso</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">12</span>            	<span class="n">true</span><span class="p">;</span>
<span class="ln">13</span>        	<span class="n">true</span> <span class="o">-&gt;</span>
<span class="ln">14</span>            	<span class="n">false</span>
<span class="ln">15</span>    	<span class="k">end</span>
<span class="ln">16</span>    <span class="k">end</span><span class="p">,</span>
<span class="ln">17</span>
<span class="ln">18</span>
<span class="ln">19</span>	<span class="nv">Odd</span> <span class="o">=</span> <span class="k">fun</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">20</span>    		<span class="k">if</span>
<span class="ln">21</span>        		<span class="p">(</span><span class="nv">T</span> <span class="ow">rem</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">1</span> <span class="ow">andalso</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">22</span>           	 		<span class="n">true</span><span class="p">;</span>
<span class="ln">23</span>        		<span class="n">true</span> <span class="o">-&gt;</span>
<span class="ln">24</span>            		<span class="n">false</span>
<span class="ln">25</span>            <span class="k">end</span>
<span class="ln">26</span>    <span class="k">end</span><span class="p">,</span>
<span class="ln">27</span>    
<span class="ln">28</span>    <span class="nv">Odds</span> <span class="o">=</span> <span class="n">filter</span><span class="p">(</span><span class="nv">Odd</span><span class="p">,</span> <span class="nv">L</span><span class="p">),</span>
<span class="ln">29</span>    <span class="nv">Evens</span> <span class="o">=</span> <span class="n">filter</span><span class="p">(</span><span class="nv">Even</span><span class="p">,</span> <span class="nv">L</span><span class="p">),</span>
<span class="ln">30</span>    <span class="p">{</span><span class="nv">Odds</span><span class="p">,</span> <span class="nv">Evens</span><span class="p">}.</span>
</code></pre></div><h2 id="第5章-记录与映射组">第5章 记录与映射组</h2>
<ul>
<li>记录其实就是元组的另一种形式。通过使用记录，可以给元组里的各个元素关联一个名称。</li>
<li>映射组是键值对的关联性集合。键可以是任意的Erlang数据类型。</li>
<li>与其记住某个数据项在复杂数据结构里的存放位置，不如使用该项的名称，让系统找到数据存放的位置。记录使用一组固定且预定义的名称，而映射组可以动态添加新的名称。</li>
</ul>
<h3 id="映射组记录的选择">映射组/记录的选择</h3>
<p>记录：</p>
<ul>
<li>当你可以用一些预先确定且数量固定的原子来表示数据时；</li>
<li>当记录里的元素数量和元素名称不会随时间而改变时；</li>
<li>当存储空间是个问题时，典型的案例是你有一大堆元组，并且每个元组都有相同的结构。</li>
</ul>
<p>映射组：</p>
<ul>
<li>当键不能预先知道时用来表示键-值数据结构；</li>
<li>当存在大量不同的键时用来表示数据；</li>
<li>当方便使用很重要而效率无关紧要时作为万能的数据结构使用；</li>
<li>用作“自解释型”的数据结构，也就是说，用户容易从键名猜出值的含义；</li>
<li>用来表示键-值解析树，例如XML或配置文件；</li>
<li>用JSON来和其他编程语言通信。</li>
</ul>
<h3 id="记录的使用">记录的使用</h3>
<ol>
<li>
<p>记录声明</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">Name</span><span class="p">,</span> <span class="p">{</span>
<span class="ln">2</span>	<span class="c">%% 下面两个键带有默认值
</span><span class="ln">3</span><span class="c"></span>	<span class="n">key1</span> <span class="o">=</span> <span class="nv">Default1</span><span class="p">,</span>
<span class="ln">4</span>	<span class="n">key2</span> <span class="o">=</span> <span class="nv">Default2</span><span class="p">,</span>
<span class="ln">5</span>	<span class="p">...</span>
<span class="ln">6</span>	<span class="c">%% 相当于未定义
</span><span class="ln">7</span><span class="c"></span>	<span class="n">key3</span><span class="p">,</span>
<span class="ln">8</span>	<span class="p">...</span>
<span class="ln">9</span><span class="p">}).</span>
</code></pre></div><p>Name是记录名。key1、key2这些是记录所含各个字段的名称，它们必须是原子。记录里的每个字段都可以带一个默认值，如果创建记录时没有指定某个字段的值，就会使用默认值。</p>
</li>
<li>
<p>引用记录定义</p>
<p>记录的定义既可以保存在Erlang源代码文件里，也可以由扩展名为.hrl的文件保存，然后包含在Erlang源代码文件里</p>
<p>文件包含是唯一能确保多个Erlang模块共享相同记录定义的方式。</p>
<p>records.hrl：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">todo</span><span class="p">,</span> <span class="p">{</span><span class="n">status</span><span class="o">=</span><span class="n">reminder</span><span class="p">,</span><span class="n">who</span><span class="o">=</span><span class="n">joe</span><span class="p">,</span><span class="n">text</span><span class="p">}).</span>
</code></pre></div></li>
<li>
<p>shell里，必须先把记录的定义读入shell，然后才能创建记录。我们将用shell函数rr（read records的缩写，即读取记录）来实现。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span> <span class="n">rr</span><span class="p">(</span><span class="s">&#34;records.hrl&#34;</span><span class="p">)</span>
<span class="ln">2</span><span class="p">[</span><span class="n">todo</span><span class="p">]</span>
</code></pre></div></li>
<li>
<p>创建记录</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span>   <span class="nl">#todo</span><span class="p">{</span><span class="n">key1</span><span class="o">=</span><span class="nv">Val1</span><span class="p">,</span> <span class="p">...,</span> <span class="n">keyN</span><span class="o">=</span><span class="nv">ValN</span><span class="p">}</span>
</code></pre></div><p>所有的键都是原子，而且必须与记录定义里所用的一致。</p>
<p>如果省略了一个键，系统就会用记录定义里的值作为该键的默认值。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span> <span class="nl">#todo</span><span class="p">{}</span>
<span class="ln">2</span><span class="nl">#todo</span><span class="p">{</span><span class="n">status</span> <span class="o">=</span> <span class="n">reminder</span><span class="p">,</span><span class="n">who</span> <span class="o">=</span> <span class="n">joe</span><span class="p">,</span><span class="n">text</span> <span class="o">=</span> <span class="n">undefined</span><span class="p">}</span>
<span class="ln">3</span><span class="o">&gt;</span> <span class="nv">X1</span> <span class="o">=</span> <span class="nl">#todo</span><span class="p">{</span><span class="n">status</span><span class="o">=</span><span class="n">urgent</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">&#34;Fix errata in book&#34;</span><span class="p">}.</span>
<span class="ln">4</span><span class="nl">#todo</span><span class="p">{</span><span class="n">status</span> <span class="o">=</span> <span class="n">urgent</span><span class="p">,</span><span class="n">who</span> <span class="o">=</span> <span class="n">joe</span><span class="p">,</span><span class="n">text</span> <span class="o">=</span> <span class="s">&#34;Fix errata in book&#34;</span><span class="p">}</span>
</code></pre></div></li>
<li>
<p>复制记录</p>
<p>这么做生成的是原始记录的一个副本，原始记录没有变化。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span> <span class="nv">X2</span> <span class="o">=</span> <span class="nv">X1</span><span class="nl">#todo</span><span class="p">{</span><span class="n">status</span><span class="o">=</span><span class="n">done</span><span class="p">}</span>
<span class="ln">2</span><span class="c">%% 创建一个X1的副本（类型必须是todo），并修改字段status的值为done。
</span></code></pre></div></li>
<li>
<p>提取记录字段</p>
<p>使用模式匹配</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span> <span class="nl">#todo</span><span class="p">{</span><span class="n">who</span><span class="o">=</span><span class="nv">W</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="nv">Txt</span><span class="p">}</span> <span class="o">=</span> <span class="nv">X2</span><span class="p">.</span>
<span class="ln">2</span><span class="o">&gt;</span> <span class="nv">W</span><span class="p">.</span>
<span class="ln">3</span><span class="n">joe</span>
<span class="ln">4</span><span class="o">&gt;</span> <span class="nv">Txt</span><span class="p">.</span>
<span class="ln">5</span><span class="s">&#34;Fix errata in book&#34;</span>
</code></pre></div></li>
<li>
<p>函数中模式匹配记录</p>
<p>以编写模式匹配记录字段或者创建新记录的函数：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">clear_status</span><span class="p">(</span><span class="nl">#todo</span><span class="p">{</span><span class="n">status</span><span class="o">=</span><span class="nv">S</span><span class="p">,</span><span class="n">who</span><span class="o">=</span><span class="nv">W</span><span class="p">}</span> <span class="o">=</span> <span class="nv">R</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="nv">R</span><span class="nl">#todo</span><span class="p">{</span><span class="n">status</span><span class="o">=</span><span class="n">finished</span><span class="p">}</span>
<span class="ln">3</span>                                               
<span class="ln">4</span><span class="c">%% S和W绑定了记录里的字段值
</span><span class="ln">5</span><span class="c">%% R是整个记录
</span></code></pre></div><p>匹配某个类型的记录：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">do_something</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_record</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="n">todo</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="c">%% ...
</span></code></pre></div><p>使用<code>is_record</code>函数匹配todo类型的记录。</p>
</li>
<li>
<p>记录是元组的另一种形式</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>&gt; X2.
<span class="ln">2</span>#todo{status = done,who = joe,text = &#34;Fix errata in book&#34;}
<span class="ln">3</span>&gt; rf(todo).
<span class="ln">4</span>ok
<span class="ln">5</span>&gt; X2.
<span class="ln">6</span>{todo,done,joe,&#34;Fix errata in book&#34;}
</code></pre></div><p><code>rf(todo)</code>命令使shell忘了todo记录的定义。现在打印X2时，shell将X2显示成一个元组</p>
</li>
</ol>
<h3 id="映射组的使用">映射组的使用</h3>
<ol>
<li>
<p>属性</p>
<ul>
<li>映射组的语法与记录相似，不同之处是省略了记录名，并且键值分隔符是=&gt;或:=。</li>
<li>映射组是键-值对的关联性集合。</li>
<li>映射组里的键可以是任何<strong>全绑定的Erlang数据类型</strong>（即数据结构里没有任何未绑定变量）。</li>
<li>映射组里的各个元素根据键进行排序。</li>
<li>在不改变键的情况下更新映射组是一种节省空间的操作。</li>
<li>查询映射组里某个键的值是一种高效的操作。</li>
<li>映射组有着明确的顺序。</li>
</ul>
</li>
<li>
<p>创建映射组</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">#{</span><span class="nv">Key1</span> <span class="nv">Op</span> <span class="nv">Val1</span><span class="p">,</span> <span class="nv">Key2</span> <span class="nv">Op</span> <span class="nv">Val2</span><span class="p">,</span> <span class="p">...,</span> <span class="nv">KeyN</span> <span class="nv">Op</span> <span class="nv">ValN</span><span class="p">}</span>
</code></pre></div><p>Op是=&gt;或:=这两个符号的其中一个。</p>
<p>键和值可以是任何有效的Erlang数据类型。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span> <span class="nv">F1</span> <span class="o">=</span> <span class="p">#{</span><span class="n">a</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">}.</span>
<span class="ln">2</span><span class="p">#{</span><span class="n">a</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">}.</span>
<span class="ln">3</span><span class="o">&gt;</span> <span class="nv">Facts</span> <span class="o">=</span> <span class="p">#{{</span><span class="n">wife</span><span class="p">,</span><span class="n">fred</span><span class="p">}</span><span class="o">=&gt;</span><span class="s">&#34;Sue&#34;</span><span class="p">,</span> <span class="p">{</span><span class="n">age</span><span class="p">,</span><span class="n">fred</span><span class="p">}</span><span class="o">=&gt;</span><span class="mi">45</span><span class="p">}.</span>
</code></pre></div></li>
<li>
<p>映射组在系统内部是作为有序集合存储的，打印时总是使用各键排序后的顺序，与映射组的创建方式无关。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span> <span class="nv">F2</span> <span class="o">=</span> <span class="p">#{</span><span class="n">b</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">}.</span>
<span class="ln">2</span><span class="p">#{</span><span class="n">a</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">}.</span>
</code></pre></div></li>
<li>
<p>基于现有的映射组更新一个映射组：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nv">NewMap</span> <span class="o">=</span> <span class="nv">OldMap</span> <span class="p">#{</span><span class="nv">K1</span> <span class="nv">Op</span> <span class="nv">V1</span><span class="p">,</span> <span class="p">...,</span> <span class="nv">Kn</span> <span class="nv">Op</span> <span class="nv">Vn</span><span class="p">}</span>
</code></pre></div><p>表达式K =&gt; V有两种用途，一种是将现有键K的值更新为新值V，另一种是给映射组添加一个全新的K-V对。这个操作总是成功的。</p>
<p>表达式K := V的作用是将现有键K的值更新为新值V。如果被更新的映射组不包含键K，这个操作就会失败。</p>
<p>使用映射组的最佳方式是在首次定义某个键时总是使用Key =&gt; Val，而在修改具体某个键的值时都使用Key := Val。</p>
<p>（操作是深拷贝的，这两个变量是不相关的）</p>
</li>
<li>
<p>模式匹配映射组字段</p>
<p>用来编写映射组的=&gt;语法还可以作为映射组模式使用。和之前一样，映射组模式里的键不能包含任何未绑定变量，但是值现在可以包含未绑定变量了（在模式匹配成功后绑定）。</p>
<p>（TODO 我测试这段代码失败了，不管怎么匹配都是错误的，这里留一个坑。）</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span> <span class="nv">Henry8</span> <span class="o">=</span> <span class="p">#{</span><span class="n">class</span><span class="o">=&gt;</span><span class="n">king</span><span class="p">,</span><span class="n">born</span><span class="o">=&gt;</span><span class="mi">1491</span><span class="p">,</span><span class="n">died</span><span class="o">=&gt;</span><span class="mi">1547</span><span class="p">}.</span>
<span class="ln">2</span><span class="o">&gt;</span> <span class="p">#{</span><span class="n">born</span> <span class="o">=&gt;</span> <span class="nv">B</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Henry8</span><span class="p">.</span>
<span class="ln">3</span><span class="o">&gt;</span> <span class="nv">B</span><span class="p">.</span>
<span class="ln">4</span><span class="mi">1491</span>
<span class="ln">5</span><span class="o">&gt;</span> <span class="p">#{</span> <span class="nv">D</span> <span class="o">=&gt;</span> <span class="mi">1547</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Henry8</span><span class="p">.</span>
<span class="ln">6</span><span class="n">unbound</span>
</code></pre></div></li>
<li>
<p>函数头部使用包含模式的映射组</p>
<p>count_characters(Str)函数，让它返回一个映射组，内含某个字符串里各个字符的出现次数。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="c">%% 入口
</span><span class="ln"> 2</span><span class="c"></span><span class="nf">count_characters</span><span class="p">(</span><span class="nv">Str</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 3</span>	<span class="n">count_characters</span><span class="p">(</span><span class="nv">Str</span><span class="p">,</span> <span class="p">#{}).</span>
<span class="ln"> 4</span>   	
<span class="ln"> 5</span><span class="c">%% 核心
</span><span class="ln"> 6</span><span class="c"></span><span class="nf">count_characters</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="p">#{</span> <span class="nv">H</span> <span class="o">=&gt;</span> <span class="nv">N</span><span class="p">}</span><span class="o">=</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>	<span class="n">count_characters</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span><span class="nv">X</span><span class="p">#{</span> <span class="nv">H</span> <span class="p">:</span><span class="o">=</span> <span class="nv">N</span><span class="o">+</span><span class="mi">1</span><span class="p">});</span>
<span class="ln"> 8</span><span class="c">%% 上一条没匹配成功，表明这个字母的计数是第一次
</span><span class="ln"> 9</span><span class="c"></span><span class="nf">count_characters</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">10</span>	<span class="n">count_characters</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span><span class="nv">X</span><span class="p">#{</span> <span class="nv">H</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">});</span>
<span class="ln">11</span><span class="c">%% 处理完毕
</span><span class="ln">12</span><span class="c"></span><span class="nf">count_characters</span><span class="p">([],</span> <span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">13</span>	<span class="nv">X</span><span class="p">.</span>
</code></pre></div></li>
<li>
<p>映射组api：</p>
<ul>
<li><code>map:new() -&gt; #{}</code> 返回一个新的空映射组。</li>
<li><code>erlang:is_map(M) -&gt; bool()</code> 如果M是映射组就返回true，否则返回false。它可以用在关卡测试或函数主体中。</li>
<li><code>maps:to_list(M) -&gt; [{K1,V1, ..., {Kn,Vn}]</code> 把映射组M里的所有键和值转换成一个键值列表。键在生成的列表里严格按升序排列。</li>
<li><code>maps:from_list([{K1,V1}, ..., {Kn,Vn}]) -&gt; M</code>把一个包含键值对的列表转换成映射组M。如果同样的键不止一次出现，就使用列表里第一个键所关联的值，后续的值都会被忽略。</li>
<li><code>maps:map_size(Map) -&gt; NumberOfEntries</code>返回映射组里的条目数量。</li>
<li><code>maps:is)key(Key,Map)-&gt; bool()</code>如果映射组包含一个键为Key的项就返回true，否则返回false。</li>
<li><code>maps:get(Key,Map)-&gt;Val</code>返回映射组里与Key关联的值，否则抛出一个异常错误。</li>
<li><code>maps:find(Key,Map)-&gt;{ok,Value}|error</code>返回映射组里与Key关联的值，否则返回error。</li>
<li><code>maps:keys(Map)-&gt;[Key1,...,KeyN]</code>返回映射组所含的键列表，按升序排列。</li>
<li><code>maps:remove(Key,M)-&gt;M1</code>返回一个新映射组M1，除了键为Key的项（如果有的话）被移除外，其他与M一致。</li>
<li><code>maps:without([Key1,...,KeyN],M)-&gt;M1</code>返回一个新映射组M1，它是M的复制，但移除了带有[Key1,&hellip;,KeyN]列表里这些键的元素。</li>
<li><code>maps:difference(M1,M2)-&gt;M3</code>M3是M1的复制，但移除了那些与M2里的元素具有相同键的元素。</li>
</ul>
</li>
<li>
<p>映射组排序规则</p>
<p>映射组在比较时首先会比大小，然后再按照键的排序比较键和值。</p>
<ul>
<li>如果A和B是映射组，那么当maps:size(A) &lt; maps:size(B)时A &lt; B。</li>
<li>如果A和B是大小相同的映射组，那么当maps:to_list(A) &lt; maps:to_list(B)时A &lt; B。</li>
<li>当映射组与其他Erlang数据类型相比较时，因为我们认为映射组比列表或元组“更复杂”，所以映射组总是会大于列表或元组。</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nv">A</span> <span class="o">=</span> <span class="p">#{</span><span class="n">age</span> <span class="o">=&gt;</span> <span class="mi">23</span><span class="p">,</span> <span class="n">person</span> <span class="o">=&gt;</span> <span class="s">&#34;jim&#34;</span><span class="p">}</span> <span class="o">&lt;</span> <span class="nv">B</span> <span class="o">=</span> <span class="err">#</span> <span class="p">{</span><span class="n">email</span> <span class="o">=&gt;</span> <span class="s">&#34;sue@somplace.com&#34;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#34;sue&#34;</span><span class="p">}</span>
<span class="ln">2</span>   
<span class="ln">3</span><span class="c">%% A的最小键（age）比B的最小键（email）更小。
</span></code></pre></div></li>
<li>
<p>映射组可以通过<code>io:format</code>里的~p选项输出，并用<code>io:read</code>或<code>file:consult</code>读取。</p>
</li>
<li>
<p>映射组和JSON相关api</p>
<ul>
<li><code>maps:to_json(Map) -&gt;Bin</code> 把一个映射组转换成二进制型，它包含用JSON表示的该映射组。</li>
<li><code>maps:from_json(Bin) -&gt; Map</code> 把一个包含JSON数据的二进制型转换成映射组。</li>
<li><code>maps:safe_from_json(Bin) -&gt; Map</code> 把一个包含JSON数据的二进制型转换成映射组。Bin里的任何原子必须在调用此内置函数前就已存在，否则就会抛出一个异常错误。这样做是为了防止创建大量的新原子。出于效率的原因，Erlang不会垃圾回收（garbage collect）原子，所以连续不断地添加新原子会（在很长一段时间后）让Erlang虚拟机崩溃。</li>
</ul>
<p>上面两种定义里的Map都必须是json_map()类型的实例。</p>
<p>（目前maps模块已经没有这些函数了，还是需要另外查询）</p>
</li>
<li>
<p>JSON对象与Erlang值的映射关系：<code>json_map()</code>类型</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">type</span> <span class="n">json_map</span><span class="p">()</span> <span class="o">=</span> <span class="p">[{</span><span class="n">json_key</span><span class="p">(),</span> <span class="n">json_value</span><span class="p">()}].</span>
<span class="ln">2</span>    
<span class="ln">3</span><span class="p">-</span><span class="ni">type</span> <span class="n">json_key</span><span class="p">()</span> <span class="o">=</span> 
<span class="ln">4</span>	<span class="n">atom</span><span class="p">()</span> <span class="p">|</span> <span class="n">binary</span><span class="p">()</span> <span class="p">|</span> <span class="n">io_list</span><span class="p">()</span>
<span class="ln">5</span>    	
<span class="ln">6</span><span class="p">-</span><span class="ni">type</span> <span class="n">json_value</span><span class="p">()</span> <span class="o">=</span> 
<span class="ln">7</span>	<span class="n">integer</span><span class="p">()</span> <span class="p">|</span> <span class="n">binary</span><span class="p">()</span> <span class="p">|</span> <span class="nb">float</span><span class="p">()</span> <span class="p">|</span> <span class="n">atom</span><span class="p">()</span> <span class="p">|</span> <span class="p">[</span><span class="n">json_value</span><span class="p">()]</span> <span class="p">|</span> <span class="n">json_map</span><span class="p">()</span>
</code></pre></div><ul>
<li>JSON的数字用Erlang的整数或浮点数表示。</li>
<li>JSON的字符串用Erlang的二进制型表示。</li>
<li>JSON的列表用Erlang的列表表示。</li>
<li>JSON的true和false用Erlang的原子true和false表示。</li>
<li>JSON的对象用Erlang的映射组表示，但是有限制：映射组里的键必须是原子、字符串或二进制型，而值必须可以用JSON的数据类型表示。</li>
</ul>
<p>当来回转换JSON数据类型时，应当注意一些特定的转换限制。Erlang对整数提供了无限的精度。所以，Erlang会很自然地把映射组里的某个大数转换成JSON数据里的大数，而解码此JSON数据的程序不一定能理解它。</p>
</li>
</ol>
<h3 id="练习-3">练习</h3>
<p><strong>(1)</strong></p>
<blockquote>
<p>配置文件可以很方便地用JSON数据表示。请编写一些函数来读取包含JSON数据的配置文件，并将它们转换成Erlang的映射组。再编写一些代码，对配置文件里的数据进行合理性检查。</p>
</blockquote>
<p>json:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="ln">1</span><span class="p">{</span>
<span class="ln">2</span>	<span class="err">{username,</span> <span class="err">liming</span><span class="p">}</span><span class="err">,</span>
<span class="ln">3</span>	<span class="p">{</span><span class="err">password,</span> <span class="err">123456</span><span class="p">}</span><span class="err">,</span>
<span class="ln">4</span>	<span class="p">{</span><span class="err">location,</span> <span class="err">beijing</span><span class="p">}</span><span class="err">,</span>
<span class="ln">5</span>	<span class="p">{</span><span class="err">male,</span> <span class="err">true</span><span class="p">}</span>
<span class="ln">6</span><span class="err">}</span>
</code></pre></div><p>等到以后再来。</p>
<p><strong>(2)</strong></p>
<blockquote>
<p>编写一个map_search_pred(Map, Pred) 函数，让它返回映射组里第一个符合条件的{Key,Value}元素（条件是Pred(Key, Value)为true）。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">map_search</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">map_search_pred</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">map_search_pred</span><span class="p">(</span><span class="nv">Map</span><span class="p">,</span> <span class="nv">Pred</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>	<span class="n">list_search_pred</span><span class="p">(</span><span class="nn">maps</span><span class="p">:</span><span class="nf">to_list</span><span class="p">(</span><span class="nv">Map</span><span class="p">),</span> <span class="nv">Pred</span><span class="p">).</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="nf">list_search_pred</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">Pred</span><span class="p">)</span> <span class="o">-&gt;</span> 
<span class="ln"> 8</span>	<span class="p">{</span><span class="nv">K</span><span class="p">,</span><span class="nv">V</span><span class="p">}</span> <span class="o">=</span> <span class="nv">H</span><span class="p">,</span>
<span class="ln"> 9</span>	<span class="k">case</span> <span class="nv">Pred</span><span class="p">(</span><span class="nv">K</span><span class="p">,</span><span class="nv">V</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">10</span>		<span class="n">true</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">K</span><span class="p">,</span><span class="nv">V</span><span class="p">};</span>
<span class="ln">11</span>		<span class="n">false</span> <span class="o">-&gt;</span> <span class="n">list_search_pred</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="nv">Pred</span><span class="p">)</span>
<span class="ln">12</span>	<span class="k">end</span><span class="p">;</span>
<span class="ln">13</span><span class="nf">list_search_pred</span><span class="p">([],</span> <span class="nv">Pred</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">14</span>	<span class="s">&#34;None of them matchs&#34;</span><span class="p">.</span>
</code></pre></div><p>测试：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nv">Pred</span> <span class="o">=</span> <span class="k">fun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="nv">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">V</span><span class="o">=:=</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">2</span>		  <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="nv">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">V</span><span class="o">=:=</span><span class="mi">2</span>
<span class="ln">3</span>	   <span class="k">end</span><span class="p">.</span>
<span class="ln">4</span>	   
<span class="ln">5</span><span class="nv">M1</span> <span class="o">=</span> <span class="p">#{</span><span class="n">a</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">}.</span>
</code></pre></div><h2 id="第6章-顺序程序的错误处理">第6章 顺序程序的错误处理</h2>
<h3 id="书本内容">书本内容</h3>
<ol>
<li>
<p>在Erlang里，单个进程的崩溃就不那么重要了，前提是其他某些进程能察觉这个崩溃，并接手崩溃进程原本应该做的事情。</p>
</li>
<li>
<p>Erlang里，防御式编程是内建的。在描述函数的行为时应该只考虑合法的输入参数，其他所有参数都将导致内部错误并自动被检测到。永远不能让函数对非法的参数返回值，而是应该抛出一个异常错误。这条规则被称为“任其崩溃”。</p>
</li>
<li>
<p>显式生成错误：</p>
<ul>
<li><code>exit(Why)</code> 当你确实想要终止当前进程时就用它。如果这个异常错误没有被捕捉到，信号{&lsquo;EXIT&rsquo;,Pid,Why}就会被广播给当前进程链接的所有进程。</li>
<li><code>throw(Why)</code> 抛出一个调用者可能想要捕捉的异常错误。在这种情况下，我们注明了被调用函数可能会抛出这个异常错误。有两种方法可以代替它使用：可以为通常的情形编写代码并且有意忽略异常错误，也可以把调用封装在一个try&hellip;catch表达式里，然后对错误进行处理。</li>
<li><code>error(Why)</code> 这个函数的作用是指示“崩溃性错误”，也就是调用者没有准备好处理的非常严重的问题。它与系统内部生成的错误差不多。</li>
</ul>
</li>
<li>
<p>Erlang有两种方法来捕捉异常错误。第一种是把抛出异常错误的调用函数封装在一个<code>try...catch</code>表达式里，另一种是把调用封装在一个<code>catch</code>表达式里。</p>
</li>
<li>
<p><code>try catch</code>语法</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="k">try</span> <span class="nv">FuncOrExpressionSeq</span> <span class="k">of</span>
<span class="ln"> 2</span>	<span class="nv">Pattern1</span> <span class="p">[</span><span class="k">when</span> <span class="nv">Guard1</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="nv">Expressions1</span><span class="p">;</span>
<span class="ln"> 3</span>	<span class="nv">Pattern2</span> <span class="p">[</span><span class="k">when</span> <span class="nv">Guard2</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="nv">Expressions2</span><span class="p">;</span>
<span class="ln"> 4</span>	<span class="p">...</span>
<span class="ln"> 5</span><span class="k">catch</span>
<span class="ln"> 6</span>	<span class="nv">ExceptionType1</span><span class="p">:</span> <span class="nv">ExPattern1</span> <span class="p">[</span><span class="k">when</span> <span class="nv">ExGuard1</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="nv">ExExpressions1</span><span class="p">;</span>
<span class="ln"> 7</span>	<span class="nv">ExceptionType2</span><span class="p">:</span> <span class="nv">ExPattern2</span> <span class="p">[</span><span class="k">when</span> <span class="nv">ExGuard2</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="nv">ExExpressions2</span><span class="p">;</span>
<span class="ln"> 8</span>	<span class="p">...</span>
<span class="ln"> 9</span><span class="k">after</span>
<span class="ln">10</span>	<span class="nv">AfterExoressuibs</span>
<span class="ln">11</span><span class="k">end</span>
</code></pre></div><p>首先执行FuncOrExpessionSeq。如果执行过程没有抛出异常错误，那么函数的返回值就会与Pattern1（以及可选的关卡Guard1）、Pattern2等模式进行匹配，直到匹配成功。如果能匹配，那么整个try&hellip;catch的值就通过执行匹配模式之后的表达式序列得出。</p>
<p>如果FuncOrExpressionSeq在执行中抛出了异常错误，那么ExPattern1等捕捉模式就会与它进行匹配，找出应该执行哪一段表达式序列。ExceptionType是一个原子（throw、exit和error其中之一），它告诉我们异常错误是如何生成的。如果省略ExceptionType，就会使用默认值throw。</p>
<p>关键字after之后的代码是用来在FuncOrExpressionSeq结束后执行清理的。这段代码一定会被执行 ， 哪怕有异常错误抛出也是如此。after区块的代码会在try或catch区块里的Expressions代码完成后立即运行。AfterExpressions的返回值会被丢弃。</p>
</li>
<li>
<p><code>try catch</code>简写</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="k">try</span> <span class="nv">F</span>
<span class="ln">2</span><span class="k">catch</span>
<span class="ln">3</span>	<span class="p">...</span>
<span class="ln">4</span><span class="k">end</span>
</code></pre></div></li>
<li>
<p><code>try catch</code>样例</p>
<p>try_test.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">generate_exception</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">;</span>
<span class="ln"> 2</span><span class="nf">generate_exception</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">throw</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="ln"> 3</span><span class="nf">generate_exception</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">exit</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="ln"> 4</span><span class="nf">generate_exception</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">&#39;EXIT&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">};</span>
<span class="ln"> 5</span><span class="nf">generate_exception</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">error</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="ln"> 6</span>   
<span class="ln"> 7</span><span class="nf">demo1</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>    <span class="p">[</span><span class="n">catcher</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="p">||</span> <span class="nv">I</span> <span class="o">&lt;-</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]].</span>
<span class="ln"> 9</span>   
<span class="ln">10</span><span class="nf">catcher</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">11</span>    <span class="k">try</span> <span class="n">generate_exception</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">12</span>        <span class="nv">Val</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">N</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="nv">Val</span><span class="p">}</span>
<span class="ln">13</span>    <span class="k">catch</span>
<span class="ln">14</span>        <span class="nn">throw</span><span class="p">:</span><span class="nv">X</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">N</span><span class="p">,</span> <span class="n">caught</span><span class="p">,</span> <span class="n">thrown</span><span class="p">,</span> <span class="nv">X</span><span class="p">};</span>
<span class="ln">15</span>        <span class="nb">exit</span><span class="p">:</span><span class="nv">X</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">N</span><span class="p">,</span> <span class="n">caught</span><span class="p">,</span> <span class="n">exited</span><span class="p">,</span> <span class="nv">X</span><span class="p">};</span>
<span class="ln">16</span>        <span class="nn">error</span><span class="p">:</span><span class="nv">X</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">N</span><span class="p">,</span> <span class="n">caught</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="nv">X</span><span class="p">}</span>
<span class="ln">17</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>[{1,normal,a},
<span class="ln">2</span> {2,caught,thrown,a},
<span class="ln">3</span> {3,caught,exited,a},
<span class="ln">4</span> {4,normal,{&#39;EXIT&#39;,a}},
<span class="ln">5</span> {5,caught,error,a}]
</code></pre></div></li>
<li>
<p>用<code>catch</code>捕获异常</p>
<p>try_test.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">demo2</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="p">[{</span><span class="nv">I</span><span class="p">,</span> <span class="p">(</span><span class="k">catch</span> <span class="n">generate_exception</span><span class="p">(</span><span class="nv">I</span><span class="p">))}</span> <span class="p">||</span> <span class="nv">I</span> <span class="o">&lt;-</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]]</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>[{1,a},
<span class="ln">2</span> {2,a},
<span class="ln">3</span> {3,{&#39;EXIT&#39;,a}},
<span class="ln">4</span> {4,{&#39;EXIT&#39;,a}},
<span class="ln">5</span> {5,{&#39;EXIT&#39;,
<span class="ln">6</span>         {a,[try_test,genera....]}}}]
</code></pre></div><p>提供了详细的栈跟踪信息。</p>
</li>
<li>
<p>针对异常错误的代码模式</p>
<ul>
<li>
<p>改进错误消息</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">sqrt</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="k">when</span> <span class="nv">X</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="n">error</span><span class="p">({</span><span class="n">squareRootNegativeArgument</span><span class="p">,</span> <span class="nv">X</span><span class="p">});</span>
<span class="ln">3</span><span class="nf">sqrt</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">4</span>    <span class="nn">math</span><span class="p">:</span><span class="nf">sqrt</span><span class="p">(</span><span class="nv">X</span><span class="p">).</span>
</code></pre></div></li>
<li>
<p>函数经常返回错误时该这么写：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="k">case</span> <span class="n">f</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">2</span>	<span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Val</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">3</span>       <span class="n">do_some_thing_with</span><span class="p">(</span><span class="nv">Val</span><span class="p">);</span>
<span class="ln">4</span>     	
<span class="ln">5</span>	<span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Why</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">6</span>       <span class="c">%% 处理错误
</span><span class="ln">7</span><span class="c"></span><span class="k">end</span><span class="p">,</span>
<span class="ln">8</span><span class="p">...</span>
</code></pre></div></li>
<li>
<p>错误罕见但可能有该这么写：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="k">try</span> <span class="n">my_func</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span>
<span class="ln">2</span><span class="k">catch</span>
<span class="ln">3</span>	<span class="nn">throw</span><span class="p">:{</span><span class="n">thisError</span><span class="p">,</span> <span class="nv">X</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="p">...</span>
<span class="ln">4</span>	<span class="nn">throw</span><span class="p">:{</span><span class="n">someOtherError</span><span class="p">,</span> <span class="nv">X</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="p">...</span>
<span class="ln">5</span><span class="k">end</span>
</code></pre></div></li>
<li>
<p>捕捉一切可能的异常：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="k">try</span> <span class="nv">Expr</span>
<span class="ln">2</span><span class="k">catch</span>
<span class="ln">3</span>	<span class="p">_:_</span> <span class="o">-&gt;</span> <span class="p">...</span> <span class="err">处理所有异常错误的代码</span>
<span class="ln">4</span><span class="k">end</span>
</code></pre></div><p>如果漏写了标签<code>_ -&gt; ...</code>，就不会捕捉到所有的错误，因为在这种情形下系统会假设标签是默认的throw。</p>
</li>
</ul>
</li>
<li>
<p>栈跟踪信息</p>
<p>捕捉到一个异常错误后，可以调用erlang:get_stacktrace()来找到最近的栈跟踪信息。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">demo3</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="k">try</span> <span class="n">generate_exception</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="ln">3</span>	<span class="k">catch</span>
<span class="ln">4</span>        <span class="nn">error</span><span class="p">:</span><span class="nv">X</span> <span class="o">-&gt;</span>
<span class="ln">5</span>            <span class="p">{</span><span class="nv">X</span><span class="p">,</span> <span class="nn">erlang</span><span class="p">:</span><span class="nf">get_stacktrace</span><span class="p">()}</span>
<span class="ln">6</span>	<span class="k">end</span><span class="p">.</span>
</code></pre></div></li>
<li>
<p>要牢记的一个重点是任其崩溃。永远不要在函数被错误参数调用时返回一个值，而是要抛出一个异常错误。要假定调用者会修复这个错误。在Erlang里，当系统内部或程序逻辑检测出错误时，正确的做法是立即崩溃并生成一段有意义的错误消息。立即崩溃是为了不让事情变得更糟。错误消息应当被写入永久性的错误日志，而且要包含足够多的细节，以便过后查明是哪里出了错。</p>
</li>
</ol>
<h3 id="练习-4">练习</h3>
<p><strong>(1)</strong></p>
<blockquote>
<p>file:read_file(File)会返回{ok, Bin}或者{error, Why}，其中File是文件名，Bin则包含了文件的内容。请编写一个myfile:read(File)函数，当文件可读取时返回Bin，否则抛出一个异常错误。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">myfile</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">read</span><span class="o">/</span><span class="mi">1</span><span class="p">])</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">read</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>	<span class="k">case</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="k">of</span>
<span class="ln"> 6</span>		<span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>			<span class="nv">Bin</span><span class="p">;</span>
<span class="ln"> 8</span>		<span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Why</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>			<span class="n">throw</span><span class="p">(</span><span class="nv">Why</span><span class="p">)</span>
<span class="ln">10</span>	<span class="k">end</span><span class="p">.</span>
<span class="ln">11</span>
</code></pre></div><p><strong>(2)</strong></p>
<blockquote>
<p>重写try_test.erl里的代码，让它生成两条错误消息：一条文明的消息给用户，另一条详细的消息给开发者。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">generate_exception</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">;</span>
<span class="ln"> 2</span><span class="nf">generate_exception</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">throw</span><span class="p">(</span><span class="s">&#34;遇到2,程序异常&#34;</span><span class="p">);</span>
<span class="ln"> 3</span><span class="nf">generate_exception</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">exit</span><span class="p">(</span><span class="s">&#34;遇到3,程序退出&#34;</span><span class="p">);</span>
<span class="ln"> 4</span><span class="nf">generate_exception</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">&#39;EXIT&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">};</span>
<span class="ln"> 5</span><span class="nf">generate_exception</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">error</span><span class="p">(</span><span class="s">&#34;遇到5,程序错误&#34;</span><span class="p">);</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="nf">demo1</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>    <span class="p">[</span><span class="n">catcher</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="p">||</span> <span class="nv">I</span> <span class="o">&lt;-</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]].</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="nf">catcher</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">11</span>    <span class="k">try</span> <span class="n">generate_exception</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">12</span>        <span class="nv">Val</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">N</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="nv">Val</span><span class="p">}</span>
<span class="ln">13</span>    <span class="k">catch</span>
<span class="ln">14</span>        <span class="nn">throw</span><span class="p">:</span><span class="nv">X</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">N</span><span class="p">,</span> <span class="n">caught</span><span class="p">,</span> <span class="n">thrown</span><span class="p">,</span> <span class="nv">X</span><span class="p">,</span> <span class="s">&#34;程序暂不可用&#34;</span><span class="p">};</span>
<span class="ln">15</span>        <span class="nb">exit</span><span class="p">:</span><span class="nv">X</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">N</span><span class="p">,</span> <span class="n">caught</span><span class="p">,</span> <span class="n">exited</span><span class="p">,</span> <span class="nv">X</span><span class="p">,</span> <span class="s">&#34;程序退出&#34;</span><span class="p">};</span>
<span class="ln">16</span>        <span class="nn">error</span><span class="p">:</span><span class="nv">X</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">N</span><span class="p">,</span> <span class="n">caught</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="nv">X</span><span class="p">,</span> <span class="s">&#34;程序错误&#34;</span><span class="p">}</span>
<span class="ln">17</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><h2 id="第7章-二进制型与位语法">第7章 二进制型与位语法</h2>
<h3 id="二进制型">二进制型</h3>
<ul>
<li>
<p>二进制型的编写和打印形式是双小于号与双大于号之间的一列整数或字符串。</p>
<p>在二进制型里使用整数时，它们必须属于0至255这个范围 。</p>
<p>如果某个二进制型的内容是可打印的字符串，shell就会将这个二进制型打印成字符串，否则就打印成一列整数。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span> <span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="o">&gt;&gt;</span><span class="p">.</span>
<span class="ln">2</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="o">&gt;&gt;</span>
<span class="ln">3</span><span class="o">&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&#34;hello&#34;</span><span class="o">&gt;&gt;</span><span class="p">.</span>
<span class="ln">4</span><span class="o">&lt;&lt;</span><span class="s">&#34;hello&#34;</span><span class="o">&gt;&gt;</span>
<span class="ln">5</span><span class="o">&gt;</span> <span class="o">&lt;&lt;</span><span class="mi">65</span><span class="p">,</span><span class="mi">66</span><span class="p">,</span><span class="mi">67</span><span class="o">&gt;&gt;</span><span class="p">.</span>
<span class="ln">6</span><span class="o">&lt;&lt;</span><span class="s">&#34;ABC&#34;</span><span class="o">&gt;&gt;</span>
</code></pre></div></li>
<li>
<p>操作二进制型的内置函数(binary模块里的函数)：</p>
<ul>
<li><code>list_to_binary(L) -&gt; B</code> list_to_binary返回一个二进制型，它是通过把io列表（iolist）L里的所有元素压扁后形成的（压扁的意思是移除列表里所有的括号）。</li>
<li><code>split_binary(Bin, Pos) -&gt; {Bin1, Bin2} </code>这个函数在Pos处把二进制型Bin一分为二。</li>
<li><code>term_to_binary(Term) -&gt; Bin</code> 这个函数能把任何Erlang数据类型转换成一个二进制型。数据类型通过<code>term_to_binary</code>转换成二进制型后可以被保存在文件里，作为消息通过网络发送，等等，而转换前的初始数据类型可以在稍后重建。对于在文件里保存复杂数据结构，或者向远程机器发送复杂数据结构而言，这是极其有用的。</li>
<li><code>binary_to_term(Bin) -&gt; Term </code>这是term_to_binary的逆向函数。</li>
<li><code>byte_size(Bin) -&gt; Size </code>这个函数返回二进制型里的字节数。</li>
</ul>
</li>
</ul>
<h3 id="位语法">位语法</h3>
<p>1.概念</p>
<ul>
<li>
<p>位语法表达式：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>&lt;&lt;&gt;&gt;
<span class="ln">2</span>&lt;&lt;E1,E2,...,En&gt;&gt;
</code></pre></div><p>每个Ei元素都标识出二进制型或位串里的一个片段。单个Ei元素可以有4种形式：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>Ei = Value | 
<span class="ln">2</span>   Value:Size |
<span class="ln">3</span>   Value/TypeSpecifierList | 
<span class="ln">4</span>   Value:Size/TypeSpecifierList
</code></pre></div><p>如果表达式的总位数是<strong>8的整数倍</strong>，就会构建一个<strong>二进制型</strong>，否则构建一个位串。</p>
<p>Size的值指明了片段的大小。它的默认值取决于不同的数据类型，对整数来说是8，浮点数则是64，如果是二进制型就是该二进制型的大小。在模式匹配里，默认值只对最后那个元素有效。如果未指定片段的大小，就会采用默认值。</p>
</li>
<li>
<p>TypeSpecifierList （类型指定列表）是一个用连字符分隔的列表，形式为 End-Sign-Type-Unit。前面这些项中的任何一个都可以被省略，各个项也可以按任意顺序排列。如果省略了某一项，系统就会使用它的默认值。</p>
<ul>
<li>
<p>End可以是big | little | native</p>
<p>它指定机器的字节顺序。native是指在运行时根据机器的CPU来确定。默认值是big，也就是网络字节顺序（network byte order）。这一项只和从二进制型里打包和解包整数与浮点数有关。</p>
<p>term_to_binary和binary_to_term可以帮你搞定打包和解包整数的工作。因此，你可以在高位优先（big-endian）的机器上创建一个包含整数的元组，然后用term_to_binary把它转换成二进制型并发送至低位优先（little-endian）的机器。最后，在低位优先的机器上运行binary_to_term，这样元组里所有整数的值都会是正确的。</p>
</li>
<li>
<p>Sign可以是signed|unsigned</p>
<p>这个参数只用于模式匹配。默认值是unsigned。</p>
</li>
<li>
<p>Type可以是integer|float|binary|bytes|bitstring|bits|utf8|utf16|utf32。</p>
<p>默认值是integer。</p>
</li>
<li>
<p>Unit的写法是unit:1|2|…256
integer、float和bitstring的Unit默认值是1，binary则是8。utf8、utf16和utf32类型无需提供值。</p>
</li>
</ul>
</li>
</ul>
<p>2.例子</p>
<ul>
<li>
<p>寻找MPEG数据里的同步帧</p>
<p>mp3_sync.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">find_sync</span><span class="p">(</span><span class="nv">Bin</span><span class="p">,</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="k">case</span> <span class="n">is_header</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">)</span> <span class="k">of</span>
<span class="ln"> 3</span>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Len1</span><span class="p">,</span> <span class="p">_}</span> <span class="o">-&gt;</span>
<span class="ln"> 4</span>            <span class="k">case</span> <span class="n">is_header</span><span class="p">(</span><span class="nv">N</span><span class="o">+</span><span class="nv">Len1</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">)</span> <span class="k">of</span>
<span class="ln"> 5</span>                <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Len2</span><span class="p">,</span> <span class="p">_}</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>                    <span class="k">case</span> <span class="n">is_header</span><span class="p">(</span><span class="nv">N</span><span class="o">+</span><span class="nv">Len1</span><span class="o">+</span><span class="nv">Len2</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">)</span> <span class="k">of</span>
<span class="ln"> 7</span>                        <span class="p">{</span><span class="n">ok</span><span class="p">,_</span> <span class="p">,_}</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>                            <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">N</span><span class="p">};</span>
<span class="ln"> 9</span>                        <span class="n">error</span> <span class="o">-&gt;</span>
<span class="ln">10</span>                            <span class="n">find_sync</span><span class="p">(</span><span class="nv">Bin</span><span class="p">,</span><span class="nv">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="ln">11</span>                     <span class="k">end</span><span class="p">;</span>
<span class="ln">12</span>                <span class="n">error</span> <span class="o">-&gt;</span>
<span class="ln">13</span>                    <span class="n">find_sync</span><span class="p">(</span><span class="nv">Bin</span><span class="p">,</span><span class="nv">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="ln">14</span>             <span class="k">end</span><span class="p">;</span>
<span class="ln">15</span>        <span class="n">error</span> <span class="o">-&gt;</span>
<span class="ln">16</span>            <span class="n">find_sync</span><span class="p">(</span><span class="nv">Bin</span><span class="p">,</span><span class="nv">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="ln">17</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">18</span>  
<span class="ln">19</span><span class="nf">is_header</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">20</span>    <span class="n">unpack_header</span><span class="p">(</span><span class="n">get_word</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">)).</span>
<span class="ln">21</span>  
<span class="ln">22</span><span class="c">%% 提取32位数据进行分析
</span><span class="ln">23</span><span class="c"></span><span class="nf">get_word</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">24</span>    <span class="p">{_,</span> <span class="o">&lt;&lt;</span><span class="nv">C</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="n">binary</span><span class="p">,_</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="o">=</span> <span class="nb">split_binary</span><span class="p">(</span><span class="nv">Bin</span><span class="p">,</span><span class="nv">N</span><span class="p">),</span>
<span class="ln">25</span>    <span class="nv">C</span><span class="p">.</span>
<span class="ln">26</span>  
<span class="ln">27</span><span class="nf">unpack_header</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">28</span>    <span class="k">try</span> <span class="n">decode_header</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span>
<span class="ln">29</span>    <span class="k">catch</span>
<span class="ln">30</span>      <span class="p">_:_</span> <span class="o">-&gt;</span> <span class="n">error</span>
<span class="ln">31</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">32</span>            
<span class="ln">33</span><span class="c">%% 2#11111111111是个二进制整数，因此这个模式匹配11个连续的1位，指派给B2位，指派给C2位，以此类推。请注意，这段代码严格遵循之前给出的位级MPEG头规范。
</span><span class="ln">34</span><span class="c"></span><span class="nf">decode_header</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="mi">2#11111111111</span><span class="p">,</span><span class="nv">B</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nv">C</span><span class="p">:</span><span class="mi">2</span><span class="p">,_</span><span class="nv">D</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nv">E</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="nv">F</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nv">G</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nv">Bits</span><span class="p">:</span><span class="mi">9</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">35</span>    <span class="nv">Vsn</span> <span class="o">=</span> <span class="k">case</span> <span class="nv">B</span> <span class="k">of</span>
<span class="ln">36</span>              <span class="mi">0</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">};</span>
<span class="ln">37</span>              <span class="mi">1</span> <span class="o">-&gt;</span> <span class="nb">exit</span><span class="p">(</span><span class="n">badVsn</span><span class="p">);</span>
<span class="ln">38</span>              <span class="mi">2</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="p">;</span>
<span class="ln">39</span>              <span class="mi">3</span> <span class="o">-&gt;</span> <span class="mi">1</span>
<span class="ln">40</span>           <span class="k">end</span><span class="p">,</span>
<span class="ln">41</span>    <span class="nv">Layer</span> <span class="o">=</span> <span class="k">case</span> <span class="nv">C</span> <span class="k">of</span>
<span class="ln">42</span>                <span class="mi">0</span> <span class="o">-&gt;</span> <span class="nb">exit</span><span class="p">(</span><span class="n">badLayer</span><span class="p">);</span>
<span class="ln">43</span>                <span class="mi">1</span> <span class="o">-&gt;</span> <span class="mi">3</span><span class="p">;</span>
<span class="ln">44</span>                <span class="mi">2</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="p">;</span>
<span class="ln">45</span>                <span class="mi">3</span> <span class="o">-&gt;</span> <span class="mi">1</span>
<span class="ln">46</span>             <span class="k">end</span><span class="p">,</span>
<span class="ln">47</span>    <span class="c">%% Protection = D,
</span><span class="ln">48</span><span class="c"></span>    <span class="nv">BitRate</span> <span class="o">=</span> <span class="n">bitrate</span><span class="p">(</span><span class="nv">Vsn</span><span class="p">,</span> <span class="nv">Layer</span><span class="p">,</span> <span class="nv">E</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
<span class="ln">49</span>    <span class="nv">SampleRate</span> <span class="o">=</span> <span class="n">samplerate</span><span class="p">(</span><span class="nv">Vsn</span><span class="p">,</span> <span class="nv">F</span><span class="p">),</span>
<span class="ln">50</span>    <span class="nv">Padding</span> <span class="o">=</span> <span class="nv">G</span><span class="p">,</span>
<span class="ln">51</span>    <span class="nv">FrameLength</span> <span class="o">=</span> <span class="n">framelength</span><span class="p">(</span><span class="nv">Layer</span><span class="p">,</span> <span class="nv">BitRate</span><span class="p">,</span> <span class="nv">SampleRate</span><span class="p">,</span> <span class="nv">Padding</span><span class="p">),</span>
<span class="ln">52</span>    <span class="k">if</span>
<span class="ln">53</span>        <span class="nv">FrameLength</span> <span class="o">&lt;</span> <span class="mi">21</span> <span class="o">-&gt;</span>
<span class="ln">54</span>            <span class="nb">exit</span><span class="p">(</span><span class="n">frameSize</span><span class="p">);</span>
<span class="ln">55</span>        <span class="n">ture</span> <span class="o">-&gt;</span>
<span class="ln">56</span>            <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">FrameLength</span><span class="p">,</span> <span class="p">{</span><span class="nv">Layer</span><span class="p">,</span><span class="nv">BitRate</span><span class="p">,</span><span class="nv">SampleRate</span><span class="p">,</span><span class="nv">Vsn</span><span class="p">,</span><span class="nv">Bits</span><span class="p">}}</span>
<span class="ln">57</span>    <span class="k">end</span><span class="p">;</span>
<span class="ln">58</span><span class="nf">decode_header</span><span class="p">(_)</span> <span class="o">-&gt;</span>
<span class="ln">59</span>    <span class="nb">exit</span><span class="p">(</span><span class="n">badHeader</span><span class="p">).</span>
</code></pre></div><p>这个例子中<code>&lt;&lt;C:4/binary,_/binary&gt;&gt;</code>需要注意，这里C是匹配了32位。</p>
</li>
<li>
<p>解包COFF数据</p>
<p>要展开这些宏，需要使用?DWORD和?LONG之类的语法。举个例子，宏?DWORD会展开成文本字面量32/unsigned-little-integer。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">DWORD</span><span class="p">,</span> <span class="mi">32</span><span class="o">/</span><span class="n">unsigned</span><span class="o">-</span><span class="n">little</span><span class="o">-</span><span class="n">integer</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">LONG</span><span class="p">,</span> <span class="mi">32</span><span class="o">/</span><span class="n">unsigned</span><span class="o">-</span><span class="n">litter</span><span class="o">-</span><span class="n">integer</span><span class="p">).</span>
<span class="ln">3</span><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">WORD</span><span class="p">,</span> <span class="mi">16</span><span class="o">/</span><span class="n">unsigned</span><span class="o">-</span><span class="n">litter</span><span class="o">-</span><span class="n">integer</span><span class="p">).</span>
<span class="ln">4</span><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">BYTE</span><span class="p">,</span> <span class="mi">8</span><span class="o">/</span><span class="n">unsigned</span><span class="o">-</span><span class="n">litter</span><span class="o">-</span><span class="n">integer</span><span class="p">).</span>
<span class="ln">5</span>  
<span class="ln">6</span><span class="nf">unpack_image_resource_directory</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">7</span>    <span class="o">&lt;&lt;</span><span class="nv">Characteristics</span> <span class="p">:</span> <span class="o">?</span><span class="nv">DWORD</span><span class="p">,</span>
<span class="ln">8</span>      <span class="nv">TimeDateStamp</span> <span class="p">:</span> <span class="o">?</span><span class="nv">DWORD</span><span class="p">,</span>
<span class="ln">9</span>      <span class="nv">MajorVersion</span><span class="p">:</span> <span class="o">?</span><span class="nv">WORD</span><span class="p">,...</span>
</code></pre></div></li>
</ul>
<h3 id="位串">位串</h3>
<ul>
<li>
<p>没有按照8位边界对齐的数据或者可变长度数据，它们的数据长度用位而不是字节来表示。</p>
</li>
<li>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="o">&gt;</span> <span class="nv">B1</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="o">&gt;&gt;</span><span class="p">.</span>
<span class="ln"> 2</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="o">&gt;&gt;</span>
<span class="ln"> 3</span><span class="o">&gt;</span> <span class="nb">byte_size</span><span class="p">(</span><span class="nv">B1</span><span class="p">).</span>
<span class="ln"> 4</span><span class="mi">1</span>
<span class="ln"> 5</span>  
<span class="ln"> 6</span><span class="o">&gt;</span> <span class="nv">B2</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">:</span><span class="mi">17</span><span class="o">&gt;&gt;</span><span class="p">.</span>
<span class="ln"> 7</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="o">&gt;&gt;</span>
<span class="ln"> 8</span><span class="o">&gt;</span> <span class="nb">byte_size</span><span class="p">(</span><span class="nv">B2</span><span class="p">).</span>
<span class="ln"> 9</span><span class="mi">3</span>
<span class="ln">10</span><span class="o">&gt;</span> <span class="nb">bit_size</span><span class="p">(</span><span class="nv">B2</span><span class="p">).</span>
<span class="ln">11</span><span class="mi">17</span>
<span class="ln">12</span>  
<span class="ln">13</span><span class="c">%% B1是一个二进制型，而B2是一个位串，因为它的长度是17位。
</span><span class="ln">14</span><span class="c">%% 我们用语法&lt;&lt;1:17&gt;&gt;构建了B2，它被打印成&lt;&lt;0,0,1:1&gt;&gt;，也就是说，作为一个二进制型字面量，它的第三个片段是一个长度为1的位串。
</span><span class="ln">15</span><span class="c">%% B2的位大小是17，而字节大小是3（这是包含该位串的二进制型的实际大小）。
</span></code></pre></div></li>
<li>
<p>位推导</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span> <span class="nv">B</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="mi">16#5f</span><span class="o">&gt;&gt;</span><span class="p">.</span>
<span class="ln">2</span><span class="o">&gt;</span> <span class="p">[</span><span class="nv">X</span> <span class="p">||</span> <span class="o">&lt;&lt;</span><span class="nv">X</span><span class="p">:</span><span class="mi">1</span><span class="o">&gt;&gt;</span> <span class="o">&lt;=</span> <span class="nv">B</span><span class="p">].</span>
<span class="ln">3</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="ln">4</span><span class="o">&gt;</span> <span class="o">&lt;&lt;</span> <span class="o">&lt;&lt;</span><span class="nv">X</span><span class="o">&gt;&gt;</span> <span class="p">||</span> <span class="o">&lt;&lt;</span><span class="nv">X</span><span class="p">:</span><span class="mi">1</span><span class="o">&gt;&gt;</span> <span class="o">&lt;=</span> <span class="nv">B</span> <span class="o">&gt;&gt;</span><span class="p">.</span>
<span class="ln">5</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;&gt;</span>
</code></pre></div></li>
</ul>
<h3 id="练习-5">练习</h3>
<p><strong>(1)</strong></p>
<blockquote>
<p>编写一个函数来反转某个二进制型里的字节顺序。</p>
</blockquote>
<p>反转的是字节顺序而不是位的顺序</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">reverseByte</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>	<span class="nb">list_to_binary</span><span class="p">(</span><span class="n">reverseByteList</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)).</span>
<span class="ln"> 3</span>	
<span class="ln"> 4</span><span class="nf">reverseByteList</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)</span> <span class="k">when</span> <span class="nb">size</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">1</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>	<span class="o">&lt;&lt;</span><span class="nv">Val</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Bin</span><span class="p">,</span>
<span class="ln"> 6</span>	<span class="nv">Val</span><span class="p">;</span>
<span class="ln"> 7</span><span class="nf">reverseByteList</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>	<span class="p">{</span><span class="nv">Bf</span><span class="p">,</span> <span class="nv">Bl</span><span class="p">}</span> <span class="o">=</span> <span class="nb">split_binary</span><span class="p">(</span><span class="nv">Bin</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
<span class="ln"> 9</span>	<span class="o">&lt;&lt;</span><span class="nv">Val</span><span class="p">:</span><span class="mi">8</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Bf</span><span class="p">,</span>
<span class="ln">10</span>	<span class="p">[</span><span class="n">reverseByteList</span><span class="p">(</span><span class="nv">Bl</span><span class="p">)</span> <span class="p">,</span> <span class="nv">Val</span><span class="p">].</span> 
<span class="ln">11</span>	
</code></pre></div><p><strong>(2)</strong></p>
<blockquote>
<p>编写一个term_to_packet(Term) -&gt; Packet函数，通过调用term_to_binary(Term)来生成并返回一个二进制型，它内含长度为4个字节的包头N，后跟N个字节的数据。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">term_to_packet</span><span class="p">(</span><span class="nv">Term</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="nv">B</span> <span class="o">=</span> <span class="nb">term_to_binary</span><span class="p">(</span><span class="nv">Term</span><span class="p">),</span>
<span class="ln">3</span>	<span class="o">&lt;&lt;</span><span class="nv">Head</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Data</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">B</span><span class="p">,</span>
<span class="ln">4</span>	<span class="p">{</span><span class="n">packet</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="nv">Data</span><span class="p">}.</span>
</code></pre></div><p><strong>(3)</strong></p>
<blockquote>
<p>编写一个反转函数 packet_to_term(Packet) -&gt; Term，使它成为前一个函数的逆向函数。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">packet_to_term</span><span class="p">(</span><span class="nv">Packet</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="p">{_,</span> <span class="nv">Head</span><span class="p">,</span> <span class="nv">Data</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Packet</span><span class="p">,</span>
<span class="ln">3</span>	<span class="nb">binary_to_term</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Head</span><span class="p">,</span> <span class="nv">Data</span><span class="o">&gt;&gt;</span><span class="p">).</span>
</code></pre></div><p><strong>(4)</strong></p>
<blockquote>
<p>按照4.1.3节的样式编写一些测试，测一下之前的两个函数是否能正确地把数据类型编码成数据包（packet），以及通过解码数据包来复原最初的数据类型。</p>
</blockquote>
<p>不知道如何构造数据包，这道题就算了。</p>
<p><strong>(5)</strong></p>
<blockquote>
<p>编写一个函数来反转某个二进制型所包含的位。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">reversebit</span><span class="p">(</span><span class="nv">Bit</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="nv">Res</span> <span class="o">=</span> <span class="p">[</span> <span class="nv">X</span> <span class="p">||</span> <span class="o">&lt;&lt;</span><span class="nv">X</span><span class="p">:</span><span class="mi">1</span><span class="o">&gt;&gt;</span> <span class="o">&lt;=</span> <span class="nv">Bit</span> <span class="p">],</span>
<span class="ln">3</span>	<span class="nb">list_to_binary</span><span class="p">(</span><span class="nn">list</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">Res</span><span class="p">)).</span>
</code></pre></div><h2 id="第8章-erlang顺序编程补遗">第8章 Erlang顺序编程补遗</h2>
<h3 id="书本内容-1">书本内容</h3>
<p>本章知识比较杂乱，一些地方没有记，需要时翻原书。</p>
<ol>
<li>
<p>内置函数<code>apply(Mod, Func, [Arg1, Arg2, ..., ArgN])</code>会将模块Mod里的Func函数应用到Arg1, Arg2, &hellip; ArgN这些参数上。</p>
<p>所有的Erlang内置函数也可以通过apply进行调用，方法是假定它们都属于erlang模块。</p>
<p>apply的Mod参数不必非得是一个原子，也可以是一个元组。这种机制可以用来创建“有状态的模块”（将在24.3节里讨论）和“适配器模式”（将在24.4节里讨论）。</p>
</li>
<li>
<p>算术表达式</p>
<p>数字的意思是此参数可以是整数或浮点数</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>描述</th>
<th>参数类型</th>
<th>优先级</th>
</tr>
</thead>
<tbody>
<tr>
<td>+ X</td>
<td>+ X</td>
<td>数字</td>
<td>1</td>
</tr>
<tr>
<td>- X</td>
<td>- X</td>
<td>数字</td>
<td>1</td>
</tr>
<tr>
<td>X * Y</td>
<td>X * Y</td>
<td>数字</td>
<td>2</td>
</tr>
<tr>
<td>X / Y</td>
<td>X / Y（浮点除法）</td>
<td>数字</td>
<td>2</td>
</tr>
<tr>
<td>bnot X</td>
<td>对X执行按位取反（bitwise not）</td>
<td>整数</td>
<td>2</td>
</tr>
<tr>
<td>X div Y</td>
<td>X被Y整除</td>
<td>整数</td>
<td>2</td>
</tr>
<tr>
<td>X rem Y</td>
<td>X除以Y的整数余数</td>
<td>整数</td>
<td>2</td>
</tr>
<tr>
<td>X band Y</td>
<td>对X和Y执行按位与（bitwise and）</td>
<td>整数</td>
<td>2</td>
</tr>
<tr>
<td>X + Y</td>
<td>X + Y</td>
<td>数字</td>
<td>3</td>
</tr>
<tr>
<td>X - Y</td>
<td>X - Y</td>
<td>数字</td>
<td>3</td>
</tr>
<tr>
<td>X bor Y</td>
<td>对X和Y执行按位或（bitwise or）</td>
<td>整数</td>
<td>3</td>
</tr>
<tr>
<td>X bxor Y</td>
<td>对X和Y执行按位异或（bitwise xor）</td>
<td>整数</td>
<td>3</td>
</tr>
<tr>
<td>X bsl N</td>
<td>把X向左算术位移（arithmetic bitshift）N位</td>
<td>整数</td>
<td>3</td>
</tr>
<tr>
<td>X bsr N</td>
<td>把X向右算术位移N位</td>
<td>整数</td>
<td>3</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>一个函数的元数（arity）是该函数所拥有的参数数量。在Erlang里，同一模块里的两个名称相同、元数不同的函数是完全不同的函数。除了碰巧使用同一个名称外，它们之间毫不相关。</p>
</li>
<li>
<p>模块属性的语法是-AtomTag(&hellip;)，它们被用来定义文件的某些属性。（注意：-record(&hellip;)和-include(&hellip;)有着类似的语法，但是不算模块属性。）</p>
</li>
<li>
<p><code>-compile(export_all)</code>.这个编译器选项经常会在调试程序时用到。它会导出模块里的所有函数，无需再显式使用-export标识了。</p>
</li>
<li>
<p>块表达式用于以下情形：代码某处的Erlang语法要求单个表达式，但我们想使用一个表达式序列。</p>
<p>在一个形式为[E || &hellip;]的列表推导中，语法要求E是单个表达式，但我们也许想要在E里做不止一件事情。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="k">begin</span>
<span class="ln">2</span>	<span class="nv">Expr1</span><span class="p">,</span>
<span class="ln">3</span>	<span class="nv">Expr2</span><span class="p">,</span>
<span class="ln">4</span>	<span class="p">...</span>
<span class="ln">5</span>	<span class="nv">ExprN</span>
<span class="ln">6</span><span class="k">end</span>
</code></pre></div></li>
<li>
<p>Erlang没有单独的布尔值类型。不过原子true和false具有特殊的含义，可以用来表示布尔值。</p>
</li>
<li>
<p>布尔表达式not，and，or，xor</p>
</li>
<li>
<p>Erlang里的注释从一个百分号字符（%）开始，一直延伸到行尾。Erlang没有块注释。Erlang里的注释从一个百分号字符（%）开始，一直延伸到行尾。Erlang没有块注释。</p>
</li>
<li>
<p>动态代码载入每当调用someModule:someFunction(&hellip;)时，调用的总是最新版模块里的<strong>最新版函数</strong>，哪怕当代码在模块里运行时重新编译了该模块也是如此。</p>
<p>在任一时刻，Erlang允许一个模块的两个版本同时运行：当前版和旧版。重新编译某个模块时，任何运行旧版代码的进程都会被终止，当前版成为旧版，新编译的版本则成为当前版。</p>
</li>
<li>
<p>查看some_module.erl模块的预处理结果: <code>erlc -P some_module.erl</code> 这会生成一个名为some_module.P的清单文件。</p>
</li>
<li>
<p>可以在字符串和带引号的原子里使用转义序列来输入任何不可打印的字符。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="o">&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;</span><span class="si">~w~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#34;</span><span class="se">\b\d\e\f\n\r\s\t\v</span><span class="s">&#34;</span><span class="p">]).</span>
<span class="ln">2</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">]</span>
<span class="ln">3</span><span class="c">% 格式字符串里的~w是指忠实地打印列表，而不对输出结果进行美化。
</span></code></pre></div></li>
<li>
<p>在Erlang里，任何可以执行并生成一个值的事物都被称为表达式（expression）。</p>
<p>表达式序列（expression sequence）是一系列由逗号分隔的表达式。它们在-&gt;箭头之后随处可见。表达式序列E1, E2,&hellip;, En的值被定义为序列最后那个表达式的值，而该表达式在计算时可以使用E1, E2等表达式所创建的绑定。</p>
</li>
<li>
<p>包含文件<code>-include(Filename)</code></p>
<p>包含库的头文件<code>-include_lib(Name)</code></p>
<p>按照Erlang的惯例，包含文件的扩展名是.hrl。包含文件里经常会有记录的定义。如果许多模块需要共享通用的记录定义，就会把它们放到包含文件里，再由所有需要这些定义的模块包含此文件。</p>
</li>
<li>
<p>++和&ndash;是用于列表添加和移除的中缀操作符。
A ++ B使A和B相加（也就是附加）。
A &ndash; B从列表A中移除列表B。移除的意思是B中所有元素都会从A里面去除。请注意：如果符号X在B里只出现了K次，那么A只会移除前K个X。</p>
<p>++也可以用在模式里。在匹配字符串时，可以编写如下模式：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">f</span><span class="p">(</span><span class="s">&#34;begin&#34;</span> <span class="o">++</span> <span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span><span class="p">...</span>
</code></pre></div><p>模式会扩展成[$b,$e,$g,$i,$n|T]。</p>
</li>
<li>
<p>宏的写法：</p>
<p><code>define(Constant, Replacement).</code></p>
<p><code>define(Func(Var1, Var2,..., Var), Replacement).</code></p>
<p>当Erlang的预处理器epp碰到一个?MacroName形式的表达式时，就会展开这个宏。宏定义里出现的变量会匹配对应宏调用位置的完整形式。</p>
</li>
<li>
<p>还有一些预定义宏提供了关于当前模块的信息。列举如下：</p>
<ul>
<li>?FILE展开成当前的文件名；</li>
<li>?MODULE展开成当前的模块名；</li>
<li>?LINE展开成当前的行号。</li>
</ul>
</li>
<li>
<p>宏控制流。模块的内部支持下列指令，可以用它们来控制宏的展开。</p>
<ul>
<li><code>-undef(Macro).</code> 取消宏的定义，此后就无法调用这个宏了。</li>
<li><code>-ifdef(Macro). </code>仅当Macro有过定义时才执行后面的代码。</li>
<li><code>-ifndef(Macro).</code> 仅当Macro未被定义时才执行后面的代码。</li>
<li><code>-else.</code> 可用于ifdef或ifndef语句之后。如果条件为否，else后面的语句就会被执行。</li>
<li><code>-endif. </code>标记ifdef或ifndef语句的结尾。</li>
</ul>
</li>
<li>
<p>用宏实现DEBUG：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">m1</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">loop</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>    
<span class="ln"> 4</span><span class="p">-</span><span class="ni">ifdef</span><span class="p">(</span><span class="n">debug_flag</span><span class="p">),</span>
<span class="ln"> 5</span><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">DEBUG</span><span class="p">(</span><span class="nv">X</span><span class="p">),</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;DEBUG </span><span class="si">~p</span><span class="s">:</span><span class="si">~p</span><span class="s"> </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="n">m</span> <span class="p">[</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span><span class="o">?</span><span class="nv">LINE</span><span class="p">,</span><span class="nv">X</span><span class="p">])).</span>
<span class="ln"> 6</span><span class="c">% io:format(String, [Args])会根据String里的格式信息在Erlang shell 中打印出[Args]所含的变量。
</span><span class="ln"> 7</span><span class="c">% 格式编码用一个~符号作为前缀。
</span><span class="ln"> 8</span><span class="c">% ~p是美化打印（pretty print）的简称，~n则会生成一个新行。
</span><span class="ln"> 9</span><span class="c"></span><span class="p">-</span><span class="ni">else</span><span class="p">.</span>
<span class="ln">10</span><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">DEBUG</span><span class="p">(</span><span class="nv">X</span><span class="p">),</span> <span class="n">void</span><span class="p">).</span>
<span class="ln">11</span><span class="p">-</span><span class="ni">endif</span>
<span class="ln">12</span>    
<span class="ln">13</span><span class="nf">loop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">14</span>    <span class="n">done</span><span class="p">;</span>
<span class="ln">15</span><span class="nf">loop</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">16</span>    <span class="o">?</span><span class="nv">DEBUG</span><span class="p">(</span><span class="nv">X</span><span class="p">),</span>
<span class="ln">17</span>    <span class="n">loop</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span>
</code></pre></div><p>为了启用这个宏，我们在编译代码时设置了debug_flag。具体做法是给c/2添加一个额外参数如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>&gt; c(m1, {d,debug_flag}).
<span class="ln">2</span>{ok,m1}
<span class="ln">3</span>&gt; m1:loop(4)
<span class="ln">4</span>DEBUG m1:13 4
<span class="ln">5</span>DEBUG m1:13 3
<span class="ln">6</span>DEBUG m1:13 2
<span class="ln">7</span>DEBUG m1:13 1
<span class="ln">8</span>done
</code></pre></div></li>
<li>
<p>模式的匹配操作符（把这个模式指派给一个临时变量Z）</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">func</span><span class="p">([{</span><span class="n">tag</span><span class="p">,</span> <span class="p">{</span><span class="n">one</span><span class="p">,</span><span class="nv">A</span><span class="p">}</span><span class="o">=</span><span class="nv">Z1</span><span class="p">,</span> <span class="nv">B</span><span class="p">}</span><span class="o">=</span><span class="nv">Z2</span><span class="p">|</span><span class="nv">T</span><span class="p">])</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="p">...</span>
<span class="ln">3</span>	<span class="p">...</span><span class="n">f</span><span class="p">(...,</span><span class="nv">Z2</span><span class="p">,...),</span>
<span class="ln">4</span>	<span class="p">...</span><span class="n">g</span><span class="p">(...,</span><span class="nv">Z1</span><span class="p">,...),</span>
</code></pre></div></li>
<li>
<p>整数可以有三种不同的写法：</p>
<ul>
<li>传统写法</li>
<li>K进制整数 <code>K#Digits</code></li>
<li>$ 写法：$C这种写法代表了ASCII字符C的整数代码。</li>
</ul>
</li>
<li>
<p>进程字典：每个Erlang进程都有一个被称为进程字典（process dictionary）的私有数据存储区域。进程字典是一个关联数组（在其他语言里可能被称作map、hashmap或者散列表），它由若干个键和值组成。每个键只有一个值。</p>
<p>API：</p>
<ul>
<li>
<p><code>put(Key,Value) -&gt; OldValue.</code></p>
<p>给进程字典添加一个Key, Value组合。put的值是OldValue，也就是Key之前关联的值。如果没有之前的值，就返回原子undefined。</p>
</li>
<li>
<p><code>get(Key) -&gt; Value.</code></p>
<p>查找Key的值。如果字典里存在Key, Value组合就返回Value，否则返回原子undefined。</p>
</li>
<li>
<p><code>get() -&gt; [{Key,Value}].</code></p>
<p>返回整个字典，形式是一个由{Key,Value}元组所构成的列表。</p>
</li>
<li>
<p><code>get_keys(Value) -&gt;[Key].</code></p>
<p>返回一个列表，内含字典里所有值为Value的键。</p>
</li>
<li>
<p><code>erase(Key) -&gt; Value.</code></p>
<p>返回Key的关联值，如果不存在则返回原子undefined。最后，删除Key的关联值。</p>
</li>
<li>
<p><code>erase() -&gt; [{Key,Value}].</code></p>
<p>删除整个进程字典。返回值是一个由{Key,Value}元组所构成的列表，代表了字典删除之前的状态。</p>
</li>
</ul>
</li>
<li>
<p>引用（reference）是一种全局唯一的Erlang数据类型。它们由内置函数erlang:make_ref()创建。引用的用途是创建独一无二的标签，把它存放在数据里并在后面用于比较是否相等。</p>
</li>
<li>
<p>短路布尔表达式（short-circuit boolean expression）是一种只在必要时才对参数求值的表达式。在对应的布尔表达式里（A or B和A and B），两边的参数总会被执行，即使表达式的真值只需要第一个表达式的值就能确定也是如此。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nv">Expr1</span> <span class="ow">orelse</span> <span class="nv">Expr2</span>
<span class="ln">2</span><span class="c">% 它会首先执行Expr1。如果Expr1的执行结果是true，Expr2就不再执行。如果Expr1的执行结果是false，则会执行Expr2。
</span><span class="ln">3</span><span class="c"></span>    
<span class="ln">4</span><span class="nv">Expr1</span> <span class="ow">andalso</span> <span class="nv">Expr2</span>
<span class="ln">5</span><span class="c">% 它会首先执行Expr1。如果Expr1的执行结果是true，则会执行Expr2。如果Expr1的执行结果是false，Expr2就不再执行。
</span></code></pre></div></li>
<li>
<p>比较数据类型</p>
<ul>
<li>
<table>
<thead>
<tr>
<th>操作符</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>X &gt; Y</td>
<td>X大于Y</td>
</tr>
<tr>
<td>X &lt; Y</td>
<td>X小于Y</td>
</tr>
<tr>
<td>X =&lt; Y</td>
<td>X等于或小于Y</td>
</tr>
<tr>
<td>X &gt;= Y</td>
<td>X大于或等于Y</td>
</tr>
<tr>
<td>X == Y</td>
<td>X等于Y</td>
</tr>
<tr>
<td>X /= Y</td>
<td>X不等于Y</td>
</tr>
<tr>
<td>X =:= Y</td>
<td>X与Y完全相同</td>
</tr>
<tr>
<td>X =/= Y</td>
<td>X与Y不完全相同</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>数据类型做了全排序（total ordering）的定义：</p>
<p><code>number &lt; atom &lt; reference &lt; fun &lt; port &lt; pid &lt; tuple(record) &lt; map &lt; list &lt; binary</code></p>
</li>
<li>
<p>所有的数据类型比较操作符（除了=:=和=/=）在参数全为数字时具有以下行为:</p>
<p>如果一个参数是整数而另一个是浮点数，那么整数会先转换成浮点数，然后再进行比较。</p>
<p>如果两个参数都是整数或者都是浮点数，就会“按原样”使用，也就是不做转换。</p>
</li>
<li>
<p>如果==的参数不包含任何浮点数的话，那么这两个操作符的行为就是相同的。</p>
</li>
<li>
<p>函数的子句匹配总是意味着精确的模式匹配，所以如果定义了一个fun F =fun(12) -&gt; &hellip; end，那么试图执行F(12.0)就会出错。</p>
</li>
</ul>
</li>
<li>
<p>下划线变量,<code>_VarName</code> 这种特殊语法代表一个常规变量（normalvariable），而不是匿名变量。</p>
<p>下划线变量有两种主要的用途:</p>
<ul>
<li>
<p>命名一个我们不打算使用的变量。例如，相比open(File, _)，open(File, _Mode)这种写法能让程序的可读性更高。</p>
</li>
<li>
<p>用于调试:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">some_func</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="p">{</span><span class="nv">P</span><span class="p">,</span><span class="nv">Q</span><span class="p">}</span> <span class="o">=</span> <span class="n">some_other_func</span><span class="p">(</span><span class="nv">X</span><span class="p">),</span>
<span class="ln">3</span>	<span class="c">%% io:format(&#34;Q = ~p~n&#34;, [Q]),
</span><span class="ln">4</span><span class="c"></span>	<span class="nv">P</span><span class="p">.</span>
<span class="ln">5</span><span class="c">% 如果编译它，编译器就会生成一个变量Q未使用的警告。
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">some_func</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>	<span class="p">{</span><span class="nv">P</span><span class="p">,_</span><span class="nv">Q</span><span class="p">}</span> <span class="o">=</span> <span class="n">some_other_func</span><span class="p">(</span><span class="nv">X</span><span class="p">),</span>
<span class="ln">3</span>	<span class="c">%% io:format(&#34;_Q = ~p~n&#34;, [_Q]),
</span><span class="ln">4</span><span class="c"></span>	<span class="nv">P</span><span class="p">.</span>
<span class="ln">5</span><span class="c">% 编译器也不会再抱怨了。
</span></code></pre></div><p>一般来说，当某个变量在子句里只使用了一次时，编译器会生成一个警告，因为这通常是出错的信号。但如果这个只用了一次的变量以下划线开头，就不会有错误消息。</p>
</li>
</ul>
</li>
</ol>
<h3 id="练习-6">练习</h3>
<p><strong>(2)</strong></p>
<blockquote>
<p>code:all_loaded()命令会返回一个由{Mod,File}对构成的列表，内含所有Erlang系统载入的模块。使用内置函数Mod:module_info()了解这些模块。编写一些函数来找出哪个模块导出的函数最多，以及哪个函数名最常见。编写一个函数来找出所有不带歧义的函数名，也就是那些只在一个模块里出现过的函数名。</p>
</blockquote>
<p>我们从code:all_loaded()开始：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>2&gt; code:all_loaded().
<span class="ln"> 2</span>[{erpc,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/erpc.beam&#34;},
<span class="ln"> 3</span> {rpc,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/rpc.beam&#34;},
<span class="ln"> 4</span> {os,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/os.beam&#34;},
<span class="ln"> 5</span> {inet_parse,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/inet_parse.beam&#34;},
<span class="ln"> 6</span> {prim_inet,preloaded},
<span class="ln"> 7</span> {erts_dirty_process_signal_handler,preloaded},
<span class="ln"> 8</span> {socket_registry,preloaded},
<span class="ln"> 9</span> {error_logger,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/error_logger.beam&#34;},
<span class="ln">10</span> {logger_proxy,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/logger_proxy.beam&#34;},
<span class="ln">11</span> {logger_backend,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/logger_backend.beam&#34;},
<span class="ln">12</span> {proplists,&#34;/usr/lib/erlang/lib/stdlib-4.3.1.3/ebin/proplists.beam&#34;},
<span class="ln">13</span> {gb_trees,&#34;/usr/lib/erlang/lib/stdlib-4	.3.1.3/ebin/gb_trees.beam&#34;},
<span class="ln">14</span> {logger_handler_watcher,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/logger_handler_watcher.beam&#34;},
<span class="ln">15</span> {logger_sup,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/logger_sup.beam&#34;},
<span class="ln">16</span> {erl_parse,&#34;/usr/lib/erlang/lib/stdlib-4.3.1.3/ebin/erl_parse.beam&#34;},
<span class="ln">17</span> {init,preloaded},
<span class="ln">18</span> {erl_features,&#34;/usr/lib/erlang/lib/stdlib-4.3.1.3/ebin/erl_features.beam&#34;},
<span class="ln">19</span> {application_controller,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/application_controller.beam&#34;},
<span class="ln">20</span> {user_sup,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/user_sup.beam&#34;},
<span class="ln">21</span> {io,&#34;/usr/lib/erlang/lib/stdlib-4.3.1.3/ebin/io.beam&#34;},
<span class="ln">22</span> {edlin,&#34;/usr/lib/erlang/lib/stdlib-4.3.1.3/ebin/edlin.beam&#34;},
<span class="ln">23</span> {erl_distribution,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/erl_distribution.beam&#34;},
<span class="ln">24</span> {prim_socket,preloaded},
<span class="ln">25</span> {logger_filters,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/logger_filters.beam&#34;},
<span class="ln">26</span> {io_lib,&#34;/usr/lib/erlang/lib/stdlib-4.3.1.3/ebin/io_lib.beam&#34;},
<span class="ln">27</span> {error_handler,&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/error_handler.beam&#34;},
<span class="ln">28</span> {prim_buffer,preloaded},
<span class="ln">29</span> {zlib,...},
<span class="ln">30</span> {...}|...]
</code></pre></div><p>返回的以一个列表，里面都是模块名+位置组成的元组，我们只需要模块名即可。</p>
<p>拿到一个模块名，我们就调用Mod:module_info()：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>4&gt; erlang:module_info().
<span class="ln"> 2</span>[{module,erlang},
<span class="ln"> 3</span> {exports,[{binary_to_atom,1},
<span class="ln"> 4</span>           {binary_to_existing_atom,1},
<span class="ln"> 5</span>           {binary_to_integer,1},
<span class="ln"> 6</span>           {binary_to_integer,2},
<span class="ln"> 7</span>           {check_process_code,2},
<span class="ln"> 8</span>           {check_process_code,3},
<span class="ln"> 9</span>           {alias,0},
<span class="ln">10</span>           {garbage_collect,1},
<span class="ln">11</span>           {garbage_collect,2},
<span class="ln">12</span>           {garbage_collect_message_area,0},
<span class="ln">13</span>           {is_alive,0},
<span class="ln">14</span>           {list_to_integer,2},
<span class="ln">15</span>           {process_display,2},
<span class="ln">16</span>           {process_flag,3},
<span class="ln">17</span>           {setnode,3},
<span class="ln">18</span>           {suspend_process,2},
<span class="ln">19</span>           {suspend_process,1},
<span class="ln">20</span>           {trace_pattern,2},
<span class="ln">21</span>           {spawn,2},
<span class="ln">22</span>           {spawn_link,2},
<span class="ln">23</span>           {spawn_monitor,2},
<span class="ln">24</span>           {spawn_monitor,3},
<span class="ln">25</span>           {spawn_opt,2},
<span class="ln">26</span>           {spawn_opt,...},
<span class="ln">27</span>           {...}|...]},
<span class="ln">28</span> {attributes,[]},
<span class="ln">29</span> {compile,[]},
<span class="ln">30</span> {md5,&lt;&lt;192,119,22,112,208,85,113,68,95,199,120,159,236,
<span class="ln">31</span>        64,31,14&gt;&gt;}]
<span class="ln">32</span>
</code></pre></div><p>所以每一个调用又返回一个列表，我们需要的是{export,[]}这个，里面全是函数名和元数，我们拿到这些东西就可以进行处理了。</p>
<p>三个问题：</p>
<ol>
<li>找出哪个模块导出的函数最多</li>
<li>哪个函数名最常见</li>
<li>找出所有不带歧义的函数名，也就是那些只在一个模块里出现过的函数名</li>
</ol>
<p>先就做到这程度。编程里面涉及到严重的问题，普通循环和遍历到底该怎么写？还有Erlang中的变量不可再绑定这也是个问题，只能将我们想要的值输入或者输出了。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">analyse_loaded</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">get_max_count</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="c">% code:all_loaded/0本身返回会不完全，这一点我们不处理
</span><span class="ln"> 5</span><span class="c"></span><span class="nf">init</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>	<span class="c">% 拿到所有模块
</span><span class="ln"> 7</span><span class="c"></span>	<span class="nv">M</span> <span class="o">=</span> <span class="p">[</span> <span class="nv">Module</span> <span class="p">||</span> <span class="p">{</span><span class="nv">Module</span><span class="p">,</span> <span class="p">_</span><span class="nv">Location</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nn">code</span><span class="p">:</span><span class="nf">all_loaded</span><span class="p">()],</span>
<span class="ln"> 8</span>	<span class="c">% 使用apply拿到每个模块导出的函数信息
</span><span class="ln"> 9</span><span class="c"></span>	<span class="n">get_func</span><span class="p">(</span><span class="nv">M</span><span class="p">).</span>
<span class="ln">10</span>	
<span class="ln">11</span>	
<span class="ln">12</span><span class="nf">get_func</span><span class="p">([])</span> <span class="o">-&gt;</span>
<span class="ln">13</span>	<span class="p">[];</span>
<span class="ln">14</span><span class="nf">get_func</span><span class="p">(</span><span class="nv">M</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">15</span>	<span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">]</span> <span class="o">=</span> <span class="nv">M</span><span class="p">,</span>
<span class="ln">16</span>	<span class="c">% 由于module_info格式是固定的，可以这样做不过有点丑
</span><span class="ln">17</span><span class="c"></span>	<span class="p">[_|</span><span class="nv">Other</span><span class="p">]</span><span class="o">=</span> <span class="nb">apply</span><span class="p">(</span><span class="nv">H</span><span class="p">,</span> <span class="n">module_info</span><span class="p">,[]),</span>
<span class="ln">18</span>	<span class="p">[{</span><span class="n">exports</span><span class="p">,</span><span class="nv">Func</span><span class="p">}</span> <span class="p">|</span> <span class="p">_]</span> <span class="o">=</span> <span class="nv">Other</span><span class="p">,</span>
<span class="ln">19</span>	<span class="c">% 这样做会多一个列表符号
</span><span class="ln">20</span><span class="c"></span>	<span class="c">% Func = [ B || {A,B} &lt;- apply(H, module_info,[]), A =:= exports],
</span><span class="ln">21</span><span class="c"></span>	<span class="p">[{</span><span class="nv">H</span><span class="p">,</span><span class="nv">Func</span><span class="p">}|</span><span class="n">get_func</span><span class="p">(</span><span class="nv">T</span><span class="p">)].</span>
<span class="ln">22</span>	
<span class="ln">23</span>	
<span class="ln">24</span><span class="c">% 处理数目问题
</span><span class="ln">25</span><span class="c"></span><span class="nf">get_max_count</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">26</span>	<span class="nv">Number</span> <span class="o">=</span> <span class="p">[</span><span class="nb">size</span><span class="p">(</span><span class="nb">list_to_tuple</span><span class="p">(</span><span class="nv">Func</span><span class="p">))</span> <span class="p">||</span> <span class="p">{</span><span class="nv">Module</span><span class="p">,</span> <span class="nv">Func</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="n">init</span><span class="p">()],</span>
<span class="ln">27</span>	<span class="nn">lists</span><span class="p">:</span><span class="nf">max</span><span class="p">(</span><span class="nv">Number</span><span class="p">).</span>
<span class="ln">28</span>		
<span class="ln">29</span>	
</code></pre></div><h2 id="第9章-类型">第9章 类型</h2>
<h3 id="erlang-的类型表示法">Erlang 的类型表示法</h3>
<p>1.语法</p>
<ul>
<li>
<p><code>T1 :: A|B|C...</code></p>
<p>类型定义可以使用的非正式语法。T1被定义为A、B或C其中之一。</p>
</li>
<li>
<p><code>type NewTypeName(TVar1, TVar2, ..., TVarN) :: Type.</code></p>
<p>定义新的类型可以使用语法。TVar1至TVarN是可选的类型变量，Type是一个类型表达式。</p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">spec</span> <span class="n">plan_route</span><span class="p">(</span><span class="n">point</span><span class="p">(),</span><span class="n">point</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">route</span><span class="p">().</span>
<span class="ln"> 2</span><span class="c">% 如果调用plan_route/2函数时使用了两个类型为point()的参数，此函数就会返回一个类型为route()的对象。
</span><span class="ln"> 3</span><span class="c"></span><span class="p">-</span><span class="ni">type</span> <span class="n">direction</span><span class="p">()</span> <span class="p">::</span> <span class="n">north</span> <span class="p">|</span> <span class="n">south</span> <span class="p">|</span> <span class="n">east</span> <span class="p">|</span> <span class="n">west</span><span class="p">.</span>
<span class="ln"> 4</span><span class="c">% 引入一个名为direction()的新类型，它的值是下列原子之一：north、south、east或west。
</span><span class="ln"> 5</span><span class="c"></span><span class="p">-</span><span class="ni">type</span> <span class="n">point</span> <span class="p">()</span> <span class="p">::</span> <span class="p">{</span><span class="n">integer</span><span class="p">(),</span><span class="n">integer</span><span class="p">()}.</span>
<span class="ln"> 6</span><span class="c">% 指point()类型是一个包含两个整数的元组（integer()是预定义类型）。
</span><span class="ln"> 7</span><span class="c"></span><span class="p">-</span><span class="ni">type</span> <span class="n">route</span><span class="p">()</span> <span class="p">::</span> <span class="p">[{</span><span class="n">go</span><span class="p">,</span><span class="n">direction</span><span class="p">(),</span><span class="n">integer</span><span class="p">()}].</span>
<span class="ln"> 8</span><span class="c">% 将route()类型定义为一个由三元组（3-tuple）构成的列表，每个元组都包含一个原子go，一个类型为direction的对象和一个整数。[X]这种表示法的意思是一个由X类型构成的列表。
</span><span class="ln"> 9</span><span class="c"></span>
<span class="ln">10</span>
<span class="ln">11</span><span class="p">-</span><span class="ni">type</span> <span class="n">onOff</span><span class="p">()</span> <span class="p">::</span> <span class="n">on</span> <span class="p">|</span> <span class="n">off</span><span class="p">.</span>
<span class="ln">12</span><span class="p">-</span><span class="ni">type</span> <span class="n">person</span><span class="p">()</span> <span class="p">::</span> <span class="p">{</span><span class="n">person</span><span class="p">,</span> <span class="n">name</span><span class="p">(),</span> <span class="n">age</span><span class="p">()}.</span>
<span class="ln">13</span><span class="p">-</span><span class="ni">type</span> <span class="n">people</span><span class="p">()</span> <span class="p">::</span> <span class="p">[</span><span class="n">person</span><span class="p">()].</span>
<span class="ln">14</span><span class="p">-</span><span class="ni">type</span> <span class="n">name</span><span class="p">()</span> <span class="p">::</span> <span class="p">{</span><span class="n">firstname</span><span class="p">,</span> <span class="n">string</span><span class="p">()}.</span>
<span class="ln">15</span><span class="p">-</span><span class="ni">type</span> <span class="n">age</span><span class="p">()</span> <span class="p">::</span> <span class="n">integer</span><span class="p">().</span>
<span class="ln">16</span><span class="p">-</span><span class="ni">type</span> <span class="n">dict</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Val</span><span class="p">)</span> <span class="p">::</span> <span class="p">[{</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Val</span><span class="p">}].</span>
</code></pre></div><p>2.预定义类型</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">type</span> <span class="n">term</span><span class="p">()</span> <span class="p">::</span> <span class="n">any</span><span class="p">().</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">type</span> <span class="n">boolean</span><span class="p">()</span> <span class="p">::</span> <span class="n">true</span> <span class="p">|</span> <span class="n">false</span><span class="p">.</span>
<span class="ln"> 3</span><span class="p">-</span><span class="ni">type</span> <span class="n">byte</span><span class="p">()</span> <span class="p">::</span> <span class="mi">0</span><span class="p">..</span><span class="mi">255</span><span class="p">.</span>
<span class="ln"> 4</span><span class="p">-</span><span class="ni">type</span> <span class="n">char</span><span class="p">()</span> <span class="p">::</span> <span class="mi">0</span><span class="p">..</span><span class="mi">16#10ffff</span><span class="p">.</span>
<span class="ln"> 5</span><span class="p">-</span><span class="ni">type</span> <span class="n">number</span><span class="p">()</span> <span class="p">::</span> <span class="n">integer</span><span class="p">()</span> <span class="p">|</span> <span class="nb">float</span><span class="p">().</span>
<span class="ln"> 6</span><span class="p">-</span><span class="ni">type</span> <span class="n">list</span><span class="p">()</span> <span class="p">::</span> <span class="p">[</span><span class="n">any</span><span class="p">()].</span>
<span class="ln"> 7</span><span class="p">-</span><span class="ni">type</span> <span class="n">maybe_improper_list</span><span class="p">()</span> <span class="p">::</span> <span class="n">maybe_improper_list</span><span class="p">(</span><span class="n">any</span><span class="p">(),</span><span class="n">any</span><span class="p">()).</span>
<span class="ln"> 8</span><span class="p">-</span><span class="ni">type</span> <span class="n">maybe_improper_list</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="p">::</span> <span class="n">maybe_imperper_list</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span><span class="n">any</span><span class="p">()).</span>
<span class="ln"> 9</span><span class="p">-</span><span class="ni">type</span> <span class="n">string</span><span class="p">()</span> <span class="p">::</span> <span class="p">[</span><span class="n">char</span><span class="p">()].</span>
<span class="ln">10</span><span class="p">-</span><span class="ni">type</span> <span class="n">nonempty_string</span><span class="p">()</span> <span class="p">::</span> <span class="p">[</span><span class="n">char</span><span class="p">(),...].</span>
<span class="ln">11</span><span class="p">-</span><span class="ni">type</span> <span class="n">module</span><span class="p">()</span> <span class="p">::</span><span class="nf">atom</span><span class="p">().</span>
<span class="ln">12</span><span class="p">-</span><span class="ni">type</span> <span class="n">mfa</span><span class="p">()</span> <span class="p">::</span> <span class="p">{</span><span class="n">atom</span><span class="p">(),</span><span class="n">atom</span><span class="p">(),</span> <span class="n">atom</span><span class="p">()}.</span>
<span class="ln">13</span><span class="p">-</span><span class="ni">type</span> <span class="nb">node</span><span class="p">()</span> <span class="p">::</span> <span class="n">atom</span><span class="p">().</span>
<span class="ln">14</span><span class="p">-</span><span class="ni">type</span> <span class="n">timeout</span><span class="p">()</span> <span class="p">::</span> <span class="n">infinity</span> <span class="p">|</span> <span class="n">non_neg_integer</span><span class="p">().</span>
<span class="ln">15</span><span class="p">-</span><span class="ni">type</span> <span class="n">no_return</span><span class="p">()</span> <span class="p">::</span> <span class="n">none</span><span class="p">().</span>
</code></pre></div><ul>
<li><code>..</code> 表示范围。</li>
<li>maybe_improper_list用于指定带有非空（non-nil）最终列表尾的列表类型。这样的列表很少会用到，但是指定它们的类型是可能的！</li>
<li>non_neg_integer()是一个非负的整数</li>
<li>pos_integer()是一个正整数</li>
<li>neg_integer()是一个负整数。</li>
<li>[X,&hellip;]这种表示法的意思是一个由X类型<strong>构成</strong>的非空列表（可能0也可能很多）。</li>
</ul>
<p>3.指定函数的输入输出类型</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">spec</span> <span class="n">functionName</span><span class="p">(</span><span class="nv">T1</span><span class="p">,</span> <span class="nv">T2</span><span class="p">,</span> <span class="p">...,</span> <span class="nv">Tn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Tret</span> <span class="k">when</span>
<span class="ln">2</span>	<span class="nv">Ti</span> <span class="p">::</span> <span class="nv">Typei</span><span class="p">,</span>
<span class="ln">3</span>	<span class="nv">Tj</span> <span class="p">::</span> <span class="nv">Typej</span><span class="p">,</span>
<span class="ln">4</span>	<span class="p">...</span>
</code></pre></div><p>T1, T2,&hellip;, Tn描述了某个函数的参数类型，Tret描述了函数返回值的类型。如果有必要，可以在可选关键字when后面引入额外的类型变量。</p>
<p>类型变量可以在参数里使用，如下所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">spec</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">map</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">B</span><span class="p">,</span> <span class="p">[</span><span class="nv">A</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">B</span><span class="p">].</span>
<span class="ln">2</span><span class="c">% map函数接受一个从A类型到B类型的函数和一个由A类型对象组成的列表，然后返回一个由B类型对象组成的列表
</span><span class="ln">3</span><span class="c"></span><span class="p">-</span><span class="ni">spec</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">filter</span><span class="p">(</span><span class="k">fun</span><span class="p">((</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">bool</span><span class="p">()),[</span><span class="nv">X</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">X</span><span class="p">].</span>
</code></pre></div><p>4.导出类型和本地类型</p>
<p>用注解-export_type(&hellip;)导出:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">a</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">type</span> <span class="n">rich_text</span><span class="p">()</span> <span class="p">::</span> <span class="p">[{</span><span class="n">font</span><span class="p">(),</span> <span class="n">char</span><span class="p">()}].</span>
<span class="ln">3</span><span class="p">-</span><span class="ni">type</span> <span class="n">font</span><span class="p">()</span> <span class="p">::</span> <span class="n">integer</span><span class="p">().</span>
<span class="ln">4</span><span class="p">-</span><span class="ni">export_type</span><span class="p">([</span><span class="n">rich_text</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">font</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln">5</span><span class="p">...</span>
<span class="ln">6</span><span class="c">% 不仅声明了一个富文本和一个字体类型，还用注解-export_type(...)导出了它们。
</span></code></pre></div><p>引用：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">b</span><span class="p">).</span>
<span class="ln">2</span><span class="p">...</span>
<span class="ln">3</span><span class="p">-</span><span class="ni">sepc</span> <span class="n">rich_text_length</span><span class="p">(</span><span class="nn">a</span><span class="p">:</span><span class="nf">rich_text</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">integer</span><span class="p">().</span>
<span class="ln">4</span><span class="c">% rich_text_length的输入参数使用了完全限定的类型名a:rich_text()
</span></code></pre></div><p>5.不透明类型</p>
<p>希望隐藏富文本数据结构的内部细节，使得只有创建此数据结构的模块才了解类型的细节</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">a</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">opaque</span> <span class="n">rich_text</span><span class="p">()</span> <span class="p">::</span> <span class="p">[{</span><span class="n">font</span><span class="p">(),</span><span class="n">char</span><span class="p">()}].</span>
<span class="ln">3</span><span class="c">% 创建了一个名为rich_text()的不透明类型（opaque type）。
</span><span class="ln">4</span><span class="c"></span><span class="p">-</span><span class="ni">export_type</span><span class="p">([</span><span class="n">rich_text</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln">5</span>
<span class="ln">6</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">make_text</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">bounding_box</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">7</span><span class="p">-</span><span class="ni">spec</span> <span class="n">make_text</span><span class="p">(</span><span class="n">string</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">rich_text</span><span class="p">().</span>
<span class="ln">8</span><span class="p">-</span><span class="ni">spec</span> <span class="n">bountding_box</span><span class="p">(</span><span class="n">rich_text</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Height</span><span class="p">::</span><span class="nf">integer</span><span class="p">(),</span> <span class="nv">Width</span><span class="p">::</span><span class="nf">integer</span><span class="p">()}.</span>
<span class="ln">9</span><span class="c">% 使用不透明类型为函数的输出输入类型
</span></code></pre></div><p>引用不透明类型：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">b</span><span class="p">).</span>
<span class="ln">2</span><span class="p">...</span>
<span class="ln">3</span><span class="nf">do_this</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">4</span>	<span class="nv">X</span> <span class="o">=</span> <span class="nn">a</span><span class="p">:</span><span class="nf">make_text</span><span class="p">(</span><span class="s">&#34;hello word&#34;</span><span class="p">).</span>
<span class="ln">5</span>	<span class="p">{</span><span class="nv">W</span><span class="p">,</span><span class="nv">H</span><span class="p">}</span> <span class="o">=</span> <span class="nn">a</span><span class="p">:</span><span class="nf">bounding_box</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span>
<span class="ln">6</span>    <span class="c">% b模块永远不需要知道变量X的内部结构
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">c</span><span class="p">).</span>
<span class="ln">2</span><span class="p">...</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">fonts_in</span><span class="p">(</span><span class="nv">Str</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">5</span>    <span class="nv">X</span> <span class="o">=</span> <span class="nn">a</span><span class="p">:</span><span class="nf">make_text</span><span class="p">(</span><span class="nv">Str</span><span class="p">),</span>
<span class="ln">6</span>    <span class="p">[</span><span class="nv">F</span> <span class="p">||</span> <span class="p">{</span><span class="nv">F</span><span class="p">,_}</span> <span class="o">&lt;-</span> <span class="nv">X</span><span class="p">].</span>
</code></pre></div><p>我们不该知道此类型的任何内部结构信息。利用此类型的内部结构信息被称为抽象违规（abstraction violation），如果正确声明了相关函数的类型可见性，这一违规就可以被dialyzer检测出来。</p>
<h3 id="dialyzer">dialyzer</h3>
<p>1.创建PLT（Persistent Lookup Table（持久性查询表）），PLT应当包含标准系统里所有类型的缓存。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>dialyzer --build_plt --apps erts kernel stdlib
<span class="ln">2</span><span class="c1"># 生成erts、stdlib和kernel的PLT。</span>
</code></pre></div><p>出现未知函数的警告是因为列出的函数存在于外部的应用中，它们不再plt中。</p>
<p>2.使用dialyzer</p>
<p>分析程序：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>dialyzer app.erl
</code></pre></div><p>例子中分析了错误使用内置函数的返回值；内置函数的错误参数；错误的程序逻辑这几种错误。</p>
<p>进行函数的类型推断：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>typer test3.erl
</code></pre></div><p>3.注意事项</p>
<p>使用dialyzer的最佳方式是将它用于每一个开发阶段。开始编写一个新模块时，应该首先考虑类型并声明它们，然后再编写代码。要为模块里所有的导出函数编写类型规范。先完成这一步再开始写代码。可以先注释掉未完成函数的类型规范，然后在实现函数的过程中取消注释。</p>
<p>如果函数是导出的，就加上类型规范；如果不是，就要考虑添加类型规范是否有助于类型分析或者能帮助我们理解程序（请记住，类型注解是很好的程序文档）。如果dialyzer发现了任何错误，就应该停下来思考并找出错误的准确含义。</p>
<p>4.干扰dialyzer的情况</p>
<ul>
<li>避免使用-compile(export_all)。</li>
<li>为模块导出函数的所有参数提供详细的类型规范。尽量给导出函数的参数设置最严格的限制。</li>
<li>为记录定义里的所有元素提供默认的参数。</li>
<li>把匿名变量用作函数的参数经常会导致结果类型不如你预想得那么精确。要尽可能地给变量添加限制。</li>
</ul>
<h3 id="类型推断过程">类型推断过程</h3>
<p>类型推断（type inference）是指通过分析代码得出函数类型的过程。要做到这一点，我们会分析程序，寻找约束条件。用这些约束条件构建出一组约束方程式，然后求解。得到的一组类型就被称为此程序的成功分型（success typing）。</p>
<p>我们把函数的推断类型称为合格类型的原因，从字面上讲就是“要让函数能成功执行，它的参数就必须属于这个类型”。</p>
<p>出现的一些约束条件：</p>
<ul>
<li>乘法操作符的左右参数都必须是数字</li>
<li>加法操作符的左右参数都必须是数字</li>
<li>is_integer(H)说明H必须是整数</li>
<li>如果函数之后调用了一个函数，那么里面这个函数的约束条件通过参数扩散到外部函数。</li>
</ul>
<p>一个反例：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">myand1</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">true</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">true</span><span class="p">;</span>
<span class="ln">2</span><span class="nf">myand1</span><span class="p">(</span><span class="n">false</span><span class="p">,</span> <span class="p">_)</span> <span class="o">-&gt;</span> <span class="n">false</span><span class="p">;</span>
<span class="ln">3</span><span class="nf">myand1</span><span class="p">(_,</span> <span class="n">false</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">false</span><span class="p">.</span>
<span class="ln">4</span>
<span class="ln">5</span><span class="nf">bug1</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">6</span>	<span class="k">case</span> <span class="n">myand1</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">7</span>		<span class="n">true</span> <span class="o">-&gt;</span>
<span class="ln">8</span>			<span class="nv">X</span><span class="o">+</span><span class="nv">Y</span>
<span class="ln">9</span>	<span class="k">end</span><span class="p">.</span>
</code></pre></div><p>在这个模块上运行dialyzer，它是不会返回错误的。因为它推断<code>myand1</code>函数可以接收任何值，当然数字也可以了。这个例子展示了参数类型规范的不到位（即把_当作类型而非boolean()）会导致分析程序时无法发现的错误。</p>
<h3 id="练习-7">练习</h3>
<h2 id="第10章-编译和运行程序">第10章 编译和运行程序</h2>
<h3 id="设置载入代码的搜索路径">设置载入代码的搜索路径</h3>
<p>1.获取当前载入的路径值</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>code:get_path().
</code></pre></div><p>2.操作载入路径的函数</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">spec</span> <span class="nn">code</span><span class="p">:</span><span class="nf">add_patha</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">true</span> <span class="p">|</span> <span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="n">bad_directory</span><span class="p">}</span>
<span class="ln">2</span><span class="c">% 向载入路径的开头添加一个新目录Dir。
</span><span class="ln">3</span><span class="c"></span><span class="p">-</span><span class="ni">spec</span> <span class="nn">code</span><span class="p">:</span><span class="nf">add_pathz</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">true</span> <span class="p">|</span> <span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="n">bad_directory</span><span class="p">}</span>
<span class="ln">4</span><span class="c">% 向载入路径的末端添加一个新目录Dir
</span></code></pre></div><p>3.返回一个已加载模块的总列表</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>code:all_loaded()
</code></pre></div><p>4.怀疑载入了错误的模块，帮助调查哪里出了错。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>code:clash()
</code></pre></div><p>5.启动erl时添加载入目录</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>erl -pa Dir1 -pa Dir2... .. -pz DirK1 -pz DirK2
<span class="ln">2</span>
<span class="ln">3</span><span class="c1">#-pa Dir标识会把Dir添加到代码搜索路径的开头</span>
<span class="ln">4</span><span class="c1">#-pz Dir则会把此目录添加到代码路径的末端。</span>
</code></pre></div><h3 id="在系统启动时执行一组命令">在系统启动时执行一组命令</h3>
<p>我们可以在主目录的.erlang文件里添加上一节的代码设置载入路径。</p>
<p>事实上，你可以把任意的Erlang代码放入这个文件。启动Erlang时，它会首先读取并执行此文件里的所有命令。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span><span class="nv">$cat</span> .erlang 
<span class="ln"> 2</span>io:format<span class="o">(</span><span class="s2">&#34;This is your home .erlang file print!~n&#34;</span><span class="o">)</span>.
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nv">$erl</span>
<span class="ln"> 5</span>Erlang/OTP <span class="m">25</span> <span class="o">[</span>erts-13.2.2.5<span class="o">]</span> <span class="o">[</span>source<span class="o">]</span> <span class="o">[</span>64-bit<span class="o">]</span> <span class="o">[</span>smp:6:6<span class="o">]</span> <span class="o">[</span>ds:6:6:10<span class="o">]</span> <span class="o">[</span>async-threads:1<span class="o">]</span> <span class="o">[</span>jit:ns<span class="o">]</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span>This is your home .erlang file print!
<span class="ln"> 8</span>Eshell V13.2.2.5  <span class="o">(</span>abort with ^G<span class="o">)</span>
<span class="ln"> 9</span>1&gt; q<span class="o">()</span>.
<span class="ln">10</span>ok
</code></pre></div><p>如果Erlang启动时的当前目录里已经有一个.erlang文件 ，它就会优先于主目录里的.erlang。通过这种方式，可以让Erlang根据不同的启动位置表现出不同的行为。这对特定的应用程序来说可能很有用。</p>
<p>获取主目录：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; init:get_argument(home).
<span class="ln">2</span>{ok,[[&#34;/home/joe&#34;]]}
</code></pre></div><h3 id="程序运行的三种方式">程序运行的三种方式</h3>
<p>hello.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">hello</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">5</span>	<span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Hello world</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">).</span>
</code></pre></div><p>1.Erlang Shell里编译运行</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl
<span class="ln">2</span>&gt; c(hello).
<span class="ln">3</span>&gt; hello:start().
</code></pre></div><p>2.命令行里运行</p>
<p>erl -noshell &hellip;命令可以放在shell脚本里，所以通常会制作一个shell脚本来运行程序，里面会设置路径（用-pa Directory）并启动程序。在这个例子里用了两个-s ..命令。命令行里的函数数量是不受限制的。每个-s &hellip;命令都由一个apply语句执行，运行完毕后再执行下一个命令。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erlc hello.erl
<span class="ln">2</span># erlc hello.erl编译了hello.erl文件，生成了一个名为hello.beam的目标代码文件
<span class="ln">3</span>
<span class="ln">4</span>erl -noshell -s
<span class="ln">5</span>#-noshell以不带交互式shell的方式启动Erlang（因此不会看到Erlang的“徽标”，也就是通常系统启动时首先显示的那些信息）。
<span class="ln">6</span>#-s hello start运行hello:start()函数。注意：使用-s Mod ...选项时，Mod必须是已编译的
<span class="ln">7</span>#-s init stop在之前的命令完成后执行init:stop()函数，从而停止系统。	
</code></pre></div><p>快速脚本编程，编辑+执行代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>erl -eval <span class="s1">&#39;io:format(&#34;Memory: ~p~n&#34;, [erlang:memory(total)]).&#39;</span><span class="se">\
</span><span class="ln">2</span><span class="se"></span>    -noshell -s init stop
</code></pre></div><p>3.作为Escript运行</p>
<p>可以用escript来让程序直接作为脚本运行，无需事先编译它们</p>
<p>hello:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>#!/usr/bin/env escript
<span class="ln">2</span>
<span class="ln">3</span>main(Args) -&gt;
<span class="ln">4</span>	io:format(&#34;Hello world~n&#34;).
</code></pre></div><p>这个文件必须包含一个main(Args)函数。当它从操作系统的shell里调用时，Args会包含一列用原子表示的命令行参数。这个文件的文件模式必须设置为“可执行”</p>
<h3 id="带命令行参数程序的运行">带命令行参数程序的运行</h3>
<p>fac.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">fac</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">fac</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">fac</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">5</span><span class="nf">fac</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">N</span><span class="o">*</span><span class="n">fac</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span>
</code></pre></div><p>1.Erlang Shell</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl
<span class="ln">2</span>c(fac).
<span class="ln">3</span>fac:fac(25).
</code></pre></div><p>2.命令行</p>
<p>fac1.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">fac1</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">main</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">main</span><span class="p">([</span><span class="nv">A</span><span class="p">])</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>	<span class="nv">I</span> <span class="o">=</span> <span class="nb">list_to_integer</span><span class="p">(</span><span class="nb">atom_to_list</span><span class="p">(</span><span class="nv">A</span><span class="p">)),</span>
<span class="ln"> 6</span>	<span class="nv">F</span> <span class="o">=</span> <span class="n">fac</span><span class="p">(</span><span class="nv">I</span><span class="p">),</span>
<span class="ln"> 7</span>	<span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;factorial </span><span class="si">~w</span><span class="s"> = </span><span class="si">~w~n</span><span class="s">&#34;</span><span class="p">,[</span><span class="nv">I</span><span class="p">,</span><span class="nv">F</span><span class="p">]),</span>
<span class="ln"> 8</span>	<span class="nn">init</span><span class="p">:</span><span class="nf">stop</span><span class="p">().</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="nf">fac</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">11</span><span class="nf">fac</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">N</span><span class="o">*</span><span class="n">fac</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erlc fac1.erl
<span class="ln">2</span>erl -noshell -s fac1 main 25
</code></pre></div><p>这个函数的名称main没有什么特殊含义，你可以给它取任何名字。重点是函数名和命令行里的名称要一致。</p>
<p>3.Escript</p>
<p>无需编译就可以运行它</p>
<p>factorial:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>#!/usr/bin/env escript
<span class="ln">2</span>
<span class="ln">3</span>main([A]) -&gt;
<span class="ln">4</span>	I = list_to_integer(atom_to_list(A)),
<span class="ln">5</span>	F = fac(I),
<span class="ln">6</span>	io:format(&#34;factorial ~w = ~w~n&#34;,[I,F]),
<span class="ln">7</span>
<span class="ln">8</span>fac(0) -&gt; 1;
<span class="ln">9</span>fac(N) -&gt; N*fac(N-1).
</code></pre></div><h3 id="使用make使编译自动化">使用make使编译自动化</h3>
<h3 id="一个makefile模板">一个makefile模板</h3>
<p>makefile.template</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="c">#别碰这几行
</span><span class="ln"> 2</span><span class="c"></span><span class="nf">.SUFFIXES</span><span class="o">:</span> .<span class="n">erl</span> .<span class="n">beam</span> .<span class="n">yrl</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">.erl.veam</span><span class="o">:</span>
<span class="ln"> 5</span>		erlc -W $&lt;
<span class="ln"> 6</span>		
<span class="ln"> 7</span><span class="nf">-yrl.erl</span><span class="o">:</span>
<span class="ln"> 8</span>		erlc -W $&lt;
<span class="ln"> 9</span>		
<span class="ln">10</span><span class="nv">ERL</span> <span class="o">=</span> erl -boot start_clean
<span class="ln">11</span>
<span class="ln">12</span><span class="c">#这里是一个想要编译的Erlang模块列表。
</span><span class="ln">13</span><span class="c">#如果这些模块在一行里放不下，
</span><span class="ln">14</span><span class="c">#就在行尾添加一个 \ 字符然后在下一行继续。
</span><span class="ln">15</span><span class="c">#编辑下面这几行
</span><span class="ln">16</span><span class="c"></span><span class="nv">MOD</span> <span class="o">=</span> module1 module2<span class="se">\
</span><span class="ln">17</span><span class="se"></span>	  module3 ... special1 ...<span class="se">\
</span><span class="ln">18</span><span class="se"></span>	  ...
<span class="ln">19</span>	  moduleN
<span class="ln">20</span>
<span class="ln">21</span><span class="c">#任何makefile里的第一个目标就是默认的目标。
</span><span class="ln">22</span><span class="c">#如果只输入了&#34;make&#34;，系统就会假定为&#34;make all&#34;。
</span><span class="ln">23</span><span class="c">#（因为&#34;all&#34;是这个makefile里的第一个目标）
</span><span class="ln">24</span><span class="c"></span><span class="nf">all</span><span class="o">:</span> <span class="n">compile</span>
<span class="ln">25</span>
<span class="ln">26</span><span class="nf">compile</span><span class="o">:</span> ${<span class="n">MODS</span>:%=%.<span class="n">beam</span>} <span class="n">subdirs</span>
<span class="ln">27</span>
<span class="ln">28</span><span class="c">#此处添加特殊的编译要求
</span><span class="ln">29</span><span class="c"></span><span class="nf">special1.beam</span><span class="o">:</span> <span class="n">special</span>1.<span class="n">erl</span>
<span class="ln">30</span>		<span class="si">${</span><span class="nv">ERL</span><span class="si">}</span> -Dflag1 -W0 special1.erl
<span class="ln">31</span>		
<span class="ln">32</span><span class="c">#从makefile里运行应用程序
</span><span class="ln">33</span><span class="c"></span><span class="nf">application1</span><span class="o">:</span> <span class="n">compile</span>
<span class="ln">34</span>		<span class="si">${</span><span class="nv">ERL</span><span class="si">}</span> -pa Dir1 -s application1 start Arg1 Arg2
<span class="ln">35</span>		
<span class="ln">36</span><span class="c">#subdir目标会编译子目录里的代码
</span><span class="ln">37</span><span class="c"></span><span class="nf">subdirs</span><span class="o">:</span>
<span class="ln">38</span>		<span class="nb">cd</span> dir1<span class="p">;</span> <span class="k">$(</span>MAKE<span class="k">)</span>
<span class="ln">39</span>		<span class="nb">cd</span> dir2<span class="p">;</span> <span class="k">$(</span>MAKE<span class="k">)</span>
<span class="ln">40</span>		...
<span class="ln">41</span>		
<span class="ln">42</span><span class="c">#移除所有代码
</span><span class="ln">43</span><span class="c"></span><span class="nf">clean</span><span class="o">:</span>
<span class="ln">44</span>		rm -rf *.beam erl_crash.dump
<span class="ln">45</span>		<span class="nb">cd</span> dir1<span class="p">;</span> <span class="k">$(</span>MAKE<span class="k">)</span> clean
<span class="ln">46</span>		<span class="nb">cd</span> dir2<span class="p">;</span> <span class="k">$(</span>MAKE<span class="k">)</span> clean
</code></pre></div><h3 id="精简makefile模板">精简makefile模板</h3>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="nf">.SUFFIXED</span><span class="o">:</span> .<span class="n">erl</span> .<span class="n">beam</span>
<span class="ln"> 2</span>
<span class="ln"> 3</span><span class="nf">.erl.beam</span><span class="o">:</span>
<span class="ln"> 4</span>	erlc -W $&lt;
<span class="ln"> 5</span>	
<span class="ln"> 6</span><span class="nv">ERL</span> <span class="o">=</span> erl -boot start_clean
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="nv">MODS</span> <span class="o">=</span> module1 module2 module3
<span class="ln"> 9</span>
<span class="ln">10</span><span class="nf">all</span><span class="o">:</span> <span class="n">compile</span>
<span class="ln">11</span>	<span class="si">${</span><span class="nv">ERL</span><span class="si">}</span> -pa <span class="s1">&#39;/home/joe/.../this/dir&#39;</span> -s module1 start
<span class="ln">12</span>	
<span class="ln">13</span><span class="nf">compile</span><span class="o">:</span> ${<span class="n">MODS</span>:%=%.<span class="n">beam</span>}
<span class="ln">14</span>
<span class="ln">15</span><span class="nf">clean</span><span class="o">:</span>
<span class="ln">16</span>	rm -rf *.beam erl_crash.dump
</code></pre></div><h2 id="第11章-现实世界中的并发">第11章 现实世界中的并发</h2>
<ul>
<li>Erlang进程没有共享内存，每个进程都有它自己的内存。要改变其他某个进程的内存，必须向它发送一个消息，并祈祷它能收到并理解这个消息。</li>
<li>Erlang进程就像人类一样，有时会死去。但和人类不同的是，当它们死亡时，会用尽最后一口气喊出导
致它们死亡的准确原因。</li>
<li>Erlang的错误检测正是使用的这种方式：进程可以相互连接。如果其中一个进程挂了，另一
个进程就会得到一个说明前者死亡原因的错误消息。</li>
<li>Erlang程序由大量进程组成。这些进程间能相互发送消息。这些消息也许能被其他进程收到和理解，也许不能。如果想知道某个消息是否已被对方进程收到和理解，就必须向该进程发送一个消息并等待回复。</li>
</ul>
<h2 id="第12章-并发编程">第12章 并发编程</h2>
<p>在Erlang里：</p>
<ul>
<li>创建和销毁进程是非常快速的；</li>
<li>在进程间发送消息是非常快速的；</li>
<li>进程在所有操作系统上都具有相同的行为方式；</li>
<li>可以拥有大量进程；</li>
<li>进程不共享任何内存，是完全独立的；</li>
<li>进程唯一的交互方式就是消息传递。</li>
</ul>
<h3 id="基本并发函数">基本并发函数</h3>
<p>1.<code>Pid = spawn(Mod, Func, Args)</code></p>
<p>创建一个新的并发进程来执行<code>apply(Mod, Func, Args)</code>。这个新进程和调用进程并列运行。spawn返回一个Pid（process identifier的简称，即进程标识符）。可以用Pid来给此进程发送消息。</p>
<p>请注意，元数为length(Args)的Func函数必须从Mod模块导出。</p>
<p>当一个新进程被创建后，会使用<strong>最新版</strong>的代码定义模块。</p>
<p>2.<code>Pid = spawn(Fun)</code></p>
<p>创建一个新的并发进程来执行Fun()。这种形式的spawn总是使用被执行fun的当前值，而且这个fun无需从模块里导出。</p>
<blockquote>
<p>这两种spawn形式的本质区别与动态代码升级有关。12.8节会讨论如何从这两种spawn形式中做出选择。</p>
</blockquote>
<p>3.<code>Pid ! Message</code></p>
<p>向标识符为Pid的进程发送消息Message。消息发送是异步的。发送方并不等待，而是会继续之前的工作。!被称为发送操作符。</p>
<p>Pid ! M被定义为M。因此，Pid1 ! Pid2 !&hellip;! Msg的意思是把消息Msg发送给Pid1、Pid2等所有进程。</p>
<p>4.<code>receice... end</code></p>
<p>接收发送给某个进程的消息。它的语法如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="k">receive</span>
<span class="ln">2</span>	<span class="nv">Pattern1</span> <span class="p">[</span><span class="k">when</span> <span class="nv">Guard1</span><span class="p">]</span> <span class="o">-&gt;</span>
<span class="ln">3</span>		<span class="nv">Expressions1</span><span class="p">;</span>
<span class="ln">4</span>	<span class="nv">Pattern2</span> <span class="p">[</span><span class="k">when</span> <span class="nv">Guard2</span><span class="p">]</span> <span class="o">-&gt;</span>
<span class="ln">5</span>		<span class="nv">Expression2</span><span class="p">;</span>
<span class="ln">6</span>	<span class="p">...</span>
<span class="ln">7</span><span class="k">end</span>
</code></pre></div><p>当某个消息到达进程后，系统会尝试将它与Pattern1（以及可选的关卡Guard1）匹配，如果成功就执行Expressions1。如果第一个模式不匹配，就会尝试Pattern2，以此类推。如果没有匹配的模式，消息就会被保存起来供以后处理，进程则会开始等待下一条消息。</p>
<p>接收语句里的模式和关卡和我们定义函数时使用的模式和关卡具有相同的语法形式和含义。</p>
<h3 id="选择mfa还是fun进行分裂">选择MFA还是Fun进行分裂</h3>
<p>用显式的模块、函数名和参数列表（称为MFA）来分裂一个函数是确保运行进程能够正确升级为新版模块代码（即使用中被再次编译）的恰当方式。动态代码升级机制不适用于fun的分裂，只能用于带有显式名称的MFA上。</p>
<p>如果你不关心动态代码升级，或者确定程序不会在未来进行修改，就可以使用 spawn 的spawn(Fun)形式。如果有疑问，就使用spawn(MFA)。</p>
<h3 id="简单进程示例">简单进程示例</h3>
<p>代码</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">area_server0</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">loop</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">loop</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="k">receive</span>
<span class="ln"> 6</span>        <span class="p">{</span><span class="n">rectangle</span><span class="p">,</span> <span class="nv">Width</span><span class="p">,</span> <span class="nv">Ht</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Area of ractangle is </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Width</span> <span class="o">*</span> <span class="nv">Ht</span><span class="p">]),</span>
<span class="ln"> 8</span>            <span class="n">loop</span><span class="p">();</span>
<span class="ln"> 9</span>        <span class="p">{</span><span class="n">square</span><span class="p">,</span> <span class="nv">Side</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">10</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Area of square is </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Side</span> <span class="o">*</span> <span class="nv">Side</span><span class="p">]),</span>
<span class="ln">11</span>            <span class="n">loop</span><span class="p">()</span>
<span class="ln">12</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>测试</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; Pid = spawn(area_server0, loop, []).
<span class="ln">2</span>&lt;0.36.0&gt;
<span class="ln">3</span>2&gt; Pid ! {rectangle, 6, 10}.
<span class="ln">4</span>Area of ractangle is 60
<span class="ln">5</span>{rectangle, 6, 10}
</code></pre></div><p>最后，shell打印出{rectangle, 6, 10}，这是因为Pid ! Msg的值被定义为Msg。</p>
<h3 id="客户端-服务器示例">客户端-服务器示例</h3>
<p>发送请求的进程通常称为客户端。接收请求并回复客户端的进程称为服务器。</p>
<p>1.初步实例</p>
<p>area_server1.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">area_server1</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">loop</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">rpc</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="c">% 客户端
</span><span class="ln"> 5</span><span class="c"></span><span class="nf">rpc</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Request</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="nv">Pid</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Request</span><span class="p">},</span>
<span class="ln"> 7</span>    <span class="k">receive</span>
<span class="ln"> 8</span>        <span class="nv">Response</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>            <span class="nv">Response</span>
<span class="ln">10</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="c">%服务器
</span><span class="ln">13</span><span class="c"></span><span class="nf">loop</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">14</span>    <span class="k">receive</span>
<span class="ln">15</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="p">{</span><span class="n">rectangle</span><span class="p">,</span> <span class="nv">Width</span><span class="p">,</span> <span class="nv">Ht</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">16</span>            <span class="nv">From</span> <span class="o">!</span> <span class="nv">Width</span> <span class="o">*</span> <span class="nv">Ht</span><span class="p">,</span>
<span class="ln">17</span>            <span class="n">loop</span><span class="p">();</span>
<span class="ln">18</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="p">{</span><span class="n">circle</span><span class="p">,</span> <span class="nv">R</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">19</span>            <span class="nv">From</span> <span class="o">!</span> <span class="mi">3</span><span class="p">.</span><span class="mi">14159</span> <span class="o">*</span> <span class="nv">R</span> <span class="o">*</span> <span class="nv">R</span><span class="p">,</span>
<span class="ln">20</span>            <span class="n">loop</span><span class="p">();</span>
<span class="ln">21</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Other</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">22</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Other</span><span class="p">},</span>
<span class="ln">23</span>            <span class="n">loop</span><span class="p">()</span>
<span class="ln">24</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>测试</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>&gt; Pid = spawn(area_server1, loop, []).
<span class="ln">2</span>&lt;0.36.0&gt;
<span class="ln">3</span>&gt; area_server1:rpc(Pid, {rectangle, 6, 8}).
<span class="ln">4</span>48
<span class="ln">5</span>&gt; area_server1:rpc(Pid, {circle, 6}).
<span class="ln">6</span>113.097
<span class="ln">7</span>&gt; area_server1:rpc(Pid, socks).
<span class="ln">8</span>{error, socks}
</code></pre></div><ul>
<li>
<p>最佳实践是确认发送给进程的每一个消息都已收到。如果发送给进程的消息不匹配原始接收语句里的任何一个模式，这条消息就会遗留在进程邮箱里，永远无法接收。</p>
<p>为了解决这个问题，我们在接收语句的最后加了一个子句，让它能匹配所有发送给此进程的消息</p>
</li>
<li>
<p>小问题：客户端向服务器发送请求然后等待响应。但我们并不是等待来自服务器的响应，而是在等待任意消息。</p>
</li>
</ul>
<p>2.改进使客户端只接收对应服务器的消息</p>
<p>area_server2.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">area_server2</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">loop</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">rpc</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="c">% 客户端
</span><span class="ln"> 5</span><span class="c"></span><span class="nf">rpc</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Request</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="nv">Pid</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Request</span><span class="p">},</span>
<span class="ln"> 7</span>    <span class="k">receive</span>
<span class="ln"> 8</span>        <span class="p">{</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Response</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>            <span class="nv">Response</span>
<span class="ln">10</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="c">%服务器
</span><span class="ln">13</span><span class="c"></span><span class="nf">loop</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">14</span>    <span class="k">receive</span>
<span class="ln">15</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="p">{</span><span class="n">rectangle</span><span class="p">,</span> <span class="nv">Width</span><span class="p">,</span> <span class="nv">Ht</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">16</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Width</span> <span class="o">*</span> <span class="nv">Ht</span><span class="p">},</span>
<span class="ln">17</span>            <span class="n">loop</span><span class="p">();</span>
<span class="ln">18</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="p">{</span><span class="n">circle</span><span class="p">,</span> <span class="nv">R</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">19</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="mi">3</span><span class="p">.</span><span class="mi">14159</span> <span class="o">*</span> <span class="nv">R</span> <span class="o">*</span> <span class="nv">R</span><span class="p">},</span>
<span class="ln">20</span>            <span class="n">loop</span><span class="p">();</span>
<span class="ln">21</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Other</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">22</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Other</span><span class="p">}},</span>
<span class="ln">23</span>            <span class="n">loop</span><span class="p">()</span>
<span class="ln">24</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>这段代码客户端多了Pid匹配，服务器多了Pid发送。</p>
<p>3.封装，使spawn和rpc函数隐藏</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">area_server_final</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">area</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">loop</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="c">% 客户端
</span><span class="ln"> 5</span><span class="c"></span><span class="nf">area</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">What</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="n">rpc</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">What</span><span class="p">).</span>
<span class="ln"> 7</span><span class="nf">rpc</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Request</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>    <span class="nv">Pid</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Request</span><span class="p">},</span>
<span class="ln"> 9</span>    <span class="k">receive</span>
<span class="ln">10</span>        <span class="p">{</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Response</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">11</span>            <span class="nv">Response</span>
<span class="ln">12</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">13</span>
<span class="ln">14</span><span class="c">%服务器
</span><span class="ln">15</span><span class="c"></span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">16</span>    <span class="nb">spawn</span><span class="p">(</span><span class="n">area_server_final</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="p">[]).</span>
<span class="ln">17</span><span class="nf">loop</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">18</span>    <span class="k">receive</span>
<span class="ln">19</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="p">{</span><span class="n">rectangle</span><span class="p">,</span> <span class="nv">Width</span><span class="p">,</span> <span class="nv">Ht</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">20</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Width</span> <span class="o">*</span> <span class="nv">Ht</span><span class="p">},</span>
<span class="ln">21</span>            <span class="n">loop</span><span class="p">();</span>
<span class="ln">22</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="p">{</span><span class="n">circle</span><span class="p">,</span> <span class="nv">R</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">23</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="mi">3</span><span class="p">.</span><span class="mi">14159</span> <span class="o">*</span> <span class="nv">R</span> <span class="o">*</span> <span class="nv">R</span><span class="p">},</span>
<span class="ln">24</span>            <span class="n">loop</span><span class="p">();</span>
<span class="ln">25</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Other</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">26</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Other</span><span class="p">}},</span>
<span class="ln">27</span>            <span class="n">loop</span><span class="p">()</span>
<span class="ln">28</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>请注意，还需要把spawn的参数（也就是loop/0）从模块中导出。这是一种好的做法，因为它能让我们在不改变客户端
代码的情况下修改服务器的内部细节。（我想可能是加参数的一些东西）</p>
<h3 id="计算进程平均创建时间">计算进程平均创建时间</h3>
<p>processes.erl</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">processes</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">max</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="c">% max(N)
</span><span class="ln"> 5</span><span class="c">% 创建N个进程然后销毁
</span><span class="ln"> 6</span><span class="c"></span>
<span class="ln"> 7</span><span class="nf">max</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>    <span class="nv">Max</span> <span class="o">=</span> <span class="nn">erlang</span><span class="p">:</span><span class="nb">system_info</span><span class="p">(</span><span class="n">process_limit</span><span class="p">),</span>
<span class="ln"> 9</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Maximum allowed processes: </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Max</span><span class="p">]),</span>
<span class="ln">10</span>    <span class="nb">statistics</span><span class="p">(</span><span class="n">runtime</span><span class="p">),</span>
<span class="ln">11</span>    <span class="nb">statistics</span><span class="p">(</span><span class="n">wall_clock</span><span class="p">),</span>
<span class="ln">12</span>    <span class="nv">L</span> <span class="o">=</span> <span class="n">for</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> 
<span class="ln">13</span>            <span class="nv">N</span><span class="p">,</span> 
<span class="ln">14</span>            <span class="c">% 创建进程wait函数
</span><span class="ln">15</span><span class="c"></span>            <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> 
<span class="ln">16</span>                <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> 
<span class="ln">17</span>                          <span class="o">-&gt;</span> <span class="n">wait</span><span class="p">()</span> 
<span class="ln">18</span>                      <span class="k">end</span><span class="p">)</span> 
<span class="ln">19</span>            <span class="k">end</span><span class="p">),</span>
<span class="ln">20</span>    <span class="p">{_,</span> <span class="nv">Time1</span><span class="p">}</span> <span class="o">=</span> <span class="nb">statistics</span><span class="p">(</span><span class="n">runtime</span><span class="p">),</span>
<span class="ln">21</span>    <span class="p">{_,</span> <span class="nv">Time2</span><span class="p">}</span> <span class="o">=</span> <span class="nb">statistics</span><span class="p">(</span><span class="n">wall_clock</span><span class="p">),</span>
<span class="ln">22</span>    <span class="nn">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p">(</span>
<span class="ln">23</span>                  <span class="k">fun</span><span class="p">(</span><span class="nv">Pid</span><span class="p">)</span> <span class="o">-&gt;</span> 
<span class="ln">24</span>                      <span class="nv">Pid</span> <span class="o">!</span> <span class="n">die</span> <span class="k">end</span><span class="p">,</span> 
<span class="ln">25</span>                  <span class="nv">L</span><span class="p">),</span>
<span class="ln">26</span>    <span class="nv">U1</span> <span class="o">=</span> <span class="nv">Time1</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="nv">N</span><span class="p">,</span>
<span class="ln">27</span>    <span class="nv">U2</span> <span class="o">=</span> <span class="nv">TIme2</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="nv">N</span><span class="p">,</span>
<span class="ln">28</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Process spawn time=</span><span class="si">~p</span><span class="s">(</span><span class="si">~p</span><span class="s">) microseconds</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">U1</span><span class="p">,</span> <span class="nv">U2</span><span class="p">]).</span>
<span class="ln">29</span>
<span class="ln">30</span><span class="nf">wait</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">31</span>    <span class="k">receive</span>
<span class="ln">32</span>        <span class="n">die</span> <span class="o">-&gt;</span> <span class="n">void</span>
<span class="ln">33</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">34</span>
<span class="ln">35</span><span class="nf">for</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span><span class="nv">N</span><span class="p">,</span><span class="nv">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">F</span><span class="p">()];</span>
<span class="ln">36</span><span class="nf">for</span><span class="p">(</span><span class="nv">I</span><span class="p">,</span><span class="nv">N</span><span class="p">,</span><span class="nv">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">F</span><span class="p">()|</span><span class="n">for</span><span class="p">(</span><span class="nv">I</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nv">N</span><span class="p">,</span><span class="nv">F</span><span class="p">)].</span>
</code></pre></div><ul>
<li>
<p>内置函数 erlang:system_info(process_limit)来找出所允许的最大进程数量。其中有一些是系统保留的进程，所以你的程序实际上不能用那么多。当超出限制值时，系统会拒绝启动更多的进程并生成一个错误报告</p>
</li>
<li>
<p>系统内设的限制值是262 144个进程。要超越这一限制，必须用+P标识启动Erlang仿真器</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl +P 3000000
</code></pre></div><p>随着进程数量的增加，进程分裂时间也在增加。如果继续增加进程的数量，最终会耗尽物理内存，导致系统开始把物理内存交换到硬盘上，运行速度明显变慢。</p>
</li>
<li>
<p><code>statistics(wall_clock)</code>：Returns information about wall clock. wall_clock can be used in the same manner as runtime, except that real time is measured as opposed to runtime or CPU time.</p>
</li>
<li>
<p><code>statistics(runtime)</code>：Returns information about runtime, in milliseconds.This is the sum of the runtime for all threads in the Erlang runtime system and can therefore be greater than the wall clock time.</p>
</li>
</ul>
<h3 id="超时的接收">超时的接收</h3>
<ol>
<li>
<p>给接收语句增加一个超时设置，设定进程等待接收消息的最长时间：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="k">receive</span>
<span class="ln">2</span>	<span class="nv">Pattern1</span> <span class="p">[</span><span class="k">when</span> <span class="nv">Guard1</span><span class="p">]</span> <span class="o">-&gt;</span>
<span class="ln">3</span>        <span class="nv">Expressions1</span><span class="p">;</span>
<span class="ln">4</span>	<span class="nv">Pattern2</span> <span class="p">[</span><span class="k">when</span> <span class="nv">Guard2</span><span class="p">]</span> <span class="o">-&gt;</span>
<span class="ln">5</span>        <span class="nv">Expressions2</span><span class="p">;</span>
<span class="ln">6</span>	<span class="p">...</span>
<span class="ln">7</span><span class="k">after</span> <span class="nv">Time</span> <span class="o">-&gt;</span>
<span class="ln">8</span>          <span class="nv">Expressions</span>
<span class="ln">9</span><span class="k">end</span>
</code></pre></div><p>如果在进入接收表达式的Time<strong>毫秒</strong>后还没有收到匹配的消息，进程就会停止等待消息，转而执行Expressions。</p>
<p>当然如果在规定时间受到匹配消息，这条语句就结束了，receive end只会处理一条语句。具体原理看下一节</p>
</li>
<li>
<p>只带超时的接收：</p>
<p>可以编写一个只有超时部分的receive。通过这种方法，我们可以定义一个sleep(T)函数，它会让当前的进程挂起T毫秒：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">sleep</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="k">receive</span>
<span class="ln">3</span>    <span class="k">after</span> <span class="nv">T</span> <span class="o">-&gt;</span>
<span class="ln">4</span>            <span class="n">true</span>
<span class="ln">5</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div></li>
<li>
<p>超时值为 0 的接收：</p>
<p>超时值为0会<strong>让超时的主体部分立即发生</strong>，但在这之前，系统会尝试<strong>对邮箱里的消息进行匹配</strong>。（先对消息匹配，匹配完之后让超时部分立即发生）</p>
<p>请记住，只有当邮箱里的所有条目都进行过模式匹配后，才会检查after部分。</p>
<p>对大的邮箱使用优先接收是相当低效的，所以如果你打算使用这一技巧，请确保邮箱不要太满。</p>
<p>可以用它来定义一个flush_buffer函数，它会清空进程邮箱里的所有消息：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">flush_buffer</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="k">receive</span>
<span class="ln">3</span>        <span class="p">_</span><span class="nv">Any</span> <span class="o">-&gt;</span>
<span class="ln">4</span>            <span class="n">flush_buffer</span><span class="p">()</span>
<span class="ln">5</span>    <span class="c">% 如果没有超时子句，flush_buffer就会在邮箱为空时永远挂起且不返回。
</span><span class="ln">6</span><span class="c"></span>    <span class="k">after</span> <span class="mi">0</span> <span class="o">-&gt;</span>
<span class="ln">7</span>            <span class="n">true</span>
</code></pre></div><p>还可以使用零超时来实现某种形式的“优先接收”：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">priority_receive</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="k">receive</span>
<span class="ln"> 3</span>        <span class="c">% 如果存在匹配{alarm, X}的消息，这个消息就会被立即返回。
</span><span class="ln"> 4</span><span class="c"></span>        <span class="c">% 如果没有after 0语句，警告（alarm）消息就不会被首先匹配。
</span><span class="ln"> 5</span><span class="c"></span>        <span class="p">{</span><span class="n">alarm</span><span class="p">,</span><span class="nv">X</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>            <span class="p">{</span><span class="n">alarm</span><span class="p">,</span><span class="nv">X</span><span class="p">}</span>
<span class="ln"> 7</span>    <span class="k">after</span> <span class="mi">0</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>            <span class="c">% 如果邮箱里不存在匹配{alarm, X}的消息，priority_receive就会接收邮箱里的第一个消息。
</span><span class="ln"> 9</span><span class="c"></span>            <span class="c">% 如果没有任何消息，它就会在最里面的接收语句处挂起，并返回它收到的第一个消息。
</span><span class="ln">10</span><span class="c"></span>            <span class="k">receive</span>
<span class="ln">11</span>                <span class="nv">Any</span> <span class="o">-&gt;</span>
<span class="ln">12</span>                    <span class="nv">Any</span>
<span class="ln">13</span>            <span class="k">end</span>
<span class="ln">14</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div></li>
<li>
<p>超时值为无穷大的接收：</p>
<p>如果接收语句里的超时值是<strong>原子infinity</strong>（无穷大），就永远不会触发超时。这对那些在接收语句之外计算超时值的程序可能很有用。有时候计算的结果是返回一个实际的超时值，其他的时候则是让接收语句永远等待下去。</p>
</li>
<li>
<p>可以用接收超时来实现一个简单的定时器：</p>
<p>stimer.erl：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">stimer</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">cancel</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>   
<span class="ln"> 4</span><span class="nf">start</span><span class="p">(</span><span class="nv">Time</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">timer</span><span class="p">(</span><span class="nv">Time</span><span class="p">,</span><span class="nv">Fun</span><span class="p">)</span> <span class="k">end</span><span class="p">).</span>
<span class="ln"> 5</span><span class="c">% 向进程发送消息cancel
</span><span class="ln"> 6</span><span class="c"></span><span class="nf">cancel</span><span class="p">(</span><span class="nv">Pid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Pid</span> <span class="o">!</span> <span class="n">cancel</span><span class="p">.</span>
<span class="ln"> 7</span><span class="nf">timer</span><span class="p">(</span><span class="nv">Time</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>    <span class="k">receive</span>
<span class="ln"> 9</span>        <span class="c">% 在Time前收到消息cancel则会关闭这个定时器
</span><span class="ln">10</span><span class="c"></span>        <span class="n">cancel</span> <span class="o">-&gt;</span>
<span class="ln">11</span>            <span class="n">void</span>
<span class="ln">12</span>    <span class="k">after</span> <span class="nv">Time</span> <span class="o">-&gt;</span>
<span class="ln">13</span>            <span class="nv">Fun</span><span class="p">()</span>
<span class="ln">14</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>&gt; Pid = stimer:start(5000, fun() -&gt; io:format(&#34;timer event~n&#34;) end).
<span class="ln">2</span>&lt;0.42.0&gt;
<span class="ln">3</span>timer event
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>&gt; Pid1 = stimer:start(25000, fun() -&gt; io:format(&#34;timer event~n&#34;) end).
<span class="ln">2</span>&lt;0.49.0&gt;
<span class="ln">3</span>&gt; stimer:cancel(Pid1).
<span class="ln">4</span>cancel
</code></pre></div></li>
</ol>
<h3 id="receive的工作方式">receive的工作方式</h3>
<ol>
<li>
<p>进入receive语句时会启动一个定时器（但只有当表达式包含after部分时才会如此）。</p>
</li>
<li>
<p>取出邮箱里的第一个消息，尝试将它与Pattern1、Pattern2等模式匹配。</p>
</li>
<li>
<p>如果匹配成功，系统就会从邮箱中移除这个消息，并执行模式后面的表达式。</p>
<p>如果receive语句里的所有模式都不匹配邮箱的第一个消息，系统就会从邮箱中<strong>移除</strong>这个消息并把它放入一个“<strong>保存队列</strong>”</p>
<p>然后继续尝试邮箱里的第二个消息。这一过程会不断重复，直到发现匹配的消息或者邮箱里的所有消息都被检查过了为止。</p>
</li>
<li>
<p>如果邮箱里的所有消息都不匹配，进程就会被挂起并重新调度，直到新的消息进入邮箱才会继续执行。新消息到达后，保存队列里的消息不会重新匹配，只有新消息才会进行匹配。</p>
</li>
<li>
<p>后面一旦某个消息匹配成功，保存队列里的所有消息就会按照到达进程的顺序<strong>重新进入</strong>邮箱。如果设置了定时器，就会<strong>清除</strong>它。</p>
</li>
<li>
<p>如果定时器在我们等待消息时到期了，系统就会执行表达式ExpressionsTimeout，并把所有保存的消息按照它们到达进程的顺序重新放回邮箱。</p>
</li>
</ol>
<h3 id="注册进程">注册进程</h3>
<p>如果想给一个进程发送消息，就需要知道它的PID，但是当进程创建时，只有父进程才知道它的PID。系统里没有其他进程知道它的存在。</p>
<p>Erlang有一种公布进程标识符的方法，它让系统里的任何进程都能与该进程通信。这样的进程被称为注册进程（registered process）。管理注册进程的内置函数有四个：</p>
<ul>
<li>
<p><code>register(AnAtom, Pid)</code></p>
<p>用AnAtom（一个原子）作为名称来注册进程Pid。如果AnAtom已被用于注册某个进程，这次注册就会失败。</p>
</li>
<li>
<p><code>unregister(AnAtom)</code></p>
<p>移除与AnAtom关联的所有注册信息。如果某个注册进程崩溃了，就会自动取消注册。</p>
</li>
<li>
<p><code>whereis(AnAtom) -&gt; Pid | undefined</code></p>
<p>检查AnAtom是否已被注册。如果是就返回进程标识符Pid，如果没有找到与AnAtom关联的进程就返回原子undefined。</p>
</li>
<li>
<p><code>registered() -&gt; [AnAtom::atom()]</code></p>
<p>返回一个包含系统里所有注册进程的列表。</p>
</li>
</ul>
<p>示例：</p>
<p>一旦名称注册完成，就可以用注册的原子给它发送消息</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>&gt; Pid = spawn(area_server0, loop, []).
<span class="ln">2</span>&lt;0.51.0&gt;
<span class="ln">3</span>&gt; register(area, Pid).
<span class="ln">4</span>true
<span class="ln">5</span>&gt; area ! {rectangle, 4, 5}.
<span class="ln">6</span>Area of rectangle is 20
<span class="ln">7</span>{rectangle, 4, 5}
</code></pre></div><p>一个模拟时钟的进程：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">clock</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">stop</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="c">% 创建一个tick进程并注册为clock
</span><span class="ln"> 5</span><span class="c"></span><span class="nf">start</span><span class="p">(</span><span class="nv">Time</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="nb">register</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">tick</span><span class="p">(</span><span class="nv">Time</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">)</span> <span class="k">end</span><span class="p">)).</span>
<span class="ln"> 7</span><span class="c">% 给名为clock的注册进程发送消息stop
</span><span class="ln"> 8</span><span class="c"></span><span class="nf">stop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">clock</span> <span class="o">!</span> <span class="n">stop</span><span class="p">.</span>
<span class="ln"> 9</span><span class="c">%每隔Time执行一次Fun，然后重复
</span><span class="ln">10</span><span class="c"></span><span class="nf">tick</span><span class="p">(</span><span class="nv">Time</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">11</span>    <span class="k">receive</span>
<span class="ln">12</span>        <span class="n">stop</span> <span class="o">-&gt;</span>
<span class="ln">13</span>            <span class="n">void</span>
<span class="ln">14</span>    <span class="k">after</span> <span class="nv">Time</span> <span class="o">-&gt;</span>
<span class="ln">15</span>            <span class="nv">Fun</span><span class="p">(),</span>
<span class="ln">16</span>            <span class="n">tick</span><span class="p">(</span><span class="nv">Time</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">)</span>
<span class="ln">17</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>&gt; clock:start(5000, fun() -&gt; io:format(&#34;TICK ~p~n&#34;, [erlang:now()]) end).	
<span class="ln">2</span>
<span class="ln">3</span>&gt; clock:stop().
</code></pre></div><h3 id="尾递归">尾递归</h3>
<p>如果你仔细观察，就会发现每当我们收到消息时就会处理它并立即再次调用loop()。这一过程被称为尾递归（tail-recursive）。可以对一个尾递归的函数进行<strong>特别编译</strong>，把语句序列里的最后一次函数调用<strong>替换成</strong>跳至被调用函数的开头。这就意味着尾递归的函数<strong>无需消耗栈空间</strong>也能一直循环下去。</p>
<p>假设编写了以下（不正确的）代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">loop</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="k">receive</span>
<span class="ln"> 3</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="p">{</span><span class="n">rectangle</span><span class="p">,</span> <span class="nv">Width</span><span class="p">,</span> <span class="nv">Ht</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln"> 4</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Width</span> <span class="o">*</span> <span class="nv">Ht</span><span class="p">},</span>
<span class="ln"> 5</span>            <span class="n">loop</span><span class="p">(),</span>
<span class="ln"> 6</span>            <span class="n">someOtherFunc</span><span class="p">();</span>
<span class="ln"> 7</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="p">{</span><span class="n">circle</span><span class="p">,</span> <span class="nv">R</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>            <span class="p">....</span>
<span class="ln"> 9</span>	<span class="k">end</span>
<span class="ln">10</span><span class="k">end</span>
</code></pre></div><p>我们在第5行里调用了loop()，但是编译器必然推断出“当我调用loop()后必须返回这里，因为我得调用第6行里的someOtherFunc()”。于是它把someOtherFunc的地址推入栈，然后跳到loop的开头。这么做的问题在于loop()是永不返回的，它会一直循环下去。所以，每次经过第5行，就会有一个返回地址被推入控制栈，最终系统的空间会消耗殆尽。</p>
<p>避免这个问题的方法很简单，如果你编写的函数F是永不返回的（就像loop()一样），就要确保在<strong>调用F之后不再调用其他任何东西</strong>，并且<strong>别把F用在列表或元组构造器里</strong>。</p>
<h3 id="并发程序模板">并发程序模板</h3>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">ctemplate</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">compile</span><span class="p">(</span><span class="n">export_all</span><span class="p">).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="nb">spawn</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="p">[]).</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="nf">rpc</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Request</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>    <span class="nv">Pid</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Request</span><span class="p">},</span>
<span class="ln"> 9</span>    <span class="k">receive</span>
<span class="ln">10</span>        <span class="p">{</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Response</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">11</span>            <span class="nv">Response</span>
<span class="ln">12</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">13</span>
<span class="ln">14</span><span class="nf">loop</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">15</span>    <span class="k">receive</span>
<span class="ln">16</span>        <span class="nv">Any</span> <span class="o">-&gt;</span>
<span class="ln">17</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Received:</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Any</span><span class="p">]),</span>
<span class="ln">18</span>            <span class="n">loop</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span>
<span class="ln">19</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>给接收循环添加一个匹配模式并重新运行程序。这一技巧在相当程度上决定了我编写程序的顺序：从一个小程序开始，逐渐扩展它，并在开发过程中不断进行测试。</p>
<h3 id="练习-8">练习</h3>
<p><strong>(3)</strong></p>
<blockquote>
<p>编写一个环形计时测试。创建一个由N个进程组成的环。把一个消息沿着环发送M次，这样总共发送的消息数量是N * M。记录不同的N和M值所花费的时间。</p>
</blockquote>
<p>创建这些进程是非常麻烦的，如果是同步创建，那么不能绑定Pid，只能在发送的时候寻找Pid，那么就必须要注册，而注册使用的原子需要是不一样且有规律的，所以说需要字符串处理拼接。</p>
<p>字符串拼接不熟悉，先放这。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 2</span><span class="c">%%% @author bnaod1
</span><span class="ln"> 3</span><span class="c">%%% @copyright (C) 2024, &lt;COMPANY&gt;
</span><span class="ln"> 4</span><span class="c">%%% @doc
</span><span class="ln"> 5</span><span class="c">%%%
</span><span class="ln"> 6</span><span class="c">%%% @end
</span><span class="ln"> 7</span><span class="c">%%% Created : 12. 12月 2024 15:25
</span><span class="ln"> 8</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 9</span><span class="c"></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">ring_timer</span><span class="p">).</span>
<span class="ln">10</span><span class="p">-</span><span class="ni">author</span><span class="p">(</span><span class="s">&#34;bnaod1&#34;</span><span class="p">).</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="c">%% API
</span><span class="ln">13</span><span class="c"></span><span class="p">-</span><span class="ni">export</span><span class="p">([]).</span>
<span class="ln">14</span>
<span class="ln">15</span>
<span class="ln">16</span><span class="nf">init</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">17</span>  <span class="c">% 创建N个进程
</span><span class="ln">18</span><span class="c"></span>  <span class="nv">L</span> <span class="o">=</span> <span class="n">for</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">N</span><span class="p">,</span> <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ring</span><span class="p">()</span> <span class="k">end</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
<span class="ln">19</span>  <span class="c">% 注册进程
</span><span class="ln">20</span><span class="c"></span>
<span class="ln">21</span>
<span class="ln">22</span><span class="nf">registerN</span><span class="p">([])</span> <span class="o">-&gt;</span>
<span class="ln">23</span>  <span class="n">void</span><span class="p">;</span>
<span class="ln">24</span><span class="nf">registerN</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">25</span>  <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">]</span> <span class="o">=</span> <span class="nv">L</span><span class="p">,</span>
<span class="ln">26</span>  <span class="nb">register</span><span class="p">(,</span><span class="nv">H</span><span class="p">),</span>
<span class="ln">27</span>  <span class="n">registerN</span><span class="p">(</span><span class="nv">T</span><span class="p">).</span>
<span class="ln">28</span>
<span class="ln">29</span>
<span class="ln">30</span><span class="nf">ring</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">31</span>  <span class="k">receive</span>
<span class="ln">32</span>    <span class="p">_</span><span class="nv">Any</span> <span class="o">-&gt;</span>
<span class="ln">33</span>      <span class="c">% 将消息发给下一个进程
</span><span class="ln">34</span><span class="c"></span>      <span class="nv">Pid</span> <span class="o">=</span> <span class="n">find_next</span><span class="p">(</span><span class="n">self</span><span class="p">()),</span>
<span class="ln">35</span>      <span class="nv">Pid</span> <span class="o">!</span> <span class="p">_</span><span class="nv">Any</span><span class="p">,</span>
<span class="ln">36</span>      <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Send msg </span><span class="si">~p</span><span class="s"> to </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Pid</span><span class="p">,</span> <span class="p">_</span><span class="nv">Any</span><span class="p">]),</span>
<span class="ln">37</span>      <span class="n">ring</span><span class="p">()</span>
<span class="ln">38</span>  <span class="k">end</span><span class="p">.</span>
<span class="ln">39</span>
<span class="ln">40</span>
<span class="ln">41</span>
<span class="ln">42</span><span class="nf">for</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span><span class="nv">N</span><span class="p">,</span><span class="nv">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">F</span><span class="p">()];</span>
<span class="ln">43</span><span class="nf">for</span><span class="p">(</span><span class="nv">I</span><span class="p">,</span><span class="nv">N</span><span class="p">,</span><span class="nv">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">F</span><span class="p">()|</span><span class="n">for</span><span class="p">(</span><span class="nv">I</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nv">N</span><span class="p">,</span><span class="nv">F</span><span class="p">)].</span>
<span class="ln">44</span>
<span class="ln">45</span>
</code></pre></div><h2 id="第13章-并发程序中的错误">第13章 并发程序中的错误</h2>
<p>在Erlang里，我们有大量的进程可供支配，因此任何单进程故障都不算特别重要。通常只需编写少量的防御性代码，而把重点放在编写纠正性代码上。我们采取各种措施检测错误，然后在错误发生后纠正它们。</p>
<p>检测错误和找出故障原因内建于Erlang虚拟机底层的功能，也是Erlang编程语言的一部分。标准OTP库提供了构建互相监视的进程组和在检测到错误时采取纠正措施的功能，23.5节中会进行相关介绍。这一章介绍的是语言层面的错误检测和恢复。</p>
<h3 id="错误处理的理念">错误处理的理念</h3>
<ul>
<li>
<p>让其他进程修复错误：要让一个进程监控另一个，就必须在它们之间创建一个连接（link）或监视（monitor）。如果被连接或监视的进程挂了，监控进程就会得到通知。</p>
<p>这可以作为顺序代码错误处理的延伸。虽然可以捕捉顺序代码里的异常并尝试纠正错误（这是第6章的主题），但如果失败了或者整台机器出了故障，就要让其他进程来修复错误。</p>
</li>
<li>
<p>任其崩溃：如果在错误发生后第一时间举旗示意，就能得到非常好的错误诊断。在错误发生后继续运行经常会导致更多错误发生，让调试变得更加困难。</p>
</li>
</ul>
<h3 id="错误处理的术语">错误处理的术语</h3>
<ul>
<li>
<p>进程</p>
<p>进程有两种：普通进程和系统进程。</p>
<p>spawn创建的是普通进程。</p>
<p>普通进程可以通过执行内置函数<code>process_flag(trap_exit, true)</code>变成系统进程。</p>
</li>
<li>
<p>连接</p>
<p>进程可以<strong>互相</strong>连接。如果A和B两个进程有连接，而A出于某种原因终止了，就会向B发送一个<strong>错误信号</strong>，反之亦然。</p>
</li>
<li>
<p>连接组</p>
<p>进程P的连接组是指与P相连的一组进程。</p>
</li>
<li>
<p>监视</p>
<p>监视和连接很相似，但它是<strong>单向</strong>的。如果A监视B，而B出于某种原因终止了，就会向A发送一个“宕机”消息，而不是退出信号。但反过来就不行了</p>
<p>当你想要不对称的错误处理时，可以使用监视，对称的错误处理则适合使用连接。监视通常会被服务器用来监视客户端的行为。</p>
</li>
<li>
<p>消息和错误信号</p>
<p>进程协作的方式是交换消息或错误信号。</p>
<p>消息是通过基本函数send发送的，错误信号则是进程<strong>崩溃</strong>或进程终止时<strong>自动发送</strong>的。错误信号会发送给终止进程的连接组。</p>
</li>
<li>
<p>错误信号的接收</p>
<p>当系统进程收到错误信号时，该信号会被<strong>转换成</strong>{&lsquo;EXIT&rsquo;, Pid, Why}形式的<strong>消息</strong>。Pid是终止进程的标识，Why是终止原因（有时候被称为退出原因）。如果进程是无错误终止，Why就会是原子normal，否则Why会是错误的描述。（基于这个特性，系统进程可以充当防火墙的作用）</p>
<p>当普通进程收到错误信号时，如果退出原因不是normal，该进程就会<strong>终止</strong>。当它终止时，同样会向它的连接组广播一个<strong>退出信号</strong>。</p>
</li>
<li>
<p>显式错误信号</p>
<p>任何执行<code>exit(Why)</code>的进程都会<strong>终止</strong>（如果代码不是在catch或try的范围内执行的话），并向它的连接组广播一个带有原因Why的<strong>退出信号</strong>。</p>
<p>进程可以通过执行<code>exit(Pid, Why)</code>来发送一个“虚假”的错误信号。在这种情况下，Pid会收到一个带有原因Why的退出信号。调用exit/2的进程则<strong>不会终止</strong>（这是有意如此的）。</p>
</li>
<li>
<p>不可捕捉的退出信号</p>
<p><strong>系统进程</strong>收到摧毁信号（kill signal）时会终止。摧毁信号是通过调用<code>exit(Pid, kill)</code>生成的。这种信号会绕过常规的错误信号处理机制，不会被转换成消息。摧毁信号只应该用在其他错误处理机制无法终止的顽固进程上。</p>
</li>
</ul>
<h3 id="基本错误处理函数">基本错误处理函数</h3>
<ul>
<li>
<p><code>-spec spawn_link(Fun) -&gt; Pid</code></p>
<p>-<code>spec spawn_link(Mod, Fnc, Args) -&gt; Pid</code></p>
<p>它们的行为类似于spawn(Fun)和spawn(Mod,Func,Args)，同时还会在父子进程之间创建连接。</p>
</li>
<li>
<p><code>-spec spawn_monitor(Fun) -&gt; {Pid, Ref}</code></p>
<p>-<code>spec spawn_monitor(Mod, Func, Args) -&gt; {Pid, Ref}</code></p>
<p>它与spawn_link相似，但创建的是监视而非连接。Pid是新创建进程的进程标识符，Ref是该进程的引用。如果这个进程因为Why的原因终止了，消息{&lsquo;DOWN&rsquo;,Ref,process,Pid,Why}就会被发往父进程。</p>
</li>
<li>
<p><code>-spec process_flag(trap_exit, true)</code></p>
<p>它会把当前进程转变成系统进程。系统进程是一种能接收和处理错误信号的进程。</p>
</li>
<li>
<p><code>-spec link(Pid) -&gt; true</code></p>
<p>它会创建一个与进程Pid的连接。连接是双向的。如果进程A执行了link(B)，就会与B相连。实际效果就和B执行link(A)一样。</p>
<p>如果进程Pid不存在，就会抛出一个noproc退出异常。</p>
<p>如果执行link(B)时A已经连接了B（或者相反），这个调用就会被忽略。</p>
</li>
<li>
<p><code>-spec unlink(Pid) -&gt; true</code></p>
<p>它会移除当前进程和进程Pid之间的所有连接。</p>
</li>
<li>
<p><code>-spec erlang:monitor(process, Item) -&gt; Ref</code></p>
<p>它会设立一个监视。Item可以是进程的Pid，也可以是它的注册名称。</p>
</li>
<li>
<p><code>-sepc demonitor(Ref) -&gt; true</code></p>
<p>它会移除以Ref作为引用的监视。</p>
</li>
<li>
<p><code>-spec exit(Why) -&gt; none()</code></p>
<p>它会使当前进程因为Why的原因终止。如果执行这一语句的子句不在catch语句的范围内，此进程就会向当前连接的所有进程广播一个带有参数Why的退出信号。它还会向所有监视它的进程广播一个DOWN消息。</p>
</li>
<li>
<p><code>-spec exit(Pid, Why) -&gt; true</code></p>
<p>它会向进程Pid发送一个带有原因Why的退出信号。执行这个内置函数的进程本身不会终止。它可以用于伪造退出信号。</p>
</li>
</ul>
<h3 id="容错式编程示例">容错式编程示例</h3>
<p>1.在进程终止时执行操作</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">on_exit</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">3</span>         	<span class="nv">Ref</span> <span class="o">=</span> <span class="nb">monitor</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">),</span>
<span class="ln">4</span>         	<span class="k">receive</span>
<span class="ln">5</span>         		<span class="p">{</span><span class="n">&#39;DOWN&#39;</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">,</span> <span class="nv">Why</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">6</span>         			<span class="nv">Fun</span><span class="p">(</span><span class="nv">Why</span><span class="p">)</span>
<span class="ln">7</span>         	<span class="k">end</span>
<span class="ln">8</span>    	 <span class="k">end</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span>1&gt; <span class="nv">F</span> <span class="o">=</span> fun<span class="o">()</span> -&gt;
<span class="ln"> 2</span>			receive
<span class="ln"> 3</span>				X -&gt; list_to_atom<span class="o">(</span>X<span class="o">)</span>
<span class="ln"> 4</span>			end
<span class="ln"> 5</span>		end.
<span class="ln"> 6</span>2&gt; <span class="nv">Pid</span> <span class="o">=</span> spawn<span class="o">(</span>F<span class="o">)</span>.
<span class="ln"> 7</span>
<span class="ln"> 8</span>3&gt; lib_misc:on_exit<span class="o">(</span>Pid, 
<span class="ln"> 9</span>					fun<span class="o">(</span>Why<span class="o">)</span> -&gt;
<span class="ln">10</span>						io:format<span class="o">(</span><span class="s2">&#34; ~p died with:~p~n&#34;</span>, <span class="o">[</span>Pid, Why<span class="o">])</span>
<span class="ln">11</span>					end<span class="o">)</span>.
<span class="ln">12</span><span class="c1"># 如果向Pid发送一个原子，这个进程就会挂掉（因为它试图对非列表类型执行list_to_atom）</span>
<span class="ln">13</span>4&gt; Pid ! hello.
<span class="ln">14</span>hello
<span class="ln">15</span>5&gt;
<span class="ln">16</span><span class="o">=</span>ERROR <span class="nv">REPORT</span><span class="o">====</span>
</code></pre></div><ul>
<li>进程挂掉时触发的函数可以执行任何它喜欢的计算：它可以忽略错误，记录错误或者重启应用程序。这个选择完全取决于程序员。</li>
</ul>
<p>2.让一组进程共同终止</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">start</span><span class="p">(</span><span class="nv">Fs</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">3</span>              	<span class="c">% 创建进程并且建立连接
</span><span class="ln">4</span><span class="c"></span>         		<span class="p">[</span><span class="nb">spawn_link</span><span class="p">(</span><span class="nv">F</span><span class="p">)</span> <span class="p">||</span> <span class="nv">F</span> <span class="o">&lt;-</span> <span class="nv">Fs</span><span class="p">],</span>
<span class="ln">5</span>         		<span class="k">receive</span>
<span class="ln">6</span>         		<span class="k">after</span>
<span class="ln">7</span>         			<span class="n">infinity</span> <span class="o">-&gt;</span> <span class="n">true</span>
<span class="ln">8</span>         		<span class="k">end</span>
<span class="ln">9</span>         <span class="k">end</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>Pid = start([F1,F2,...]),
<span class="ln">2</span>on_exit(Pid, fun(Why) -&gt;
<span class="ln">3</span>					...
<span class="ln">4</span>					...
<span class="ln">5</span>			end)
</code></pre></div><ul>
<li>各个进程通过start函数创建的进程连接，于是一个挂了发送的退出信号全部都会接收，于是全都会终止</li>
</ul>
<p>3.生成一个永不终止的进程</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">keep_alive</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span><span class="nv">Fun</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="nb">register</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Pid</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="nv">Fun</span><span class="p">)),</span>
<span class="ln">3</span>    <span class="n">on_exit</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="k">fun</span><span class="p">(_</span><span class="nv">Why</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">keep_alive</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">)</span> <span class="k">end</span><span class="p">).</span>
</code></pre></div><ul>
<li>可能会在register和on_exit这两个语句之间挂掉。如果进程在on_exit被执行之前终止，就不会创建连接，on_exit进程的行为就会和预计的不同。如果有两个程序<strong>同时</strong>尝试用相同的Name值执行keep_alive，这个错误就会发生这被称为竞争状况（race condition）：两段代码（都是这段）和on_exit里执行连接操作的代码片段正在互相竞争。如果这里出了错，程序就可能会表现出你预料之外的行为。</li>
<li>一般语言解决并发程序竞争时可以加锁或者设置信号量，不过Erlang语言的全局变量不太好搞定。</li>
</ul>
<h3 id="练习-9">练习</h3>
<p><strong>(1)</strong></p>
<blockquote>
<p>编写一个my_spawn(Mod, Func, Args)函数。它的行为类似spawn(Mod, Func, Args)，但有一点区别。如果分裂出的进程挂了，就应打印一个消息，说明进程挂掉的原因以及在此之前存活了多长时间。</p>
</blockquote>
<p>使用spawn函数需要注意，模块里面的函数使用spawn最好时MFA的形式，而匿名函数使用Fun的形式，不然会有一些奇怪的问题。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 2</span><span class="c">%%% @author bnaod1
</span><span class="ln"> 3</span><span class="c">%%% @copyright (C) 2024, &lt;COMPANY&gt;
</span><span class="ln"> 4</span><span class="c">%%% @doc
</span><span class="ln"> 5</span><span class="c">%%%
</span><span class="ln"> 6</span><span class="c">%%% @end
</span><span class="ln"> 7</span><span class="c">%%% Created : 13. 12月 2024 09:10
</span><span class="ln"> 8</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 9</span><span class="c"></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">my_spawn</span><span class="p">).</span>
<span class="ln">10</span><span class="p">-</span><span class="ni">author</span><span class="p">(</span><span class="s">&#34;bnaod1&#34;</span><span class="p">).</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="c">%% API
</span><span class="ln">13</span><span class="c"></span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">my_spawn</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">test</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln">14</span>
<span class="ln">15</span>
<span class="ln">16</span><span class="nf">my_spawn</span><span class="p">(</span><span class="nv">Mod</span><span class="p">,</span> <span class="nv">Func</span><span class="p">,</span> <span class="nv">Argc</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">17</span>  <span class="nv">Pid</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="nv">Mod</span><span class="p">,</span> <span class="nv">Func</span><span class="p">,</span> <span class="nv">Argc</span><span class="p">),</span>
<span class="ln">18</span>  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Process </span><span class="si">~p</span><span class="s"> start.</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Pid</span><span class="p">]),</span>
<span class="ln">19</span>  <span class="nb">statistics</span><span class="p">(</span><span class="n">runtime</span><span class="p">),</span>
<span class="ln">20</span>  <span class="nv">Ref</span> <span class="o">=</span> <span class="nb">monitor</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">),</span>
<span class="ln">21</span>  <span class="k">receive</span>
<span class="ln">22</span>    <span class="p">{</span><span class="n">&#39;DOWN&#39;</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">,</span> <span class="nv">Why</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">23</span>      <span class="p">{_,</span> <span class="nv">Time</span><span class="p">}</span> <span class="o">=</span> <span class="nb">statistics</span><span class="p">(</span><span class="n">runtime</span><span class="p">),</span>
<span class="ln">24</span>      <span class="nv">U</span> <span class="o">=</span> <span class="nv">Time</span><span class="p">,</span>
<span class="ln">25</span>      <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Process </span><span class="si">~p</span><span class="s"> survived </span><span class="si">~p</span><span class="s"> seconds.</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">U</span><span class="p">]),</span>
<span class="ln">26</span>      <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Process </span><span class="si">~p</span><span class="s"> died for reason </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Why</span><span class="p">])</span>
<span class="ln">27</span>  <span class="k">end</span>
<span class="ln">28</span>  <span class="p">.</span>
<span class="ln">29</span>
<span class="ln">30</span>
<span class="ln">31</span>
<span class="ln">32</span><span class="nf">test</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">33</span>    <span class="k">receive</span>
<span class="ln">34</span>      <span class="nv">X</span> <span class="o">-&gt;</span> <span class="nb">list_to_atom</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span>
<span class="ln">35</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>1&gt; c(my_spawn).
<span class="ln"> 2</span>{ok,my_spawn}
<span class="ln"> 3</span>2&gt; Pid = spawn(my_spawn, my_spawn, [my_spawn, test, []]).
<span class="ln"> 4</span>Process &lt;0.90.0&gt; start.
<span class="ln"> 5</span>&lt;0.89.0&gt;
<span class="ln"> 6</span>3&gt; &lt;0.90.0&gt; ! e1.
<span class="ln"> 7</span>Process &lt;0.90.0&gt; survived 9 seconds.
<span class="ln"> 8</span>=ERROR REPORT==== 13-Dec-2024::10:38:36.634989 ===
<span class="ln"> 9</span>Error in process &lt;0.90.0&gt; with exit value:
<span class="ln">10</span>{badarg,[{erlang,list_to_atom,
<span class="ln">11</span>                 [e1],
<span class="ln">12</span>                 [{error_info,#{module =&gt; erl_erts_errors}}]},
<span class="ln">13</span>         {my_spawn,test,0,[{file,&#34;my_spawn.erl&#34;},{line,34}]}]}
<span class="ln">14</span>
<span class="ln">15</span>e1
<span class="ln">16</span>Process &lt;0.90.0&gt; died for reason {badarg,
<span class="ln">17</span>                                  [{erlang,list_to_atom,
<span class="ln">18</span>                                    [e1],
<span class="ln">19</span>                                    [{error_info,
<span class="ln">20</span>                                      #{module =&gt; erl_erts_errors}}]},
<span class="ln">21</span>                                   {my_spawn,test,0,
<span class="ln">22</span>                                    [{file,&#34;my_spawn.erl&#34;},{line,34}]}]}
<span class="ln">23</span>4&gt; 
</code></pre></div><p><strong>(2)</strong></p>
<blockquote>
<p>用本章前面展示的on_exit函数来完成上一个练习。</p>
</blockquote>
<p>这个题就是count函数，如果传函数定义的话是不行的，只能使用匿名函数。</p>
<p>破案了，原来是spawn里面参数不能加括号。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 2</span><span class="c">%%% @author bnaod1
</span><span class="ln"> 3</span><span class="c">%%% @copyright (C) 2024, &lt;COMPANY&gt;
</span><span class="ln"> 4</span><span class="c">%%% @doc
</span><span class="ln"> 5</span><span class="c">%%%
</span><span class="ln"> 6</span><span class="c">%%% @end
</span><span class="ln"> 7</span><span class="c">%%% Created : 13. 12月 2024 10:40
</span><span class="ln"> 8</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 9</span><span class="c"></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">question2</span><span class="p">).</span>
<span class="ln">10</span><span class="p">-</span><span class="ni">author</span><span class="p">(</span><span class="s">&#34;bnaod1&#34;</span><span class="p">).</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="c">%% API
</span><span class="ln">13</span><span class="c"></span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">time</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">on_exit</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">test</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">sleep</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln">14</span>
<span class="ln">15</span>
<span class="ln">16</span><span class="nf">time</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">17</span>  <span class="c">%% 创建测试进程
</span><span class="ln">18</span><span class="c"></span>  <span class="nv">Pid</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="n">question2</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="p">[]),</span>
<span class="ln">19</span>  <span class="c">%% 开始计时
</span><span class="ln">20</span><span class="c"></span>  <span class="nb">statistics</span><span class="p">(</span><span class="n">wall_clock</span><span class="p">),</span>
<span class="ln">21</span>  <span class="c">%% 创建监视进程，一旦死亡执行count计算时间
</span><span class="ln">22</span><span class="c"></span>  <span class="n">on_exit</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">23</span>                    <span class="p">{_,</span> <span class="nv">Time</span><span class="p">}</span> <span class="o">=</span> <span class="nb">statistics</span><span class="p">(</span><span class="n">wall_clock</span><span class="p">),</span>
<span class="ln">24</span>                    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Duration: </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Time</span><span class="p">])</span>
<span class="ln">25</span>               <span class="k">end</span><span class="p">),</span>
<span class="ln">26</span>  <span class="c">%% 创建一个进程，隔一定时间使进程死亡
</span><span class="ln">27</span><span class="c"></span>  <span class="n">sleep</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="mi">3000</span><span class="p">),</span>
<span class="ln">28</span>  <span class="n">done</span><span class="p">.</span>
<span class="ln">29</span>
<span class="ln">30</span><span class="c">%% 监视器
</span><span class="ln">31</span><span class="c"></span><span class="nf">on_exit</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">32</span>  <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">33</span>    <span class="nv">Ref</span> <span class="o">=</span> <span class="nb">monitor</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">),</span>
<span class="ln">34</span>    <span class="k">receive</span>
<span class="ln">35</span>      <span class="p">{</span><span class="n">&#39;DOWN&#39;</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">,</span> <span class="nv">Why</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">36</span>        <span class="nv">Fun</span><span class="p">()</span>
<span class="ln">37</span>    <span class="k">end</span>
<span class="ln">38</span>  <span class="k">end</span><span class="p">).</span>
<span class="ln">39</span>
<span class="ln">40</span><span class="c">%% 计算存活时间
</span><span class="ln">41</span><span class="c">%%count() -&gt;
</span><span class="ln">42</span><span class="c">%%  {_, Time} = statistics(runtime),
</span><span class="ln">43</span><span class="c">%%  io:format(&#34;Duration: ~p~n&#34;, [Time]).
</span><span class="ln">44</span><span class="c"></span>
<span class="ln">45</span><span class="c">%% 隔一定时间发送死亡通知
</span><span class="ln">46</span><span class="c"></span><span class="nf">sleep</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">47</span>  <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">48</span>          <span class="k">receive</span>
<span class="ln">49</span>          <span class="k">after</span> <span class="nv">T</span> <span class="o">-&gt;</span>
<span class="ln">50</span>            <span class="nv">Pid</span> <span class="o">!</span> <span class="n">seterror</span>
<span class="ln">51</span>          <span class="k">end</span>
<span class="ln">52</span>        <span class="k">end</span>
<span class="ln">53</span>  <span class="p">).</span>
<span class="ln">54</span>
<span class="ln">55</span>
<span class="ln">56</span><span class="c">%% 测试函数
</span><span class="ln">57</span><span class="c"></span><span class="nf">test</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">58</span>  <span class="k">receive</span>
<span class="ln">59</span>    <span class="nv">X</span> <span class="o">-&gt;</span> <span class="nb">list_to_atom</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span>
<span class="ln">60</span>  <span class="k">end</span><span class="p">.</span>
</code></pre></div><p><strong>(3)</strong></p>
<blockquote>
<p>编写一个my_spawn(Mod, Func, Args, Time)函数。它的行为类似spawn(Mod, Func,Args)，但有一点区别。如果分裂出的进程存活超过了Time秒，就应当被摧毁。</p>
</blockquote>
<p>使用spawn函数时，放入的函数只能是名字，不能加括号。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 2</span><span class="c">%%% @author bnaod1
</span><span class="ln"> 3</span><span class="c">%%% @copyright (C) 2024, 四川农业大学
</span><span class="ln"> 4</span><span class="c">%%% @doc
</span><span class="ln"> 5</span><span class="c">%%%
</span><span class="ln"> 6</span><span class="c">%%% @end
</span><span class="ln"> 7</span><span class="c">%%% Created : 13. 12月 2024 11:19
</span><span class="ln"> 8</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 9</span><span class="c"></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">question3</span><span class="p">).</span>
<span class="ln">10</span><span class="p">-</span><span class="ni">author</span><span class="p">(</span><span class="s">&#34;bnaod1&#34;</span><span class="p">).</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="c">%% API
</span><span class="ln">13</span><span class="c"></span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">my_spawn</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">test</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln">14</span>
<span class="ln">15</span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">16</span>  <span class="nb">spawn</span><span class="p">(</span><span class="n">question3</span><span class="p">,</span> <span class="n">my_spawn</span><span class="p">,</span> <span class="p">[</span><span class="n">question3</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="p">[],</span> <span class="mi">3000</span><span class="p">]).</span>
<span class="ln">17</span>
<span class="ln">18</span><span class="nf">my_spawn</span><span class="p">(</span><span class="nv">Mod</span><span class="p">,</span> <span class="nv">Func</span><span class="p">,</span> <span class="nv">Args</span><span class="p">,</span> <span class="nv">Time</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">19</span>  <span class="nv">Pid</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="nv">Mod</span><span class="p">,</span> <span class="nv">Func</span><span class="p">,</span> <span class="nv">Args</span><span class="p">),</span>
<span class="ln">20</span>  <span class="k">receive</span>
<span class="ln">21</span>  <span class="k">after</span> <span class="nv">Time</span> <span class="o">-&gt;</span>
<span class="ln">22</span>    <span class="nv">Pid</span> <span class="o">!</span> <span class="n">shutdown</span>
<span class="ln">23</span>  <span class="k">end</span><span class="p">.</span>
<span class="ln">24</span>
<span class="ln">25</span><span class="nf">test</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">26</span>  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;test is running.</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">),</span>
<span class="ln">27</span>  <span class="k">receive</span>
<span class="ln">28</span>    <span class="n">shutdown</span> <span class="o">-&gt;</span>
<span class="ln">29</span>      <span class="nb">exit</span><span class="p">(</span><span class="s">&#34;Time limit</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">)</span>
<span class="ln">30</span>  <span class="k">after</span> <span class="mi">1000</span> <span class="o">-&gt;</span>
<span class="ln">31</span>    <span class="n">test</span><span class="p">()</span>
<span class="ln">32</span>  <span class="k">end</span><span class="p">.</span>
<span class="ln">33</span>
</code></pre></div><p><strong>(4)</strong></p>
<blockquote>
<p>编写一个函数，让它创建一个每隔5秒就打印一次“我还在运行”的注册进程。</p>
<p>编写一个函数来监视这个进程，如果进程挂了就重启它。</p>
<p>启动公共进程和监视进程，然后摧毁公共进程，检查它是否会被监视进程重启。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 2</span><span class="c">%%% @author bnaod1
</span><span class="ln"> 3</span><span class="c">%%% @copyright (C) 2024, 四川农业大学
</span><span class="ln"> 4</span><span class="c">%%% @doc
</span><span class="ln"> 5</span><span class="c">%%%
</span><span class="ln"> 6</span><span class="c">%%% @end
</span><span class="ln"> 7</span><span class="c">%%% Created : 13. 12月 2024 14:35
</span><span class="ln"> 8</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 9</span><span class="c"></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">question4</span><span class="p">).</span>
<span class="ln">10</span><span class="p">-</span><span class="ni">author</span><span class="p">(</span><span class="s">&#34;bnaod1&#34;</span><span class="p">).</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="c">%% API
</span><span class="ln">13</span><span class="c"></span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">make</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">print</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">monitor_print</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln">14</span>
<span class="ln">15</span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">16</span>  <span class="n">make</span><span class="p">(),</span>
<span class="ln">17</span>  <span class="nb">spawn</span><span class="p">(</span><span class="n">question4</span><span class="p">,</span> <span class="n">monitor_print</span><span class="p">,</span> <span class="p">[]).</span>
<span class="ln">18</span>
<span class="ln">19</span>
<span class="ln">20</span><span class="nf">make</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">21</span>  <span class="nb">register</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="nb">spawn</span><span class="p">(</span><span class="n">question4</span><span class="p">,</span> <span class="n">print</span><span class="p">,</span> <span class="p">[])).</span>
<span class="ln">22</span>
<span class="ln">23</span><span class="nf">print</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">24</span>  <span class="k">receive</span>
<span class="ln">25</span>    <span class="p">{_,</span> <span class="n">die</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">26</span>      <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;died</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">),</span>
<span class="ln">27</span>      <span class="nb">exit</span><span class="p">(</span><span class="s">&#34;command die&#34;</span><span class="p">);</span>
<span class="ln">28</span>    <span class="p">{</span><span class="nv">Pid</span><span class="p">,</span> <span class="n">comfirm</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">29</span>      <span class="nv">Pid</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="s">&#34;still alive&#34;</span><span class="p">}</span>
<span class="ln">30</span>  <span class="k">after</span> <span class="mi">5000</span> <span class="o">-&gt;</span>
<span class="ln">31</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Im still running.</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">),</span>
<span class="ln">32</span>    <span class="n">print</span><span class="p">()</span>
<span class="ln">33</span>  <span class="k">end</span><span class="p">.</span>
<span class="ln">34</span>
<span class="ln">35</span><span class="nf">monitor_print</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">36</span>  <span class="nv">Ref</span> <span class="o">=</span> <span class="nb">monitor</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">period</span><span class="p">),</span>
<span class="ln">37</span>  <span class="k">receive</span>
<span class="ln">38</span>    <span class="p">{</span><span class="n">&#39;DOWN&#39;</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">,</span> <span class="nv">Why</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">39</span>      <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Process period died, restart...</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">),</span>
<span class="ln">40</span>      <span class="n">make</span><span class="p">(),</span>
<span class="ln">41</span>      <span class="nb">spawn</span><span class="p">(</span><span class="n">question4</span><span class="p">,</span> <span class="n">monitor_print</span><span class="p">,</span> <span class="p">[])</span>
<span class="ln">42</span>  <span class="k">end</span><span class="p">.</span>
<span class="ln">43</span>
<span class="ln">44</span>
<span class="ln">45</span>
</code></pre></div><p><strong>(5)</strong></p>
<blockquote>
<p>编写一个函数来启动和监视多个工作进程。如果任何一个工作进程非正常终止，就重启它。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>
</code></pre></div><blockquote>
<p>编写一个函数来启动和监视多个工作进程。如果任何一个工作进程非正常终止，就摧毁所有工作进程，然后重启它们。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>
</code></pre></div><h2 id="第14章-分布式编程">第14章 分布式编程</h2>
<h3 id="分布式优势">分布式优势</h3>
<ul>
<li>性能：可以通过安排程序的不同部分在不同的机器上并行运行来让程序跑得更快。</li>
<li>可靠性：可以通过让系统运行在数台机器上来实现容错式系统。如果一台机器出了故障，可以在另一台机器上继续。</li>
<li>可扩展性：随着我们把应用程序越做越大，即使机器的处理能力再强大也迟早会耗尽。到那时，就必须添加更多的机器来提升处理能力。添加一台新机器应当是一次简单的操作，不需要对应用程序的架构做出大的修改。</li>
</ul>
<h3 id="分布式erlang示例">分布式Erlang示例</h3>
<p>本质上都是通过rpc在远程节点上执行操作然后返回。注意这里就有节点的称呼了。</p>
<p>不同阶段处理的问题主要是最开始的连通问题，而不是代码问题，他们都是使用rpc对远程服务器进行的方法调用。所以本质来说我认为只有一个服务器节点。</p>
<h4 id="第1阶段双方在同一节点">第1阶段：双方在同一节点</h4>
<p>一个简单的名称服务器。这步的代码和我们之前所学的一样</p>
<p>socket_dist/kvs.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">kvs</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">store</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">lookup</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="c">%注册服务器进程为kvs
</span><span class="ln"> 5</span><span class="c"></span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">register</span><span class="p">(</span><span class="n">kvs</span><span class="p">,</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">loop</span><span class="p">()</span> <span class="k">end</span><span class="p">)).</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="c">%服务器：一直在接收消息中
</span><span class="ln"> 8</span><span class="c"></span><span class="nf">loop</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>    <span class="k">receive</span>
<span class="ln">10</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="p">{</span><span class="n">store</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">11</span>            <span class="nb">put</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Value</span><span class="p">}),</span>
<span class="ln">12</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="n">kvs</span><span class="p">,</span> <span class="n">true</span><span class="p">},</span>
<span class="ln">13</span>            <span class="n">loop</span><span class="p">();</span>
<span class="ln">14</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="p">{</span><span class="n">lookup</span><span class="p">,</span> <span class="nv">Key</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">15</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="n">kvs</span><span class="p">,</span> <span class="nb">get</span><span class="p">(</span><span class="nv">Key</span><span class="p">)},</span>
<span class="ln">16</span>            <span class="n">loop</span><span class="p">()</span>
<span class="ln">17</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">18</span>
<span class="ln">19</span><span class="c">%封装客户端的消息
</span><span class="ln">20</span><span class="c"></span><span class="nf">store</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rpc</span><span class="p">({</span><span class="n">lookup</span><span class="p">,</span> <span class="nv">Key</span><span class="p">}).</span>
<span class="ln">21</span><span class="nf">lookup</span><span class="p">(</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rpc</span><span class="p">({</span><span class="n">lookup</span><span class="p">,</span> <span class="nv">Key</span><span class="p">}).</span>
<span class="ln">22</span>
<span class="ln">23</span><span class="c">%客户端：每次进行一次操作然后等待服务器回信
</span><span class="ln">24</span><span class="c"></span><span class="nf">rpc</span><span class="p">(</span><span class="nv">Q</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">25</span>    <span class="n">kvs</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Q</span><span class="p">},</span>
<span class="ln">26</span>    <span class="k">receive</span>
<span class="ln">27</span>        <span class="p">{</span><span class="n">kvs</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">28</span>            <span class="nv">Reply</span>
<span class="ln">29</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">30</span>
<span class="ln">31</span>
</code></pre></div><p>测试：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="o">&gt;</span> <span class="nn">kvs</span><span class="p">:</span><span class="nf">start</span><span class="p">().</span>
<span class="ln"> 2</span><span class="n">true</span>
<span class="ln"> 3</span><span class="o">&gt;</span> <span class="nn">kvs</span><span class="p">:</span><span class="nf">store</span><span class="p">({</span><span class="n">location</span><span class="p">,</span> <span class="n">joe</span><span class="p">},</span> <span class="s">&#34;Stockholm&#34;</span><span class="p">).</span>
<span class="ln"> 4</span><span class="n">true</span>
<span class="ln"> 5</span><span class="o">&gt;</span> <span class="nn">kvs</span><span class="p">:</span><span class="nf">store</span><span class="p">(</span><span class="n">weather</span><span class="p">,</span> <span class="n">raining</span><span class="p">).</span>
<span class="ln"> 6</span><span class="n">true</span>
<span class="ln"> 7</span><span class="o">&gt;</span> <span class="nn">kvs</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="n">weather</span><span class="p">).</span>
<span class="ln"> 8</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">raining</span><span class="p">}</span>
<span class="ln"> 9</span><span class="o">&gt;</span> <span class="nn">kvs</span><span class="p">:</span><span class="nf">lookup</span><span class="p">({</span><span class="n">location</span><span class="p">,</span> <span class="n">joe</span><span class="p">}).</span>
<span class="ln">10</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="s">&#34;Stockholm&#34;</span><span class="p">}</span>
<span class="ln">11</span><span class="o">&gt;</span> <span class="nn">kvs</span><span class="p">:</span><span class="nf">lookup</span><span class="p">({</span><span class="n">location</span><span class="p">,</span> <span class="n">jane</span><span class="p">}).</span>
<span class="ln">12</span><span class="n">undefined</span>
</code></pre></div><h4 id="第2阶段双方在同一主机不同节点">第2阶段：双方在同一主机不同节点</h4>
<p>终端1：服务器</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="sc">$ </span><span class="n">erl</span> <span class="o">-</span><span class="n">sname</span> <span class="n">gandalf</span>
<span class="ln">2</span><span class="p">(</span><span class="n">gandalf</span><span class="p">@</span><span class="n">localhost</span><span class="p">)</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="nn">kvs</span><span class="p">:</span><span class="nf">start</span><span class="p">().</span>
<span class="ln">3</span><span class="n">true</span>
</code></pre></div><p>终端2：客户端</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="sc">$ </span><span class="n">erl</span> <span class="o">-</span><span class="n">sname</span> <span class="n">bilbo</span>
<span class="ln">2</span><span class="p">(</span><span class="n">bilbo</span><span class="p">@</span><span class="n">localhost</span><span class="p">)</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="nn">rpc</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="n">gandalf</span><span class="p">@</span><span class="n">localhost</span><span class="p">,</span> <span class="n">kvs</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="p">[</span><span class="n">weather</span><span class="p">,</span> <span class="n">fine</span><span class="p">]).</span>
<span class="ln">3</span><span class="nf">true</span>
<span class="ln">4</span><span class="p">(</span><span class="n">bilbo</span><span class="p">@</span><span class="n">localhost</span><span class="p">)</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="nn">rpc</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="n">gandalf</span><span class="p">@</span><span class="n">localhost</span><span class="p">,</span> <span class="n">kvs</span><span class="p">,</span> <span class="n">lookup</span><span class="p">,</span> <span class="p">[</span><span class="n">weather</span><span class="p">]).</span>
<span class="ln">5</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">fine</span><span class="p">}</span>
</code></pre></div><ul>
<li>
<p><code>erl -sname gandalf</code></p>
<p>参数-sname gandalf的意思是“在本地主机上启动一个名为gandalf的Erlang节点”。注意一下Erlang shell是如何把Erlang节点名打印在命令提示符前面的。</p>
<p>节点名的形式是Name@Host。Name和Host都是原子，所以如果它们包含任何非原子的字符，就必须加上引号。</p>
</li>
<li>
<p><code>rpc:call(Node, Mod, Func, [Arg1, Arg2, .., ArgN])</code></p>
<p>rpc是一个标准的Erlang库模块。这个函数在Node上执行一次远程过程调用。调用的函数是Mod:Func(Arg1, Arg2, &hellip;, ArgN)。</p>
</li>
<li>
<p>上面这个过程是客户端远程执行服务器的函数</p>
</li>
</ul>
<h4 id="第3阶段双方在同一局域网不同机器上">第3阶段：双方在同一局域网不同机器上</h4>
<p>填入节点名称时需要加上单引号。然后有可能会报错，使用创建节点：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl -name gandalf@doris.myerl.example.com -setcookie abc
</code></pre></div><p>机器1终端：服务器</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="n">doris</span> <span class="sc">$ </span><span class="n">erl</span> <span class="o">-</span><span class="n">name</span> <span class="n">gandalf</span> <span class="o">-</span><span class="n">setcookie</span> <span class="n">abc</span>
<span class="ln">2</span><span class="p">(</span><span class="n">gandalf</span><span class="p">@</span><span class="n">doris</span><span class="p">.</span><span class="n">myerl</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">)</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="nn">kvs</span><span class="p">:</span><span class="nf">start</span><span class="p">().</span>
<span class="ln">3</span><span class="n">true</span>
</code></pre></div><p>机器2终端：客户端</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="n">george</span> <span class="sc">$ </span><span class="n">erl</span> <span class="o">-</span><span class="n">name</span> <span class="n">bilbo</span> <span class="o">-</span><span class="n">setcookie</span> <span class="n">abc</span>
<span class="ln">2</span><span class="p">(</span><span class="n">bilbo</span><span class="p">@</span><span class="n">george</span><span class="p">.</span><span class="n">myerl</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">)</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="nn">rpc</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="n">gandalf</span><span class="p">@</span><span class="n">doris</span><span class="p">.</span><span class="n">myerl</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">,</span> <span class="n">kvs</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="p">[</span><span class="n">weather</span><span class="p">,</span> <span class="n">cold</span><span class="p">]).</span>
<span class="ln">3</span><span class="nf">true</span>
<span class="ln">4</span><span class="p">(</span><span class="n">bilbo</span><span class="p">@</span><span class="n">george</span><span class="p">.</span><span class="n">myerl</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">)</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="nn">rpc</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="n">gandalf</span><span class="p">@</span><span class="n">doris</span><span class="p">.</span><span class="n">myerl</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">,</span> <span class="n">kvs</span><span class="p">,</span> <span class="n">lookup</span><span class="p">,</span> <span class="p">[</span><span class="n">weather</span><span class="p">]).</span>
<span class="ln">5</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">cold</span><span class="p">}</span>
</code></pre></div><ul>
<li>
<p>用<code>-name</code>参数启动Erlang。</p>
<p>我们在同一台机器上运行两个节点时使用了“短”（short）名称（通过-sname标识体现）。但如果它们属于不同的网络，我们就要使用-name。</p>
<p>当两台机器位于同一个子网时我们也可以使用-sname。而且如果没有DNS服务，-sname就是唯一可行的方式。</p>
</li>
<li>
<p>使用命令行参数<code>-setcookie abc</code>， 确保两个节点拥有相同的cookie。</p>
<p>当我们在同一台机器上运行两个节点时，因为它们都能访问同一个cookie文件$HOME/.erlang.cookie，所以我们不需要在Erlang命令行里添加cookie。</p>
</li>
<li>
<p>确保相关节点的完全限定主机名（fully qualified hostname）可以被DNS解析。对于我来说，域名myerl.example.com完全属于我的家庭网络，通过在/etc/hosts里添加一个条目来实现本地解析。</p>
</li>
<li>
<p>确保两个系统拥有相同版本的代码和相同版本的Erlang。如果不这么做，就可能会得到严重而离奇的错误。</p>
</li>
</ul>
<h4 id="第4阶段双方在互联网不同主机上">第4阶段：双方在互联网不同主机上</h4>
<p>原则上，这和第3阶段是一样的，但现在我们必须更加关注安全性。</p>
<ul>
<li>
<p>确保4369端口对TCP和UDP流量都开放。这个端口会被一个名为epmd的程序使用（它是Erlang Port Mapper Daemon的缩写，即Erlang端口映射守护进程）。</p>
</li>
<li>
<p>选择一个或一段连续端口给分布式Erlang使用，并确保这些端口是开放的。如果这些端口位于Min和Max之间（只想用一个端口就让Min=Max），就用以下命令启动Erlang：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>$ erl -name ... -setcookie ... -kernel inet_dist_listen_min Min  inet_dist_listen_max Max
</code></pre></div></li>
</ul>
<h3 id="两种分布式模型">两种分布式模型</h3>
<p>1.分布式Erlang</p>
<ul>
<li>编写的程序会在Erlang的节点（node）上运行。节点是一个独立的Erlang系统，包含一个自带地址空间和进程组的完整虚拟机。</li>
<li>分布式Erlang应用程序运行在一个<strong>可信</strong>环境中。因为任何节点都可以在其他Erlang节点上执行任意操作，所以这涉及高度的信任。虽然分布式Erlang应用程序可以运行在开放式网络上，但它们通常是运行在属于同一个局域网的集群上，并受防火墙保护。</li>
</ul>
<p>2.基于套接字的分布式模型</p>
<ul>
<li>可以用TCP/IP套接字来编写运行在不可信环境中的分布式应用程序。这个编程模型不如分布式Erlang那样强大，但是更安全。</li>
</ul>
<h3 id="一分布式编程的库和内置函数">一、分布式编程的库和内置函数</h3>
<p>在我的理解中，Node也是进程。</p>
<p>分布式相关库：</p>
<ol>
<li>
<p>rpc提供了许多远程过程调用服务。</p>
<p><code>call(Node, Mod ,Function, Args) -&gt; Result | {badrpc, Reason}</code>： 它会在Node上执行apply(Mod, Function, Args)，然后返回结果Result，如果调用失败则返回{badrpc, Reason}。</p>
</li>
<li>
<p>global里的函数可以用来在分布式系统里注册名称和加锁，以及维护一个全连接网络。</p>
</li>
<li>
<p>erlang模块有很多基本函数</p>
</li>
</ol>
<p>erlang库中的分布式基本函数：</p>
<ul>
<li>
<p><code>net_adm:ping(NodeName)</code> 连接节点</p>
</li>
<li>
<p><code>-spec monitor_node(Node, Flag) -&gt; true</code></p>
<p>如果Flag是true就会开启监视，Flag是false就会关闭监视。如果开启了监视，那么当Node加入或离开Erlang互连节点组时，执行这个内置函数的进程就会收到{nodeup, Node}或{nodedown, Node}的消息。</p>
</li>
<li>
<p><code>-spec node() -&gt; Node</code></p>
<p>它会返回本地节点的名称。如果节点不是分布式的则会返回nonode@nohost。</p>
</li>
<li>
<p><code>-spec node(Arg) -&gt;Node</code></p>
<p>它会返回Arg所在的节点。Arg可以是PID、引用或者端口。如果本地节点不是分布式的，则会返回nonode@nohost。</p>
</li>
<li>
<p><code>-spec nodes() -&gt; [Node]</code></p>
<p>它会返回一个列表，内含网络里其他所有与我们相连的节点。</p>
</li>
<li>
<p><code>spec is_alive() -&gt; bool()</code></p>
<p>如果本地节点是活动的，并且可以成为分布式系统的一部分，就返回true，否则返回false。</p>
</li>
<li>
<p><code>-spec spawn(Node, Fun) -&gt; Pid</code></p>
<p>它的工作方式和spawn(Fun)完全一致，只是新进程是在Node上分裂的进程。</p>
</li>
<li>
<p><code>-spec spawn(Node, Mod, Func, ArgList) -&gt; Pid</code></p>
<p>它的工作方式和spawn(Mod, Func, ArgList)完全一致，只是新进程是在Node上分裂的。spawn(Mod, Func, Args)会创建一个执行apply(Mod, Func, Args)的新进程。它会返回这个新进程的PID。</p>
<p>这种形式的spawn比spawn(Node, Fun)更加健壮。如果运行在多个分布式节点上的特定模块不是完全相同的版本，spawn(Node, Fun)就可能会出错。</p>
</li>
<li>
<p><code>-spec spawn_link(Node, Fun) -&gt; Pid</code></p>
<p>它的工作方式和spawn_link(Fun)完全一致，只是新进程是在Node上分裂的。所以新分裂的进程会连接Node节点。</p>
</li>
<li>
<p><code>-spec spawn_link(Node, Mod, Func, ArgList) -&gt; Pid</code></p>
<p>它的工作方式类似spawn(Node, Mod, Func, ArgList)，但是新进程会与当前进程相连接。</p>
</li>
<li>
<p><code>-spec disconnect_node(Node) -&gt; bool() | ignored</code></p>
<p>它会强制断开与某个节点的连接。</p>
</li>
</ul>
<h3 id="远程分裂示例">远程分裂示例</h3>
<p>这个示例在本质上也是rpc调用。</p>
<p>dist_demo.erl</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">dist_demo</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">rpc</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">start</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">(</span><span class="nv">Node</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="nb">spawn</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">loop</span><span class="p">()</span> <span class="k">end</span><span class="p">).</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="nf">rpc</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">M</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>    <span class="nv">Pid</span> <span class="o">!</span> <span class="p">{</span><span class="n">rpc</span><span class="p">,</span> <span class="n">self</span><span class="p">(),</span> <span class="nv">M</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">},</span>
<span class="ln"> 9</span>    <span class="k">receive</span>
<span class="ln">10</span>        <span class="p">{</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Response</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">11</span>            <span class="nv">Response</span>
<span class="ln">12</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">13</span>
<span class="ln">14</span><span class="c">%% 服务器根据匹配的消息创建进程
</span><span class="ln">15</span><span class="c"></span><span class="nf">loop</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">16</span>    <span class="k">receive</span>
<span class="ln">17</span>        <span class="p">{</span><span class="n">rpc</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">,</span> <span class="nv">M</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">18</span>            <span class="nv">Pid</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="p">(</span><span class="k">catch</span> <span class="nb">apply</span><span class="p">(</span><span class="nv">M</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">))},</span>
<span class="ln">19</span>            <span class="n">loop</span><span class="p">()</span>
<span class="ln">20</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><ul>
<li><code>(catch apply(M, F, A))</code>：就是运行MFA，然后有异常捕获异常</li>
</ul>
<p>测试1：</p>
<ul>
<li>主机1：服务器</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>doris $ erl -name gandalf -setcookie abc
<span class="ln">2</span>(gandalf@doris.myerl.example.com) 1&gt;
</code></pre></div><ul>
<li>主机2：客户端</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>george $ erl -name bilbo -setcookie abc
<span class="ln">2</span>(bilbo@george.myerl.example.com) 1&gt; Pid = dist_demo:start(&#39;gandalf@doris.myerl.example.com&#39;).
<span class="ln">3</span>&lt;5094.40.0&gt;
<span class="ln">4</span># spawn让远程节点（gandalf）分裂一个进程
<span class="ln">5</span># Pid是这个远程节点进程的标识符
<span class="ln">6</span>(bilbo@george.myerl.example.com) 2&gt; dist_demo:rpc(Pid, erlang, node, []).
<span class="ln">7</span>&#39;gandalf@doris.myerl.example.com&#39;
<span class="ln">8</span>%% 远程分裂：在远程节点上执行erlang:node()并返回一个值。
</code></pre></div><p>测试2：文件服务器</p>
<p>由于可以在远程主机执行任何erl代码，所以可以充当文件服务器：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>(bilbo@george.myerl.example.com) 1&gt; Pid = dist_demo:start(&#39;gandalf@doris.myerl.example.com&#39;).
<span class="ln">2</span>(bilbo@george.myerl.example.com) 2&gt; dist_demo:rpc(Pid, file, get_cwd, []).
<span class="ln">3</span>{ok, &#34;/home/joe/projects/book/code&#34;}
<span class="ln">4</span>(bilbo@george.myerl.example.com) 3&gt; dist_demo:rpc(Pid, file, list_dir, [&#34;.&#34;]).
<span class="ln">5</span>{ok, [&#34;adapter_db1.erl&#34;, &#34;processes.erl&#34;, ...]}
<span class="ln">6</span>(bilbo@george.myerl.example.com) 4&gt; dist_demo:Pid, file, read_file, [&#34;dist_demo.erl&#34;]).
<span class="ln">7</span>{ok, &lt;&lt;&#34;-module...&#34;}
</code></pre></div><p>使用file模块里的三个函数来访问gandalf主机的文件系统 ：</p>
<ul>
<li><code>file:get_cwd()</code> 返回文件服务器的当前工作目录</li>
<li><code>file:list_dir(Dir)</code>返回Dir里所有文件的列表</li>
<li><code>file:read_file(File)</code> 读取文件File。</li>
</ul>
<p>测试3：远程命令执行摧毁计算机</p>
<p>分布式Erlang适合编写那些可信任其他参与者的集群应用程序</p>
<p>分布式Erlang的主要问题在于客户端可以自行决定在服务器上分裂出各种进程。因此，要摧毁你的系统，只需执行下面的命令：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nn">rpc</span><span class="p">:</span><span class="nf">multicall</span><span class="p">(</span><span class="nb">nodes</span><span class="p">(),</span> <span class="n">os</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">[</span><span class="s">&#34;cd /&#39; rm -rf *&#39;&#34;</span><span class="p">])</span>
</code></pre></div><h3 id="cookie-保护系统">cookie 保护系统</h3>
<p>cookie系统让访问单个或一组节点变得更安全。每个节点都有一个cookie，如果它想与其他任何节点通信，它的cookie就必须和对方节点的cookie相同。为了确保cookie相同，分布式Erlang系统里的所有节点都必须以相同的“神奇”（magic）cookie启动，或者通过执行<code>erlang:set_cookie</code>把它们的cookie修改成相同的值。Erlang集群的定义就是一组带有相同cookie的互连节点。</p>
<p>cookie保护系统被设计用来创建运行在局域网（LAN）上的分布式系统，LAN本身应该受防火墙保护，与互联网隔开。</p>
<p>可以用三种方法设置cookie：</p>
<ol>
<li>在文件$HOME/.erlang.cookie里存放相同的cookie。这个文件包含一个随机字符串，是Erlang第一次在你的机器上运行时自动创建的。这个文件可以被复制到所有想要参与分布式Erlang会话的机器上。也可以显式设置它的值。</li>
<li>当Erlang启动时，可以用命令行参数-setcookie C来把神奇cookie设成C。（这种方法Unix系统里的任何用户都可以用ps命令来查看你的cookie。）</li>
<li>内置函数erlang:set_cookie(node(), C)能把本地节点的cookie设成原子C。</li>
</ol>
<p>cookie从不会在网络中明文传输，它只用来对某次会话进行初始认证。分布式Erlang会话不是加密的，但可以被设置成在加密通道中运行。</p>
<h3 id="二lib_chan模块">二、lib_chan模块</h3>
<p>这个lib_chan模块并不是官方库，可能是作者自己写的，正式的服务器还是等到OTP再说。</p>
<p>lib_chan模块让用户能够显式控制自己的机器能分裂出哪些进程：</p>
<ul>
<li>
<p><code>-spec start_server() -&gt; true</code></p>
<p>它会在本地主机上启动一个服务器。这个服务器的行为由文件$HOME/.erlang_config/lib_chan.conf决定。</p>
</li>
<li>
<p><code>-spec start_server(Conf) -&gt; true</code></p>
<p>它会在本地主机上启动一个服务器。这个服务器的行为由文件Conf决定，它包含一个由下列形式的元组所组成的列表：</p>
<p><code>{port, NNNN}</code>：它会开始监听端口号NNNN。</p>
<p><code>{service, S, password, P, mfa, SomeMod, SomeFunc, SomeArgsS}</code>：它会定义一个被密码P保护的服务S。如果这个服务启动了，就会通过分裂SomeMod:SomeFunc(MM, ArgsC, SomeArgsS)创建一个进程，负责处理来自客户端的消息。这里的MM是一个代理进程的PID，可以用来向客户端发送消息。参数ArgsC来自于客户端的连接调用。</p>
</li>
<li>
<p><code>-spec connect(Host, Port, S, P, ArgsC) -&gt; {ok, Pid} | {error, Why}</code></p>
<p>尝试开启主机Host上的端口Port，然后尝试激活被密码P保护的服务S。如果密码正确，就会返回{ok, Pid}。Pid是一个代理进程的标识符，可以用来向服务器发送消息。</p>
<p>当客户端调用connect/5建立连接后，就会分裂出两个代理进程，一个在客户端，另一个在服务器端。这些代理进程负责把Erlang消息转换成TCP包数据，捕捉来自控制进程的退出信号，以及套接字关闭。</p>
</li>
</ul>
<h3 id="基于套接字的分布式模型示例">基于套接字的分布式模型示例</h3>
<h4 id="服务器">服务器</h4>
<p>配置文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>{port, 1234}.
<span class="ln">2</span>{service, nameServer, password, &#34;ABXy45&#34;, mfa, mod_name_server, start_me_up, notUsed}.
</code></pre></div><p>它的意思是我们将在自己机器的1234端口上提供一个名为nameServer的服务。这个服务被密码ABXy45保护。</p>
<p>socket_dist/mod_name_server.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">mod_name_server</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_me_up</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start_me_up</span><span class="p">(</span><span class="nv">MM</span><span class="p">,</span> <span class="p">_</span><span class="nv">ArgsC</span><span class="p">,</span> <span class="p">_</span><span class="nv">ArgS</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="n">loop</span><span class="p">(</span><span class="nv">MM</span><span class="p">).</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="nf">loop</span><span class="p">(</span><span class="nv">MM</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>    <span class="k">receive</span>
<span class="ln"> 9</span>        <span class="p">{</span><span class="n">chan</span><span class="p">,</span> <span class="nv">MM</span><span class="p">,</span> <span class="p">{</span><span class="n">store</span><span class="p">,</span> <span class="nv">K</span><span class="p">,</span> <span class="nv">V</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">10</span>            <span class="nn">kvs</span><span class="p">:</span><span class="nf">store</span><span class="p">(</span><span class="nv">K</span><span class="p">,</span><span class="nv">V</span><span class="p">),</span>
<span class="ln">11</span>            <span class="n">loop</span><span class="p">(</span><span class="nv">MM</span><span class="p">);</span>
<span class="ln">12</span>        <span class="p">{</span><span class="n">chan</span><span class="p">,</span> <span class="nv">MM</span><span class="p">,</span> <span class="p">{</span><span class="n">lookup</span><span class="p">,</span> <span class="nv">K</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">13</span>            <span class="nv">MM</span> <span class="o">!</span> <span class="p">{</span><span class="nb">send</span><span class="p">,</span> <span class="nn">kvs</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="nv">K</span><span class="p">)},</span>
<span class="ln">14</span>            <span class="n">loop</span><span class="p">(</span><span class="nv">MM</span><span class="p">);</span>
<span class="ln">15</span>        <span class="p">{</span><span class="n">chan_closed</span><span class="p">,</span> <span class="nv">MM</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">16</span>            <span class="n">true</span>
<span class="ln">17</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>mod_name_server遵循以下协议：</p>
<ul>
<li>如果客户端向服务器发送一个消息{send, X}，这个消息在mod_name_server里就会变
成{chan, MM, X}的形式（MM是服务器代理进程的PID）。</li>
<li>如果客户端终止或者用于通信的套接字出于任何原因关闭了，服务器就会收到一个
{chan_closed, MM}形式的消息。</li>
<li>如果服务器想给客户端发送一个消息X，就会通过调用MM ! {send, X}实现。</li>
<li>如果服务器想要显式关闭连接，就会通过执行MM ! close实现。</li>
</ul>
<p>这个协议是一个中间人协议，客户端代码和服务器代码都遵循它。本书附录B里的“lib_chan_mm：中间人”一节会更详细地解释套接字中间人代码。</p>
<h4 id="测试">测试</h4>
<p>服务器</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; kvs:start().
<span class="ln">2</span>true
<span class="ln">3</span>2&gt; lib_chan:start_server().
<span class="ln">4</span>Starting a port server on 1234....
<span class="ln">5</span>true
</code></pre></div><p>客户端</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; {ok, Pid} = lib_chan:connnect(&#34;localhost&#34;, 1234, nameServer, &#34;ABXy45&#34;, &#34;&#34;).
<span class="ln">2</span>{ok, &lt;0.43.0&gt;}
<span class="ln">3</span>2&gt; lib_chan:cast(Pid, {store, joe, &#34;writing a book&#34;}).
<span class="ln">4</span>{send, {store, joe, &#34;writing a book&#34;}}
<span class="ln">5</span>3&gt; lib_chan:rpc(Pid, {lookup, joe}).
<span class="ln">6</span>{ok, &#34;writing a book&#34;}
<span class="ln">7</span>4&gt; lib_chan:rpc(Pid, {lookup, jim}).
<span class="ln">8</span>undefined
</code></pre></div><p>在这个案例里，决定配置文件内容的是<strong>远程机器的所有者</strong>。配置文件指定了哪些应用程序是这台机器允许运行的，以及哪个端口是用来与这些应用程序通信的。</p>
<h3 id="练习-10">练习</h3>
<p>(1) 在同一主机上启动两个节点。查询rpc模块的手册页。对这两个节点执行一些远程过程调用。</p>
<p>(2) 重复上一个练习，这次使用同一局域网里的两个节点。</p>
<p>(3) 重复上一个练习，这次使用不同网络里的两个节点。</p>
<p>(4) 用lib_chan里的库编写YAFS（Yet Another File Server的缩写，即“又一个文件服务器”）
。你会从中学到很多知识。给你的文件服务器添加一些“装饰品”。</p>
<h3 id="附录lib_chan模块实现原理">附录：lib_chan模块实现原理</h3>
<p>TODO，在附录</p>
<h2 id="第15章-接口技术">第15章 接口技术</h2>
<p>可以用多种方式建立外部语言程序与Erlang之间的接口：</p>
<ul>
<li>让程序以<strong>外部操作系统进程</strong>的形式在Erlang虚拟机以外运行。这是一种安全的做法。即使外部语言的代码有问题，也不会让Erlang系统崩溃。Erlang通过一种名为<strong>端口（port）的对象</strong>来控制外部进程，与外部进程的通信则是通过一个面向字节的通信信道。Erlang负责启动和停止外部程序，还可以监视它，让在它崩溃后重启。外部进程被称为端口进程，因为它是通过一个Erlang端口控制的。</li>
<li>在Erlang内部运行<strong>操作系统命令</strong>并捕捉结果。</li>
<li>在Erlang虚拟机的内部运行外部语言代码。这涉及链接外部代码和Erlang虚拟机代码，是一种<strong>不安全</strong>的做法。外部语言代码里的错误可能会导致Erlang系统崩溃。虽然它不安全，但还是有用的，因为这么做比使用外部进程更<strong>高效</strong>。把代码链接到Erlang内核只适用于C这样<strong>能生成本地目标代码</strong>的语言，不适用于Java这样自身拥有虚拟机的语言。</li>
</ul>
<h3 id="端口概述">端口概述</h3>
<p>Erlang通过名为端口的对象与外部程序通信。如果向端口发送一个消息，此消息就会被发往与端口相连的外部程序。来自外部程序的消息则会变成来自端口的Erlang消息。</p>
<p>对程序员而言，端口的行为就像是一个Erlang进程。你可以向它发送消息，可以注册它（就像进程一样），诸如此类。如果外部程序崩溃了，就会有一个退出信号发送给相连的进程。如果相连的进程挂了，外部程序就会被关闭。</p>
<p>创建端口的进程被称为该端口的<strong>相连进程</strong>。相连进程有其特殊的重要性：所有发往端口的消息都必须标明相连进程的PID，所有来自外部程序的消息都会发往相连进程。</p>
<h3 id="创建端口">创建端口</h3>
<p><code>-spec open_port(PortName, [Opt]) -&gt; Port</code></p>
<p>其中PortName是下列选项中的一个:</p>
<ul>
<li>
<p><code>{spawn, Command}</code></p>
<p>启动一个外部程序。Command是这个外部程序的<strong>名称</strong>。除非能找到一个名为Command的<strong>内链驱动</strong>，否则Command会在Erlang工作空间之外运行。</p>
</li>
<li>
<p><code>{fd, In, Out}</code></p>
<p>允许一个Erlang进程访问Erlang使用的任何当前打开<strong>文件描述符</strong>。文件描述符In可以用作标准输入，文件描述符Out可以用作标准输出。</p>
</li>
</ul>
<p>Opt是下列选项中的一个:</p>
<ul>
<li>
<p><code>{packet, N}</code></p>
<p>数据包（packet）前面有N（1、2或4）个字节的<strong>长度计数</strong>。</p>
</li>
<li>
<p><code>stream</code></p>
<p>发送消息时不带数据包长度信息。应用程序必须知道如何处理这些数据包。</p>
</li>
<li>
<p><code>{line, Max}</code></p>
<p>发送消息时使用一次一行的形式。如果有一行超过了Max字节，就会在Max字节处被拆分。</p>
</li>
<li>
<p><code>{cd, Dir}</code></p>
<p>只适用于<code>{spawn, Command}</code>选项。外部程序从Dir里启动。</p>
</li>
<li>
<p><code>{env, Env}</code></p>
<p>只适用于<code>{spawn, Command}</code>选项。外部程序的环境通过Env列表里的环境变量进行扩展。Env列表由若干个{VarName, Value}对组成，其中VarName和Value是字符串。</p>
</li>
</ul>
<h3 id="端口api">端口Api</h3>
<p>PidC即是相连进程Pid</p>
<ul>
<li>
<p><code>Port ! {PidC, {command, Data}}</code></p>
<p>向端口发送Data（一个I/O列表）。</p>
</li>
<li>
<p><code>Port ! {PidC, {connect, Pid1}}</code></p>
<p>把相连进程的PID从PidC改为Pid1。</p>
</li>
<li>
<p><code>Port ! {PidC, close}</code></p>
<p>关闭端口。</p>
</li>
<li>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="k">receive</span>
<span class="ln">2</span>	<span class="p">{</span><span class="nv">Port</span><span class="p">,</span> <span class="p">{</span><span class="n">data</span><span class="p">,</span> <span class="nv">Data</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">3</span>      <span class="p">...</span> <span class="err">数据从外部进程进来</span> <span class="p">...</span>
</code></pre></div><p>相连进程可以用这种方式从外部程序接收消息。</p>
</li>
</ul>
<h3 id="用端口建立外部c程序接口">用端口建立外部C程序接口</h3>
<h4 id="规定协议">规定协议</h4>
<p>我们的最终目的是从Erlang里调用C文件方法。</p>
<p>ports/example1.c:</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="ln">1</span><span class="kt">int</span> <span class="nf">sum</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">2</span>	<span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">;</span>
<span class="ln">3</span><span class="p">}</span>
<span class="ln">4</span>
<span class="ln">5</span><span class="kt">int</span> <span class="nf">twice</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">){</span>
<span class="ln">6</span>	<span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
<span class="ln">7</span><span class="p">}</span>
</code></pre></div><p>希望能像这样调用它们：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nv">X1</span> <span class="o">=</span> <span class="nn">example1</span><span class="p">:</span><span class="nf">sum</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span>
<span class="ln">2</span><span class="nv">Y1</span> <span class="o">=</span> <span class="nn">example1</span><span class="p">:</span><span class="nf">twice</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
</code></pre></div><p>对用户而言，example1是一个Erlang模块，因此所有与C程序接口有关的细节都应该隐藏在example1模块内部。</p>
<p>要实现它，需要把sum(12,23)和twice(10)这样的函数调用转变成字节序列，通过端口发送给外部程序。端口给字节序列加上长度信息，然后把结果发给外部程序。当外部程序回复时，端口接收回复，并把结果发给与端口相连的进程。外部C程序和Erlang程序都必须遵循这一协议。下面是具体协议：</p>
<ul>
<li>所有数据包都以2字节的长度代码（Len）开头，后接Len字节的数据。这个包头会被端口自动添加，因为打开端口时设置了参数{packet,2}。</li>
<li>把sum(N, M)调用编码成字节序列[1,N,M]。</li>
<li>把twice(N)调用编码成字节序列[2,N]。</li>
<li>参数和返回值都被假定为1字节长。</li>
</ul>
<h4 id="调用过程">调用过程</h4>
<p>端口驱动这个东西和端口是一个整体，应该是在创建时就有了。</p>
<ol>
<li>本地驱动把函数调用 sum(12,23) 编码成字节序列 [1,12,23] ，然后向端口发送 {self(),{command, [1,12,23]}}消息。</li>
<li>端口驱动给这个消息加上2字节的长度包头，然后把字节序列 0,3,1,12,23 发给外部程序。</li>
<li>外部程序从标准输入里读取这5个字节，解包，调用sum函数，得到结果再封包，然后把字节序列0,1,35写入标准输出。</li>
<li>端口驱动移除长度包头，然后向相连进程发送一个{Port, {data, [35]}}消息。</li>
<li>相连进程解码这个消息，然后把结果返回给调用程序。</li>
</ol>
<h4 id="相应c应用与驱动程序">相应C应用与驱动程序</h4>
<p>这个就相当于外部程序了。</p>
<p>文件：</p>
<ul>
<li>
<p>ports/example1.c：包含了我们想要调用的函数（之前已经见过它了）。</p>
</li>
<li>
<p>ports/example1_driver.c：管理字节流协议并调用example1.c里的方法。</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="ln"> 1</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="ln"> 2</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="ln"> 3</span><span class="cp"></span><span class="c1">//定义1字节为byte
</span><span class="ln"> 4</span><span class="c1"></span><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>
<span class="ln"> 5</span>  
<span class="ln"> 6</span><span class="kt">int</span> <span class="nf">read_cmd</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">buff</span><span class="p">);</span>
<span class="ln"> 7</span><span class="kt">int</span> <span class="nf">write_cmd</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="ln"> 8</span><span class="kt">int</span> <span class="nf">sum</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">);</span>
<span class="ln"> 9</span><span class="kt">int</span> <span class="nf">twice</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">);</span>
<span class="ln">10</span>  
<span class="ln">11</span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
<span class="ln">12</span>    <span class="c1">//模式，函数调用参数一二，结果
</span><span class="ln">13</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">fn</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
<span class="ln">14</span>    <span class="n">byte</span> <span class="n">buff</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
<span class="ln">15</span>      
<span class="ln">16</span>    <span class="c1">//read_cmd函数处理协议，返回的是字节序列 [1,12,23]或 [2,10]
</span><span class="ln">17</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">read_cmd</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">18</span>        <span class="n">fn</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="ln">19</span>          
<span class="ln">20</span>        <span class="c1">//模式匹配函数
</span><span class="ln">21</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">fn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">22</span>            <span class="n">arg1</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="ln">23</span>            <span class="n">arg2</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="ln">24</span>              
<span class="ln">25</span>            <span class="c1">//调试语句，打印到stderr
</span><span class="ln">26</span><span class="c1"></span>            <span class="c1">//fprintf(stderr, &#34;calling sum %i %i\n&#34;, arg1, arg2);
</span><span class="ln">27</span><span class="c1"></span>            <span class="n">result</span> <span class="o">=</span> <span class="n">sum</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">);</span>
<span class="ln">28</span>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fn</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">29</span>            <span class="n">arg1</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="ln">30</span>            <span class="n">result</span> <span class="o">=</span> <span class="n">twice</span><span class="p">(</span><span class="n">arg1</span><span class="p">);</span>
<span class="ln">31</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">32</span>            <span class="c1">//未知错误直接退出
</span><span class="ln">33</span><span class="c1"></span>            <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="ln">34</span>        <span class="p">}</span>
<span class="ln">35</span>        <span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
<span class="ln">36</span>        <span class="c1">//同样write_cmd进行封装协议
</span><span class="ln">37</span><span class="c1"></span>        <span class="n">write_cmd</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">38</span>    <span class="p">}</span>
<span class="ln">39</span><span class="p">}</span>
</code></pre></div></li>
<li>
<p>ports/erl_comm.c：带有读取和写入内存缓冲区的方法。相当于应用驱动（协议处理）这段代码专门用于处理带有2字节长度包头的数据，因此它与提供给端口驱动程序的{packet, 2}选项匹配。</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="ln"> 1</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="ln"> 2</span><span class="cp"></span><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>
<span class="ln"> 3</span>  
<span class="ln"> 4</span><span class="c1">//将0,3,1,12,23转化为1,12,23
</span><span class="ln"> 5</span><span class="c1"></span><span class="kt">int</span> <span class="nf">read_cmd</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="ln"> 6</span><span class="c1">//将35转化为0,1,35，len是写入的字节
</span><span class="ln"> 7</span><span class="c1"></span><span class="kt">int</span> <span class="nf">write_cmd</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="ln"> 8</span><span class="kt">int</span> <span class="nf">read_exact</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="ln"> 9</span><span class="kt">int</span> <span class="nf">write_exact</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="ln">10</span>  
<span class="ln">11</span><span class="kt">int</span> <span class="nf">read_cmd</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="ln">12</span><span class="p">{</span>
<span class="ln">13</span>    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<span class="ln">14</span>    <span class="c1">//读取长度计数，读取错误直接退出
</span><span class="ln">15</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">read_exact</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
<span class="ln">16</span>        <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="ln">17</span>    <span class="c1">//这行计算实际的参数长度，无论第一字节值是多少，都取第二字节的值
</span><span class="ln">18</span><span class="c1"></span>    <span class="c1">//执行位或运算，实际上取得就是第二字节的数字了。因为第一字节以及左移8位清零了。
</span><span class="ln">19</span><span class="c1"></span>    <span class="c1">//0,3  那么是00000000 00000011。
</span><span class="ln">20</span><span class="c1"></span>    <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="ln">21</span>    <span class="k">return</span> <span class="n">read_exact</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="ln">22</span><span class="p">}</span>
<span class="ln">23</span>  
<span class="ln">24</span><span class="kt">int</span> <span class="nf">write_cmd</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="ln">25</span><span class="p">{</span>
<span class="ln">26</span>    <span class="n">byte</span> <span class="n">li</span><span class="p">;</span>
<span class="ln">27</span>    <span class="c1">//这行取出len第二个字节的值 int类型是4 3 2 1字节
</span><span class="ln">28</span><span class="c1"></span>    <span class="n">li</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">0</span><span class="n">Xff</span><span class="p">;</span>
<span class="ln">29</span>    <span class="n">write_exact</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">30</span>    <span class="c1">//这行取出len第一个字节的值（最低8位）
</span><span class="ln">31</span><span class="c1"></span>    <span class="n">li</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="ln">32</span>    <span class="n">write_exact</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">33</span>    <span class="k">return</span> <span class="n">write_exact</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="ln">34</span><span class="p">}</span>
<span class="ln">35</span>  
<span class="ln">36</span><span class="kt">int</span> <span class="nf">read_exact</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="ln">37</span><span class="p">{</span>
<span class="ln">38</span>    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">got</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="ln">39</span>    <span class="c1">//有可能量很大，所以循环读入。
</span><span class="ln">40</span><span class="c1"></span>    <span class="k">do</span> <span class="p">{</span>
<span class="ln">41</span>        <span class="c1">//读取，如果读取不正常直接结束
</span><span class="ln">42</span><span class="c1"></span>        <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="o">+</span><span class="n">got</span><span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="n">got</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
<span class="ln">43</span>            <span class="k">return</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="ln">44</span>        <span class="n">got</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
<span class="ln">45</span>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">got</span><span class="o">&lt;</span><span class="n">len</span><span class="p">);</span>
<span class="ln">46</span>    <span class="k">return</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="ln">47</span><span class="p">}</span>
<span class="ln">48</span>  
<span class="ln">49</span><span class="kt">int</span> <span class="nf">write_exact</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="ln">50</span><span class="p">{</span>
<span class="ln">51</span>    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">wrote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">52</span>    <span class="k">do</span> <span class="p">{</span>
<span class="ln">53</span>        <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="o">+</span><span class="n">wrote</span><span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="n">wrote</span><span class="p">))</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>
<span class="ln">54</span>            <span class="k">return</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="ln">55</span>        <span class="n">wrote</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
<span class="ln">56</span>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">wrote</span><span class="o">&lt;</span><span class="n">len</span><span class="p">);</span>
<span class="ln">57</span>    <span class="k">return</span> <span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="ln">58</span><span class="p">}</span>
<span class="ln">59</span>  
</code></pre></div></li>
</ul>
<p>涉及到的C标准库函数：</p>
<ul>
<li>
<p><code>read (int __fd, void *__buf, size_t __nbytes)</code></p>
<p>read 函数是C语言中用来读取文件数据的系统调用。</p>
<p>参数一为文件描述符，其中0为stdin，1为stdout，2为stderr。</p>
<p>参数二为存放读入的地方</p>
<p>参数三为要读取的字节</p>
<p>读取成功后，返回实际读取到的字节数；如果发生错误则返回-1。</p>
</li>
<li>
<p><code>ssize_t write(int handle, void *buf, int nbyte);</code></p>
<p>write函数把buf中nbyte写入文件描述符handle所指的文档，成功时返回写的字节数，错误时返回-1.</p>
<p>handle 是 文件描述符；</p>
<p>buf是指定的缓冲区，即 指针，指向一段内存单元；</p>
<p>nbyte是要写入文件指定的字节数；</p>
<p>返回值：写入文档的字节数（成功）；-1（出错）</p>
</li>
<li>
<p><code>write（const char* str,int n)</code></p>
<p>这个没用到，不过是同名的写一下。</p>
<p>str是 字符指针或字符数组，用来存放一个字符串。n是int型数，它用来表示输出显示字符串中字符的个数。</p>
</li>
</ul>
<h4 id="相应erlang程序">相应Erlang程序</h4>
<p>ports/example1.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">example1</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln"> 3</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">twice</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">sum</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="nb">register</span><span class="p">(</span><span class="n">example1</span><span class="p">,</span>
<span class="ln"> 7</span>            <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>                 <span class="c">%% 系统进程
</span><span class="ln"> 9</span><span class="c"></span>                 <span class="nb">process_flag</span><span class="p">(</span><span class="n">trap_exit</span><span class="p">,</span> <span class="n">true</span><span class="p">),</span>
<span class="ln">10</span>                 <span class="c">%% 创建端口
</span><span class="ln">11</span><span class="c"></span>                 <span class="nv">Port</span> <span class="o">=</span> <span class="nb">open_port</span><span class="p">({</span><span class="nb">spawn</span><span class="p">,</span> <span class="s">&#34;./example1&#34;</span><span class="p">},</span> <span class="p">[{</span><span class="n">packet</span><span class="p">,</span> <span class="mi">2</span><span class="p">}]),</span>
<span class="ln">12</span>                 <span class="c">%% 相连进程执行loop，通过loop操作端口
</span><span class="ln">13</span><span class="c"></span>                 <span class="n">loop</span><span class="p">(</span><span class="nv">Port</span><span class="p">)</span>
<span class="ln">14</span>               <span class="k">end</span><span class="p">)).</span>
<span class="ln">15</span>
<span class="ln">16</span><span class="nf">stop</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">17</span>    <span class="c">%% ?MODULE是宏，展开成当前的模块名
</span><span class="ln">18</span><span class="c"></span>    <span class="c">%% 实际上是向系统进程发消息，因为模块名已经注册了。
</span><span class="ln">19</span><span class="c"></span>    <span class="o">?</span><span class="nv">MODULE</span> <span class="o">!</span> <span class="n">stop</span><span class="p">.</span>
<span class="ln">20</span>
<span class="ln">21</span><span class="nf">twice</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">call_port</span><span class="p">({</span><span class="n">twice</span><span class="p">,</span> <span class="nv">X</span><span class="p">}).</span>
<span class="ln">22</span><span class="nf">sum</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">call_port</span><span class="p">({</span><span class="n">sum</span><span class="p">,</span> <span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">}).</span>
<span class="ln">23</span><span class="nf">call_port</span><span class="p">(</span><span class="nv">Msg</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">24</span>    <span class="o">?</span><span class="nv">MODULE</span> <span class="o">!</span> <span class="p">{</span><span class="n">call</span><span class="p">,</span> <span class="n">self</span><span class="p">(),</span> <span class="nv">Msg</span><span class="p">},</span>
<span class="ln">25</span>    <span class="k">receive</span>
<span class="ln">26</span>        <span class="p">{</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="nv">Result</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">27</span>            <span class="nv">Result</span>
<span class="ln">28</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">29</span>
<span class="ln">30</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Port</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">31</span>    <span class="k">receive</span>
<span class="ln">32</span>        <span class="p">{</span><span class="n">call</span><span class="p">,</span> <span class="nv">Caller</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">33</span>            <span class="nv">Port</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="p">{</span><span class="n">command</span><span class="p">,</span> <span class="n">encode</span><span class="p">(</span><span class="nv">Msg</span><span class="p">)}},</span>
<span class="ln">34</span>            <span class="k">receive</span>
<span class="ln">35</span>                <span class="p">{</span><span class="nv">Port</span><span class="p">,</span> <span class="p">{</span><span class="n">data</span><span class="p">,</span> <span class="nv">Data</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">36</span>                    <span class="nv">Caller</span> <span class="o">!</span> <span class="p">{</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">decode</span><span class="p">(</span><span class="nv">Data</span><span class="p">)}</span>
<span class="ln">37</span>            <span class="k">end</span><span class="p">,</span>
<span class="ln">38</span>            <span class="n">loop</span><span class="p">(</span><span class="nv">Port</span><span class="p">);</span>
<span class="ln">39</span>        <span class="n">stop</span> <span class="o">-&gt;</span>
<span class="ln">40</span>            <span class="nv">Port</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="n">close</span><span class="p">},</span>
<span class="ln">41</span>            <span class="k">receive</span>
<span class="ln">42</span>                <span class="p">{</span><span class="nv">Port</span><span class="p">,</span> <span class="n">closed</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">43</span>                    <span class="nb">exit</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
<span class="ln">44</span>            <span class="k">end</span><span class="p">;</span>
<span class="ln">45</span>        <span class="p">{</span><span class="n">&#39;EXIT&#39;</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">46</span>            <span class="nb">exit</span><span class="p">({</span><span class="n">port_terminated</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">})</span>
<span class="ln">47</span>   <span class="k">end</span><span class="p">.</span>
<span class="ln">48</span>
<span class="ln">49</span><span class="nf">encode</span><span class="p">({</span><span class="n">sum</span><span class="p">,</span> <span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">];</span>
<span class="ln">50</span><span class="nf">encode</span><span class="p">({</span><span class="n">twice</span><span class="p">,</span> <span class="nv">X</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="nv">X</span><span class="p">].</span>
<span class="ln">51</span>
<span class="ln">52</span><span class="nf">decode</span><span class="p">([</span><span class="nv">Int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nv">Int</span><span class="p">.</span>
</code></pre></div><h4 id="makefile编译链接程序">Makefile编译链接程序</h4>
<p>prots/Makefile.mac</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="nf">.SUFFIXES</span><span class="o">:</span> .<span class="n">erl</span> .<span class="n">beam</span> .<span class="n">yrl</span>
<span class="ln"> 2</span>
<span class="ln"> 3</span><span class="nf">.erl.beam</span><span class="o">:</span>
<span class="ln"> 4</span>		erlc -W $&lt;
<span class="ln"> 5</span>		
<span class="ln"> 6</span><span class="nv">MODS</span> <span class="o">=</span> example1 example1_lid unit_test
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="nf">all</span><span class="o">:</span>	${<span class="n">MODS</span>:%=%.<span class="n">beam</span>} <span class="n">example</span>1 <span class="n">example</span>1<span class="n">_drv</span>.<span class="n">so</span>
<span class="ln"> 9</span>		@erl -noshell -s unit_test start
<span class="ln">10</span><span class="nf">example1</span><span class="o">:</span> <span class="n">example</span>1.<span class="n">c</span> <span class="n">erl_comm</span>.<span class="n">c</span> <span class="n">example</span>1<span class="n">_driver</span>.<span class="n">c</span>
<span class="ln">11</span>		gcc -o example1 example1.c erl_comm.c example1_driver.c
<span class="ln">12</span><span class="nf">example1_drv.so</span><span class="o">:</span> <span class="n">example</span>1<span class="n">_lid</span>.<span class="n">c</span> <span class="n">example</span>1.<span class="n">c</span>
<span class="ln">13</span>		gcc -arch i386 -I /usr/local/lib/erlang/usr/include<span class="se">\
</span><span class="ln">14</span><span class="se"></span>			-o example1_drv.so -fPIC -bundle -flat_namespace -undefined suppress<span class="se">\
</span><span class="ln">15</span><span class="se"></span>			example1.c example1_lid.c
<span class="ln">16</span><span class="nf">clean</span><span class="o">:</span>
<span class="ln">17</span>		rm example1 example1_drv.so *.beam
</code></pre></div><ul>
<li>.SUFFIXES：定义后缀，前者是前提，后者是目标</li>
<li>$&lt;：第一个依赖文件</li>
</ul>
<h4 id="运行">运行</h4>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; example1:start().
<span class="ln">2</span>true
<span class="ln">3</span>2&gt; example1:su,(45, 32).
<span class="ln">4</span>77
</code></pre></div><h3 id="在-erlang-里调用-shell-脚本">在 Erlang 里调用 shell 脚本</h3>
<p>假设想要在Erlang里调用一个shell脚本。要做到这一点，可以使用库函数os:cmd(Str)。它会运行字符串Str里的命令并捕捉结果：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; os:cmd(&#34;ifconfig&#34;).
<span class="ln">2</span>&#34;lo0: flags...&#34;
</code></pre></div><h3 id="高级接口技术">高级接口技术</h3>
<ul>
<li>
<p>内链驱动</p>
<p>这些程序和之前讨论的端口驱动遵循相同的协议，唯一的区别是它们的驱动代码被链接到Erlang内核中，因此会在Erlang的操作系统主进程内运行。要构建一个内链驱动，就必须添加少量代码来初始化它，驱动本身必须被编译和链接到Erlang虚拟机上。</p>
</li>
<li>
<p>NIF</p>
<p>NIF是指原生实现函数（Natively Implemented Function）。这些函数是用C（或其他能编译成本地代码的语言）编写的，并且被链接到Erlang虚拟机中。NIF直接将参数传递到Erlang进程的栈上，还能直接访问所有的Erlang内部数据结构。</p>
</li>
<li>
<p>C-node</p>
<p>C-node是用C实现的节点，它们遵循Erlang分布式协议。一个“真正的”分布式Erlang节点不仅能够与C-node通信，还会把它当作一个Erlang节点（前提是它不在C-node上做一些花哨的事情，比如发送Erlang代码让它执行）。</p>
</li>
</ul>
<h3 id="练习-11">练习</h3>
<p>(1) 下载之前给出的端口驱动代码，然后在你的系统上测试它。</p>
<p>(2) 打开git://github.com/erlang/linked_in_drivers.git，下载内链驱动的代码并在你的系统上测试。这里的难点是找到编译和链接代码的正确命令。如果不能完成这个练习，可以去Erlang邮件列表寻求帮助。</p>
<p>(3) 看看能否找到一个操作系统命令，用它查看你的计算机使用的是哪种CPU。如果能找到这样的命令，请编写一个函数来返回你的CPU类型，做法是用os:cmd函数调用这个操作系统命令。</p>
<h2 id="第16章-文件编程">第16章 文件编程</h2>
<h3 id="操作文件的模块">操作文件的模块</h3>
<ul>
<li>
<p>file</p>
<p>它包含打开、关闭、读取和写入文件的方法，还有列出目录，等等。</p>
</li>
<li>
<p>filename</p>
<p>这个模块里的方法能够以<strong>跨平台</strong>的方式操作文件名，这样就能在许多不同的操作系统上运行相同的代码了。</p>
</li>
<li>
<p>filelib</p>
<p>这个模块是file的扩展。它包含的许多工具函数能够列出文件、检查文件类型，等等。其中大多数都是使用file里的函数编写的。</p>
</li>
<li>
<p>io</p>
<p>这个模块有一些操作已打开文件的方法。它包含的方法能够解析文件里的数据，或者把格式化数据写入文件。</p>
</li>
</ul>
<p>文件操作摘要（file模块）：</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>change_group</td>
<td>修改某个文件所属的组</td>
</tr>
<tr>
<td>change_owner</td>
<td>修改某个文件的所有者</td>
</tr>
<tr>
<td>change_time</td>
<td>修改某个文件的最后修改或访问时间</td>
</tr>
<tr>
<td>close</td>
<td>关闭某个文件</td>
</tr>
<tr>
<td>consult</td>
<td>从某个文件里读取Erlang数据类型</td>
</tr>
<tr>
<td>copy</td>
<td>复制文件内容</td>
</tr>
<tr>
<td>del_dir</td>
<td>删除某个目录</td>
</tr>
<tr>
<td>delete</td>
<td>删除某个文件</td>
</tr>
<tr>
<td>eval</td>
<td>执行某个文件里的Erlang表达式</td>
</tr>
<tr>
<td>format_error</td>
<td>返回一个描述错误原因的字符串</td>
</tr>
<tr>
<td>get_cwd</td>
<td>获取当前工作目录</td>
</tr>
<tr>
<td>list_dir</td>
<td>列出某个目录里的文件</td>
</tr>
<tr>
<td>make_dir</td>
<td>创建一个目录</td>
</tr>
<tr>
<td>make_link</td>
<td>创建指向某个文件的硬链接（hard link）</td>
</tr>
<tr>
<td>make_symlink</td>
<td>创建指向某个文件或目录的符号链接（symbolic link）</td>
</tr>
<tr>
<td>open</td>
<td>打开某个文件</td>
</tr>
<tr>
<td>position</td>
<td>设立在文件里的位置</td>
</tr>
<tr>
<td>pread</td>
<td>对文件里的某个位置进行读取</td>
</tr>
<tr>
<td>pwrite</td>
<td>对文件里的某个位置进行写入</td>
</tr>
<tr>
<td>read</td>
<td>对某个文件进行读取</td>
</tr>
<tr>
<td>read_file</td>
<td>读取整个文件</td>
</tr>
<tr>
<td>read_file_info</td>
<td>获取某个文件的信息</td>
</tr>
<tr>
<td>read_link</td>
<td>获得某个链接指向的位置</td>
</tr>
<tr>
<td>read_link_info</td>
<td>获取某个链接或文件的信息</td>
</tr>
<tr>
<td>rename</td>
<td>重命名某个文件</td>
</tr>
<tr>
<td>script</td>
<td>执行并返回某个文件里Erlang表达式的值</td>
</tr>
<tr>
<td>set_cwd</td>
<td>设置当前工作目录</td>
</tr>
<tr>
<td>sync</td>
<td>同步某个文件在内存和物理介质中的状态</td>
</tr>
<tr>
<td>truncate</td>
<td>截断某个文件</td>
</tr>
<tr>
<td>write</td>
<td>对某个文件进行写入</td>
</tr>
<tr>
<td>write_file</td>
<td>写入整个文件</td>
</tr>
<tr>
<td>write_file_info</td>
<td>修改某个文件的信息</td>
</tr>
</tbody>
</table>
<h3 id="读取文件">读取文件</h3>
<p>文件data1.dat：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>{person, &#34;joe&#34;, &#34;armstrong&#34;,
<span class="ln">2</span>		[{occupation, programmer},
<span class="ln">3</span>		 {favoriteLanguage, erlang}]}.
<span class="ln">4</span>		 
<span class="ln">5</span>{cat, {name, &#34;zorro&#34;},
<span class="ln">6</span>	  {owner, &#34;joe&#34;}}.
</code></pre></div><h4 id="读取所有数据类型">读取所有数据类型</h4>
<p>可调用file:consult来读取所有的数据类型。</p>
<p><code>file:consult(File)</code>假定File包含一个由Erlang数据类型组成的序列。如果它能读取文件里的所有数据类型，就会返回{ok, [Term]}，否则会返回{error, Reason}。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; file:consult(&#34;data1.dat&#34;).
<span class="ln">2</span>{ok,[{person,&#34;joe&#34;,&#34;armstrong&#34;,
<span class="ln">3</span>             [{occupation,programmer},{favoriteLanguage,erlang}]},
<span class="ln">4</span>     {cat,{name,&#34;zorro&#34;},{owner,&#34;joe&#34;}}]}
</code></pre></div><h4 id="分次读取数据类型">分次读取数据类型</h4>
<p>如果想从文件里一次读取一个数据类型，就要首先用file:open打开文件，然后用io:read逐个读取数据类型，直到文件末尾，最后再用file:close关闭文件。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>3&gt; {ok, S} = file:open(&#34;data1.dat&#34;, read).
<span class="ln"> 2</span>{ok,&lt;0.86.0&gt;}
<span class="ln"> 3</span>4&gt; io:read(S, &#39;&#39;).
<span class="ln"> 4</span>{ok,{person,&#34;joe&#34;,&#34;armstrong&#34;,
<span class="ln"> 5</span>            [{occupation,programmer},{favoriteLanguage,erlang}]}}
<span class="ln"> 6</span>5&gt; io:read(S,&#39;&#39;).
<span class="ln"> 7</span>{ok,{cat,{name,&#34;zorro&#34;},{owner,&#34;joe&#34;}}}
<span class="ln"> 8</span>6&gt; io:read(S, &#39;&#39;).
<span class="ln"> 9</span>eof
<span class="ln">10</span>7&gt; file:close(S).
<span class="ln">11</span>ok
</code></pre></div><p>涉及函数：</p>
<ul>
<li>
<p><code>-spec file:oepn(File, read) -&gt; {ok, IoDevice} | {error, Why}</code></p>
<p>尝试打开File进行读取。如果它能打开文件就会返回{ok, IoDevice}，否则返回{error,Reason}。IoDevice是一个用来访问文件的I/O对象。</p>
</li>
<li>
<p><code>-spec io:read(IoDevice, Prompt) -&gt; {ok, Term} | {error, Why} | eof</code></p>
<p>从 IoDevice 读取一个Erlang数据类型 Term 。如果 IoDevice 代表一个被打开的文件，Prompt就会被忽略。只有用io:read读取标准输入时，才会用Prompt提供一个提示符。</p>
</li>
<li>
<p><code>-spec file:close(IoDevice) -&gt; ok | {error, Why}</code></p>
<p>关闭IoDevice。</p>
</li>
</ul>
<p>用以上方法实现<code>file:consult</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">consult</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="k">case</span> <span class="nn">file</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="nv">File</span><span class="p">,</span> <span class="n">read</span><span class="p">)</span> <span class="k">of</span>
<span class="ln"> 3</span>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">S</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 4</span>            <span class="nv">Val</span> <span class="o">=</span> <span class="n">consult1</span><span class="p">(</span><span class="nv">S</span><span class="p">),</span>
<span class="ln"> 5</span>            <span class="nn">file</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">S</span><span class="p">),</span>
<span class="ln"> 6</span>            <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Val</span><span class="p">};</span>
<span class="ln"> 7</span>        <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Why</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>            <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Why</span><span class="p">}</span>
<span class="ln"> 9</span>     <span class="k">end</span><span class="p">.</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="nf">consult1</span><span class="p">(</span><span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">12</span>    <span class="k">case</span> <span class="nn">io</span><span class="p">:</span><span class="nf">read</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="err">&#39;&#39;</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">13</span>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Term</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">Term</span><span class="p">|</span><span class="n">consult1</span><span class="p">(</span><span class="nv">S</span><span class="p">)];</span>
<span class="ln">14</span>        <span class="n">eof</span> <span class="o">-&gt;</span> <span class="p">[];</span>
<span class="ln">15</span>        <span class="nv">Error</span> <span class="o">-&gt;</span> <span class="nv">Error</span>
<span class="ln">16</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>找到file.erl的源代码：</p>
<p>可使用code:which函数来找到它，该函数能定位所有已载入模块的目标代码。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; code:which(file).
<span class="ln">2</span>&#34;/usr/lib/erlang/lib/kernel-8.5.4.2/ebin/file.beam&#34;
</code></pre></div><p>在标准分发套装里，每个库都有两个子目录。一个名为src，包含源代码；另一个名为ebin，包含编译后的Erlang代码。因此，file.erl的源代码应该是在下面这个目录里：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>/usr/lib/erlang/lib/kernel-8.5.4.2/src/file.erl
</code></pre></div><h4 id="分次读取文件里的行">分次读取文件里的行</h4>
<p>如果把io:read改成io:get_line，就可以分次读取文件里的行。io:get_line会一直读取字符，直到遇上换行符或者文件尾。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>1&gt; {ok, S} = file:open(&#34;data1.dat&#34;, read).
<span class="ln"> 2</span>{ok,&lt;0.83.0&gt;}
<span class="ln"> 3</span>2&gt; io:get_line(S, &#39;&#39;). 
<span class="ln"> 4</span>&#34;{person, \&#34;joe\&#34;, \&#34;armstrong\&#34;,\n&#34;
<span class="ln"> 5</span>3&gt; io:get_line(S, &#39;&#39;).
<span class="ln"> 6</span>&#34;\t\t[{occupation, programmer},\n&#34;
<span class="ln"> 7</span>4&gt; io:get_line(S, &#39;&#39;).
<span class="ln"> 8</span>&#34;\t\t {favoriteLanguage, erlang}]}.\n&#34;
<span class="ln"> 9</span>5&gt; io:get_line(S, &#39;&#39;).
<span class="ln">10</span>&#34;\t\t \n&#34;
<span class="ln">11</span>6&gt; io:get_line(S, &#39;&#39;).
<span class="ln">12</span>&#34;{cat, {name, \&#34;zorro\&#34;},\n&#34;
<span class="ln">13</span>7&gt; io:get_line(S, &#39;&#39;).
<span class="ln">14</span>&#34;\t  {owner, \&#34;joe\&#34;}}.\n&#34;
<span class="ln">15</span>8&gt; io:get_line(S, &#39;&#39;).
<span class="ln">16</span>eof
<span class="ln">17</span>9&gt; file:close(S).
<span class="ln">18</span>ok
</code></pre></div><h4 id="读取整个文件到二进制型中">读取整个文件到二进制型中</h4>
<p>可以用<code>file:read_file(File)</code>把整个文件读入一个二进制型，这是一次原子操作。</p>
<p>如果成功，file:read_file(File)就会返回{ok, Bin}，否则返回{error, Why}。这是到目前为止最高效的文件读取方式。在大多数操作里，我会把整个文件一次性读入内存，然后操作内容并一次性保存文件（用file:write_file）。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>10&gt; file:read_file(&#34;data1.dat&#34;).
<span class="ln">2</span>{ok,&lt;&lt;&#34;{person, \&#34;joe\&#34;, \&#34;armstrong\&#34;,\n\t\t[{occupation, programmer},\n\t\t {favoriteLanguage, erlang}]}.\n\t\t \n{cat, {name, &#34;...&gt;&gt;}
</code></pre></div><h4 id="按字节访问读取文件">按字节访问读取文件</h4>
<p>如果想要读取的文件非常大，或者它包含某种外部定义格式的二进制数据，就可以用raw模式打开这个文件，然后用file:pread读取它的任意部分。</p>
<p>file:pread(IoDevice, Start, Len)会从IoDevice读取Len个字节的数据，读取起点是字节Start处（文件里的字节会被编号，所以文件里第一个字节的位置是0）。它会返回{ok, Bin}或者{error, Why}。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>1&gt; {ok, S} = file:open(&#34;data1.dat&#34;, [read,binary,raw]).
<span class="ln"> 2</span>{ok,{file_descriptor,prim_file,
<span class="ln"> 3</span>                     #{handle =&gt; #Ref&lt;0.3212107313.3749838861.229403&gt;,
<span class="ln"> 4</span>                       owner =&gt; &lt;0.81.0&gt;,r_ahead_size =&gt; 0,
<span class="ln"> 5</span>                       r_buffer =&gt; #Ref&lt;0.3212107313.3749838853.229337&gt;}}}
<span class="ln"> 6</span>2&gt; file:pread(S, 22, 26).
<span class="ln"> 7</span>{ok,&lt;&lt;&#34;rong\&#34;,\n\t\t[{occupation, pro&#34;&gt;&gt;}
<span class="ln"> 8</span>3&gt; file:pread(S, 1, 10).
<span class="ln"> 9</span>{ok,&lt;&lt;&#34;person, \&#34;j&#34;&gt;&gt;}
<span class="ln">10</span>4&gt; file:pread(S, 2, 10).
<span class="ln">11</span>{ok,&lt;&lt;&#34;erson, \&#34;jo&#34;&gt;&gt;}
<span class="ln">12</span>5&gt; file:close(S).
<span class="ln">13</span>ok
</code></pre></div><h4 id="读取mp3元数据案例">读取MP3元数据案例</h4>
<p>MP3是一种二进制格式，用来保存压缩过的音频数据。MP3文件本身并不包含有关文件内容的信息。比如说，在一个包含音乐数据的MP3文件里，音频数据并不包含录制音乐的艺术家姓名。这类数据（曲目名和艺术家姓名等）以一种被称为ID3的标签块格式保存在MP3文件中。ID3标签是由一位名叫Eric Kemp的程序员发明的，用来保存描述音频文件内容的元数据。ID3格式实际上有很多种，但基于我们的目的，这里只会编写代码来访问ID3标签的两种最简单的形式，即ID3v1和ID3v1.1标签。</p>
<p>ID3v1标签的结构很简单：文件最后的128个字节包含了一个固定长度的标签。前三个字节包含ASCII字符TAG，接下来是一些固定长度的字段。整个128字节数据是按照以下方式打包的：</p>
<table>
<thead>
<tr>
<th>长度</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td>包含TAG字符的标签头</td>
</tr>
<tr>
<td>30</td>
<td>标题</td>
</tr>
<tr>
<td>30</td>
<td>艺术家</td>
</tr>
<tr>
<td>30</td>
<td>专辑</td>
</tr>
<tr>
<td>4</td>
<td>年份</td>
</tr>
<tr>
<td>30</td>
<td>备注</td>
</tr>
<tr>
<td>1</td>
<td>流派</td>
</tr>
</tbody>
</table>
<p>ID3v1的标签里没有地方可以添加曲目编号。Michael Mutschler在ID3v1.1格式里建议了一种
做法，把30个字节的备注字段改成下面这样：</p>
<table>
<thead>
<tr>
<th>长度</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>28</td>
<td>评论</td>
</tr>
<tr>
<td>1</td>
<td>0（一个零）</td>
</tr>
<tr>
<td>1</td>
<td>曲目编号</td>
</tr>
</tbody>
</table>
<p>读取MP3文件里的ID3v1标签的程序：</p>
<p><code>lib_find:files/3</code>，<code>lib_misc:dump/2</code>函数在后面。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">id3_v1</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">import</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span> <span class="p">[</span><span class="n">filter</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">map</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">reverse</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">test</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">dir</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">read_d3_tag</span><span class="p">]).</span>
<span class="ln"> 4</span><span class="nf">test</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">dir</span><span class="p">(</span><span class="s">&#34;/home/joe/music_keep&#34;</span><span class="p">).</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="nf">dir</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>    <span class="c">%% 读取文件夹中的所有mp3文件名为一个列表
</span><span class="ln"> 8</span><span class="c"></span>    <span class="nv">Files</span> <span class="o">=</span> <span class="nn">lib_find</span><span class="p">:</span><span class="nf">files</span><span class="p">(</span><span class="nv">Dir</span><span class="p">,</span> <span class="s">&#34;*.mp3&#34;</span><span class="p">,</span> <span class="n">true</span><span class="p">),</span>
<span class="ln"> 9</span>    <span class="nv">L1</span> <span class="o">=</span> <span class="n">map</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">10</span>            <span class="p">{</span><span class="nv">I</span><span class="p">,</span> <span class="p">(</span><span class="k">catch</span> <span class="n">read_id3_tag</span><span class="p">(</span><span class="nv">I</span><span class="p">))}</span>
<span class="ln">11</span>            <span class="k">end</span><span class="p">,</span> <span class="nv">Files</span><span class="p">),</span>
<span class="ln">12</span>    <span class="c">%% L1 = [{File, Parse}], 其中Parse = error | [{Tag, Val}].
</span><span class="ln">13</span><span class="c"></span>    <span class="c">%% Tag是ID3v1或ID3v1.1
</span><span class="ln">14</span><span class="c"></span>    <span class="c">%% 现在将所有Parse = error的条目从L中移出
</span><span class="ln">15</span><span class="c"></span>    <span class="c">%% 可以用一次filter操作实现
</span><span class="ln">16</span><span class="c"></span>    <span class="nv">L2</span> <span class="o">=</span> <span class="n">filter</span><span class="p">(</span><span class="k">fun</span><span class="p">({_,</span><span class="n">error</span><span class="p">})</span> <span class="o">-&gt;</span><span class="n">false</span><span class="p">;</span>
<span class="ln">17</span>               <span class="p">(_)</span> <span class="o">-&gt;</span> <span class="n">true</span>
<span class="ln">18</span>               <span class="k">end</span><span class="p">,</span> <span class="nv">L1</span><span class="p">),</span>
<span class="ln">19</span>    <span class="nn">lib_misc</span><span class="p">:</span><span class="nf">dump</span><span class="p">(</span><span class="s">&#34;mp3data&#34;</span><span class="p">,</span> <span class="nv">L2</span><span class="p">).</span>
<span class="ln">20</span>
<span class="ln">21</span><span class="c">%% 对每个文件，取出ID3v1标签，交由parse_v1_tag处理
</span><span class="ln">22</span><span class="c">%% 不能打开文件则为error
</span><span class="ln">23</span><span class="c"></span><span class="nf">read_id3_tag</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">24</span>    <span class="k">case</span> <span class="nn">file</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="nv">File</span><span class="p">,</span> <span class="p">[</span><span class="n">read</span><span class="p">,</span><span class="n">binary</span><span class="p">,</span><span class="n">raw</span><span class="p">])</span> <span class="k">of</span>
<span class="ln">25</span>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">S</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">26</span>                  <span class="nv">Size</span> <span class="o">=</span> <span class="nn">filelib</span><span class="p">:</span><span class="nf">file_size</span><span class="p">(</span><span class="nv">File</span><span class="p">),</span>
<span class="ln">27</span>            	  <span class="c">%% 读取的是最后128位
</span><span class="ln">28</span><span class="c"></span>                  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">B2</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">pread</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="nv">Size</span><span class="o">-</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
<span class="ln">29</span>                  <span class="nv">Result</span> <span class="o">=</span> <span class="n">parse_v1_tag</span><span class="p">(</span><span class="nv">B2</span><span class="p">),</span>
<span class="ln">30</span>                  <span class="nn">file</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">S</span><span class="p">),</span>
<span class="ln">31</span>                  <span class="nv">Result</span><span class="p">;</span>
<span class="ln">32</span>		<span class="p">_</span><span class="nv">Error</span> <span class="o">-&gt;</span>
<span class="ln">33</span>            <span class="n">error</span>
<span class="ln">34</span>     <span class="k">end</span><span class="p">.</span>
<span class="ln">35</span>
<span class="ln">36</span><span class="c">%% 处理128位的ID3v1.1标签
</span><span class="ln">37</span><span class="c"></span><span class="nf">parse_v1_tag</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="sc">$T</span><span class="p">,</span><span class="sc">$A</span><span class="p">,</span><span class="sc">$G</span><span class="p">,</span>
<span class="ln">38</span>               <span class="nv">Title</span><span class="p">:</span><span class="mi">30</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> 
<span class="ln">39</span>               <span class="nv">Artist</span><span class="p">:</span><span class="mi">30</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> 
<span class="ln">40</span>               <span class="nv">Album</span><span class="p">:</span><span class="mi">30</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> 
<span class="ln">41</span>               <span class="p">_</span><span class="nv">Year</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> 
<span class="ln">42</span>               <span class="p">_</span><span class="nv">Comment</span><span class="p">:</span><span class="mi">28</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="nv">Track</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> 
<span class="ln">43</span>               <span class="p">_</span><span class="nv">Genre</span><span class="p">:</span><span class="mi">8</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">44</span>    <span class="p">{</span><span class="s">&#34;ID3v1.1&#34;</span><span class="p">,</span>
<span class="ln">45</span>     <span class="p">[{</span><span class="n">track</span><span class="p">,</span> <span class="nv">Track</span><span class="p">},</span> 
<span class="ln">46</span>      <span class="p">{</span><span class="n">title</span><span class="p">,</span> <span class="n">trim</span><span class="p">(</span><span class="nv">Title</span><span class="p">)},</span> 
<span class="ln">47</span>      <span class="p">{</span><span class="n">artist</span><span class="p">,</span> <span class="n">trim</span><span class="p">(</span><span class="nv">Artist</span><span class="p">)},</span> 
<span class="ln">48</span>      <span class="p">{</span><span class="n">album</span><span class="p">,</span> <span class="n">trim</span><span class="p">(</span><span class="nv">Album</span><span class="p">)}]};</span>
<span class="ln">49</span><span class="c">%% 处理128位的ID3v1标签
</span><span class="ln">50</span><span class="c"></span><span class="nf">parse_v1_tag</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="sc">$T</span><span class="p">,</span><span class="sc">$A</span><span class="p">,</span><span class="sc">$G</span><span class="p">,</span>
<span class="ln">51</span>               <span class="nv">Title</span><span class="p">:</span><span class="mi">30</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> 
<span class="ln">52</span>               <span class="nv">Artist</span><span class="p">:</span><span class="mi">30</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> 
<span class="ln">53</span>               <span class="nv">Album</span><span class="p">:</span><span class="mi">30</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> 
<span class="ln">54</span>               <span class="p">_</span><span class="nv">Year</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> 
<span class="ln">55</span>               <span class="p">_</span><span class="nv">Comment</span><span class="p">:</span><span class="mi">30</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span>
<span class="ln">56</span>               <span class="p">_</span><span class="nv">Genre</span><span class="p">:</span><span class="mi">8</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">57</span>    <span class="p">{</span><span class="s">&#34;ID3v1&#34;</span><span class="p">,</span>
<span class="ln">58</span>     <span class="p">[{</span><span class="n">title</span><span class="p">,</span> <span class="n">trim</span><span class="p">(</span><span class="nv">Title</span><span class="p">)},</span> 
<span class="ln">59</span>      <span class="p">{</span><span class="n">artist</span><span class="p">,</span> <span class="n">trim</span><span class="p">(</span><span class="nv">Artist</span><span class="p">)},</span> 
<span class="ln">60</span>      <span class="p">{</span><span class="n">album</span><span class="p">,</span> <span class="n">trim</span><span class="p">(</span><span class="nv">Album</span><span class="p">)}]};</span>
<span class="ln">61</span><span class="c">%% 错误格式
</span><span class="ln">62</span><span class="c"></span><span class="nf">parse_v1_tag</span><span class="p">(_)</span> <span class="o">-&gt;</span>
<span class="ln">63</span>    <span class="n">error</span><span class="p">.</span>
<span class="ln">64</span>
<span class="ln">65</span><span class="c">%% 处理字符串，去掉前面多余字符
</span><span class="ln">66</span><span class="c"></span><span class="nf">trim</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">67</span>    <span class="nb">list_to_binary</span><span class="p">(</span><span class="n">trim_blanks</span><span class="p">(</span><span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Bin</span><span class="p">))).</span>
<span class="ln">68</span><span class="nf">trim_blanks</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">reverse</span><span class="p">(</span><span class="n">skip_blanks_and_zero</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="nv">X</span><span class="p">))).</span>
<span class="ln">69</span>
<span class="ln">70</span><span class="nf">skip_blanks_and_zero</span><span class="p">([</span><span class="sc">$\s</span><span class="p">|</span><span class="nv">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">skip_blanks_and_zero</span><span class="p">(</span><span class="nv">T</span><span class="p">);</span>
<span class="ln">71</span><span class="nf">skip_blanks_and_zero</span><span class="p">([</span><span class="n">o</span><span class="p">|</span><span class="nv">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">skip_blanks_and_zero</span><span class="p">(</span><span class="nv">T</span><span class="p">);</span>
<span class="ln">72</span><span class="nf">skip_blanks_and_zero</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">X</span><span class="p">.</span>
</code></pre></div><h3 id="写入文件">写入文件</h3>
<h4 id="把数据列表写入文件">把数据列表写入文件</h4>
<p>假设想要创建一个能用file:consult读取的文件。标准库里实际上并没有这样的函数，所以我们将自己编写它。不妨把这个函数称为unconsult。</p>
<p>lib_misc.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">unconsult</span><span class="p">(</span><span class="nv">File</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">S</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">oepn</span><span class="p">(</span><span class="nv">File</span><span class="p">,</span> <span class="n">write</span><span class="p">),</span>
<span class="ln">3</span>    <span class="nn">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">X_</span> <span class="o">-&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="s">&#34;</span><span class="si">~p</span><span class="s">,</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">X</span><span class="p">])</span> <span class="k">end</span><span class="p">,</span> <span class="nv">L</span><span class="p">))</span>
</code></pre></div><p><code>-spec io:format(IoDevice, Format, Args) -&gt; ok</code>：</p>
<p>其中ioDevice是一个I/O对象（必须以write模式打开），Format是一个包含格式代码的字符串，Args是待输出的项目列表。Args里的每一项都必须对应格式字符串里的某个格式命令。格式命令以一个波浪字符（~）开头。这里有一些最常用的格式命令：</p>
<ul>
<li><code>~n</code> 输出一个换行符。~n很智能，会输出一个符合平台标准的换行符。比如说，~n在Unix机器上会把ASCII（10）写入输出流，在Windows机器上则会把回车换行ASCII（13, 10）写入输出流。</li>
<li><code>~p</code>把参数打印为美观的形式。</li>
<li><code>~s</code>参数是一个字符串、I/O列表或原子，打印时不带引号。</li>
<li><code>~w</code>用标准语法输出数据。它被用于输出各种Erlang数据类型。</li>
</ul>
<p>格式字符串大概有几亿个参数，一个正常思维的人是记不住的。可以在io模块的手册页里找到完整的参数清单。</p>
<table>
<thead>
<tr>
<th>Format</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>`io:format(&quot;</td>
<td>~10s</td>
</tr>
<tr>
<td>`io:format(&quot;</td>
<td>~-10s</td>
</tr>
<tr>
<td>`io:format(&quot;</td>
<td>~10.3.+s</td>
</tr>
<tr>
<td>`io:format(&quot;</td>
<td>~10.10.+s</td>
</tr>
<tr>
<td>`io:format(&quot;</td>
<td>~10.7.+s</td>
</tr>
</tbody>
</table>
<h4 id="把各行写入文件">把各行写入文件</h4>
<p>还是使用<code>io:format</code>，每一个最后加一个<code>~n</code>即可。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>1&gt; {ok, S} = file:open(&#34;test2.dat&#34;, write).
<span class="ln"> 2</span>{ok,&lt;0.83.0&gt;}
<span class="ln"> 3</span>2&gt; io:format(S, &#34;~s~n&#34;, [&#34;Hello readers&#34;]).
<span class="ln"> 4</span>ok
<span class="ln"> 5</span>3&gt; io:format(S, &#34;~w~n&#34;, [123]).            
<span class="ln"> 6</span>ok
<span class="ln"> 7</span>4&gt; io:format(S, &#34;~s~n&#34;, [&#34;that&#39;s it&#34;]).
<span class="ln"> 8</span>ok
<span class="ln"> 9</span>5&gt; file:close(S).
<span class="ln">10</span>ok
<span class="ln">11</span>6&gt; q().
<span class="ln">12</span>ok
<span class="ln">13</span>7&gt; z@Ubuntu:~/code/erlang/programming-erlang/chapter16
<span class="ln">14</span>$cat test2.dat 
<span class="ln">15</span>Hello readers
<span class="ln">16</span>123
<span class="ln">17</span>that&#39;s it
</code></pre></div><h4 id="一次性写入整个文件">一次性写入整个文件</h4>
<p>这是最高效的写入文件方式。file:write_file(File, IO)会把IO里的数据（一个I/O列表）写入File。（I/O列表是一个元素为I/O列表、二进制型或0到255整数的列表。I/O列表在输出时会被自动“扁平化”，意思是所有的列表括号都会被移除。）这种方式极其高效，也是我经常用的。</p>
<h4 id="扫描html中的链接案例">扫描html中的链接案例</h4>
<p>scavenge_urls.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">scavenge_urls</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">urls2htmlFile</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bin2urls</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span><span class="p">-</span><span class="ni">import</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span> <span class="p">[</span><span class="n">reverse</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">map</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="c">%% urls2htmlFile(Urls, File)接受一个URL列表并创建HTML文件，在文件里为每个URL各创建一个可点击的链接
</span><span class="ln"> 6</span><span class="c"></span><span class="nf">url2htmlFIle</span><span class="p">(</span><span class="nv">Urls</span><span class="p">,</span> <span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>    <span class="nn">file</span><span class="p">:</span><span class="nf">write_file</span><span class="p">(</span><span class="nv">File</span><span class="p">,</span> <span class="n">urls2html</span><span class="p">(</span><span class="nv">Urls</span><span class="p">)).</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="c">%% bin2urls(Bin)遍历一个二进制型，然后返回一个包含该二进制型内所有URL的列表
</span><span class="ln">10</span><span class="c"></span><span class="nf">bin2urls</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)</span> <span class="o">-&gt;</span><span class="n">gather_urls</span><span class="p">(</span><span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span> <span class="p">[]).</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="c">%% URL列表制作封装
</span><span class="ln">13</span><span class="c"></span><span class="nf">urls2html</span><span class="p">(</span><span class="nv">Urls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">h1</span><span class="p">(</span><span class="s">&#34;Urls&#34;</span><span class="p">),</span> <span class="n">make_list</span><span class="p">(</span><span class="nv">Urls</span><span class="p">)].</span>
<span class="ln">14</span>
<span class="ln">15</span><span class="c">%% 制作标题
</span><span class="ln">16</span><span class="c"></span><span class="nf">h1</span><span class="p">(</span><span class="nv">Title</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="s">&#34;&lt;h1&gt;&#34;</span><span class="p">,</span> <span class="nv">Title</span><span class="p">,</span> <span class="s">&#34;&lt;/h1&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">].</span>
<span class="ln">17</span>
<span class="ln">18</span><span class="c">%% 制作列表
</span><span class="ln">19</span><span class="c"></span><span class="nf">make_list</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">20</span>    <span class="p">[</span><span class="s">&#34;&lt;ul&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
<span class="ln">21</span>     <span class="n">map</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="s">&#34;&lt;li&gt;&#34;</span><span class="p">,</span> <span class="nv">I</span><span class="p">,</span> <span class="s">&#34;&lt;/li&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">]</span> <span class="k">end</span><span class="p">,</span> <span class="nv">L</span><span class="p">),</span>
<span class="ln">22</span>     <span class="s">&#34;&lt;/ul&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">].</span>
<span class="ln">23</span>
<span class="ln">24</span><span class="c">%% 从html源文件中提取url
</span><span class="ln">25</span><span class="c"></span><span class="nf">gather_urls</span><span class="p">(</span><span class="s">&#34;&lt;a href&#34;</span> <span class="o">++</span> <span class="nv">T</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">26</span>    <span class="c">%% L是装Url的列表，Url是单次提取的Url，T1是剩余的网页内容
</span><span class="ln">27</span><span class="c"></span>    <span class="p">{</span><span class="nv">Url</span><span class="p">,</span> <span class="nv">T1</span><span class="p">}</span> <span class="o">=</span> <span class="n">collect_url_body</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="n">reverse</span><span class="p">(</span><span class="s">&#34;&lt;a href&#34;</span><span class="p">)),</span>
<span class="ln">28</span>    <span class="n">gather_urls</span><span class="p">(</span><span class="nv">T1</span><span class="p">,</span> <span class="p">[</span><span class="nv">Url</span><span class="p">|</span><span class="nv">L</span><span class="p">]);</span>
<span class="ln">29</span><span class="nf">gather_urls</span><span class="p">([_|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">30</span>    <span class="n">gather_urls</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="nv">L</span><span class="p">);</span>
<span class="ln">31</span><span class="nf">gather_urls</span><span class="p">([],</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">32</span>    <span class="nv">L</span><span class="p">.</span>
<span class="ln">33</span>
<span class="ln">34</span><span class="c">%% 提取出Url以及后面剩余的html内容。
</span><span class="ln">35</span><span class="c"></span><span class="nf">collect_url_body</span><span class="p">(</span><span class="s">&#34;&lt;/a&gt;&#34;</span> <span class="o">++</span> <span class="nv">T</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">reverse</span><span class="p">(</span><span class="nv">L</span><span class="p">,</span> <span class="s">&#34;&lt;/a&gt;&#34;</span><span class="p">),</span> <span class="nv">T</span><span class="p">};</span>
<span class="ln">36</span><span class="nf">collect_url_body</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">]</span> <span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">collect_url_boy</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="nv">L</span><span class="p">]);</span>
<span class="ln">37</span><span class="nf">collect_url_body</span><span class="p">(</span><span class="n">p</span><span class="p">[,</span> <span class="p">_)</span> <span class="o">-&gt;</span> <span class="p">{[],</span> <span class="p">[]}.</span>
</code></pre></div><p>TODO collect_url_body没看明白，特别是为什么要reverse，难道是我++的意思理解错了？</p>
<p>要运行它，需要有一些数据来解析。输入数据（一个二进制型）是HTML网页的内容，所以需要找一张HTML网页来操作。我们将通过socket_examples:nano_get_url（参见17.1.1节）来实现。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; B = socket_examples:nano_get_url(&#34;www.erlang.rog&#34;),
<span class="ln">2</span>   L = scavenge_urls:bin2urls(B),
<span class="ln">3</span>   scavenge_urls:urls2htmlFile(L, &#34;gathered.html&#34;).
<span class="ln">4</span>ok
</code></pre></div><h3 id="目录和文件操作">目录和文件操作</h3>
<h4 id="操作目录">操作目录</h4>
<p>file里有三个操作目录的函数:</p>
<ul>
<li><code>list_dir(Dir)</code> 生成一个Dir里的文件列表 ，列出的文件没有特定的顺序，不会告诉你它们是文件还是目录，也没有文件大小等信息。</li>
<li><code>make_dir(Dir)</code> 创建一个新目录</li>
<li><code>del_dir(Dir)</code> 删除一个目录</li>
</ul>
<h4 id="查找文件信息">查找文件信息</h4>
<p>要查找文件F的信息，我们会调用file:read_file_info(F)。如果F是一个合法的文件或目录名，它就会返回{ok, Info}。Info是一个#file_info类型的记录，此类型的定义如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">file_info</span><span class="p">,</span>
<span class="ln"> 2</span>       <span class="p">{</span><span class="nb">size</span><span class="p">,</span> <span class="c">% 文件的字节大小
</span><span class="ln"> 3</span><span class="c"></span>        <span class="n">type</span><span class="p">,</span> <span class="c">% 原子，是device, directory, regular, other其中一个
</span><span class="ln"> 4</span><span class="c"></span>        <span class="n">access</span><span class="p">,</span> <span class="c">% 原子，是read, write, read_write, none
</span><span class="ln"> 5</span><span class="c"></span>        <span class="n">atime</span><span class="p">,</span> <span class="c">% 最后一次文件被读的本地时间，{{Year, Mon, Day}, {Hour, Min, Sec}}
</span><span class="ln"> 6</span><span class="c"></span>        <span class="n">mtime</span><span class="p">,</span> <span class="c">% 最后一次文件被修改的本地时间
</span><span class="ln"> 7</span><span class="c"></span>        <span class="n">ctime</span><span class="p">,</span> <span class="c">% 取决于操作系统，Unix是文件/inode最后一次被修改，windows是创建时间
</span><span class="ln"> 8</span><span class="c"></span>        <span class="n">mode</span><span class="p">,</span> <span class="c">% 整数，文件权限
</span><span class="ln"> 9</span><span class="c"></span>        <span class="n">links</span><span class="p">,</span> <span class="c">% 文件的链接数
</span><span class="ln">10</span><span class="c"></span>        <span class="p">...</span>
<span class="ln">11</span>  <span class="p">}).</span>
</code></pre></div><p>为了方便起见，filelib模块导出了一些小方法，比如<code>file_size(File)</code>和<code>is_dir(X)</code>。它们只不过是 file:read_file_info 的接口。如果只想获得文件大小，更方便的做法是调用filelib:file_size，而不是调用file:read_file_info然后解包#file_info记录里的元素。</p>
<p>要查找某个文件的大小和类型（我们必须包含file.hrl，因为它内含#file_info记录的定义）：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">include_lib</span><span class="p">(</span><span class="s">&#34;kernel/include/file.hrl&#34;</span><span class="p">).</span>
<span class="ln">2</span><span class="nf">file_size_and_type</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">3</span>    <span class="k">case</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file_info</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">4</span>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Facts</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">5</span>            <span class="p">{</span><span class="nv">Facts</span><span class="nl">#file_info.type</span><span class="p">,</span> <span class="nv">Facts</span><span class="nl">#file_info.size</span><span class="p">};</span>
<span class="ln">6</span>        <span class="p">_</span> <span class="o">-&gt;</span>
<span class="ln">7</span>            <span class="n">error</span>
<span class="ln">8</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>通过调用map和上面的函数，增强list_file返回的目录清单：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">ls</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">L</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">list_dir</span><span class="p">(</span><span class="nv">Dir</span><span class="p">),</span>
<span class="ln">3</span>    <span class="nn">lists</span><span class="p">:</span><span class="nf">map</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">I</span><span class="p">,</span> <span class="n">file_size_and_type</span><span class="p">(</span><span class="nv">I</span><span class="p">)}</span> <span class="k">end</span><span class="p">,</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">(</span><span class="nv">L</span><span class="p">)).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; lib_misc:ls(&#34;.&#34;).
</code></pre></div><h4 id="复制和删除文件">复制和删除文件</h4>
<ul>
<li><code>file:copy(Source, Destination) </code>把文件Source复制到Destination里。</li>
<li><code>file:delete(File) </code>删除File。</li>
</ul>
<h3 id="一个查找工具函数">一个查找工具函数</h3>
<p>用<code>file:list_dir</code>和<code>file:read_file_info</code>来编写一个通用型“查找”工具。下面这段代码理解起来还是不难的，编程起来难。</p>
<p>lib_find.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">lib_find</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">files</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">files</span><span class="o">/</span><span class="mi">5</span><span class="p">]).</span>
<span class="ln"> 3</span><span class="p">-</span><span class="ni">import</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span> <span class="p">[</span><span class="n">reverse</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="p">-</span><span class="ni">include_lib</span><span class="p">(</span><span class="s">&#34;kernel/include/file.hrl&#34;</span><span class="p">).</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="c">%% 这个函数是一个封装，为可以简单地使用这个基本功能
</span><span class="ln"> 8</span><span class="c">%% ShellRegExp是一个shell风格的通配符模式，比完整形式的正则表达式更容易编写。
</span><span class="ln"> 9</span><span class="c">%% Flag是是否需要递归查找 true/false
</span><span class="ln">10</span><span class="c"></span><span class="nf">files</span><span class="p">(</span><span class="nv">Dir</span><span class="p">,</span> <span class="nv">Re</span><span class="p">,</span> <span class="nv">Flag</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">11</span>    <span class="nv">Re1</span> <span class="o">=</span> <span class="nn">xmerl_regexp</span><span class="p">:</span><span class="nf">sh_to_awk</span><span class="p">(</span><span class="nv">Re</span><span class="p">),</span>
<span class="ln">12</span>    <span class="n">reverse</span><span class="p">(</span><span class="n">files</span><span class="p">(</span><span class="nv">Dir</span><span class="p">,</span> <span class="nv">Re1</span><span class="p">,</span> <span class="nv">Flag</span><span class="p">,</span> <span class="k">fun</span><span class="p">(</span><span class="nv">File</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">File</span><span class="p">|</span><span class="nv">Acc</span><span class="p">]</span> <span class="k">end</span><span class="p">,</span> <span class="p">[])).</span>
<span class="ln">13</span>
<span class="ln">14</span><span class="c">%% Dir 这个目录名是文件搜索的起点
</span><span class="ln">15</span><span class="c">%% RegExp 这是一个shell风格的正则表达式，用于测试我们找到的文件。
</span><span class="ln">16</span><span class="c">%% 如果遇到的文件匹配这个正则表达式，就会调用Fun(File, Acc)，其中File是匹配正则表达式的文件名。
</span><span class="ln">17</span><span class="c">%% Recursive = true | false 这个标记决定了搜索是否应该层层深入当前搜索目录的子目录。
</span><span class="ln">18</span><span class="c">%% Fun(File, AccIn) -&gt; AccOut 如果regExp匹配File，这个函数就会被应用到File上。
</span><span class="ln">19</span><span class="c">%% Acc是一个初始值为Acc0的归集器。Fun在每次调用后必须返回一个新的归集值，这个值会在下次调用Fun时传递给它。
</span><span class="ln">20</span><span class="c">%% 归集器的最终值就是lib_find:files/5的返回值。
</span><span class="ln">21</span><span class="c"></span><span class="nf">files</span><span class="p">(</span><span class="nv">Dir</span><span class="p">,</span> <span class="nv">Reg</span><span class="p">,</span> <span class="nv">Recursive</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">22</span>    <span class="k">case</span> <span class="nn">file</span><span class="p">:</span><span class="nf">list_dir</span><span class="p">(</span><span class="nv">Dir</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">23</span>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Files</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">find_files</span><span class="p">(</span><span class="nv">Files</span><span class="p">,</span> <span class="nv">Dir</span><span class="p">,</span> <span class="nv">Reg</span><span class="p">,</span> <span class="nv">Recursive</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">);</span>
<span class="ln">24</span>        <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="p">_}</span> <span class="o">-&gt;</span><span class="nv">Acc</span>
<span class="ln">25</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">26</span>
<span class="ln">27</span><span class="nf">find_files</span><span class="p">([</span><span class="nv">File</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">Dir</span><span class="p">,</span> <span class="nv">Reg</span><span class="p">,</span> <span class="nv">Recursive</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Acc0</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">28</span>    <span class="nv">FullName</span> <span class="o">=</span> <span class="nn">filename</span><span class="p">:</span><span class="nf">join</span><span class="p">([</span><span class="nv">Dir</span><span class="p">,</span><span class="nv">File</span><span class="p">]),</span>
<span class="ln">29</span>    <span class="k">case</span> <span class="n">file_type</span><span class="p">(</span><span class="nv">FullName</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">30</span>        <span class="n">regular</span> <span class="o">-&gt;</span>
<span class="ln">31</span>            <span class="k">case</span> <span class="nn">re</span><span class="p">:</span><span class="nf">run</span><span class="p">(</span><span class="nv">FullName</span><span class="p">,</span> <span class="nv">Reg</span><span class="p">,</span> <span class="p">[{</span><span class="n">capture</span><span class="p">,</span> <span class="n">none</span><span class="p">}])</span> <span class="k">of</span>
<span class="ln">32</span>                <span class="n">match</span> <span class="o">-&gt;</span>
<span class="ln">33</span>                    <span class="nv">Acc</span> <span class="o">=</span> <span class="nv">Fun</span><span class="p">(</span><span class="nv">FullName</span><span class="p">,</span> <span class="nv">Acc0</span><span class="p">),</span>
<span class="ln">34</span>                    <span class="n">find_files</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="nv">Dir</span><span class="p">,</span> <span class="nv">Reg</span><span class="p">,</span> <span class="nv">Recursive</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">);</span>
<span class="ln">35</span>                <span class="n">nomatch</span> <span class="o">-&gt;</span>
<span class="ln">36</span>                    <span class="n">find_files</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="nv">DIr</span><span class="p">,</span> <span class="nv">Reg</span><span class="p">,</span> <span class="nv">Recursive</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Acc0</span><span class="p">)</span>
<span class="ln">37</span>            <span class="k">end</span><span class="p">;</span>
<span class="ln">38</span>        <span class="n">directory</span> <span class="o">-&gt;</span>
<span class="ln">39</span>            <span class="k">case</span> <span class="nv">Recursive</span> <span class="k">of</span>
<span class="ln">40</span>                <span class="n">true</span> <span class="o">-&gt;</span>
<span class="ln">41</span>                    <span class="nv">Acc1</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="nv">FullName</span><span class="p">,</span> <span class="nv">Reg</span><span class="p">,</span> <span class="nv">Recursive</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Acc0</span><span class="p">),</span>
<span class="ln">42</span>                    <span class="n">find_files</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="nv">Dir</span><span class="p">,</span> <span class="nv">Reg</span><span class="p">,</span> <span class="nv">Recursive</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Acc1</span><span class="p">);</span>
<span class="ln">43</span>                <span class="n">false</span> <span class="o">-&gt;</span>
<span class="ln">44</span>                    <span class="n">find_files</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="nv">Dir</span><span class="p">,</span> <span class="nv">Reg</span><span class="p">,</span> <span class="nv">Recursive</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Acc0</span><span class="p">)</span>
<span class="ln">45</span>            <span class="k">end</span><span class="p">;</span>
<span class="ln">46</span>        <span class="n">error</span> <span class="o">-&gt;</span>
<span class="ln">47</span>            <span class="n">find_files</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="nv">Dir</span><span class="p">,</span> <span class="nv">Reg</span><span class="p">,</span> <span class="nv">Recursive</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Acc0</span><span class="p">)</span>
<span class="ln">48</span>    <span class="k">end</span><span class="p">;</span>
<span class="ln">49</span><span class="nf">find_files</span><span class="p">([],</span> <span class="p">_,</span> <span class="p">_,</span> <span class="p">_,</span> <span class="p">_,</span> <span class="nv">A</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">50</span>    <span class="nv">A</span><span class="p">.</span>
<span class="ln">51</span>
<span class="ln">52</span><span class="c">%% 判别文件类型，从file_info记录解析
</span><span class="ln">53</span><span class="c">%% 只接受regular和directory这两种类型
</span><span class="ln">54</span><span class="c"></span><span class="nf">file_type</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">55</span>    <span class="k">case</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file_info</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">56</span>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Facts</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">57</span>            <span class="k">case</span> <span class="nv">Facts</span><span class="nl">#file_info.type</span> <span class="k">of</span>
<span class="ln">58</span>                <span class="n">regular</span> <span class="o">-&gt;</span> <span class="n">regular</span><span class="p">;</span>
<span class="ln">59</span>                <span class="n">directory</span> <span class="o">-&gt;</span> <span class="n">directory</span><span class="p">;</span>
<span class="ln">60</span>                <span class="p">_</span> <span class="o">-&gt;</span> <span class="n">error</span>
<span class="ln">61</span>                <span class="k">end</span><span class="p">;</span>
<span class="ln">62</span>        <span class="p">_</span> <span class="o">-&gt;</span> 
<span class="ln">63</span>            <span class="n">error</span>
<span class="ln">64</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>函数：</p>
<ul>
<li>
<p><code>xmerl_regexp:sh_to_awk</code> 估计已经过期了</p>
</li>
<li>
<p><code>filename:join/2</code> Joins two filename components with directory separators.</p>
</li>
<li>
<p><code>re:run(Subject, RE, Options)</code> Executes a regular expression matching, and returns <code>match/{match, Captured}</code> or <code>nomatch</code>.</p>
<p>这里的Options用的是{capture, none}，If the capture options describe that no substring capturing is to be done (<code>{capture, none}</code>), the function returns the single atom <code>match</code> upon successful matching, otherwise the tuple <code>{match, ValueList}</code></p>
</li>
</ul>
<h3 id="其他信息">其他信息</h3>
<p>请查阅手册</p>
<ul>
<li>文件模式
用file:open打开文件时，我们会以某个或某一组模式来打开它。事实上，模式的数量比我们想象的要多得多。举个例子，读取和写入gzip压缩文件时可以使用compressed这个模式标记。手册页里有完整的清单。</li>
<li>修改时间、用户组、符号链接
可以用file里的一些方法来设置它们。</li>
<li>错误代码
我曾经泛泛地说过所有错误都是{error, Why}这种形式。事实上，Why是一个原子（比如用enoent表示文件不存在，等等）。错误代码的数量其实有很多，手册页里对它们都进行了描述。</li>
<li>filename
filename模块里有一些很有用的方法，比如拆分目录里的完整文件名来获得文件扩展名，以及用各个组成部分重建文件名，等等。所有这些都是以跨平台的方式实现的。</li>
<li>filelib
filelib模块有一些小方法能给我们减少一点工作量。举个例子，<code>filelib:ensure_dir(Name)</code>会确保给定文件或目录名Name的所有上级目录都存在，必要的话会尝试创建它们。</li>
</ul>
<h3 id="练习-12">练习</h3>
<p><strong>(1)</strong> 编译Erlang文件X.erl后会生成一个X.beam文件（如果编译成功的话）。编写一个程序来检查某个Erlang模块是否需要重新编译。做法是比较相关Erlang文件和beam文件的最后修改时间戳。</p>
<p>error的情况没处理。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 2</span><span class="c">%%% @author bnaod1
</span><span class="ln"> 3</span><span class="c">%%% @copyright (C) 2024, 四川农业大学
</span><span class="ln"> 4</span><span class="c">%%% @doc
</span><span class="ln"> 5</span><span class="c">%%%
</span><span class="ln"> 6</span><span class="c">%%% @end
</span><span class="ln"> 7</span><span class="c">%%% Created : 2024 12月 18. 16:40
</span><span class="ln"> 8</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 9</span><span class="c"></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">question1</span><span class="p">).</span>
<span class="ln">10</span><span class="p">-</span><span class="ni">author</span><span class="p">(</span><span class="s">&#34;bnaod1&#34;</span><span class="p">).</span>
<span class="ln">11</span><span class="p">-</span><span class="ni">include_lib</span><span class="p">(</span><span class="s">&#34;kernel/include/file.hrl&#34;</span><span class="p">).</span>
<span class="ln">12</span><span class="c">%% API
</span><span class="ln">13</span><span class="c"></span><span class="p">-</span><span class="ni">export</span><span class="p">([]).</span>
<span class="ln">14</span>
<span class="ln">15</span>
<span class="ln">16</span><span class="c">%% 编写一个程序来检查某个Erlang模块是否需要重新编译
</span><span class="ln">17</span><span class="c">%% 扫描erl与对应beam文件，比较时间戳时候完全相等
</span><span class="ln">18</span><span class="c"></span>
<span class="ln">19</span><span class="nf">need_compile</span><span class="p">(</span><span class="nv">Module</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">20</span>  <span class="nv">Erl</span> <span class="o">=</span> <span class="nv">Module</span> <span class="o">++</span> <span class="s">&#34;.erl&#34;</span><span class="p">,</span>
<span class="ln">21</span>  <span class="nv">Beam</span> <span class="o">=</span> <span class="nv">Module</span> <span class="o">++</span> <span class="s">&#34;.beam&#34;</span><span class="p">,</span>
<span class="ln">22</span>  <span class="nv">ET</span> <span class="o">=</span> <span class="n">file_mtime</span><span class="p">(</span><span class="nv">Erl</span><span class="p">),</span>
<span class="ln">23</span>  <span class="nv">BT</span> <span class="o">=</span> <span class="n">file_mtime</span><span class="p">(</span><span class="nv">Beam</span><span class="p">),</span>
<span class="ln">24</span>  <span class="k">case</span> <span class="nv">ET</span> <span class="o">=:=</span> <span class="nv">BT</span> <span class="k">of</span>
<span class="ln">25</span>    <span class="n">true</span> <span class="o">-&gt;</span>
<span class="ln">26</span>      <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;beam is new, no need to update&#34;</span><span class="p">);</span>
<span class="ln">27</span>    <span class="n">false</span> <span class="o">-&gt;</span>
<span class="ln">28</span>      <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;beam is old, need update&#34;</span><span class="p">)</span>
<span class="ln">29</span>  <span class="k">end</span><span class="p">.</span>
<span class="ln">30</span>  
<span class="ln">31</span>
<span class="ln">32</span><span class="c">%% {{Year, Mon, Day}, {Hour, Min, Sec}}
</span><span class="ln">33</span><span class="c"></span><span class="nf">file_mtime</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">34</span>  <span class="k">case</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file_info</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">35</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Facts</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">36</span>      <span class="nv">Facts</span><span class="nl">#file_info.mtime</span><span class="p">;</span>
<span class="ln">37</span>    <span class="p">_</span> <span class="o">-&gt;</span>
<span class="ln">38</span>      <span class="n">error</span>
<span class="ln">39</span>  <span class="k">end</span><span class="p">.</span>
<span class="ln">40</span>
</code></pre></div><p><strong>(2)</strong> 编写一个程序来计算某个小文件的MD5校验和，做法是用内置函数erlang:md5/1来计算文件数据的MD5校验和（有关这个内置函数的详情请参阅Erlang手册页）。</p>
<ul>
<li>
<p><code>-spec md5(Data) -&gt; Digest when Data :: iodata(), Digest :: binary().</code></p>
<p>Computes an MD5 message digest from <code>Data</code>, where the length of the digest is 128 bits (16 bytes). <code>Data</code> is a binary or a list of small integers and binaries.</p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 2</span><span class="c">%%% @author bnaod1
</span><span class="ln"> 3</span><span class="c">%%% @copyright (C) 2024, 四川农业大学
</span><span class="ln"> 4</span><span class="c">%%% @doc
</span><span class="ln"> 5</span><span class="c">%%%
</span><span class="ln"> 6</span><span class="c">%%% @end
</span><span class="ln"> 7</span><span class="c">%%% Created : 2024 12月 19. 09:12
</span><span class="ln"> 8</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 9</span><span class="c"></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">question2</span><span class="p">).</span>
<span class="ln">10</span><span class="p">-</span><span class="ni">author</span><span class="p">(</span><span class="s">&#34;bnaod1&#34;</span><span class="p">).</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="c">%% API
</span><span class="ln">13</span><span class="c"></span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">md5check</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">14</span>
<span class="ln">15</span><span class="nf">md5check</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">16</span>  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">B</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="nv">File</span><span class="p">),</span>
<span class="ln">17</span>  <span class="nn">erlang</span><span class="p">:</span><span class="nb">md5</span><span class="p">(</span><span class="nv">B</span><span class="p">).</span>
<span class="ln">18</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>4&gt; question2:md5check(&#34;question2.erl&#34;).
<span class="ln">2</span>&lt;&lt;82,4,10,130,183,212,219,207,106,161,64,136,77,80,150,81&gt;&gt;
</code></pre></div><p><strong>(3)</strong> 对一个大文件（比如几百MB）重复前面的练习。这次分小块读取该文件，并用erlang:md5_init、erlang:md5_update和erlang:md5_final计算该文件的MD5校验和。</p>
<p><strong>(4)</strong> 用lib_find模块查找计算机里的所有.jpg文件。计算每一个文件的MD5校验和，然后比较校验和来看看是否存在两张相同的图片。</p>
<p><strong>(5)</strong> 编写一种缓存机制，让它计算文件的MD5校验和，然后把结果和文件的最后修改时间一起保存在缓存里。当想要某个文件的MD5值时就检查缓存，看看是否已经计算过，如果文件的最后修改时间有变化就重新计算它。</p>
<p>以后做，现在赶时间。</p>
<p><strong>(6)</strong> 一条推特刚好是140字节长。编写一个名为twit_store.erl的随机访问式推特存储模块，并导出下列函数：init(K)分配K条推特的空间。store(N, Buf)在存储区里保存第N（范围是1至K）条推特的数据Buf（一个140字节的二进制型）。fetch(N)取出第N条推特的数据。</p>
<p>这个练习听着很有趣，但是我不知道怎么分配空间。</p>
<h2 id="第17章-套接字编程">第17章 套接字编程</h2>
<p>UDP能让应用程序相互发送简短的消息（称为数据报），但是并不保证这些消息能成功到达。它们也可能会不按照发送顺序到达。而TCP能提供可靠的字节流，只要连接存在就会按顺序到达。用TCP发送数据的额外开销比用UDP发送数据更大。</p>
<p>套接字编程有两个主要的库：gen_tcp用于编写TCP应用程序，gen_udp用于编写UDP应用程序。</p>
<h3 id="tcp的使用">TCP的使用</h3>
<h4 id="tcp客户端">TCP客户端</h4>
<p>socket_examples.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">nano_get_url</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="n">nano_get_url</span><span class="p">(</span><span class="s">&#34;www.google.com&#34;</span><span class="p">).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">nano_get_url</span><span class="p">(</span><span class="nv">Host</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">connect</span><span class="p">(</span><span class="nv">Host</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">,</span> <span class="p">{</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">}]),</span>
<span class="ln"> 6</span>    <span class="n">ok</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="s">&#34;GET / HTTP/1.0</span><span class="se">\r\n\r\n</span><span class="s">&#34;</span><span class="p">),</span>
<span class="ln"> 7</span>    <span class="n">receive_data</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="p">[]).</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="nf">receive_Data</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nv">SoFar</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">10</span>    <span class="k">receive</span>
<span class="ln">11</span>        <span class="p">{</span><span class="n">tcp</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">12</span>            <span class="n">receive_data</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="p">[</span><span class="nv">Bin</span><span class="p">|</span><span class="nv">SoFar</span><span class="p">]);</span>
<span class="ln">13</span>        <span class="p">{</span><span class="n">tcp_closed</span><span class="p">,</span><span class="nv">Socket</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">14</span>            <span class="nb">list_to_binary</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="nv">SoFar</span><span class="p">))</span>
<span class="ln">15</span>     <span class="k">end</span><span class="p">.</span>
</code></pre></div><ul>
<li>
<p>调用gen_tcp:connect来打开一个到http://www.google.com 80端口的TCP套接字。</p>
<p>连接调用里的binary参数告诉系统要以“二进制”模式打开套接字，并把所有数据用二进制型传给应用程序。</p>
<p>{packet,0}的意思是把未经修改的TCP数据直接传给应用程序。</p>
</li>
<li>
<p>调用gen_tcp:send，把消息GET / HTTP/1.0\r\n\r\n发送给套接字，然后等待回复。这个回复并不是放在一个数据包里，而是分成多个片段，一次发送一点。这些片段会被接收成为消息序列，发送给打开（或控制）套接字的进程。</p>
</li>
<li>
<p>收到一个{tcp,Socket,Bin}消息。这个元组的</p>
</li>
<li>
<p>第三个参数是一个二进制型，原因是打开套接字时使用了二进制模式。这个消息是Web服务器发送给我们的数据片段之一。把它添加到目前已收到的片段列表中，然后等待下一个片段。</p>
</li>
<li>
<p>收到一个{tcp_closed, Socket}消息。这会在服务器完成数据发送时发生。</p>
</li>
<li>
<p>当所有片段都到达后，因为它们的保存顺序是错误的，所以反转它们并连接所有片段。</p>
</li>
</ul>
<p>测试：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>B = socket_examples:nano_get_url().
<span class="ln">2</span>io:format(&#34;~p~n&#34;, [B]).
<span class="ln">3</span>string:tokens(binary_to_list(B), &#34;\r\n&#34;).
</code></pre></div><ul>
<li>这个二进制型是被截断的.如果想查看整个二进制型，可以用io:format打印它，或者用string:tokens把它分成几部分。</li>
</ul>
<h4 id="tcp服务器">TCP服务器</h4>
<ol>
<li>
<p>数据传输：</p>
<p>TCP套接字数据只不过是一个无差别的字节流。这些数据在传输过程中<strong>可以被打散成任意大小的片段</strong>，所以需要事先约定，这样才能知道多少数据代表一个请求或响应。</p>
<p>我们在Erlang里使用了一种简单的约定，即每个逻辑请求或响应前面都会有一个N（1、2或4）字节的长度计数。这就是<code>gen_tcp:connect</code>和<code>gen_tcp:listen</code>函数里参数{packet, N}的意思。packet这个词在这里指的是应用程序请求或响应消息的长度，而不是网络上的实际数据包。需要注意的是，客户端和服务器使用的packet参数必须一致。如果启动服务器时用了{packet,2}，客户端用了{packet,4}，程序就会失败。</p>
<p>用{packet,N}选项打开一个套接字后，无需担心数据碎片的问题。Erlang<strong>驱动会确保所有碎片化的数据消息首先被重组成正确的长度</strong>，然后才会传给应用程序。</p>
</li>
<li>
<p>编码和解码：</p>
<p>用term_to_binary编码Erlang数据类型，然后用它的逆函数binary_to_term解码数据。这个约定是这个程序的，而不是erlang规范。</p>
</li>
</ol>
<p>socket_examples.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">start_nano_server</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Listen</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">listen</span><span class="p">(</span><span class="mi">2345</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">,</span> <span class="p">{</span><span class="n">packet</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
<span class="ln"> 3</span>                                         <span class="p">{</span><span class="n">reuseaddr</span><span class="p">,</span> <span class="n">true</span><span class="p">},</span>
<span class="ln"> 4</span>                                        <span class="p">{</span><span class="n">active</span><span class="p">,</span> <span class="n">true</span><span class="p">}]),</span>
<span class="ln"> 5</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">accept</span><span class="p">(</span><span class="nv">Listen</span><span class="p">),</span>
<span class="ln"> 6</span>    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Listen</span><span class="p">),</span>
<span class="ln"> 7</span>    <span class="n">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">).</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">10</span>    <span class="k">receive</span>
<span class="ln">11</span>        <span class="p">{</span><span class="n">tcp</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">12</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Server received binary = </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Bin</span><span class="p">]),</span>
<span class="ln">13</span>            <span class="nv">Str</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span>
<span class="ln">14</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Server (unpacked) </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Str</span><span class="p">]),</span>
<span class="ln">15</span>            <span class="nv">Reply</span> <span class="o">=</span> <span class="nn">lib_misc</span><span class="p">:</span><span class="nf">string2value</span><span class="p">(</span><span class="nv">Str</span><span class="p">),</span>
<span class="ln">16</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Server replying = </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Reply</span><span class="p">]),</span>
<span class="ln">17</span>            <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nb">term_to_binary</span><span class="p">(</span><span class="nv">Replay</span><span class="p">)),</span>
<span class="ln">18</span>            <span class="n">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">);</span>
<span class="ln">19</span>        <span class="p">{</span><span class="n">tcp_closed</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">20</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Server socket closed</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">)</span>
<span class="ln">21</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">22</span>
<span class="ln">23</span>
<span class="ln">24</span><span class="c">%% 测试客户端程序
</span><span class="ln">25</span><span class="c"></span><span class="nf">nano_client_eval</span><span class="p">(</span><span class="nv">Str</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">26</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">connect</span><span class="p">(</span><span class="s">&#34;localhost&#34;</span><span class="p">,</span> <span class="mi">2345</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">,</span> <span class="p">{</span><span class="n">packet</span><span class="p">,</span> <span class="mi">4</span><span class="p">}]),</span>
<span class="ln">27</span>    <span class="n">ok</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nb">term_to_binary</span><span class="p">(</span><span class="nv">Str</span><span class="p">)),</span>
<span class="ln">28</span>    <span class="k">receive</span>
<span class="ln">29</span>        <span class="p">{</span><span class="n">tcp</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">30</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Client received binary = </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Bin</span><span class="p">]),</span>
<span class="ln">31</span>            <span class="nv">Val</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span>
<span class="ln">32</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Client result = </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Val</span><span class="p">]),</span>
<span class="ln">33</span>            <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span>
<span class="ln">34</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><ul>
<li>
<p>调用<code>gen_tcp:listen</code>来监听2345端口的连接，并设置消息的打包约定。{packet,4}的意思是每个应用程序消息前部都有一个4字节的长度包头。然后gen_tcp:listen(..)会返回{ok, Listen}或{error, Why}</p>
<p>程序在<code>gen_tcp:listen</code>返回{error, &hellip;}时抛出一个模式匹配异常错误。</p>
<p>在成功的情况下，这个语句会绑定Listen到刚监听的套接字上。</p>
<p>在我的理解中，listen函数更像是一种监听和通话配置。listen是监听套接字。</p>
</li>
<li>
<p>调用<code>gen_tcp:accept(Listen)</code>。在这个阶段，程序会挂起并等待一个连接。当我们收到连接时，这个函数就会返回变量Socket，它绑定了可以与连接客户端通信的套接字。</p>
<p>可以说accept就像<strong>门卫</strong>，有客人来了就请他到一个房间Socket去。</p>
<p>accept是和connect配合的，一个听一个去连接，他们返回的socket就是他们沟通的桥梁。</p>
</li>
<li>
<p>在accept返回后立即调用<code>gen_tcp:close(Listen)</code>。这样就<strong>关闭了监听套接字</strong>，使服务器不再接收任何新连接。这么做不会影响现有连接，<strong>只会阻止新连接</strong>。</p>
<p>close负责关闭accpet的监听。</p>
</li>
<li>
<p>close还可以负责切断两者通信的socket，它是通过向服务器发送{tcp_closed, Socket}做到的。</p>
</li>
<li>
<p>TODO 我是有疑问的，如果listen和connect中的opt有一个缺省了该怎么办，客户端可以肆意妄为吗？</p>
</li>
</ul>
<p>测试：</p>
<p>两个窗口</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>socket_examples:start_nano_server().
</code></pre></div><p>执行完这个后处在accpet的位置，等待链接。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>socket_examples:nano_client_eval(&#34;list_to_tuple([2+3*$, 10+20])&#34;).
</code></pre></div><p>执行完这句之后服务器窗口：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>Server received binary = &lt;&lt;131,107....
<span class="ln">2</span>Server (unpacked) &#34;list_to_tuple([2+3*4, 10+20])&#34;
<span class="ln">3</span>Server replying = {14, 30}
</code></pre></div><p>客户端窗口</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>Client received binary = &lt;&lt; 131...
<span class="ln">2</span>Client result = {14, 30}
</code></pre></div><p>最后服务器窗口</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>Server socket closed
</code></pre></div><h4 id="改进为顺序和并行服务器">改进为顺序和并行服务器</h4>
<p>顺序服务器：一次接收一个连接
并行服务器：同时接收多个并行连接</p>
<p>顺序服务器：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">start_seq_server</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>	<span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Listen</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">listen</span><span class="p">(...),</span>
<span class="ln"> 3</span>	<span class="n">seq_loop</span><span class="p">(</span><span class="nv">Listen</span><span class="p">).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="nf">seq_loop</span><span class="p">(</span><span class="nv">Listen</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">accept</span><span class="p">(</span><span class="nv">Listen</span><span class="p">),</span>
<span class="ln"> 7</span>    <span class="n">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
<span class="ln"> 8</span>    <span class="n">seq_loop</span><span class="p">(</span><span class="nv">Listen</span><span class="p">).</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="nf">loop</span><span class="p">(..)</span> <span class="o">-&gt;</span> <span class="p">...</span>
</code></pre></div><p>在loop(Socket)完成后再次调用seq_loop(Listen)，让它等待下一个连接。如果一个客户端尝试连接时服务器正忙于处理现有连接，该连接就会加入队列，直至服务器完成现有连接。如果排队的连接数量超过了监听缓冲区限制，该连接就会被拒绝。</p>
<p>停止服务器很简单（停止并行服务器也一样），只需终止启动单个或多个服务器的进程即可。gen_tcp自身会<strong>连接到控制进程</strong>上，如果控制进程终止，它就会关闭套接字。</p>
<p>并行服务器：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="n">start</span><span class="o">-</span><span class="n">parallel_server</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>	<span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Listen</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">listen</span><span class="p">(...),</span>
<span class="ln"> 3</span>    <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">par_connect</span><span class="p">(</span><span class="nv">Listen</span><span class="p">)</span> <span class="k">end</span><span class="p">).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="nf">par_connect</span><span class="p">(</span><span class="nv">Listen</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">accept</span><span class="p">(</span><span class="nv">Listen</span><span class="p">),</span>
<span class="ln"> 7</span>    <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">par_connect</span><span class="p">(</span><span class="nv">Listen</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
<span class="ln"> 8</span>    <span class="n">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">).</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="nf">loop</span><span class="p">(..)</span> <span class="o">-&gt;</span> <span class="p">...</span>
</code></pre></div><h4 id="注意事项">注意事项</h4>
<ul>
<li>
<p>创建某个套接字（通过调用gen_tcp:accept或gen_tcp:connect）的进程被称为该套接字的<strong>控制进程</strong>。所有来自套接字的消息都会被发送到控制进程。如果控制进程挂了，套接字就会被关闭。某个套接字的控制进程可以通过调用<code>gen_tcp:controlling_process(Socket, NewPid)</code>修改成NewPid。</p>
</li>
<li>
<p>我们的并行服务器可能会创建出几千个连接，所以可以限制最大同时连接数。实现的方法可以是维护一个计数器来统计任一时刻有多少活动连接。每当收到一个新连接时就让计数器加1，每当一个连接结束时就让它减1。可以用它来限制系统里的同时连接总数。</p>
</li>
<li>
<p>接受一个连接后，显式设置必要的套接字选项是一种很好的做法，就像这样：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">accept</span><span class="p">(</span><span class="nv">Listen</span><span class="p">),</span>
<span class="ln">2</span><span class="nn">inet</span><span class="p">:</span><span class="nf">setopts</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="p">[{</span><span class="n">packet</span><span class="p">,</span><span class="mi">4</span><span class="p">},</span><span class="n">binary</span><span class="p">,{</span><span class="n">nodelay</span><span class="p">,</span><span class="n">true</span><span class="p">},{</span><span class="n">active</span><span class="p">,</span><span class="n">true</span><span class="p">}]),</span>
<span class="ln">3</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span>    
</code></pre></div></li>
<li>
<p>Erlang 的R11B-3版开始允许多个Erlang进程对同一个监听套接字调用gen_tcp:accept/1。这让编写并行服务器变得简单了，因为你可以生成一个预先分裂好的进程池，让它们都处在gen_tcp:accept/1的等待状态。</p>
</li>
<li>
<p>假设编写了某种在线服务器，并且发现有人持续向网站发送垃圾信息。为了尽量防止这
种事发生，我们需要知道连接的来源。可以调用inet:peername(Socket)进行查看。</p>
<p><code>@spec inet:peername(Socket) -&gt; {ok, {IP_Address, Port}} | {error, Why}</code></p>
</li>
</ul>
<h4 id="主动和被动套接字">主动和被动套接字</h4>
<p>TODO 一个套接字指的是Listen还是Socket？难道一个Socket会有多个连接吗？</p>
<p>Erlang的套接字可以有三种打开模式：主动（active）、单次主动（active once）或被动（passive）。这是通过在gen_tcp:connect(Address, Port, Options)或gen_tcp:listen(Port, Options)的Options参数里加入{active, true | false | once}选项实现的。</p>
<p>如果指定{active, true}就会创建一个主动套接字，指定{active, false}则是被动套接字。{active, once}创建的套接字只会主动接收一个消息，接收完之后必须重新启用才能接收下一个消息。</p>
<ul>
<li>当一个主动套接字被创建后，它会在收到数据时向控制进程发送{tcp, Socket, Data}消息。控制进程无法控制这些消息流。恶意的客户端可以向系统发送成千上万的消息，而它们都会被发往控制进程。控制进程无法阻止这些消息流。</li>
<li>如果一个套接字是用被动模式打开的，控制进程就必须调用gen_tcp:recv(Socket, N)来从这个套接字接收数据。然后它会尝试从套接字接收N个字节。如果N = 0，套接字就会返回所有可用的字节。在这个案例里，服务器可以通过选择何时调用gen_tcp:recv来控制客户端所发的消息流。被动套接字的作用是控制通往服务器的数据流。</li>
</ul>
<p>1.主动消息接收（非阻塞式）:</p>
<p>只有在确信服务器能跟上客户端的需求时才会编写非阻塞式服务器。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Listen</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">listen</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="p">[..,</span> <span class="p">{</span><span class="n">active</span><span class="p">,</span> <span class="n">true</span><span class="p">}...]),</span>
<span class="ln"> 2</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">accept</span><span class="p">(</span><span class="nv">Listen</span><span class="p">),</span>
<span class="ln"> 3</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="k">receive</span>
<span class="ln"> 7</span>        <span class="p">{</span><span class="n">tcp</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Data</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>            <span class="p">...</span> <span class="err">对数据进行操作</span> <span class="p">...</span>
<span class="ln"> 9</span>		<span class="p">{</span><span class="n">tcp_closed</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">10</span>    		<span class="p">...</span>
<span class="ln">11</span>	<span class="k">end</span><span class="p">.</span>
</code></pre></div><p>2.被动消息接收（阻塞式）:</p>
<p>服务器循环里的代码会在每次想要接收数据时调用gen_tcp:recv。客户端会一直被阻塞，直到服务器调用recv为止。请注意，操作系统有自己的缓冲设置，即使没有调用recv，客户端也能在阻塞前发送少量数据。</p>
<p>当我们处于被动模式时，只能等待来自单个套接字的数据。这对于编写那些必须等待来自多个套接字数据的服务器来说毫无用处。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Listen</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">listen</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="p">[..,{</span><span class="n">active</span><span class="p">,</span> <span class="n">false</span><span class="p">}...]),</span>
<span class="ln"> 2</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">accept</span><span class="p">(</span><span class="nv">Listen</span><span class="p">),</span>
<span class="ln"> 3</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="k">case</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">recv</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nv">N</span><span class="p">)</span> <span class="k">of</span>
<span class="ln"> 7</span>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">B</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>            <span class="p">....</span>
<span class="ln"> 9</span>			<span class="n">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">);</span>
<span class="ln">10</span>		<span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">closed</span><span class="p">}</span>
<span class="ln">11</span>			<span class="p">...</span>
<span class="ln">12</span>	<span class="k">end</span><span class="p">.</span>
</code></pre></div><p>3.混合消息接收（部分阻塞式）:</p>
<p>套接字在这个模式下虽然是主动的，但只针对一个消息。当控制进程收到一个消息后，必须显式调用inet:setopts才能重启下一个消息的接收，在此之前系统会处于阻塞状态。</p>
<p>通过使用{active, once}选项，用户可以实现高级形式的流量控制（有时被称为流量整形），从而防止服务器被过多消息淹没。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Listen</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">listen</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="p">[..,{</span><span class="n">active</span><span class="p">,</span> <span class="n">once</span><span class="p">}...]),</span>
<span class="ln"> 2</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">accept</span><span class="p">(</span><span class="nv">Listen</span><span class="p">),</span>
<span class="ln"> 3</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="k">receive</span>
<span class="ln"> 7</span>        <span class="p">{</span><span class="n">tcp</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Data</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>            <span class="p">....</span>
<span class="ln"> 9</span>			<span class="c">%% 准备好启动下一个消息接收时
</span><span class="ln">10</span><span class="c"></span>			<span class="nn">inet</span><span class="p">:</span><span class="nf">setpots</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="p">[{</span><span class="n">active</span><span class="p">,</span> <span class="n">once</span><span class="p">}]),</span>
<span class="ln">11</span>    		<span class="n">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">);</span>
<span class="ln">12</span>		<span class="p">{</span><span class="n">tcp_closed</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">13</span>    		<span class="p">...</span>
<span class="ln">14</span>	<span class="k">end</span><span class="p">.</span>
</code></pre></div><h4 id="套接字错误处理">套接字错误处理</h4>
<p>每个套接字都有一个控制进程（也就是创建该套接字的进程）。如果控制进程挂了，套接字就会被自动关闭。如果我们有一个客户端和一个服务器，而服务器因为程序错误挂了，那么服务器支配的套接字就会被自动关闭，同时向客户端发送一个{tcp_closed, Socket}消息。</p>
<p>实验：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">error_Test</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">error_test_server</span><span class="p">()</span> <span class="k">end</span><span class="p">),</span>
<span class="ln"> 3</span>    <span class="nn">lib_misc</span><span class="p">:</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">),</span>
<span class="ln"> 4</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">connect</span><span class="p">(</span><span class="s">&#34;localhost&#34;</span><span class="p">,</span> <span class="mi">4321</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">,</span> <span class="p">{</span><span class="n">packet</span><span class="p">,</span><span class="mi">2</span><span class="p">}]),</span>
<span class="ln"> 5</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;connected to :</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Socket</span><span class="p">]),</span>
<span class="ln"> 6</span>    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&#34;123&#34;</span><span class="o">&gt;&gt;</span><span class="p">),</span>
<span class="ln"> 7</span>    <span class="k">receive</span>
<span class="ln"> 8</span>        <span class="nv">Any</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Any=</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,[</span><span class="nv">Any</span><span class="p">])</span>
<span class="ln">10</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="nf">error_test_server</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">13</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Listen</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">listen</span><span class="p">(</span><span class="mi">4321</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">,</span> <span class="p">{</span><span class="n">packet</span><span class="p">,</span><span class="mi">2</span><span class="p">}]),</span>
<span class="ln">14</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">accept</span><span class="p">(</span><span class="nv">Listen</span><span class="p">),</span>
<span class="ln">15</span>    <span class="n">error_test_server_loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">).</span>
<span class="ln">16</span>
<span class="ln">17</span><span class="nf">error_test_server_loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">18</span>    <span class="k">receive</span>
<span class="ln">19</span>        <span class="p">{</span><span class="n">tcp</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Data</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">20</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;received:</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Data</span><span class="p">]),</span>
<span class="ln">21</span>            <span class="p">_</span> <span class="o">=</span> <span class="nb">atom_to_list</span><span class="p">(</span><span class="nv">Data</span><span class="p">),</span>
<span class="ln">22</span>            <span class="n">error_test_server_loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span>
<span class="ln">23</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>我们分裂出一个服务器并睡眠两秒钟来让它完成启动，然后向它发送一个包含二进制型&laquo;&ldquo;123&rdquo;&raquo; 的消息。 当这个消息到达服务器后，服务器尝试对二进制型Data 计算atom_to_list(Data)，于是立即崩溃了。系统监视器打印出了你在shell里所见到的诊断信息。因为服务器端套接字的控制进程已经崩溃，所以（服务器端的）套接字就被自动关闭了。系统随后向客户端发送一个{tcp_closed, Socket}消息。</p>
<h3 id="udp">UDP</h3>
<p>互联网上的机器能够通过UDP相互发送被称为数据报（datagram）的短消息。UDP数据报是不可靠的，这就意味着如果客户端向服务器发送一串UDP数据报，它们可能会不按顺序到达，不能成功到达或者不止一次到达。但是每一个数据报只要到达，就会是完好无损的。</p>
<p>UDP是一种无连接协议，意思是客户端向服务器发送消息之前不必建立连接。这就意味着UDP非常适合那些大量客户端向服务器发送简短消息的应用程序。</p>
<h4 id="最简单的udp服务器与客户端">最简单的UDP服务器与客户端</h4>
<p>服务器：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">server</span><span class="p">(</span><span class="nv">Port</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_udp</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="nv">POrt</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">]),</span>
<span class="ln"> 3</span>    <span class="n">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="k">receive</span>
<span class="ln"> 7</span>        <span class="p">{</span><span class="n">udp</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Host</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>            <span class="nv">BinReply</span> <span class="o">=</span> <span class="p">...,</span>
<span class="ln"> 9</span>			<span class="nn">gen_udp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nv">Host</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">BinReply</span><span class="p">),</span>
<span class="ln">10</span>			<span class="n">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span>
<span class="ln">11</span>     <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>客户端：</p>
<p>必须设置一个超时，因为UDP是不可靠的，我们可能会得不到回复。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">client</span><span class="p">(</span><span class="nv">Request</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_udp</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">]),</span>
<span class="ln"> 3</span>    <span class="n">ok</span> <span class="o">=</span> <span class="nn">gen_udp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="s">&#34;localhost&#34;</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="nv">Request</span><span class="p">),</span>
<span class="ln"> 4</span>    <span class="nv">Value</span> <span class="o">=</span> <span class="k">receive</span>
<span class="ln"> 5</span>                <span class="p">{</span><span class="n">udp</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="p">_,</span> <span class="p">_,</span> <span class="nv">Bin</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>                    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">}</span>
<span class="ln"> 7</span>            <span class="k">after</span> <span class="mi">2000</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>                    <span class="n">error</span>
<span class="ln"> 9</span>            <span class="k">end</span><span class="p">,</span>
<span class="ln">10</span>    <span class="nn">gen_udp</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
<span class="ln">11</span>    <span class="nv">Value</span><span class="p">.</span>
</code></pre></div><h4 id="一个udp阶乘服务器">一个UDP阶乘服务器</h4>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">udp_test</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_server0</span><span class="p">,</span> <span class="n">client</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start_server</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">server</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span> <span class="k">end</span><span class="p">).</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="c">%% server
</span><span class="ln"> 8</span><span class="c"></span><span class="nf">server</span><span class="p">(</span><span class="nv">Port</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_udp</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">]),</span>
<span class="ln">10</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;server opened socket:</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Socket</span><span class="p">]),</span>
<span class="ln">11</span>    <span class="n">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">).</span>
<span class="ln">12</span>
<span class="ln">13</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">14</span>    <span class="k">receive</span>
<span class="ln">15</span>        <span class="p">{</span><span class="n">udp</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Host</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Msg</span> <span class="o">-&gt;</span>
<span class="ln">16</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;server received:</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Msg</span><span class="p">]),</span>
<span class="ln">17</span>            <span class="nv">N</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span>
<span class="ln">18</span>            <span class="nv">Fac</span> <span class="o">=</span> <span class="n">fac</span><span class="p">(</span><span class="nv">N</span><span class="p">),</span>
<span class="ln">19</span>            <span class="n">gen_udp_send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nv">Host</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nb">term_to_binary</span><span class="p">(</span><span class="nv">Fac</span><span class="p">)),</span>
<span class="ln">20</span>            <span class="n">loop</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span>
<span class="ln">21</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">22</span>
<span class="ln">23</span><span class="nf">fac</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">24</span><span class="nf">fac</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">N</span> <span class="o">*</span> <span class="n">fac</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span>
<span class="ln">25</span>
<span class="ln">26</span><span class="c">%% client
</span><span class="ln">27</span><span class="c"></span><span class="nf">client</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">28</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_udp</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">]),</span>
<span class="ln">29</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;client opened socket=</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Socket</span><span class="p">]),</span>
<span class="ln">30</span>    <span class="n">ok</span> <span class="o">=</span> <span class="nn">gen_udp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="s">&#34;localhost&#34;</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="nb">term_to_binary</span><span class="p">(</span><span class="nv">N</span><span class="p">)),</span>
<span class="ln">31</span>    <span class="nv">Value</span> <span class="o">=</span> <span class="k">receive</span>
<span class="ln">32</span>                <span class="p">{</span><span class="n">udp</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="p">_,</span> <span class="p">_,</span> <span class="nv">Bin</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Msg</span> <span class="o">-&gt;</span>
<span class="ln">33</span>                    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;client received:</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Msg</span><span class="p">]),</span>
<span class="ln">34</span>                    <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)</span>
<span class="ln">35</span>            <span class="k">after</span> <span class="mi">2000</span> <span class="o">-&gt;</span>
<span class="ln">36</span>                    <span class="mi">0</span>
<span class="ln">37</span>            <span class="k">end</span><span class="p">,</span>
<span class="ln">38</span>    <span class="nn">gen_udp</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
<span class="ln">39</span>    <span class="nv">Value</span><span class="p">.</span>
</code></pre></div><p>测试：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>udp_test:start_server().
<span class="ln">2</span>udp_test:client(40).
</code></pre></div><h4 id="udp数据包须知">UDP数据包须知</h4>
<ul>
<li>UDP是一种无连接协议，所以服务器无法通过拒绝读取来自某个客户端的数据来阻挡它。服务器对谁是客户端一无所知。</li>
<li>大型UDP数据包可能会分段通过网络。当UDP数据经过网络上的路由器时，如果数据大小超过了路由器允许的最大传输单元（Maximum Transfer Unit，简称MTU）大小，分段就会发生。通常的建议是在调整UDP网络时从一个较小的数据包大小开始（比如大约500字节），然后逐步增大并测量吞吐量。如果吞吐量在某个时刻骤减，你就知道数据包太大了。</li>
<li>UDP数据包可以传输两次（这出乎一些人的意料之外），所以在编写远程过程调用代码时一定要小心。第二次查询得到的回复可能只是第一次查询回复的复制。为防止这类问题，可以修改客户端代码来加入一个唯一的引用，然后检查服务器是否返回了这个引用。要生成一个唯一的引用，需要调用Erlang的内置函数make_ref，它能确保返回一个全局唯一的引用。</li>
</ul>
<p>一个ref防止重发的示例：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">client</span><span class="p">(</span><span class="nv">Request</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_udp</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">]),</span>
<span class="ln"> 3</span>    <span class="nv">Ref</span> <span class="o">=</span> <span class="n">make_ref</span><span class="p">(),</span> <span class="c">%% 生成唯一引用
</span><span class="ln"> 4</span><span class="c"></span>    <span class="nv">B1</span> <span class="o">=</span> <span class="nb">term_to_binary</span><span class="p">({</span><span class="nv">Ref</span><span class="p">,</span> <span class="nv">Request</span><span class="p">}),</span>
<span class="ln"> 5</span>    <span class="n">ok</span> <span class="o">=</span> <span class="nn">gen_udp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="s">&#34;localhost&#34;</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="nv">B1</span><span class="p">),</span>
<span class="ln"> 6</span>    <span class="n">wait_for_ref</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">).</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="nf">wait_for_ref</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>    <span class="k">receive</span>
<span class="ln">10</span>        <span class="p">{</span><span class="n">udp</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="p">_,</span> <span class="p">_,</span> <span class="nv">Bin</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">11</span>            <span class="k">case</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">12</span>                <span class="p">{</span><span class="nv">Ref</span><span class="p">,</span> <span class="nv">Val</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">13</span>                    <span class="c">%% correct
</span><span class="ln">14</span><span class="c"></span>                    <span class="nv">Val</span><span class="p">;</span>
<span class="ln">15</span>                <span class="p">{_</span><span class="nv">SomeOtherRef</span><span class="p">,</span> <span class="p">_}</span> <span class="o">-&gt;</span>
<span class="ln">16</span>                    <span class="c">%% incorrect, drop
</span><span class="ln">17</span><span class="c"></span>                    <span class="n">wait_for_ref</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span><span class="nv">Ref</span><span class="p">)</span>
<span class="ln">18</span>            <span class="k">end</span><span class="p">;</span>
<span class="ln">19</span>    <span class="k">after</span> <span class="mi">1000</span> <span class="o">-&gt;</span>
<span class="ln">20</span>            <span class="p">....</span>
<span class="ln">21</span>	<span class="k">end</span><span class="p">.</span>
</code></pre></div><h4 id="广播">广播</h4>
<p>在这里需要两个端口，一个发送广播（广播方），另一个监听回应（接听方和广播发向的端口）。我们选择了5010端口来发送广播请求，6000端口用来监听广播</p>
<p>只有发送广播的进程才会打开5010端口，而网络上的所有机器都会调用broadcast:listen()来打开6000端口并监听广播消息。broadcast:send(IoList)会对局域网里的所有机器广播IoList。</p>
<p>大概意思就是从5010给局域网每台机器的6000端口发消息，想要接收就听6000端口。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">broadcase</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">compile</span><span class="p">(</span><span class="n">export_all</span><span class="p">).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nb">send</span><span class="p">(</span><span class="nv">IoList</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="k">case</span> <span class="nn">inet</span><span class="p">:</span><span class="nf">ifget</span><span class="p">(</span><span class="s">&#34;eth0&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">broadaddr</span><span class="p">])</span> <span class="k">of</span>
<span class="ln"> 6</span>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">[{</span><span class="n">broadaddr</span><span class="p">,</span> <span class="nv">Ip</span><span class="p">}]}</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>            <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">S</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_udp</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="mi">5010</span><span class="p">,</span> <span class="p">[{</span><span class="n">broadcast</span><span class="p">,</span> <span class="n">true</span><span class="p">}]),</span>
<span class="ln"> 8</span>            <span class="nn">gen_udp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="nv">Ip</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="nv">IoList</span><span class="p">),</span>
<span class="ln"> 9</span>            <span class="nn">gen_udp</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">S</span><span class="p">);</span>
<span class="ln">10</span>       	<span class="p">_</span> <span class="o">-&gt;</span>
<span class="ln">11</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Bad interface name, or</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="ln">12</span>                      <span class="s">&#34;broadcasting not supported</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">)</span>
<span class="ln">13</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">14</span>
<span class="ln">15</span><span class="nf">listen</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">16</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">_}</span> <span class="o">=</span> <span class="nn">gen_udp</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="mi">6000</span><span class="p">),</span>
<span class="ln">17</span>    <span class="n">loop</span><span class="p">().</span>
<span class="ln">18</span><span class="nf">loop</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">19</span>    <span class="k">receive</span>
<span class="ln">20</span>        <span class="nv">Any</span> <span class="o">-&gt;</span>
<span class="ln">21</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;received:</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Any</span><span class="p">]),</span>
<span class="ln">22</span>            <span class="n">loop</span><span class="p">()</span>
<span class="ln">23</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><h3 id="案例一个-shoutcast-服务器">案例：一个 SHOUTcast 服务器</h3>
<p>SHOUTcast是由Nullsoft公司开发的协议，它被用于传输音频数据流。SHOUTcast使用HTTP作为传输协议来发送MP3或AAC编码的音频数据。</p>
<h3 id="练习-13">练习</h3>
<p>没时间了，以后做。</p>
<p>(1) 修改nano_get_url/0的代码（17.1.1节），并在必要时添加合适的HTTP头或执行重定向来获取任意网页。在多个网站上测试它。</p>
<p>(2) 输入17.1.2节里的代码，然后修改此代码来接收一个{Mod, Func, Args}元组（而不是字符串），最后计算Reply = apply(Mod, Func, Args)并把值发回套接字。编写一个nano_client_eval(Mod, Func, Args)函数（类似于本章前面所展示的版本），让它用修改版服务器代码能理解的形式编码Mod、Func和Arity。测试客户端和服务器代码能否正常工作，首先在同一台机器上，然后在同一局域网的两台机器上，最后在互联网上的两台机器上。</p>
<p>(3) 用UDP代替TCP重复上一个练习。</p>
<p>(4) 添加一个加密层，做法是先编码二进制型再发送给输出套接字，并在输入套接字接收之后立即解码。</p>
<p>(5) 制作一个简单的“类电子邮件”系统。把Erlang数据类型作为消息存储在${HOME}/mbox目录里。</p>
<h2 id="第18章-用websocket和erlang进行浏览">第18章 用WebSocket和Erlang进行浏览</h2>
<p>其实就是一个前后端的概念</p>
<p>TODO 这章都是示例程序，待补。</p>
<p>为了给Erlang运行时系统建立WebSocket接口，就会运行一个名为cowboy（牛仔）的简单Erlang服务器，让它管理套接字和WebSocket协议。第25章会详细介绍如何安装cowboy。为了简化讨论，我们假定Erlang和浏览器之间传递的所有消息都是JSON格式的。</p>
<p>这些消息在应用程序的Erlang端体现为Erlang映射组（参见5.3节），在浏览器里则体现为JavaScript对象。</p>
<h3 id="一个数字时钟">一个数字时钟</h3>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="ln"> 1</span><span class="p">&lt;</span><span class="nt">script</span> <span class="err">...</span> <span class="na">src</span><span class="o">=</span><span class="s">:./jquery...&lt;/script</span><span class="p">&gt;</span>
<span class="ln"> 2</span><span class="o">&lt;</span><span class="nx">script</span> <span class="p">...</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;websock.js&#34;</span> <span class="p">..</span> <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="ln"> 3</span><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="ln"> 4</span>    ...
<span class="ln"> 5</span><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="ln"> 9</span>	<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
<span class="ln">10</span>        <span class="nx">connect</span><span class="p">(</span><span class="s2">&#34;localhost&#34;</span><span class="p">,</span> <span class="mi">2233</span><span class="p">,</span> <span class="s2">&#34;clock1&#34;</span><span class="p">);</span>
<span class="ln">11</span>    <span class="p">})</span>
<span class="ln">12</span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div><p>websock.js包含了所有必需的代码来打开WebSocket和连接浏览器DOM对象到Erlang。它会做下列事情。</p>
<p>(1) 给网页里所有属于live_button类的按钮添加点击处理函数。这些点击处理函数会在按钮被点击时向Erlang发送消息。</p>
<p>(2) 尝试启动一个到http://localhost:2233的WebSocket连接。在服务器端会有一个新分裂 出 的 进 程 调 用 clock1:start(Browser) 函 数 。 所 有 这 些 都 是 通 过 调 用 JavaScript 函 数connect(&ldquo;localhost&rdquo;, 2233, &ldquo;clock1&rdquo;)实现的。2233这个数字没有什么特别的含义，任何大于1023的未使用端口号都可以用。</p>
<p>现在是Erlang代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">clock1</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">current_time</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">(</span><span class="nv">Browser</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="nv">Browser</span> <span class="o">!</span> <span class="p">#{</span> <span class="n">cmd</span> <span class="o">=&gt;</span> <span class="n">fill_div</span><span class="p">,</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="n">clock</span><span class="p">,</span> <span class="n">txt</span> <span class="o">=&gt;</span> <span class="n">current_time</span><span class="p">()},</span>
<span class="ln"> 6</span>    <span class="n">running</span><span class="p">(</span><span class="nv">Browser</span><span class="p">).</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="nf">running</span><span class="p">(</span><span class="nv">Browser</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>    <span class="k">receive</span>
<span class="ln">10</span>        <span class="p">{</span><span class="nv">Browser</span><span class="p">,</span> <span class="p">#{</span><span class="n">clicked</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&#34;stop&#34;</span><span class="o">&gt;&gt;</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">11</span>            <span class="n">idle</span><span class="p">(</span><span class="nv">Browser</span><span class="p">)</span>
<span class="ln">12</span>    <span class="k">after</span> <span class="mi">1000</span> <span class="o">-&gt;</span>
<span class="ln">13</span>            <span class="nv">Browser</span> <span class="o">!</span> <span class="p">#{</span><span class="n">cmd</span> <span class="o">=&gt;</span> <span class="n">fill_div</span><span class="p">,</span> <span class="n">id</span><span class="o">=&gt;</span> <span class="n">clock</span><span class="p">,</span> <span class="n">txt</span> <span class="o">=&gt;</span> <span class="n">current_time</span><span class="p">()},</span>
<span class="ln">14</span>            <span class="n">running</span><span class="p">(</span><span class="nv">Browser</span><span class="p">)</span>
<span class="ln">15</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">16</span>
<span class="ln">17</span><span class="nf">idle</span><span class="p">(</span><span class="nv">Browser</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">18</span>    <span class="k">receive</span>
<span class="ln">19</span>        <span class="p">{</span><span class="nv">Browser</span><span class="p">,</span> <span class="p">#{</span><span class="n">clicked</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&#34;start&#34;</span><span class="o">&gt;&gt;</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">20</span>            <span class="n">running</span><span class="p">(</span><span class="nv">Browser</span><span class="p">)</span>
<span class="ln">21</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">22</span>
<span class="ln">23</span><span class="nf">current_time</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">24</span>    <span class="p">{</span><span class="nv">Hour</span><span class="p">,</span> <span class="nv">Min</span><span class="p">,</span> <span class="nv">Sec</span><span class="p">}</span> <span class="o">=</span> <span class="n">time</span><span class="p">(),</span>
<span class="ln">25</span>    <span class="nb">list_to_binary</span><span class="p">(</span><span class="nn">io_lib</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;~2.2.ow:~2.2.ow:~2.2.ow&#34;</span><span class="p">,[</span><span class="nv">Hour</span><span class="p">,</span><span class="nv">Min</span><span class="p">,</span><span class="nv">Sec</span><span class="p">])).</span>
</code></pre></div><p>若希望让浏览器做点什么，就向它发送一个消息。就像在Erlang里一样。我们驯服了浏览器，它看起来就像是一个Erlang进程。</p>
<p>初始化之后，clock1会调用running/1。如果收到一个{clicked =&gt; &laquo;&ldquo;stop&rdquo;&raquo;}消息，就会调用idle(Browser)。否则，会在一秒钟的超时到期后向浏览器发送一个更新时钟的命令，然后调用自身。idle/1等待一个start消息，然后调用running/1。</p>
<h3 id="单方聊天框">单方聊天框</h3>
<p>它的工作方式类似于时钟示例。每当用户在输入框里按下回车键时，输入框就会发送一个包含输入文本的消息给浏览器。管理窗口的Erlang进程接收这个消息，然后向浏览器发回一个更新显示内容的消息。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">iunteract1</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">(</span><span class="nv">Browser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">running</span><span class="p">(</span><span class="nv">Browser</span><span class="p">).</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="nf">running</span><span class="p">(</span><span class="nv">Bowser</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>    <span class="k">receive</span>
<span class="ln"> 8</span>        <span class="p">{</span><span class="nv">Browser</span><span class="p">,</span> <span class="p">#{</span><span class="n">entry</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&#34;input&#34;</span><span class="o">&gt;&gt;</span><span class="n">m</span> <span class="n">txt</span> <span class="o">=&gt;</span> <span class="nv">Bin</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>            <span class="nv">Time</span> <span class="o">=</span> <span class="nn">clock1</span><span class="p">:</span><span class="nf">current_time</span><span class="p">(),</span>
<span class="ln">10</span>            <span class="nv">Browser</span> <span class="o">!</span> <span class="p">#{</span><span class="n">cmd</span> <span class="o">=&gt;</span> <span class="n">append_div</span><span class="p">,</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="n">scroll</span><span class="p">,</span> <span class="n">txt</span> <span class="o">=&gt;</span> <span class="nb">list_to_binary</span><span class="p">([</span><span class="nv">Time</span><span class="p">,</span> <span class="s">&#34;&gt;&#34;</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">,</span> <span class="s">&#34;&lt;Br&gt;&#34;</span><span class="p">])}</span>
<span class="ln">11</span>    <span class="k">end</span><span class="p">,</span>
<span class="ln">12</span>    <span class="n">running</span><span class="p">(</span><span class="nv">Browser</span><span class="p">).</span>
<span class="ln">13</span>        	
</code></pre></div><h3 id="浏览器里的-erlang-shell">浏览器里的 Erlang shell</h3>
<p>可以用接口模式里的代码制作一个在浏览器里运行的Erlang shell。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">start</span><span class="p">(</span><span class="nv">Browser</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="nv">Browser</span> <span class="o">!</span> <span class="p">#{</span><span class="n">cmd</span> <span class="o">=&gt;</span> <span class="n">append_div</span><span class="p">,</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="n">scroll</span><span class="p">,</span> <span class="n">txt</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&#34;Starting Erlang shell:&lt;br&gt;&#34;</span><span class="o">&gt;&gt;</span><span class="p">},</span>
<span class="ln"> 3</span>    <span class="nv">B0</span> <span class="o">=</span> <span class="nn">erl_eval</span><span class="p">:</span><span class="nf">new_bindings</span><span class="p">(),</span>
<span class="ln"> 4</span>    <span class="n">running</span><span class="p">(</span><span class="nv">Browser</span><span class="p">,</span> <span class="nv">B0</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span>
<span class="ln"> 5</span><span class="nf">running</span><span class="p">(</span><span class="nv">Browser</span><span class="p">,</span> <span class="nv">B0</span><span class="p">,</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="k">receive</span>
<span class="ln"> 7</span>        <span class="p">{</span><span class="nv">Browser</span><span class="p">,</span> <span class="p">#{</span><span class="n">entry</span> <span class="o">=&gt;</span>  <span class="o">&lt;&lt;</span><span class="s">&#34;input&#34;</span><span class="o">&gt;&gt;</span><span class="p">},</span> <span class="n">txt</span> <span class="o">=&gt;</span> <span class="nv">Bin</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>            <span class="p">{</span><span class="nv">Vaule</span><span class="p">,</span> <span class="nv">B1</span><span class="p">}</span> <span class="o">=</span> <span class="n">string2value</span><span class="p">(</span><span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span> <span class="nv">B0</span><span class="p">),</span>
<span class="ln"> 9</span>            <span class="nv">BV</span> <span class="o">=</span> <span class="n">bf</span><span class="p">(</span><span class="s">&#34;</span><span class="si">~w</span><span class="s"> &gt; &lt;font color=&#39;red&#39;&gt;</span><span class="si">~s</span><span class="s">&lt;/font&gt;&lt;br&gt;</span><span class="si">~p</span><span class="s">&lt;br&gt;&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">,</span> <span class="nv">Value</span><span class="p">]),</span>
<span class="ln">10</span>            <span class="nv">Browser</span> <span class="o">!</span> <span class="p">#{</span><span class="n">cmd</span> <span class="o">=&gt;</span> <span class="n">append_div</span><span class="p">,</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="n">scroll</span><span class="p">,</span> <span class="n">txt</span> <span class="o">=&gt;</span> <span class="nv">BV</span><span class="p">},</span>
<span class="ln">11</span>            <span class="n">running</span><span class="p">(</span><span class="nv">Brwoser</span><span class="p">,</span> <span class="nv">B1</span><span class="p">,</span> <span class="nv">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="ln">12</span>     <span class="k">end</span><span class="p">.</span>
<span class="ln">13</span>
<span class="ln">14</span><span class="nf">string2value</span><span class="p">(</span><span class="nv">Str</span><span class="p">,</span> <span class="nv">Bindings0</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">15</span>    <span class="k">case</span> <span class="nn">erl_scan</span><span class="p">:</span><span class="nf">string</span><span class="p">(</span><span class="nv">Str</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">16</span>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Tokens</span><span class="p">,</span> <span class="p">_}</span> <span class="o">-&gt;</span>
<span class="ln">17</span>            <span class="k">case</span> <span class="nn">erl_parse</span><span class="p">:</span><span class="nf">parse_exprs</span><span class="p">(</span><span class="nv">Tokens</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">18</span>                <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Exprs</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">19</span>                    <span class="p">{</span><span class="n">value</span><span class="p">,</span> <span class="nv">Val</span><span class="p">,</span> <span class="nv">Bindings1</span><span class="p">}</span> <span class="o">=</span> <span class="nn">erl_eval</span><span class="p">:</span><span class="nf">exprs</span><span class="p">(</span><span class="nv">Exprs</span><span class="p">,</span> <span class="nv">Binding0</span><span class="p">),</span>
<span class="ln">20</span>                    <span class="p">{</span><span class="nv">Val</span><span class="p">,</span> <span class="nv">Bindings1</span><span class="p">};</span>
<span class="ln">21</span>                <span class="nv">Other</span> <span class="o">-&gt;</span>
<span class="ln">22</span>                    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;cannot parse:</span><span class="si">~p</span><span class="s"> Reason=</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Tokens</span><span class="p">,</span> <span class="nv">Other</span><span class="p">]),</span>
<span class="ln">23</span>                    <span class="p">{</span><span class="n">parse_error</span><span class="p">,</span> <span class="nv">Bindings0</span><span class="p">}</span>
<span class="ln">24</span>             <span class="k">end</span><span class="p">;</span>
<span class="ln">25</span>        <span class="nv">Other</span> <span class="o">-&gt;</span>
<span class="ln">26</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;cannot tokenise:</span><span class="si">~p</span><span class="s"> Reason=</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Str</span><span class="p">,</span> <span class="nv">Other</span><span class="p">])</span>
<span class="ln">27</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><h3 id="一个聊天小部件">一个聊天小部件</h3>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">chat1</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">(</span><span class="nv">Browser</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="n">running</span><span class="p">(</span><span class="nv">Browser</span><span class="p">,</span> <span class="p">[]).</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="nf">running</span><span class="p">(</span><span class="nv">Browser</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>    <span class="k">receive</span>
<span class="ln"> 9</span>        <span class="p">{</span><span class="nv">Brwoser</span><span class="p">,</span> <span class="p">#{</span><span class="n">join</span> <span class="o">=&gt;</span> <span class="nv">Who</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">10</span>            <span class="nv">Browser</span> <span class="o">!</span> <span class="p">#{</span><span class="n">cmd</span> <span class="o">=&gt;</span> <span class="n">append_div</span><span class="p">,</span> <span class="n">id</span> <span class="o">=&gt;</span><span class="n">scroll</span><span class="p">,</span> 
<span class="ln">11</span>                        <span class="n">txt</span> <span class="o">=&gt;</span> <span class="nb">list_to_binary</span><span class="p">([</span><span class="nv">Who</span><span class="p">,</span> <span class="s">&#34; joined the group</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">])},</span>
<span class="ln">12</span>            <span class="nv">L1</span> <span class="o">=</span> <span class="p">[</span><span class="nv">Who</span><span class="p">,</span> <span class="s">&#34;&lt;br&gt;&#34;</span><span class="p">|</span><span class="nv">L</span><span class="p">],</span>
<span class="ln">13</span>            <span class="nv">Browser</span> <span class="o">!</span> <span class="p">#{</span><span class="n">cmd</span> <span class="o">=&gt;</span> <span class="n">fill_div</span><span class="p">,</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="n">users</span><span class="p">,</span>
<span class="ln">14</span>                       <span class="n">txt</span> <span class="o">=&gt;</span> <span class="nb">list_to_binary</span><span class="p">(</span><span class="nv">L1</span><span class="p">)},</span>
<span class="ln">15</span>            <span class="n">running</span><span class="p">(</span><span class="nv">Browser</span><span class="p">,</span> <span class="nv">L1</span><span class="p">);</span>
<span class="ln">16</span>        <span class="p">{</span><span class="nv">Browser</span><span class="p">,</span> <span class="p">#{</span><span class="n">entry</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&#34;tell&#34;</span><span class="o">&gt;&gt;</span> <span class="p">,</span><span class="n">txt</span> <span class="o">=&gt;</span> <span class="nv">Txt</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">17</span>            <span class="nv">Browser</span> <span class="o">!</span> <span class="p">#{</span><span class="n">cmd</span> <span class="o">=&gt;</span> <span class="n">append_div</span><span class="p">,</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="n">scroll</span><span class="p">,</span>
<span class="ln">18</span>                       <span class="n">txt</span> <span class="o">=&gt;</span> <span class="nb">list_to_binary</span><span class="p">([</span><span class="s">&#34; &gt; &#34;</span><span class="p">,</span> <span class="nv">Txt</span><span class="p">,</span> <span class="s">&#34;&lt;br&gt;&#34;</span><span class="p">])},</span>
<span class="ln">19</span>            <span class="n">running</span><span class="p">(</span><span class="nv">Browser</span><span class="p">,</span> <span class="nv">L</span><span class="p">);</span>
<span class="ln">20</span>        <span class="nv">X</span> <span class="o">-&gt;</span>
<span class="ln">21</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;chat received:</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">X</span><span class="p">])</span>
<span class="ln">22</span>     <span class="k">end</span><span class="p">,</span>
<span class="ln">23</span>    <span class="n">running</span><span class="p">(</span><span class="nv">Browser</span><span class="p">,</span> <span class="nv">L</span><span class="p">).</span>
</code></pre></div><h3 id="简化版-irc">简化版 IRC</h3>
<p>IRC是Internet Relay Chat（互联网中继聊天）的缩写，它以客户端-服务器的形式进行文本消息传输。</p>
<p>上一节里的聊天小部件可以轻松扩展成一个更真实的聊天程序。</p>
<h3 id="浏览器里的图形">浏览器里的图形</h3>
<h3 id="浏览器-服务器协议">浏览器-服务器协议</h3>
<p>这是这一章所有程序用到的协议。</p>
<h3 id="练习-14">练习</h3>
<p>(1) shell1.erl里启动的进程不够完善。如果它崩溃了，Web应用程序就会锁定并无法运行。给这个应用程序添加错误恢复代码。添加历史命令重放的功能。</p>
<p>(2) 阅读websockets.js里的代码，仔细追踪浏览器里某个活动按钮被点击后发生的事。跟着代码从JavaScript到WebSocket，再从WebSocket到Erlang。点击按钮后生成的消息是如何找到相应的Erlang控制进程的？</p>
<p>(3) 简化版IRC程序是一个功能完备的聊天程序。试着运行它并检查它的功能是否正常。你可能会发现防火墙之类的因素阻止它访问服务器，让它无法正常工作。如果是这样，就进行调查并看看能否开放防火墙。尝试找到真正的IRC协议规范，你会发现它比这里的版本长很多。为什么会这样？用某种用户身份验证系统来扩展这个IRC系统。</p>
<p>(4) IRC程序使用了一台中央服务器。能否修改这个程序，让它用点对点网络取代中央服务器？能否给聊天客户端添加SVG图形，或者用HTML5里的音频接口发送和接收声音数据？</p>
<h2 id="第19章-用ets和dets存储数据">第19章 用ETS和DETS存储数据</h2>
<h3 id="基本概念">基本概念</h3>
<ul>
<li>ETS是Erlang Term Storage（Erlang数据存储）的缩写，DETS则是Disk ETS（磁盘ETS）的缩写。</li>
<li>ETS和DETS执行的任务基本相同：它们提供大型的键值查询表。ETS常驻内存，DETS则常驻磁盘。DETS提供了几乎和ETS一样的接口，但它会把表保存在磁盘上。因为DETS使用磁盘存储，所以它远远慢于ETS，但是运行时的内存占用也会小很多。ETS表里的数据保存在内存里，它们是易失的。当ETS表被丢弃或者控制它的Erlang进程终止时，这些数据就会被删除。保存在DETS表里的数据是非易失的，即使整个系统崩溃也能留存下来。DETS表在打开时会进行一致性检查，如果发现有损坏，系统就会尝试修复它</li>
<li>ETS和DETS表是把键和值关联到一起的数据结构。最常用的表操作是插入和查找。ETS或DETS表其实就是Erlang元组的集合。</li>
<li>一些表被称为异键表（set），它们要求表里所有的键都是唯一的。另一些被称为同键表（bag），它们允许多个元素拥有相同的键。基本的表类型（异键表和同键表）各有两个变种，它们共同构成四种表类型：异键、有序异键（ordered set）、同键和副本同键（duplicate bag）。在异键表里，各个元组里的键都必须是独一无二的。在有序异键表里，元组会被排序。在同键表里可以有不止一个元组拥有相同的键，但是不能有两个完全相同的元组。在副本同键表里可以有多个元组拥有相同的键，而且在同一张表里可以存在多个相同的元组。</li>
</ul>
<h3 id="基本操作">基本操作</h3>
<ul>
<li>创建一个新表或打开现有的表
用<code>ets:new</code>或<code>dets:open_file</code>实现。</li>
<li>向表里插入一个或多个元组
这里要调用<code>insert(TableId, X)</code>，其中X是一个元组或元组列表。insert在ETS和DETS里有着相同的参数和工作方式。</li>
<li>在表里查找某个元组
这里要调用 <code>lookup(TableID, Key)</code>。得到的结果是一个匹配 Key的元组列表。 lookup在ETS和DETS里都有定义。lookup的返回值始终是一个元组列表，这样就能对异键表和同键表使用同一个查找函数。如果表的类型是同键，那么多个元组可以拥有相同的键。如果表的类型是异键，那么查找成功后的列表里只会有一个元素。如果表里没有任何元组拥有所需的键，就会返回一个空列表。</li>
<li>丢弃某个表
用完某个表后可以告知系统，方法是调用<code>dets:close(TableId)</code> 或 <code>ets:delete(TableId)</code>。</li>
</ul>
<p>ets_test.erl</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">ets_test</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="nn">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p">(</span><span class="k">fun</span> <span class="n">test_ets</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span>
<span class="ln"> 6</span>                  <span class="p">[</span><span class="n">set</span><span class="p">,</span> <span class="n">ordered_set</span><span class="p">,</span> <span class="n">bag</span><span class="p">,</span> <span class="n">duplicate_bag</span><span class="p">]).</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="nf">test_ets</span><span class="p">(</span><span class="nv">Mode</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>    <span class="nv">TableId</span> <span class="o">=</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="p">[</span><span class="nv">Mode</span><span class="p">]),</span>
<span class="ln">10</span>    <span class="nn">ets</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="nv">TableId</span><span class="p">,</span> <span class="p">{</span><span class="n">a</span><span class="p">,</span><span class="mi">1</span><span class="p">}),</span>
<span class="ln">11</span>    <span class="nn">ets</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="nv">TableId</span><span class="p">,</span> <span class="p">{</span><span class="n">b</span><span class="p">,</span><span class="mi">2</span><span class="p">}),</span>
<span class="ln">12</span>    <span class="nn">ets</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="nv">TableId</span><span class="p">,</span> <span class="p">{</span><span class="n">a</span><span class="p">,</span><span class="mi">1</span><span class="p">}),</span>
<span class="ln">13</span>    <span class="nn">ets</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="nv">TableId</span><span class="p">,</span> <span class="p">{</span><span class="n">a</span><span class="p">,</span><span class="mi">3</span><span class="p">}),</span>
<span class="ln">14</span>    <span class="nv">List</span> <span class="o">=</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">tab2list</span><span class="p">(</span><span class="nv">TableId</span><span class="p">),</span>
<span class="ln">15</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;~-13w  =&gt; </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Mode</span><span class="p">,</span> <span class="nv">List</span><span class="p">]),</span>
<span class="ln">16</span>    <span class="nn">ets</span><span class="p">:</span><span class="nf">delete</span><span class="p">(</span><span class="nv">TableId</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; ets_test:start().
<span class="ln">2</span>set            =&gt; [{b,2},{a,3}]
<span class="ln">3</span>ordered_set    =&gt; [{a,3},{b,2}]
<span class="ln">4</span>bag			   =&gt; [{b,2},{a,1},{a,3}]
<span class="ln">5</span>duplicate_bag  =&gt; [{b,2},{a,1},{a,1},{a,3}]
</code></pre></div><h3 id="影响-ets-表效率的因素">影响 ETS 表效率的因素</h3>
<p>TODO 待补</p>
<ul>
<li></li>
</ul>
<p>lib_trigrams.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">for_each_trigram_in_the_english_language</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">A0</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Bin0</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="s">&#34;354984si.ngl.gz&#34;</span><span class="p">),</span>
<span class="ln"> 3</span>    <span class="nv">Bin</span> <span class="o">=</span> <span class="nn">zlib</span><span class="p">:</span><span class="nf">gunzip</span><span class="p">(</span><span class="nv">Bin0</span><span class="p">),</span>
<span class="ln"> 4</span>    <span class="n">scan_word_list</span><span class="p">(</span><span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A0</span><span class="p">).</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="nf">scan_word_list</span><span class="p">([],</span> <span class="p">_,</span> <span class="nv">A</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>    <span class="nv">A</span><span class="p">;</span>
<span class="ln"> 8</span><span class="nf">scan_word_list</span><span class="p">(</span><span class="nv">L</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>    <span class="p">{</span><span class="nv">Word</span><span class="p">,</span> <span class="nv">L1</span><span class="p">}</span> <span class="o">=</span> <span class="n">get_next_word</span><span class="p">(</span><span class="nv">L</span><span class="p">,</span> <span class="p">[]),</span>
<span class="ln">10</span>    <span class="nv">A1</span> <span class="o">=</span> <span class="n">scan_trigrams</span><span class="p">([</span><span class="sc">$\s</span><span class="p">|</span><span class="nv">Word</span><span class="p">],</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">).</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="c">%% 扫描单词，寻找\r\n。
</span><span class="ln">13</span><span class="c">%% 第二个参数是（反转的）单词，
</span><span class="ln">14</span><span class="c">%% 所以必须在找到\r\n或扫描完字符时把它反转回来
</span><span class="ln">15</span><span class="c">%% 于是这个函数，第一个参数是一个字符串（每一行一个单词），第二个参数是结果，目的是将字符串反转（abc -&gt;cba）
</span><span class="ln">16</span><span class="c"></span>
<span class="ln">17</span><span class="nf">get_next_word</span><span class="p">([</span><span class="sc">$\r</span><span class="p">,</span><span class="sc">$\n</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">reverse</span><span class="p">([</span><span class="sc">$\s</span><span class="p">|</span><span class="nv">L</span><span class="p">]),</span> <span class="nv">T</span><span class="p">};</span>
<span class="ln">18</span><span class="nf">get_next_word</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">get_next_word</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="nv">L</span><span class="p">]);</span>
<span class="ln">19</span><span class="nf">get_next_word</span><span class="p">([],</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">reverse</span><span class="p">([</span><span class="sc">$\s</span><span class="p">|</span><span class="nv">L</span><span class="p">]),</span> <span class="p">[]}.</span>
<span class="ln">20</span>
<span class="ln">21</span><span class="nf">scan_trigrams</span><span class="p">([</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">,</span> <span class="nv">Z</span><span class="p">],</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">22</span>    <span class="nv">F</span><span class="p">([</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">,</span> <span class="nv">Z</span><span class="p">],</span> <span class="nv">A</span><span class="p">);</span>
<span class="ln">23</span><span class="nf">scan_trigrams</span><span class="p">([</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">,</span> <span class="nv">Z</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">24</span>    <span class="nv">A1</span> <span class="o">=</span> <span class="nv">F</span><span class="p">([</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">,</span><span class="nv">Z</span><span class="p">],</span> <span class="nv">A</span><span class="p">),</span>
<span class="ln">25</span>    <span class="n">scan_trigrams</span><span class="p">([</span><span class="nv">Y</span><span class="p">,</span><span class="nv">Z</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">A1</span><span class="p">);</span>
<span class="ln">26</span><span class="nf">scan_trigrams</span><span class="p">(_,</span> <span class="p">_,</span> <span class="nv">A</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">27</span>    <span class="nv">A</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="c">%% 封装异键，有序异键的创建和持久化的名称
</span><span class="ln"> 2</span><span class="c"></span><span class="nf">make_ets_ordered_set</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">make_a_set</span><span class="p">(</span><span class="n">ordered_set</span><span class="p">,</span> <span class="s">&#34;trigramsOS.tab&#34;</span><span class="p">).</span>
<span class="ln"> 3</span><span class="nf">make_ets_set</span><span class="p">()</span>         <span class="o">-&gt;</span> <span class="n">make_a_set</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="s">&#34;trigramsS.tab&#34;</span><span class="p">).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="nf">make_a_set</span><span class="p">(</span><span class="nv">TYpe</span><span class="p">,</span> <span class="nv">FileName</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="c">%% 建表
</span><span class="ln"> 7</span><span class="c"></span>    <span class="nv">Tab</span> <span class="o">=</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="p">[</span><span class="nv">Type</span><span class="p">]),</span>
<span class="ln"> 8</span>    <span class="c">%% 插入二进制型到表
</span><span class="ln"> 9</span><span class="c"></span>    <span class="nv">F</span> <span class="o">=</span> <span class="k">fun</span><span class="p">(</span><span class="nv">Str</span><span class="p">,</span> <span class="p">_)</span> <span class="o">-&gt;</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="p">{</span><span class="nb">list_to_binary</span><span class="p">(</span><span class="nv">Str</span><span class="p">)})</span> <span class="k">end</span><span class="p">,</span>
<span class="ln">10</span>    <span class="n">for_each_trigram_in_the_english_language</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="ln">11</span>    <span class="c">%% 持久化到文件
</span><span class="ln">12</span><span class="c"></span>    <span class="nn">ets</span><span class="p">:</span><span class="nf">tab2file</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="nv">FileName</span><span class="p">),</span>
<span class="ln">13</span>    <span class="nv">Size</span> <span class="o">=</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">info</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="nb">size</span><span class="p">),</span>
<span class="ln">14</span>    <span class="nn">ets</span><span class="p">:</span><span class="nf">delete</span><span class="p">(</span><span class="nv">Tab</span><span class="p">),</span>
<span class="ln">15</span>    <span class="nv">Size</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="c">%% 使用Erlang:sets创建一个包含所有三字母组合的异键表
</span><span class="ln">2</span><span class="c"></span><span class="nf">make_mod_set</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">3</span>    <span class="nv">D</span> <span class="o">=</span> <span class="nn">sets</span><span class="p">:</span><span class="nf">new</span><span class="p">(),</span>
<span class="ln">4</span>    <span class="nv">F</span> <span class="o">=</span> <span class="k">fun</span><span class="p">(</span><span class="nv">Str</span><span class="p">,</span> <span class="nv">Set</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">sets</span><span class="p">:</span><span class="nf">add_element</span><span class="p">(</span><span class="nb">list_to_binary</span><span class="p">(</span><span class="nv">Str</span><span class="p">),</span> <span class="nv">Set</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
<span class="ln">5</span>    <span class="nv">D1</span> <span class="o">=</span> <span class="n">for_each_trigram_in_the_english_language</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span><span class="nv">D</span><span class="p">),</span>
<span class="ln">6</span>    <span class="nn">file</span><span class="p">:</span><span class="nf">write_file</span><span class="p">(</span><span class="s">&#34;trigrams.set&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nb">term_to_binary</span><span class="p">(</span><span class="nv">D1</span><span class="p">)]).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">timer_tests</span><span class="p">()</span> <span class="o">-&gt;</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="c">%% 封装字符串，在左右两边加个空格
</span><span class="ln"> 2</span><span class="c"></span><span class="nf">is_word</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="nv">Str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">is_word1</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\s</span><span class="s">&#34;</span> <span class="o">++</span> <span class="nv">Str</span> <span class="o">++</span> <span class="s">&#34;</span><span class="se">\s</span><span class="s">&#34;</span><span class="p">).</span>
<span class="ln"> 3</span><span class="c">%% 只有3个字母
</span><span class="ln"> 4</span><span class="c"></span><span class="nf">is_word1</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="p">[_,_,_]</span><span class="o">=</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">is_this_a_trigram</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="nv">X</span><span class="p">);</span>
<span class="ln"> 5</span><span class="c">%% 4个及更多的字母
</span><span class="ln"> 6</span><span class="c"></span><span class="nf">is_word1</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="p">[</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">C</span><span class="p">|</span><span class="nv">D</span><span class="p">])</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>    <span class="k">case</span> <span class="n">is_this_a_trigram</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="p">[</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">C</span><span class="p">])</span> <span class="k">of</span>
<span class="ln"> 8</span>        <span class="n">true</span> <span class="o">-&gt;</span> <span class="n">is_word1</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="p">[</span><span class="nv">B</span><span class="p">,</span><span class="nv">C</span><span class="p">|</span><span class="nv">D</span><span class="p">]);</span>
<span class="ln"> 9</span>        <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">false</span>
<span class="ln">10</span>    <span class="k">end</span><span class="p">;</span>
<span class="ln">11</span><span class="c">%% 匹配到这直接错误
</span><span class="ln">12</span><span class="c"></span><span class="nf">is_word1</span><span class="p">(_,</span> <span class="p">_)</span> <span class="o">-&gt;</span>
<span class="ln">13</span>    <span class="n">false</span><span class="p">.</span>
<span class="ln">14</span>
<span class="ln">15</span><span class="c">%% 封装查询
</span><span class="ln">16</span><span class="c"></span><span class="nf">is_this_a_trigram</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">17</span>    <span class="k">case</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="nb">list_to_binary</span><span class="p">(</span><span class="nv">X</span><span class="p">))</span> <span class="k">of</span>
<span class="ln">18</span>        <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">false</span><span class="p">;</span>
<span class="ln">19</span>        <span class="p">_</span>  <span class="o">-&gt;</span> <span class="n">true</span>
<span class="ln">20</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">21</span>
<span class="ln">22</span><span class="c">%% 封装打开之前生成的字典ets
</span><span class="ln">23</span><span class="c"></span><span class="nf">open</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">24</span>    <span class="nv">File</span> <span class="o">=</span> <span class="nn">filename</span><span class="p">:</span><span class="nf">join</span><span class="p">(</span><span class="nn">filename</span><span class="p">:</span><span class="nf">dirname</span><span class="p">(</span><span class="nn">code</span><span class="p">:</span><span class="nf">which</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">)),</span>
<span class="ln">25</span>                         <span class="s">&#34;/trigramsS.tab&#34;</span><span class="p">),</span>
<span class="ln">26</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">}</span> <span class="o">=</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">file2tab</span><span class="p">(</span><span class="nv">File</span><span class="p">),</span>
<span class="ln">27</span>    <span class="nv">Tab</span><span class="p">.</span>
<span class="ln">28</span><span class="nf">close</span><span class="p">(</span><span class="nv">Tab</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">delete</span><span class="p">(</span><span class="nv">Tab</span><span class="p">).</span>
</code></pre></div><p>lib_filenames_dets.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">lib_filenames_dets</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">open</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">close</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">test</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename2index</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">index2filename</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">open</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;dets opened:</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">File</span><span class="p">]),</span>
<span class="ln"> 6</span>    <span class="c">%% 检查文件名的文件是否存在
</span><span class="ln"> 7</span><span class="c"></span>    <span class="nv">Bool</span> <span class="o">=</span> <span class="nn">filelib</span><span class="p">:</span><span class="nf">is_file</span><span class="p">(</span><span class="nv">File</span><span class="p">),</span>
<span class="ln"> 8</span>    <span class="k">case</span> <span class="nn">dets</span><span class="p">:</span><span class="nf">open_file</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">[{</span><span class="n">file</span><span class="p">,</span> <span class="nv">File</span><span class="p">}])</span> <span class="k">of</span>
<span class="ln"> 9</span>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">10</span>            <span class="k">case</span> <span class="nv">Bool</span> <span class="k">of</span>
<span class="ln">11</span>                <span class="c">%% 打开一个现有文件
</span><span class="ln">12</span><span class="c"></span>                <span class="n">true</span> <span class="o">-&gt;</span> <span class="n">void</span><span class="p">;</span>
<span class="ln">13</span>                <span class="c">%% 新建文件，初始化dets表，1代表目前1的索引为空白的
</span><span class="ln">14</span><span class="c"></span>                <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">ok</span> <span class="o">=</span> <span class="nn">dets</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">{</span><span class="n">free</span><span class="p">,</span><span class="mi">1</span><span class="p">})</span>
<span class="ln">15</span>            <span class="k">end</span><span class="p">,</span>
<span class="ln">16</span>            <span class="n">true</span><span class="p">;</span>
<span class="ln">17</span>        <span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="nv">Reason</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">18</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;cannot open dets table</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">),</span>
<span class="ln">19</span>            <span class="nb">exit</span><span class="p">({</span><span class="n">eDetOpen</span><span class="p">,</span> <span class="nv">FIle</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">})</span>
<span class="ln">20</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">21</span>
<span class="ln">22</span><span class="nf">close</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">dets</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">).</span>
<span class="ln">23</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">filename2index</span><span class="p">(</span><span class="nv">FileName</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_binary</span><span class="p">(</span><span class="nv">FileName</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="k">case</span> <span class="nn">dets</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="nv">FileName</span><span class="p">)</span> <span class="k">of</span>
<span class="ln"> 3</span>        <span class="p">[]</span> <span class="o">-&gt;</span>
<span class="ln"> 4</span>            <span class="c">%% 查询空白索引
</span><span class="ln"> 5</span><span class="c"></span>            <span class="p">[{_,</span><span class="nv">Free</span><span class="p">}]</span> <span class="o">=</span> <span class="nn">dets</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">free</span><span class="p">),</span>
<span class="ln"> 6</span>            <span class="c">%% 插入数据，同时更新空白索引为下一个位置
</span><span class="ln"> 7</span><span class="c"></span>            <span class="n">ok</span> <span class="o">=</span> <span class="nn">dets</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> 
<span class="ln"> 8</span>                             <span class="p">[{</span><span class="nv">Free</span><span class="p">,</span><span class="nv">FileName</span><span class="p">},{</span><span class="nv">FileName</span><span class="p">,</span><span class="nv">Free</span><span class="p">},{</span><span class="n">free</span><span class="p">,</span><span class="nv">Free</span><span class="o">+</span><span class="mi">1</span><span class="p">}]),</span>
<span class="ln"> 9</span>            <span class="nv">Free</span><span class="p">;</span>
<span class="ln">10</span>        <span class="p">[{_,</span><span class="nv">N</span><span class="p">}]</span> <span class="o">-&gt;</span>
<span class="ln">11</span>            <span class="nv">N</span>
<span class="ln">12</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="c">%% 根据索引查询文件名
</span><span class="ln">2</span><span class="c"></span><span class="nf">index2filename</span><span class="p">(</span><span class="nv">Index</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">Index</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">3</span>    <span class="k">case</span> <span class="nn">dets</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="nv">Index</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">4</span>        <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">error</span><span class="p">;</span>
<span class="ln">5</span>        <span class="p">[{_,</span> <span class="nv">Bin</span><span class="p">}]</span> <span class="o">-&gt;</span> <span class="nv">Bin</span>
<span class="ln">6</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><h3 id="练习-15">练习</h3>
<p>(1) Mod:module_info(exports)会返回Mod模块里所有导出函数的列表。用这个函数找出Erlang系统库里导出的所有函数。制作一个键值查询表，其中键是一个{Function,Arity}对，值是一个模块名。把这些数据储存在ETS和DETS表里。</p>
<blockquote>
<p>提示 使用code:lib_dir()和code:lib_dir(LibName)来找出系统里所有模块的名称。</p>
</blockquote>
<p>(2) 制作一个共享的ETS计数表。实现一个名为count:me(Mod,Line)的函数，通过在你的代码里添加count:me(?MODULE, ?LINE)来调用它。每当这个函数被调用时，就给记录自身执行次数的计数器加1。编写一些函数来初始化和读取计数器。</p>
<p>(3) 编写一个检测文本抄袭的程序。用一个双遍历（two-pass）算法来实现它。第一次遍历时，把文本打散成40个字符的小块并计算各个块的校验和，然后把校验和与文件名保存在一个ETS表里。第二次遍历时，计算数据里各个40字符块的校验和，并把它们与ETS表里的校验和进行比较。</p>
<blockquote>
<p>提示 要做到这一点，需要计算“滚动校验和” 。举个例子，假如C1 = B1 + B2 + &hellip; B40并且C2 = B2 + B3 + &hellip; B41，你就可以快速计算出C2，因为通过观察能发现C2 = C1 +B41 - B1。</p>
</blockquote>
<h2 id="第20章-mnesiaerlang数据库">第20章 Mnesia：Erlang数据库</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl
<span class="ln">2</span>&gt; mnesia:create_schema([node()]).
<span class="ln">3</span>ok
<span class="ln">4</span>&gt; init:stop().
<span class="ln">5</span>ok
<span class="ln">6</span>ls
<span class="ln">7</span>Mnesia.nonode@nohost
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl -name joe
<span class="ln">2</span>(joe@doris.myerl.example.com) 1&gt; mnesia:create_schema([node()]).
<span class="ln">3</span>ok
<span class="ln">4</span>(joe@doris.myerl.example.com) 2&gt; init:stop().
<span class="ln">5</span>ok
<span class="ln">6</span>ls
<span class="ln">7</span>Mnesia.joe@doris.myerl.example.com
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl -mnesia dir &#39;&#34;/home/joe/some/path/to.Mnesia.company&#34;&#39;
<span class="ln">2</span>1&gt; mnesia:create_schema([node()]).
<span class="ln">3</span>ok
<span class="ln">4</span>2&gt; init:stop().
<span class="ln">5</span>ok
</code></pre></div><p>test_mnesia.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">shop</span><span class="p">,</span> <span class="p">{</span><span class="n">item</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">cost</span><span class="p">}).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">cost</span><span class="p">,</span> <span class="p">{</span><span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="p">}).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">do_this_once</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="nn">mnesia</span><span class="p">:</span><span class="nf">create_schema</span><span class="p">([</span><span class="nb">node</span><span class="p">()]),</span>
<span class="ln"> 6</span>    <span class="nn">mnesia</span><span class="p">:</span><span class="nf">start</span><span class="p">(),</span>
<span class="ln"> 7</span>    <span class="nn">mnesia</span><span class="p">:</span><span class="nf">create_table</span><span class="p">(</span><span class="n">shop</span><span class="p">,</span> <span class="p">[{</span><span class="n">attributes</span><span class="p">,</span> <span class="n">record_info</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">shop</span><span class="p">)}]),</span>
<span class="ln"> 8</span>    <span class="nn">mnesia</span><span class="p">:</span><span class="nf">create_table</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="p">[{</span><span class="n">attributes</span><span class="p">,</span> <span class="n">record_info</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">cost</span><span class="p">)}]),</span>
<span class="ln"> 9</span>    <span class="nn">mnesia</span><span class="p">:</span><span class="nf">create_table</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="p">[{</span><span class="n">attributes</span><span class="p">,</span> <span class="n">record_info</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">design</span><span class="p">)}]),</span>
<span class="ln">10</span>    <span class="nn">mnesia</span><span class="p">:</span><span class="nf">stop</span><span class="p">().</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="c">%% SQL
</span><span class="ln">2</span><span class="c">%% SELECT * FROM shop;
</span><span class="ln">3</span><span class="c"></span>
<span class="ln">4</span><span class="nf">demo</span><span class="p">(</span><span class="n">select_shop</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">5</span>    <span class="n">do</span><span class="p">(</span><span class="nn">qlc</span><span class="p">:</span><span class="nf">q</span><span class="p">([</span><span class="nv">X</span> <span class="p">||</span> <span class="nv">X</span> <span class="o">&lt;-</span> <span class="nn">mnesia</span><span class="p">:</span><span class="nf">table</span><span class="p">(</span><span class="n">shop</span><span class="p">)]));</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>1&gt; test_mnesia:start().
<span class="ln"> 2</span>ok
<span class="ln"> 3</span>2&gt; test_mnesia:reset_tables().
<span class="ln"> 4</span>{atomic, ok}
<span class="ln"> 5</span>3&gt; test_mnesia:demo(select_shop).
<span class="ln"> 6</span>[{shop,potato,2456,1.2},
<span class="ln"> 7</span>{shop,orange,100,3.8},
<span class="ln"> 8</span>{shop,apple,20,2.3},
<span class="ln"> 9</span>{shop,pear,200,3.6},
<span class="ln">10</span>{shop,banana,420,4.5}]
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="c">%% SQL
</span><span class="ln">2</span><span class="c">%% SELECT item, quantity FROM shop;
</span><span class="ln">3</span><span class="c"></span>
<span class="ln">4</span><span class="nf">demo</span><span class="p">(</span><span class="n">select_some</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">5</span>    <span class="n">do</span><span class="p">(</span><span class="nn">qlc</span><span class="p">:</span><span class="nf">q</span><span class="p">([{</span><span class="nv">X</span><span class="nl">#shop.item</span><span class="p">,</span> <span class="nv">X</span><span class="nl">#shop.quantity</span><span class="p">}</span> <span class="p">||</span> <span class="nv">X</span> <span class="o">&lt;-</span> <span class="nn">mnesia</span><span class="p">:</span><span class="nf">table</span><span class="p">(</span><span class="n">shop</span><span class="p">)]));</span>
<span class="ln">6</span><span class="c">%% [{orange,100},{pear,200},{banana,420},{potato,2456},{apple,20}]
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="c">%% SQL
</span><span class="ln">2</span><span class="c">%% SELECT shop.item FROM shop
</span><span class="ln">3</span><span class="c">%% WHERE shop.quantity &lt; 250;
</span><span class="ln">4</span><span class="c"></span>
<span class="ln">5</span><span class="nf">demo</span><span class="p">(</span><span class="n">reorder</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">6</span>    <span class="n">do</span><span class="p">(</span><span class="nn">qlc</span><span class="p">:</span><span class="nf">q</span><span class="p">([</span><span class="nv">X</span><span class="nl">#shop.item</span> <span class="p">||</span> <span class="nv">X</span> <span class="o">&lt;-</span> <span class="nn">mnesia</span><span class="p">:</span><span class="nf">table</span><span class="p">(</span><span class="n">shop</span><span class="p">),</span> 
<span class="ln">7</span>              <span class="nv">X</span><span class="nl">#shop.quantity</span> <span class="o">&lt;</span> <span class="mi">250</span>
<span class="ln">8</span>             <span class="p">]));</span>
<span class="ln">9</span><span class="c">%% [orange, pear, apple]
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="c">%% SQL
</span><span class="ln"> 2</span><span class="c">%% SELECT shop.item FROM shop, cost
</span><span class="ln"> 3</span><span class="c">%% WHERE shop.item = cost.name
</span><span class="ln"> 4</span><span class="c">%% 	 AND cost.price &lt; 2 AND shop.quantity &lt; 250
</span><span class="ln"> 5</span><span class="c"></span>
<span class="ln"> 6</span><span class="nf">demo</span><span class="p">(</span><span class="n">join</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>    <span class="n">do</span><span class="p">(</span><span class="nn">qlc</span><span class="p">:</span><span class="nf">q</span><span class="p">([</span><span class="nv">X</span><span class="nl">#shop.item</span> <span class="p">||</span> <span class="nv">X</span> <span class="o">&lt;-</span> <span class="nn">mnesia</span><span class="p">:</span><span class="nf">table</span><span class="p">(</span><span class="n">shop</span><span class="p">),</span>
<span class="ln"> 8</span>              				 <span class="nv">X</span><span class="nl">#shop.quantity</span> <span class="o">&lt;</span> <span class="mi">250</span><span class="p">,</span>
<span class="ln"> 9</span>              				 <span class="nv">Y</span> <span class="o">&lt;-</span> <span class="nn">mnesia</span><span class="p">:</span><span class="nf">table</span><span class="p">(</span><span class="n">cost</span><span class="p">),</span>
<span class="ln">10</span>             				 <span class="nv">X</span><span class="nl">#shop.item</span> <span class="o">=:=</span> <span class="nv">Y</span><span class="nl">#cost.name</span><span class="p">,</span>
<span class="ln">11</span>             				 <span class="nv">Y</span><span class="nl">#cost.price</span> <span class="o">&lt;</span> <span class="mi">2</span>
<span class="ln">12</span>             <span class="p">])).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">add_shop_item</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Quantity</span><span class="p">,</span> <span class="nv">Cost</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="nv">Row</span> <span class="o">=</span> <span class="nl">#shop</span><span class="p">{</span><span class="n">item</span><span class="o">=</span><span class="nv">Name</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="nv">Quantity</span><span class="p">,</span> <span class="n">cost</span><span class="o">=</span><span class="nv">Cost</span><span class="p">},</span>
<span class="ln">3</span>    <span class="nv">F</span> <span class="o">=</span> <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">4</span>            <span class="nn">mnesia</span><span class="p">:</span><span class="nf">write</span><span class="p">(</span><span class="nv">Row</span><span class="p">)</span>
<span class="ln">5</span>        <span class="k">end</span><span class="p">,</span>
<span class="ln">6</span>    <span class="nn">mnesia</span><span class="p">:</span><span class="nf">transaction</span><span class="p">(</span><span class="nv">F</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>&gt; test_mnesia:start().
<span class="ln">2</span>ok
<span class="ln">3</span>&gt; test_mnesia:reset_tables().
<span class="ln">4</span>{atomic, ok}
<span class="ln">5</span>&gt; test_mnesia:demo(select_shop).
<span class="ln">6</span>&gt; test_mnesia:add_shop_item(orange, 236, 2.8).
<span class="ln">7</span>&gt; test_mnesia:demo(select_shop).
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">remove_shop_item</span><span class="p">(</span><span class="nv">Item</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="nv">Oid</span> <span class="o">=</span> <span class="p">{</span><span class="n">shop</span><span class="p">,</span> <span class="nv">Item</span><span class="p">},</span>
<span class="ln">3</span>    <span class="nv">F</span> <span class="o">=</span> <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">4</span>            <span class="nn">mnesia</span><span class="p">:</span><span class="nf">delete</span><span class="p">(</span><span class="nv">Oid</span><span class="p">)</span>
<span class="ln">5</span>        <span class="k">end</span><span class="p">,</span>
<span class="ln">6</span>    <span class="nn">mnesia</span><span class="p">:</span><span class="nf">transaction</span><span class="p">(</span><span class="nv">F</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>test_mnesia:remove_shop_item(pear).
<span class="ln">2</span>test_mnesia:demo(select_shop).
<span class="ln">3</span>mnesia:stop().
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">do</span><span class="p">(</span><span class="nv">Q</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="nv">F</span> <span class="o">=</span> <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">qlc</span><span class="p">:</span><span class="nf">e</span><span class="p">(</span><span class="nv">Q</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
<span class="ln">3</span>    <span class="p">{</span><span class="n">atomic</span><span class="p">,</span> <span class="nv">Val</span><span class="p">}</span> <span class="o">=</span> <span class="nn">mnesia</span><span class="p">:</span><span class="nf">transaction</span><span class="p">(</span><span class="nv">F</span><span class="p">),</span>
<span class="ln">4</span>    <span class="nv">Val</span><span class="p">.</span>
</code></pre></div><p>test_mnesia.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">design</span><span class="p">,</span> <span class="p">{</span><span class="n">id</span><span class="p">,</span> <span class="n">plan</span><span class="p">}).</span>
<span class="ln"> 2</span>
<span class="ln"> 3</span><span class="nf">add_plans</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 4</span>    <span class="nv">D1</span> <span class="o">=</span> <span class="nl">#design</span><span class="p">{</span><span class="n">id</span> <span class="o">=</span> <span class="p">{</span><span class="n">joe</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span>
<span class="ln"> 5</span>                 <span class="n">plan</span> <span class="o">=</span> <span class="p">{</span><span class="n">circle</span><span class="p">,</span><span class="mi">10</span><span class="p">}},</span>
<span class="ln"> 6</span>    <span class="nv">D2</span> <span class="o">=</span> <span class="nl">#design</span><span class="p">{</span><span class="n">id</span> <span class="o">=</span> <span class="n">fred</span><span class="p">,</span>
<span class="ln"> 7</span>                 <span class="n">plan</span> <span class="o">=</span> <span class="p">{</span><span class="n">rectangle</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">}},</span>
<span class="ln"> 8</span>    <span class="nv">D3</span> <span class="o">=</span> <span class="nl">#design</span><span class="p">{</span><span class="n">id</span> <span class="o">=</span> <span class="p">{</span><span class="n">jane</span><span class="p">,{</span><span class="n">house</span><span class="p">,</span><span class="mi">23</span><span class="p">}},</span>
<span class="ln"> 9</span>                 <span class="n">plan</span> <span class="o">=</span> <span class="p">{</span><span class="n">house</span><span class="p">,</span>
<span class="ln">10</span>                         <span class="p">[{</span><span class="n">floor</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
<span class="ln">11</span>                           <span class="p">[{</span><span class="n">doors</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span>
<span class="ln">12</span>                            <span class="p">{</span><span class="n">windows</span><span class="p">,</span><span class="mi">12</span><span class="p">},</span>
<span class="ln">13</span>                            <span class="p">{</span><span class="n">rooms</span><span class="p">,</span><span class="mi">5</span><span class="p">}]},</span>
<span class="ln">14</span>                          <span class="p">{</span><span class="n">floor</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span>
<span class="ln">15</span>                           <span class="p">[{</span><span class="n">doors</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span>
<span class="ln">16</span>                            <span class="p">{</span><span class="n">rooms</span><span class="p">,</span><span class="mi">4</span><span class="p">},</span>
<span class="ln">17</span>                            <span class="p">{</span><span class="n">windows</span><span class="p">,</span><span class="mi">15</span><span class="p">}]}]}},</span>
<span class="ln">18</span>    <span class="nv">F</span> <span class="o">=</span> <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">19</span>            <span class="nn">mnesia</span><span class="p">:</span><span class="nf">write</span><span class="p">(</span><span class="nv">D1</span><span class="p">),</span>
<span class="ln">20</span>            <span class="nn">mnesia</span><span class="p">:</span><span class="nf">write</span><span class="p">(</span><span class="nv">D2</span><span class="p">),</span>
<span class="ln">21</span>            <span class="nn">mnesia</span><span class="p">:</span><span class="nf">write</span><span class="p">(</span><span class="nv">D3</span><span class="p">)</span>
<span class="ln">22</span>        <span class="k">end</span><span class="p">,</span>
<span class="ln">23</span>    <span class="nn">mnesia</span><span class="p">:</span><span class="nf">transaction</span><span class="p">(</span><span class="nv">F</span><span class="p">).</span>
<span class="ln">24</span>
<span class="ln">25</span><span class="nf">get_plan</span><span class="p">(</span><span class="nv">PlanId</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">26</span>    <span class="nv">F</span> <span class="o">=</span> <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">mnesia</span><span class="p">:</span><span class="nf">read</span><span class="p">({</span><span class="n">design</span><span class="p">,</span> <span class="nv">PlanId</span><span class="p">})</span> <span class="k">end</span><span class="p">,</span>
<span class="ln">27</span>    <span class="nn">mnesia</span><span class="p">:</span><span class="nf">transaction</span><span class="p">(</span><span class="nv">F</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>test_mnesia:start().
<span class="ln">2</span>test_mnesia:add_plans().
<span class="ln">3</span>test_mnesia:get_plan(fred).
<span class="ln">4</span>test_mnesia:get_plan({jane,{house,23}}).
</code></pre></div><h3 id="练习-16">练习</h3>
<p>(1) 假设你要制作一个网站，让用户可以提供优秀Erlang程序的消息。制作一个包含三个表（users、tips和abuse）的Mnesia数据库来保存网站需要的所有数据。users表应当保存用户账户数据（姓名、邮箱地址和密码等）。tips表应当保存关于实用网站的消息（比如网站URL、描述和检查日期等）。abuse表应当保存某些数据来尽量防止网站滥用（比如网站访客的IP地址和网站访问次数等数据）。
配置这个数据库，让它运行在一台机器上并各有一个内存和磁盘副本。编写一些函数来读取、写入和列出这些表。</p>
<p>(2) 继续上一个练习，但要把数据库配置成在两台机器上各有内存和磁盘副本。尝试在一台机器上生成更新并让它崩溃，然后检查是否能接着访问第二台机器上的数据库。</p>
<p>(3) 编写一个查询来拒绝某个消息，条件是用户在一天内提交了超过10条消息，或者最近一天从三个以上的IP地址登录。
测量查询数据库所需的时间。</p>
<h2 id="第21章-性能分析调试与跟踪">第21章 性能分析、调试与跟踪</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; cprof:start(). %% 启动性能分析器
<span class="ln">2</span>4501
<span class="ln">3</span>2&gt; shout:start(). %% 运行应用程序
<span class="ln">4</span>&lt;0.35.0&gt;
<span class="ln">5</span>3&gt; cprof:pause(). %% 暂停性能分析器
<span class="ln">6</span>4844 
<span class="ln">7</span>4&gt; cprof:analyse(shout). %% 分析函数调用
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>1&gt; cover:start(). %% 启动覆盖分析器
<span class="ln"> 2</span>{ok,&lt;0.34.0&gt;}
<span class="ln"> 3</span>2&gt;cover:compile(shout). %% 编译shout.erl来进行覆盖分析
<span class="ln"> 4</span>{ok,shout}
<span class="ln"> 5</span>3&gt;shout:start(). %% 运行程序
<span class="ln"> 6</span>&lt;0.41.0&gt;
<span class="ln"> 7</span>Playing:&lt;&lt;&#34;title: track018&#34;...
<span class="ln"> 8</span>4&gt; %% 让程序运行一段时间
<span class="ln"> 9</span>4&gt; cover:analyse_to_file(shout). %% 分析结果
<span class="ln">10</span>{ok, &#34;shout,COVER.out&#34;} %% 结果文件
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>cd /home/joe/2007/vsg-1.6
<span class="ln">2</span>rm *.beam
<span class="ln">3</span>erlc +debug_info *.erl
<span class="ln">4</span>erl
<span class="ln">5</span>1&gt; xref:d(&#39;.&#39;).
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="n">a</span><span class="p">;</span>
<span class="ln">3</span><span class="nf">foo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">4</span>    <span class="n">b</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; c(bad).
<span class="ln">2</span>./bad.erl:3: head mismatch
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">foo</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="n">bar</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span> <span class="n">dothis</span><span class="p">(</span><span class="nv">X</span><span class="p">),</span> <span class="nv">B</span><span class="p">),</span>
<span class="ln">3</span>    <span class="n">baz</span><span class="p">(</span><span class="nv">Y</span><span class="p">,</span><span class="nv">X</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; c(bad).
<span class="ln">2</span>./bad.erl:2: variable &#39;X&#39; is unbound
<span class="ln">3</span>./bad.erl:3: variable &#39;Y&#39; is unbound
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>unterminated string starting with &#34;...&#34;
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">foo</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="k">case</span> <span class="n">bar</span><span class="p">()</span> <span class="k">of</span>
<span class="ln">3</span>        <span class="mi">1</span> <span class="o">-&gt;</span>
<span class="ln">4</span>            <span class="nv">X</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="ln">5</span>            <span class="nv">Y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="ln">6</span>        <span class="mi">2</span> <span class="o">-&gt;</span>
<span class="ln">7</span>            <span class="nv">X</span> <span class="o">=</span> <span class="mi">3</span>
<span class="ln">8</span>    <span class="k">end</span><span class="p">,</span>
<span class="ln">9</span>    <span class="n">b</span><span class="p">(</span><span class="nv">X</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; c(bad).
<span class="ln">2</span>./bad.erl:5: Warning: variable &#39;Y&#39; is unused
<span class="ln">3</span>{ok, bad}
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">foo</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="k">case</span> <span class="n">bar</span><span class="p">()</span> <span class="k">of</span>
<span class="ln">3</span>        <span class="mi">1</span> <span class="o">-&gt;</span>
<span class="ln">4</span>            <span class="nv">X</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="ln">5</span>            <span class="nv">Y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="ln">6</span>        <span class="mi">2</span> <span class="o">-&gt;</span>
<span class="ln">7</span>            <span class="nv">X</span> <span class="o">=</span> <span class="mi">3</span>
<span class="ln">8</span>    <span class="k">end</span><span class="p">,</span>
<span class="ln">9</span>    <span class="n">b</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; c(bad).
<span class="ln">2</span>./bad.erl:9: variable &#39;Y&#39; unsafe in &#39;case&#39;
<span class="ln">3</span>{ok, bad}
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">foo</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="nn">lists</span><span class="p">:</span><span class="nf">map</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="nv">X</span> <span class="k">end</span><span class="p">,</span> <span class="nv">L</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; c(bad).
<span class="ln">2</span>./bad.erl:1: Warning: variable &#39;X&#39; is unused
<span class="ln">3</span>./bad.erl:2: Warning: variable &#39;X&#39; shadowed in &#39;fun&#39;
<span class="ln">4</span>{ok, bad}
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>foo(Z, L) -&gt;
<span class="ln">2</span>    lists:map(fun(X) -&gt; 2*X end, L).
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">deliberate_error</span><span class="p">(</span><span class="nv">A</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="n">bad_function</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
<span class="ln">3</span>    <span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">A</span><span class="p">).</span>
<span class="ln">4</span>
<span class="ln">5</span><span class="nf">bad_function</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span> <span class="p">_)</span> <span class="o">-&gt;</span>
<span class="ln">6</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">open</span><span class="p">({</span><span class="n">abc</span><span class="p">,</span><span class="mi">123</span><span class="p">},</span> <span class="nv">A</span><span class="p">),</span>
<span class="ln">7</span>    <span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Bin</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; lib_misc:deliberate_error(&#34;file.erl&#34;).
<span class="ln">2</span>** exception error: no match of right hand side value {error,badarg}
<span class="ln">3</span>in function lib_misc:bad_function/2 (lib_misc.erl, line 804)
<span class="ln">4</span>in call from lib_misc:deliberate_error/1 (lib_misc.erl, line 800)
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">loop</span><span class="p">(...)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="k">receive</span>
<span class="ln">3</span>        <span class="nv">Any</span> <span class="o">-&gt;</span>
<span class="ln">4</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;*** warning unexpected message:</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Any</span><span class="p">])</span>
<span class="ln">5</span>            <span class="n">loop</span><span class="p">(...)</span>
<span class="ln">6</span>	<span class="k">end</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">NYI</span><span class="p">(</span><span class="nv">X</span><span class="p">),(</span><span class="k">begin</span>
<span class="ln">2</span>                    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;*** NYI </span><span class="si">~p</span><span class="s"> </span><span class="si">~p</span><span class="s"> </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,[</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="o">&gt;</span><span class="nv">LINE</span><span class="p">,</span> <span class="nv">X</span><span class="p">]),</span>
<span class="ln">3</span>               		<span class="nb">exit</span><span class="p">(</span><span class="n">nyi</span><span class="p">)</span>
<span class="ln">4</span>                <span class="k">end</span><span class="p">)).</span>
<span class="ln">5</span>
<span class="ln">6</span><span class="nf">glurk</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">7</span>    <span class="o">?</span><span class="nv">NYI</span><span class="p">({</span><span class="n">glurk</span><span class="p">,</span> <span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">}).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>&gt; lib_misc:glurk(1,2).
<span class="ln">2</span>*** NYI lib_misc 83 {glurk,1,2}
<span class="ln">3</span>** exited: nyi *
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">dump</span><span class="p">(</span><span class="nv">File</span><span class="p">,</span> <span class="nv">Term</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="nv">Out</span> <span class="o">=</span> <span class="nv">File</span> <span class="o">++</span> <span class="s">&#34;.tmp&#34;</span><span class="p">,</span>
<span class="ln">3</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;** dumping t0 </span><span class="si">~s~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Out</span><span class="p">]),</span>
<span class="ln">4</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">S</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="nv">Out</span><span class="p">,</span> <span class="p">[</span><span class="n">write</span><span class="p">]),</span>
<span class="ln">5</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="s">&#34;</span><span class="si">~p</span><span class="s">.</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Term</span><span class="p">]),</span>
<span class="ln">6</span>    <span class="nn">file</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">S</span><span class="p">).</span>
</code></pre></div><p>elog5.config</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="c">%% 文本错误日志
</span><span class="ln">2</span><span class="c"></span><span class="p">[</span> <span class="p">{</span><span class="n">kernel</span><span class="p">,</span>
<span class="ln">3</span>  <span class="p">[{</span><span class="n">error_logger</span><span class="p">,</span>
<span class="ln">4</span>   <span class="p">{</span><span class="n">file</span><span class="p">,</span> <span class="s">&#34;/Users/joe/error_logs/debug.log&#34;</span><span class="p">}}]}].</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl -config elog5.config
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>1&gt; %% 重新编译lib_misc，这样就能调试它了
<span class="ln"> 2</span>1&gt; c(lib_misc, [debug_info]).
<span class="ln"> 3</span>{ok, lib_misc}
<span class="ln"> 4</span>2&gt; im(). %% 这里会弹出一个窗口，现在可以忽略它
<span class="ln"> 5</span>&lt;0.42.0&gt;
<span class="ln"> 6</span>3&gt; ii(lib_misc).
<span class="ln"> 7</span>{module,lib_misc}
<span class="ln"> 8</span>4&gt; iaa([init]).
<span class="ln"> 9</span>true.
<span class="ln">10</span>5&gt; lib_misc:
<span class="ln">11</span>...
</code></pre></div><p>tracer_test.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">trace_module</span><span class="p">(</span><span class="nv">Mod</span><span class="p">,</span> <span class="nv">StartFun</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="c">%% 分裂一个进程来执行跟踪
</span><span class="ln"> 3</span><span class="c"></span>    <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">trace_module1</span><span class="p">(</span><span class="nv">Mod</span><span class="p">,</span> <span class="nv">StartFun</span><span class="p">)</span> <span class="k">end</span><span class="p">).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="nf">trace_module1</span><span class="p">(</span><span class="nv">Mod</span><span class="p">,</span> <span class="nv">StartFun</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="c">%% 下一方的意思是：跟踪Mod里的所有函数调用和返回值
</span><span class="ln"> 7</span><span class="c"></span>    <span class="nn">erlang</span><span class="p">:</span><span class="nb">trace_pattern</span><span class="p">({</span><span class="nv">Mod</span><span class="p">,</span> <span class="n">&#39;_&#39;</span><span class="p">,</span><span class="n">&#39;_&#39;</span><span class="p">},</span>
<span class="ln"> 8</span>                         <span class="p">[{</span><span class="n">&#39;_&#39;</span><span class="p">,[],[{</span><span class="n">return_trace</span><span class="p">}]}],</span>
<span class="ln"> 9</span>                         <span class="p">[</span><span class="n">local</span><span class="p">]),</span>
<span class="ln">10</span>    <span class="c">%% 分裂一个函数来执行跟踪
</span><span class="ln">11</span><span class="c"></span>    <span class="nv">S</span> <span class="o">=</span> <span class="n">self</span><span class="p">(),</span>
<span class="ln">12</span>    <span class="nv">Pid</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">do_trace</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="nv">StartFun</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
<span class="ln">13</span>    <span class="c">%% 设置跟踪，告诉系统开始
</span><span class="ln">14</span><span class="c"></span>    <span class="c">%% 跟踪进程Pid
</span><span class="ln">15</span><span class="c"></span>    <span class="nn">erlang</span><span class="p">:</span><span class="nb">trace</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="p">[</span><span class="n">call</span><span class="p">,</span><span class="n">procs</span><span class="p">]),</span>
<span class="ln">16</span>    <span class="c">%% 现在让Pid启动
</span><span class="ln">17</span><span class="c"></span>    <span class="nv">Pid</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="n">start</span><span class="p">},</span>
<span class="ln">18</span>    <span class="n">trace_loop</span><span class="p">().</span>
<span class="ln">19</span>
<span class="ln">20</span><span class="c">%% do_trace会在Parent的指示下执行StartFun()
</span><span class="ln">21</span><span class="c"></span><span class="nf">do_trace</span><span class="p">(</span><span class="nv">Parent</span><span class="p">,</span> <span class="nv">StartFun</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">22</span>    <span class="k">receive</span>
<span class="ln">23</span>        <span class="p">{</span><span class="nv">Parent</span><span class="p">,</span> <span class="n">start</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">24</span>            <span class="nv">StartFun</span><span class="p">()</span>
<span class="ln">25</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">26</span>
<span class="ln">27</span><span class="c">%% trace_loop负责显示函数调用和返回值
</span><span class="ln">28</span><span class="c"></span><span class="nf">trace_loop</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">29</span>    <span class="k">receive</span>
<span class="ln">30</span>        <span class="p">{</span><span class="nb">trace</span><span class="p">,_,</span><span class="n">call</span><span class="p">,</span><span class="nv">X</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">31</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Call: </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,[</span><span class="nv">X</span><span class="p">]),</span>
<span class="ln">32</span>            <span class="n">trace_loop</span><span class="p">();</span>
<span class="ln">33</span>        <span class="p">{</span><span class="nb">trace</span><span class="p">,_,</span><span class="n">return_from</span><span class="p">,</span> <span class="nv">Call</span><span class="p">,</span> <span class="nv">Ret</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">34</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Return From: </span><span class="si">~p</span><span class="s"> =&gt; </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Call</span><span class="p">,</span> <span class="nv">Ret</span><span class="p">]),</span>
<span class="ln">35</span>            <span class="n">trace_loop</span><span class="p">();</span>
<span class="ln">36</span>        <span class="nv">Other</span> <span class="o">-&gt;</span>
<span class="ln">37</span>            <span class="c">%% 其他信息，打印
</span><span class="ln">38</span><span class="c"></span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Other = </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Other</span><span class="p">]),</span>
<span class="ln">39</span>            <span class="n">trace_loop</span><span class="p">()</span>
<span class="ln">40</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">test2</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="n">trace_module</span><span class="p">(</span><span class="n">tracer_test</span><span class="p">,</span> <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">fib</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">end</span><span class="p">).</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">fib</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">5</span><span class="nf">fib</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">6</span><span class="nf">fib</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">fib</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">2</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; c(tracer_test).
<span class="ln">2</span>2&gt; tracer_test:test2().
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">test1</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">2</span>    <span class="nn">dbg</span><span class="p">:</span><span class="nf">tracer</span><span class="p">(),</span>
<span class="ln">3</span>    <span class="nn">dbg</span><span class="p">:</span><span class="nf">tpl</span><span class="p">(</span><span class="n">tracer_test</span><span class="p">,</span> <span class="n">fib</span><span class="p">,</span> <span class="n">&#39;_&#39;</span><span class="p">,</span>
<span class="ln">4</span>            <span class="nn">dbg</span><span class="p">:</span><span class="nf">fun2ms</span><span class="p">(</span><span class="k">fun</span><span class="p">(_)</span> <span class="o">-&gt;</span> <span class="n">return_trace</span><span class="p">()</span> <span class="k">end</span><span class="p">)),</span>
<span class="ln">5</span>    <span class="nn">dbg</span><span class="p">:</span><span class="nf">p</span><span class="p">(</span><span class="n">all</span><span class="p">,[</span><span class="n">c</span><span class="p">]),</span>
<span class="ln">6</span>    <span class="nn">tracer_test</span><span class="p">:</span><span class="nf">fib</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span>
</code></pre></div><h3 id="练习-17">练习</h3>
<p>(1) 创建一个新目录，然后复制标准库模块dict.erl到这个目录里。给dict.erl添加一个错误，使它在某一行代码被执行时会崩溃。然后编译这个模块。</p>
<p>(2) 现在我们有了一个问题模块dict，但多半还不知道它有问题，所以需要引发错误。编写一个简单的测试模块来用多种方式调用dict，看看能否让dict崩溃。</p>
<p>(3) 使用覆盖分析器来检查dict里的每一行代码各被执行了多少次。给你的测试模块添加更多的测试案例，看看是否覆盖了dict里的所有代码。这么做的目的是确保dict里的每一行代码都被执行。一旦知道哪些代码行未被执行，就能轻松进行反向推导，找出测试案例里的哪些代码行能导致某一行原代码被执行。
坚持做这件事，直到程序崩溃为止。崩溃迟早会发生，因为当每一行代码都被覆盖时，就意味着错误已被触发。</p>
<p>(4) 现在我们有了一个错误。假装你不知道错误出在哪里，然后使用这一章里介绍的方法来找出这个错误。
当你真的不知道错误在哪里时，这个练习会更有效。找个朋友来破坏你的某些模块，然后对这些模块运行覆盖测试来引发错误。一旦引发了错误，就使用调试技术来找出问题所在。</p>
<h2 id="第22章-otp介绍">第22章 OTP介绍</h2>
<p>有点像接口的概念。</p>
<h3 id="引入otp">引入OTP</h3>
<p>server.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">server1</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">rpc</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="c">%% 开启服务器进程并注册
</span><span class="ln"> 5</span><span class="c"></span><span class="nf">start</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="nb">register</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">:</span><span class="nf">init</span><span class="p">())</span> <span class="k">end</span><span class="p">)).</span>
<span class="ln"> 7</span><span class="c">%% 给服务器发信
</span><span class="ln"> 8</span><span class="c"></span><span class="nf">rpc</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Request</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 9</span>    <span class="nv">Name</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Request</span><span class="p">},</span>
<span class="ln">10</span>    <span class="k">receive</span>
<span class="ln">11</span>        <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Response</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nv">Response</span>
<span class="ln">12</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">13</span><span class="c">%% 服务器核心程序
</span><span class="ln">14</span><span class="c">%% 这个State参数要注意
</span><span class="ln">15</span><span class="c"></span><span class="nf">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">16</span>    <span class="k">receive</span>
<span class="ln">17</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Request</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">18</span>            <span class="p">{</span><span class="nv">Response</span><span class="p">,</span> <span class="nv">State1</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Mod</span><span class="p">:</span><span class="nf">handle</span><span class="p">(</span><span class="nv">Request</span><span class="p">,</span> <span class="nv">State</span><span class="p">),</span>
<span class="ln">19</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="nv">Name</span><span class="p">,</span><span class="nv">Response</span><span class="p">},</span>
<span class="ln">20</span>            <span class="n">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">,</span> <span class="nv">State1</span><span class="p">)</span>
<span class="ln">21</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>name_server.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">name_server</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">add</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">find</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span><span class="p">-</span><span class="ni">import</span><span class="p">(</span><span class="n">server1</span><span class="p">,</span> <span class="p">[</span><span class="n">rpc</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="c">%% 客户端方法
</span><span class="ln"> 6</span><span class="c"></span><span class="nf">add</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Place</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rpc</span><span class="p">(</span><span class="n">name_server</span><span class="p">,</span> <span class="p">{</span><span class="n">add</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Place</span><span class="p">}).</span>
<span class="ln"> 7</span><span class="nf">find</span><span class="p">(</span><span class="nv">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rpc</span><span class="p">(</span><span class="n">name_server</span><span class="p">,</span> <span class="p">{</span><span class="n">find</span><span class="p">,</span> <span class="nv">Name</span><span class="p">}).</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="c">%% 回调方法
</span><span class="ln">10</span><span class="c"></span><span class="nf">init</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">new</span><span class="p">().</span>
<span class="ln">11</span><span class="nf">handle</span><span class="p">({</span><span class="n">add</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Place</span><span class="p">},</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">stire</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span><span class="nv">Place</span><span class="p">,</span><span class="nv">Dict</span><span class="p">)};</span>
<span class="ln">12</span><span class="nf">handle</span><span class="p">({</span><span class="n">find</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nn">dict</span><span class="p">:</span><span class="nf">find</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">),</span> <span class="nv">Dict</span><span class="p">}.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; server1:start(name_server, name_server).
<span class="ln">2</span>ture
<span class="ln">3</span>2&gt; name_server:add(joe, &#34;at home&#34;).
<span class="ln">4</span>ok
<span class="ln">5</span>3&gt; name_server:find(joe).
<span class="ln">6</span>{ok, &#34;at home&#34;}
</code></pre></div><p>server2.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">server2</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">rpc</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="nb">register</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">:</span><span class="nf">init</span><span class="p">())</span> <span class="k">end</span><span class="p">)).</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="nf">rpc</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Request</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>    <span class="nv">Name</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Request</span><span class="p">},</span>
<span class="ln"> 9</span>    <span class="k">receive</span>
<span class="ln">10</span>        <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="n">crash</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nb">exit</span><span class="p">(</span><span class="n">rpc</span><span class="p">);</span>
<span class="ln">11</span>        <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">Response</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nv">Response</span>
<span class="ln">12</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">13</span>
<span class="ln">14</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">,</span> <span class="nv">OldState</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">15</span>    <span class="k">receive</span>
<span class="ln">16</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Request</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">17</span>            <span class="k">try</span> <span class="nv">Mod</span><span class="p">:</span><span class="nf">handle</span><span class="p">(</span><span class="nv">Request</span><span class="p">,</span> <span class="nv">OldState</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">18</span>                <span class="p">{</span><span class="nv">Response</span><span class="p">,</span> <span class="nv">NewState</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">19</span>                    <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">Response</span><span class="p">},</span>
<span class="ln">20</span>                    <span class="n">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">,</span> <span class="nv">NewState</span><span class="p">)</span>
<span class="ln">21</span>            <span class="k">catch</span>
<span class="ln">22</span>                <span class="p">_:</span><span class="nv">Why</span> <span class="o">-&gt;</span>
<span class="ln">23</span>                    <span class="n">log_the_error</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Request</span><span class="p">,</span> <span class="nv">Why</span><span class="p">),</span>
<span class="ln">24</span>                    <span class="c">%% 发送一个消息让客户端崩溃
</span><span class="ln">25</span><span class="c"></span>                    <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="n">crash</span><span class="p">},</span>
<span class="ln">26</span>                    <span class="c">%% 以初始状态继续循环
</span><span class="ln">27</span><span class="c"></span>                    <span class="n">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">,</span> <span class="nv">OldState</span><span class="p">)</span>
<span class="ln">28</span>            <span class="k">end</span>
<span class="ln">29</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">30</span>
<span class="ln">31</span><span class="nf">log_the_error</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Request</span><span class="p">,</span> <span class="nv">Why</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">32</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Server </span><span class="si">~p</span><span class="s"> request </span><span class="si">~p</span><span class="s"> </span><span class="si">~n</span><span class="s">&#34;</span>
<span class="ln">33</span>              <span class="s">&#34;caused exception </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span>
<span class="ln">34</span>              <span class="p">[</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Request</span><span class="p">,</span> <span class="nv">Why</span><span class="p">]).</span>
</code></pre></div><p>server3.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">server3</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">rpc</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">swap_code</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="nb">register</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">:</span><span class="nf">init</span><span class="p">())</span> <span class="k">end</span><span class="p">)).</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="c">%% 通过传入新的Mod改变运行的代码
</span><span class="ln"> 8</span><span class="c"></span><span class="nf">swap_code</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rpc</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="p">{</span><span class="n">swap_code</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">}).</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="nf">rpc</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Request</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">11</span>    <span class="nv">Name</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Request</span><span class="p">},</span>
<span class="ln">12</span>    <span class="k">receive</span>
<span class="ln">13</span>        <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Response</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nv">Response</span>
<span class="ln">14</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">15</span>
<span class="ln">16</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">,</span> <span class="nv">OldState</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">17</span>    <span class="k">receive</span>
<span class="ln">18</span>        <span class="c">%% 监听到改变代码的消息
</span><span class="ln">19</span><span class="c"></span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="p">{</span><span class="n">swap_code</span><span class="p">,</span> <span class="nv">NewCallBackMod</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">20</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="n">ack</span><span class="p">},</span>
<span class="ln">21</span>            <span class="n">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">NewcallBackMod</span><span class="p">,</span> <span class="nv">OldState</span><span class="p">);</span>
<span class="ln">22</span>        <span class="c">%% 正常处理
</span><span class="ln">23</span><span class="c"></span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Request</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">24</span>            <span class="p">{</span><span class="nv">Response</span><span class="p">,</span> <span class="nv">NewState</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Mod</span><span class="p">:</span><span class="nf">handle</span><span class="p">(</span><span class="nv">Request</span><span class="p">,</span> <span class="nv">OldState</span><span class="p">),</span>
<span class="ln">25</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Response</span><span class="p">},</span>
<span class="ln">26</span>            <span class="n">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">,</span> <span class="nv">NewState</span><span class="p">)</span>
<span class="ln">27</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>name_server1.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">name_server1</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">add</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">find</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span><span class="p">-</span><span class="ni">import</span><span class="p">(</span><span class="n">server3</span><span class="p">,</span> <span class="p">[</span><span class="n">rpc</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="c">%% 客户端方法
</span><span class="ln"> 6</span><span class="c"></span><span class="nf">add</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Place</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rpc</span><span class="p">(</span><span class="n">name_server</span><span class="p">,</span> <span class="p">{</span><span class="n">add</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Place</span><span class="p">}).</span>
<span class="ln"> 7</span><span class="nf">find</span><span class="p">(</span><span class="nv">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rpc</span><span class="p">(</span><span class="n">name_server</span><span class="p">,</span> <span class="p">{</span><span class="n">find</span><span class="p">,</span> <span class="nv">Name</span><span class="p">}).</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="c">%% 回调方法
</span><span class="ln">10</span><span class="c"></span><span class="nf">init</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">new</span><span class="p">().</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="nf">handle</span><span class="p">({</span><span class="n">add</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Place</span><span class="p">},</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">stire</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span><span class="nv">Place</span><span class="p">,</span><span class="nv">Dict</span><span class="p">)};</span>
<span class="ln">13</span><span class="nf">handle</span><span class="p">({</span><span class="n">find</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nn">dict</span><span class="p">:</span><span class="nf">find</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">),</span> <span class="nv">Dict</span><span class="p">}.</span>
</code></pre></div><p>new_name_server.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">new_name_server</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">add</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">all_names</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">delete</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">find</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span><span class="p">-</span><span class="ni">import</span><span class="p">(</span><span class="n">server3</span><span class="p">,</span> <span class="p">[</span><span class="n">rpc</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="c">%% 接口
</span><span class="ln"> 6</span><span class="c"></span><span class="nf">all_names</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">rpc</span><span class="p">(</span><span class="n">name_server</span><span class="p">,</span> <span class="n">allNames</span><span class="p">).</span>
<span class="ln"> 7</span><span class="nf">add</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Place</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rpc</span><span class="p">(</span><span class="n">name_server</span><span class="p">,</span> <span class="p">{</span><span class="n">add</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Place</span><span class="p">}).</span>
<span class="ln"> 8</span><span class="nf">delete</span><span class="p">(</span><span class="nv">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rpc</span><span class="p">(</span><span class="n">name_server</span><span class="p">,</span> <span class="p">{</span><span class="n">delete</span><span class="p">,</span> <span class="nv">Name</span><span class="p">}).</span>
<span class="ln"> 9</span><span class="nf">find</span><span class="p">(</span><span class="nv">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rpc</span><span class="p">(</span><span class="n">name_server</span><span class="p">,</span> <span class="p">{</span><span class="n">find</span><span class="p">,</span> <span class="nv">Name</span><span class="p">}).</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="c">%% 回调方法
</span><span class="ln">12</span><span class="c"></span><span class="nf">init</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">new</span><span class="p">().</span>
<span class="ln">13</span>
<span class="ln">14</span><span class="nf">handle</span><span class="p">({</span><span class="n">add</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Place</span><span class="p">},</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">store</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Place</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)};</span>
<span class="ln">15</span><span class="nf">handle</span><span class="p">(</span><span class="n">allNames</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nn">dict</span><span class="p">:</span><span class="nf">fetch_keys</span><span class="p">(</span><span class="nv">Dict</span><span class="p">),</span> <span class="nv">Dict</span><span class="p">};</span>
<span class="ln">16</span><span class="nf">handle</span><span class="p">({</span><span class="n">delete</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="nb">erase</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)};</span>
<span class="ln">17</span><span class="nf">handle</span><span class="p">({</span><span class="n">find</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nn">dict</span><span class="p">:</span><span class="nf">find</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">),</span> <span class="nv">Dict</span><span class="p">}.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>1&gt; server3:start(name_server, name_server1).
<span class="ln"> 2</span>true
<span class="ln"> 3</span>2&gt; name_server1:add(joe, &#34;at home&#34;).
<span class="ln"> 4</span>ok
<span class="ln"> 5</span>3&gt; name_server1:add(helen, &#34;at work&#34;).
<span class="ln"> 6</span>ok
<span class="ln"> 7</span>4&gt; c(new_name_server).
<span class="ln"> 8</span>5&gt; server3:swap_code(name_server, new_name_server).
<span class="ln"> 9</span>ack
<span class="ln">10</span>6&gt; new_name_server:all_names().
</code></pre></div><p>server4.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">server4</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">rpc</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">swap_code</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="nb">register</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">MOd</span><span class="p">,</span> <span class="nv">MOd</span><span class="p">:</span><span class="nf">init</span><span class="p">())</span> <span class="k">end</span><span class="p">)).</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="nf">swap_code</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rpc</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="p">{</span><span class="n">swap_code</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">}).</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="nf">rpc</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Request</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">10</span>    <span class="nv">Name</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Request</span><span class="p">},</span>
<span class="ln">11</span>    <span class="k">receive</span>
<span class="ln">12</span>        <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="n">crash</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nb">exit</span><span class="p">(</span><span class="n">rpc</span><span class="p">);</span>
<span class="ln">13</span>        <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">Response</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nv">Response</span>
<span class="ln">14</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">15</span>
<span class="ln">16</span><span class="nf">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">,</span> <span class="nv">OldState</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">17</span>    <span class="k">receive</span>
<span class="ln">18</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="p">{</span><span class="n">swap_code</span><span class="p">,</span> <span class="nv">NewCallbackMod</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln">19</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">ack</span><span class="p">},</span>
<span class="ln">20</span>            <span class="n">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">NewCallbackMod</span><span class="p">,</span> <span class="nv">OldState</span><span class="p">);</span>
<span class="ln">21</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Request</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">22</span>            <span class="k">try</span> <span class="nv">Mod</span><span class="p">:</span><span class="nf">handle</span><span class="p">(</span><span class="nv">Request</span><span class="p">,</span> <span class="nv">OldState</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">23</span>                <span class="p">{</span><span class="nv">Response</span><span class="p">,</span> <span class="nv">NewState</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">24</span>                    <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">Response</span><span class="p">},</span>
<span class="ln">25</span>                    <span class="n">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">,</span> <span class="nv">NewState</span><span class="p">)</span>
<span class="ln">26</span>            <span class="k">catch</span>
<span class="ln">27</span>                <span class="p">_:</span> <span class="nv">Why</span> <span class="o">-&gt;</span>
<span class="ln">28</span>                    <span class="n">log_the_error</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Request</span><span class="p">,</span> <span class="nv">Why</span><span class="p">),</span>
<span class="ln">29</span>                    <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="nv">Name</span><span class="p">,</span> <span class="n">crash</span><span class="p">},</span>
<span class="ln">30</span>                    <span class="n">loop</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Mod</span><span class="p">,</span> <span class="nv">OldState</span><span class="p">)</span>
<span class="ln">31</span>            <span class="k">end</span>
<span class="ln">32</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">33</span>
<span class="ln">34</span><span class="nf">log_the_error</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Request</span><span class="p">,</span> <span class="nv">Why</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">35</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Server </span><span class="si">~p</span><span class="s"> request </span><span class="si">~p</span><span class="s"> </span><span class="si">~n</span><span class="s">&#34;</span>
<span class="ln">36</span>              <span class="s">&#34;caused exception </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span>
<span class="ln">37</span>              <span class="p">[</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Request</span><span class="p">,</span> <span class="nv">Why</span><span class="p">]).</span>
</code></pre></div><p>server5.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">server5</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">rpc</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">wait</span><span class="p">()</span> <span class="k">end</span><span class="p">).</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="nf">wait</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>    <span class="k">receive</span>
<span class="ln"> 8</span>        <span class="p">{</span><span class="n">become</span><span class="p">,</span> <span class="nv">F</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nv">F</span><span class="p">()</span>
<span class="ln"> 9</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="nf">rpc</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Q</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">12</span>    <span class="nv">Pid</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Q</span><span class="p">},</span>
<span class="ln">13</span>    <span class="k">receive</span>
<span class="ln">14</span>        <span class="p">{</span><span class="nv">PId</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nv">Reply</span>
<span class="ln">15</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>my_fac_server.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">my_fac_server</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">loop</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">loop</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="k">receive</span>
<span class="ln"> 6</span>        <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="p">{</span><span class="n">fac</span><span class="p">,</span> <span class="nv">N</span><span class="p">}}</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>            <span class="nv">From</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="n">fac</span><span class="p">(</span><span class="nv">N</span><span class="p">)}</span>
<span class="ln"> 8</span>                <span class="n">loop</span><span class="p">();</span>
<span class="ln"> 9</span>        <span class="p">{</span><span class="n">become</span><span class="p">,</span> <span class="nv">Something</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">10</span>            <span class="nv">Something</span><span class="p">()</span>
<span class="ln">11</span>     <span class="k">end</span><span class="p">.</span>
<span class="ln">12</span>
<span class="ln">13</span><span class="nf">fac</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">14</span><span class="nf">fac</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">N</span> <span class="o">*</span> <span class="n">fac</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>1&gt; Pid = server5:start().
<span class="ln">2</span>2&gt; c(my_fac_server).
<span class="ln">3</span>3&gt; Pid ! {become, fun my_fac_server:loop/0}.
<span class="ln">4</span>4&gt; server5:rpc(Pid, {fac,30}).
</code></pre></div><h3 id="gen_server回调结构">gen_server回调结构</h3>
<p>应熟记。</p>
<ul>
<li>
<p><code>gen_server:start_link(Name, Mod, InitArgs, Opts)</code></p>
<p>创建一个名为Name的通用服务器，回调模块是Mod，Opts则控制通用服务器的行为。在这里可以指定消息记录、函数调试和其他行为。通用服务器通过调用Mod:init(InitArgs)启动。</p>
<p>在通常的操作里，只会返回{ok, State}。要了解其他参数的含义，请参考gen_server的手册页。
如果返回{ok, State}，就说明我们成功启动了服务器，它的初始状态是State。</p>
</li>
<li>
<p><code>gen_server:call(Name, Request)</code></p>
<p>Request(gen_server:call/2的第二个参数) 作为handle_call/3的第一个参数重新出现。From是发送请求的客户端进程的PID，State则是客户端的当前状态。
我们通常会返回{reply, Reply, NewState}。在这种情况下，Reply会返回客户端，成为gen_server:call的返回值。NewState则是服务器接下来的状态。
其他的返回值（{noreply, ..}和{stop, ..}）相对不太常用。no reply会让服务器继续工作，但客户端会等待一个回复，所以服务器必须把回复的任务委派给其他进程。用适当的参数调用stop会停止服务器。</p>
</li>
<li>
<p><code>gen_server:cast(Name, Msg)</code></p>
<p>对应的回调方法是handle_cast。这个处理函数通常只返回{noreply, NewState}或{stop, &hellip;}。前者改变服务器的状态，后者停止服务器。</p>
</li>
<li>
<p><code>handle_info(Info, State)</code></p>
<p>用来处理发给服务器的自发性消息。自发性消息是一切未经显式调用gen_server:call或gen_server:cast而到达服务器的消息。</p>
<p>举个例子，如果服务器连接到另一个进程并捕捉退出信号，就可能会突然收到一个预料之外的{&lsquo;EXIT&rsquo;, Pid,What}消息。除此之外，系统里任何知道通用服务器PID的进程都可以向它发送消息。这样的消息在服务器里表现为info值。</p>
<p>它的返回值和handle_cast相同。</p>
</li>
<li>
<p><code>terminate(Reason, NewState)</code></p>
<p>服务器会因为许多原因而终止。某个以handle_开头的函数也许会返回一个{stop, Reason,NewState}，服务器也可能崩溃并生成{&lsquo;EXIT&rsquo;, reason}。在所有这些情况下，无论它们是怎样发生的，都会调用terminate(Reason, NewState)</p>
</li>
<li>
<p><code>code_change(_OldVsn, State, _Extra)</code></p>
<p>可以在服务器运行时动态更改它的状态。这个回调函数会在系统执行软件升级时由版本处理子系统调用。</p>
</li>
</ul>
<h3 id="gen_server案例">gen_server案例</h3>
<p>my_bank.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">my_bank</span><span class="p">).</span>
<span class="ln"> 2</span>
<span class="ln"> 3</span><span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">gen_server</span><span class="p">).</span>
<span class="ln"> 4</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln"> 5</span><span class="c">%% gen_server回调函数
</span><span class="ln"> 6</span><span class="c"></span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">handle_cast</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
<span class="ln"> 7</span><span class="p">-</span><span class="ni">compile</span><span class="p">(</span><span class="n">export_all</span><span class="p">).</span>
<span class="ln"> 8</span><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">SERVER</span><span class="p">,</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">).</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">gen_server</span><span class="p">:</span><span class="nf">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span> <span class="o">?</span><span class="nv">SERVER</span><span class="p">},</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]).</span>
<span class="ln">11</span><span class="nf">stop</span><span class="p">()</span> <span class="o">-&gt;</span><span class="nn">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">stop</span><span class="p">).</span>
<span class="ln">12</span>
<span class="ln">13</span><span class="nf">new_account</span><span class="p">(</span><span class="nv">Who</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">{</span><span class="n">new</span><span class="p">,</span> <span class="nv">Who</span><span class="p">}).</span>
<span class="ln">14</span><span class="nf">deposit</span><span class="p">(</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">Amount</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">{</span><span class="n">add</span><span class="p">,</span> <span class="nv">Who</span><span class="p">,</span> <span class="nv">Amount</span><span class="p">}).</span>
<span class="ln">15</span><span class="nf">withdraw</span><span class="p">(</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">Amount</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">{</span><span class="n">remove</span><span class="p">,</span> <span class="nv">Who</span><span class="p">,</span> <span class="nv">Amount</span><span class="p">}).</span>
<span class="ln">16</span>
<span class="ln">17</span>
<span class="ln">18</span><span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">[])}.</span>
<span class="ln">19</span>
<span class="ln">20</span><span class="nf">handle_call</span><span class="p">({</span><span class="n">new</span><span class="p">,</span> <span class="nv">Who</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">21</span>    <span class="nv">Reply</span> <span class="o">=</span> <span class="k">case</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="nv">Who</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">22</span>                <span class="p">[]</span> <span class="o">-&gt;</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="p">{</span><span class="nv">Who</span><span class="p">,</span> <span class="mi">0</span><span class="p">}),</span>
<span class="ln">23</span>                    <span class="p">{</span><span class="n">welcome</span><span class="p">,</span> <span class="nv">Who</span><span class="p">};</span>
<span class="ln">24</span>                <span class="p">[_]</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Who</span><span class="p">,</span> <span class="n">you_already_are_a_customer</span><span class="p">}</span>
<span class="ln">25</span>            <span class="k">end</span><span class="p">,</span>
<span class="ln">26</span>    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">};</span>
<span class="ln">27</span><span class="nf">handle_call</span><span class="p">({</span><span class="n">add</span><span class="p">,</span><span class="nv">Who</span><span class="p">,</span><span class="nv">X</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">28</span>    <span class="nv">Reply</span> <span class="o">=</span> <span class="k">case</span> <span class="nn">etts</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="nv">Who</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">29</span>                <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">not_a_customer</span><span class="p">;</span>
<span class="ln">30</span>                <span class="p">[{</span><span class="nv">Who</span><span class="p">,</span><span class="nv">Balance</span><span class="p">}]</span> <span class="o">-&gt;</span>
<span class="ln">31</span>                    <span class="nv">NewBalance</span> <span class="o">=</span> <span class="nv">Balance</span> <span class="o">+</span> <span class="nv">X</span><span class="p">,</span>
<span class="ln">32</span>                    <span class="nn">ets</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="p">{</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">NewBalance</span><span class="p">}),</span>
<span class="ln">33</span>                    <span class="p">{</span><span class="n">thanks</span><span class="p">,</span> <span class="nv">Who</span><span class="p">,</span> <span class="n">your_balance_is</span><span class="p">,</span> <span class="nv">NewBalance</span><span class="p">}</span>
<span class="ln">34</span>            <span class="k">end</span><span class="p">,</span>
<span class="ln">35</span>    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">};</span>
<span class="ln">36</span><span class="nf">handle_call</span><span class="p">({</span><span class="n">remove</span><span class="p">,</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">X</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">37</span>    <span class="nv">Reply</span> <span class="o">=</span> <span class="k">case</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="nv">Who</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">38</span>                <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">not_a_customer</span><span class="p">;</span>
<span class="ln">39</span>                <span class="p">[{</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">Balance</span><span class="p">}]</span> <span class="k">when</span> <span class="nv">X</span> <span class="o">=&lt;</span> <span class="nv">Balance</span> <span class="o">-&gt;</span>
<span class="ln">40</span>                    <span class="nv">NewBalance</span> <span class="o">=</span> <span class="nv">Balance</span> <span class="o">-</span> <span class="nv">X</span><span class="p">,</span>
<span class="ln">41</span>                    <span class="nn">ets</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="nv">Tab</span> <span class="p">,</span> <span class="p">{</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">NewBalance</span><span class="p">}),</span>
<span class="ln">42</span>                    <span class="p">{</span><span class="n">thanks</span><span class="p">,</span> <span class="nv">Who</span><span class="p">,</span> <span class="n">your_balance_is</span><span class="p">,</span> <span class="nv">NewBalance</span><span class="p">};</span>
<span class="ln">43</span>                <span class="p">[{</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">Balance</span><span class="p">}]</span> <span class="o">-&gt;</span>
<span class="ln">44</span>                    <span class="p">{</span><span class="n">sorry</span><span class="p">,</span><span class="nv">Who</span><span class="p">,</span><span class="n">you_only_have</span><span class="p">,</span><span class="nv">Balance</span><span class="p">,</span> <span class="n">in_the_bank</span><span class="p">}</span>
<span class="ln">45</span>            <span class="k">end</span><span class="p">,</span>
<span class="ln">46</span>    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">};</span>
<span class="ln">47</span>
<span class="ln">48</span><span class="nf">handle_call</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">49</span>    <span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">stopped</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">}.</span>
<span class="ln">50</span><span class="nf">handle_cast</span><span class="p">(_</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
<span class="ln">51</span><span class="nf">handle_info</span><span class="p">(_</span><span class="nv">Info</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
<span class="ln">52</span><span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">_</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ok</span><span class="p">.</span>
<span class="ln">53</span><span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVsn</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>1&gt; my_bank:start().
<span class="ln"> 2</span>{ok, &lt;0.33.0&gt;}
<span class="ln"> 3</span>2&gt; my_bank:deposit(&#34;joe&#34;, 10).
<span class="ln"> 4</span>not_a_customer
<span class="ln"> 5</span>3&gt; my_bank:new_account(&#34;joe&#34;).
<span class="ln"> 6</span>{welcome,&#34;joe&#34;}
<span class="ln"> 7</span>4&gt; my_bank:deposit(&#34;joe&#34;, 10).
<span class="ln"> 8</span>{thanks,&#34;joe&#34;,your_balance_is,10}
<span class="ln"> 9</span>5&gt; my_bank:deposit(&#34;joe&#34;, 30).
<span class="ln">10</span>{thanks,&#34;joe&#34;,your_balance_is,40}
<span class="ln">11</span>6&gt; my_bank:withdraw(&#34;joe&#34;, 15).
<span class="ln">12</span>{thanks,&#34;joe&#34;,your_balance_is,25}
<span class="ln">13</span>7&gt; my_bank:withdraw(&#34;joe&#34;, 45).
<span class="ln">14</span>{sorry,&#34;joe&#34;,you_only_have,25,in_the_bank}
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">  1</span><span class="n">gen_server_template</span><span class="p">.</span><span class="n">full</span>
<span class="ln">  2</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln">  3</span><span class="c">%%% @作者XXX&lt;me@hostname.local&gt;
</span><span class="ln">  4</span><span class="c">%%% @版权所有 (C) 2013, XXX
</span><span class="ln">  5</span><span class="c">%%% @doc
</span><span class="ln">  6</span><span class="c">%%%
</span><span class="ln">  7</span><span class="c">%%% @end
</span><span class="ln">  8</span><span class="c">%%% 创建于：2013年5月26日 作者XXX &lt;me@hostname.local&gt;
</span><span class="ln">  9</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 10</span><span class="c"></span><span class="p">-</span><span class="ni">module</span><span class="p">().</span>
<span class="ln"> 11</span><span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">gen_server</span><span class="p">).</span>
<span class="ln"> 12</span><span class="c">%% API
</span><span class="ln"> 13</span><span class="c"></span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln"> 14</span><span class="c">%% gen_server回调函数
</span><span class="ln"> 15</span><span class="c"></span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">handle_cast</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
<span class="ln"> 16</span><span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
<span class="ln"> 17</span><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">SERVER</span><span class="p">,</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">).</span>
<span class="ln"> 18</span><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">state</span><span class="p">,</span> <span class="p">{}).</span>
<span class="ln"> 19</span><span class="c">%%%===================================================================
</span><span class="ln"> 20</span><span class="c">%%% API
</span><span class="ln"> 21</span><span class="c">%%%===================================================================
</span><span class="ln"> 22</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln"> 23</span><span class="c">%% @doc
</span><span class="ln"> 24</span><span class="c">%% 启动服务器
</span><span class="ln"> 25</span><span class="c">%%
</span><span class="ln"> 26</span><span class="c">%% @spec start_link() -&gt; {ok, Pid} | ignore | {error, Error}
</span><span class="ln"> 27</span><span class="c">%% @end
</span><span class="ln"> 28</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln"> 29</span><span class="c"></span><span class="nf">start_link</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 30</span><span class="nn">gen_server</span><span class="p">:</span><span class="nf">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span> <span class="o">?</span><span class="nv">SERVER</span><span class="p">},</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]).</span>
<span class="ln"> 31</span><span class="c">%%%===================================================================
</span><span class="ln"> 32</span><span class="c">%%% gen_server回调函数
</span><span class="ln"> 33</span><span class="c">%%%===================================================================
</span><span class="ln"> 34</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln"> 35</span><span class="c">%% @private
</span><span class="ln"> 36</span><span class="c">%% @doc
</span><span class="ln"> 37</span><span class="c">%% 初始化服务器
</span><span class="ln"> 38</span><span class="c">%%
</span><span class="ln"> 39</span><span class="c">%% @spec init(Args) -&gt; {ok, State} |
</span><span class="ln"> 40</span><span class="c">%%
</span><span class="ln"> 41</span><span class="c"></span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="nv">Timeout</span><span class="p">}</span> <span class="p">|</span>
<span class="ln"> 42</span><span class="c">%%
</span><span class="ln"> 43</span><span class="c"></span><span class="n">ignore</span> <span class="p">|</span>
<span class="ln"> 44</span><span class="c">%%
</span><span class="ln"> 45</span><span class="c"></span><span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">}</span>
<span class="ln"> 46</span><span class="c">%% @end
</span><span class="ln"> 47</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln"> 48</span><span class="c"></span><span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span>
<span class="ln"> 49</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nl">#state</span><span class="p">{}}.</span>
<span class="ln"> 50</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln"> 51</span><span class="c">%% @private
</span><span class="ln"> 52</span><span class="c">%% @doc
</span><span class="ln"> 53</span><span class="c">%% 处理调用消息
</span><span class="ln"> 54</span><span class="c">%%
</span><span class="ln"> 55</span><span class="c">%% @spec handle_call(Request, From, State) -&gt;
</span><span class="ln"> 56</span><span class="c">%%
</span><span class="ln"> 57</span><span class="c"></span><span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}</span> <span class="p">|</span>
<span class="ln"> 58</span><span class="c">%%
</span><span class="ln"> 59</span><span class="c"></span><span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="nv">Timeout</span><span class="p">}</span> <span class="p">|</span>
<span class="ln"> 60</span><span class="c">%%
</span><span class="ln"> 61</span><span class="c"></span><span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}</span> <span class="p">|</span>
<span class="ln"> 62</span><span class="c">%%
</span><span class="ln"> 63</span><span class="c"></span><span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="nv">Timeout</span><span class="p">}</span> <span class="p">|</span>
<span class="ln"> 64</span><span class="c">%%
</span><span class="ln"> 65</span><span class="c"></span><span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}</span> <span class="p">|</span>
<span class="ln"> 66</span><span class="c">%%
</span><span class="ln"> 67</span><span class="c"></span><span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">,</span> <span class="nv">State</span><span class="p">}</span>
<span class="ln"> 68</span><span class="c">%% @end
</span><span class="ln"> 69</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln"> 70</span><span class="c"></span><span class="nf">handle_call</span><span class="p">(_</span><span class="nv">Request</span><span class="p">,</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 71</span><span class="nv">Reply</span> <span class="o">=</span> <span class="n">ok</span><span class="p">,</span>
<span class="ln"> 72</span><span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
<span class="ln"> 73</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln"> 74</span><span class="c">%% @private
</span><span class="ln"> 75</span><span class="c">%% @doc
</span><span class="ln"> 76</span><span class="c">%% 处理播发消息
</span><span class="ln"> 77</span><span class="c">%%
</span><span class="ln"> 78</span><span class="c">%% @spec handle_cast(Msg, State) -&gt; {noreply, State} |
</span><span class="ln"> 79</span><span class="c">%%
</span><span class="ln"> 80</span><span class="c"></span><span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="nv">Timeout</span><span class="p">}</span> <span class="p">|</span>
<span class="ln"> 81</span><span class="c">%%
</span><span class="ln"> 82</span><span class="c"></span><span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">,</span> <span class="nv">State</span><span class="p">}</span>
<span class="ln"> 83</span><span class="c">%% @end
</span><span class="ln"> 84</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln"> 85</span><span class="c"></span><span class="nf">handle_cast</span><span class="p">(_</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 86</span><span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
<span class="ln"> 87</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln"> 88</span><span class="c">%% @private
</span><span class="ln"> 89</span><span class="c">%% @doc
</span><span class="ln"> 90</span><span class="c">%% 处理所有非调用/播发的消息
</span><span class="ln"> 91</span><span class="c">%%
</span><span class="ln"> 92</span><span class="c">%% @spec handle_info(Info, State) -&gt; {noreply, State} |
</span><span class="ln"> 93</span><span class="c">%%
</span><span class="ln"> 94</span><span class="c"></span><span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="nv">Timeout</span><span class="p">}</span> <span class="p">|</span>
<span class="ln"> 95</span><span class="c">%%
</span><span class="ln"> 96</span><span class="c"></span><span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">,</span> <span class="nv">State</span><span class="p">}</span>
<span class="ln"> 97</span><span class="c">%% @end
</span><span class="ln"> 98</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln"> 99</span><span class="c"></span><span class="nf">handle_info</span><span class="p">(_</span><span class="nv">Info</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">100</span><span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
<span class="ln">101</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln">102</span><span class="c">%% @private
</span><span class="ln">103</span><span class="c">%% @doc
</span><span class="ln">104</span><span class="c">%% 这个函数是在某个gen_server即将终止时调用的。它应当是Module:init/1的逆操作，并进行必要的清理。
</span><span class="ln">105</span><span class="c">%% 当它返回时，gen_server终止并生成原因Reason。它的返回值会被忽略
</span><span class="ln">106</span><span class="c">%%
</span><span class="ln">107</span><span class="c">%% @spec terminate(Reason, State) -&gt; void()
</span><span class="ln">108</span><span class="c">%% @end
</span><span class="ln">109</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln">110</span><span class="c"></span><span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">_</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">111</span><span class="n">ok</span><span class="p">.</span>
<span class="ln">112</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln">113</span><span class="c">%% @private
</span><span class="ln">114</span><span class="c">%% @doc
</span><span class="ln">115</span><span class="c">%% 在代码更改时转换进程状态
</span><span class="ln">116</span><span class="c">%%
</span><span class="ln">117</span><span class="c">%% @spec code_change(OldVsn, State, Extra) -&gt; {ok, NewState}
</span><span class="ln">118</span><span class="c">%% @end
</span><span class="ln">119</span><span class="c">%%--------------------------------------------------------------------
</span><span class="ln">120</span><span class="c"></span><span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVsn</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">121</span><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
<span class="ln">122</span><span class="c">%%%===================================================================
</span><span class="ln">123</span><span class="c">%%% 内部函数
</span><span class="ln">124</span><span class="c">%%%===================================================================
</span></code></pre></div><h3 id="练手小项目">练手小项目</h3>
<p>要求：</p>
<p>建立两个node，从一个node上向另一个node请求一个字符串。做两个gen server分别运行在两个节点上，互相能发消息。将两个node上的chat的pid拿到。在chat<strong>内部</strong>直接发cast消息。不用call。要让两个chat<strong>直接</strong>通信。然后发信的时候携带Pid让对方可以回信。</p>
<p>问题：</p>
<ul>
<li>
<p>节点之间没有互连，setcookie不是互联而是能够互联。使用net_adm:ping/1连接节点。</p>
</li>
<li>
<p>需要让gen_server本身的进程使用cast方法，如何让进程本身发消息而不使用rpc或者其他进程给他消息？</p>
<p>包装一下就行，让另一个进程发送消息触发handle，在handle里面使用cast。</p>
</li>
<li>
<p>如何获取Pid？注意是网络的Pid不是本地的Pid。</p>
</li>
</ul>
<p>初步实现：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 2</span><span class="c">%%% @author bnaod1
</span><span class="ln"> 3</span><span class="c">%%% @copyright (C) 2024, 
</span><span class="ln"> 4</span><span class="c">%%% @doc
</span><span class="ln"> 5</span><span class="c">%%%
</span><span class="ln"> 6</span><span class="c">%%% @end
</span><span class="ln"> 7</span><span class="c">%%% Created : 2024 12月26. 14:47
</span><span class="ln"> 8</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 9</span><span class="c"></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">chat</span><span class="p">).</span>
<span class="ln">10</span><span class="p">-</span><span class="ni">author</span><span class="p">(</span><span class="s">&#34;bnaod1&#34;</span><span class="p">).</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">gen_server</span><span class="p">).</span>
<span class="ln">13</span><span class="c">%% API
</span><span class="ln">14</span><span class="c"></span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">15</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">handle_cast</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
<span class="ln">16</span>
<span class="ln">17</span><span class="p">-</span><span class="ni">compile</span><span class="p">(</span><span class="n">export_all</span><span class="p">).</span>
<span class="ln">18</span><span class="c">%%-define(SERVER, server).
</span><span class="ln">19</span><span class="c"></span>
<span class="ln">20</span><span class="nf">start</span><span class="p">(</span><span class="nv">Sname</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">gen_server</span><span class="p">:</span><span class="nf">start_link</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Sname</span><span class="p">},</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]).</span>
<span class="ln">21</span><span class="nf">stop</span><span class="p">(</span><span class="nv">Sname</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Sname</span><span class="p">},</span> <span class="n">stop</span><span class="p">).</span>
<span class="ln">22</span>
<span class="ln">23</span><span class="nf">ask_for</span><span class="p">(</span><span class="nv">Sname</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">)</span> <span class="o">-</span><span class="p">{}</span><span class="o">&gt;</span> <span class="nn">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Sname</span><span class="p">},</span> <span class="p">{</span><span class="n">quest</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">}).</span>
<span class="ln">24</span>
<span class="ln">25</span><span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">already_to_run</span><span class="p">}.</span>
<span class="ln">26</span>
<span class="ln">27</span><span class="nf">handle_call</span><span class="p">({</span><span class="n">quest</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">},</span> <span class="nv">From</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">28</span>  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;receive msg from </span><span class="si">~p</span><span class="s">: </span><span class="si">~n~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">]),</span>
<span class="ln">29</span>  <span class="nv">Reply</span> <span class="o">=</span> <span class="s">&#34;got_it&#34;</span><span class="p">,</span>
<span class="ln">30</span>  <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">};</span>
<span class="ln">31</span><span class="nf">handle_call</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">32</span>  <span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">stopped</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">}.</span>
<span class="ln">33</span>
<span class="ln">34</span><span class="nf">handle_cast</span><span class="p">(_</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
<span class="ln">35</span><span class="nf">handle_info</span><span class="p">(_</span><span class="nv">Info</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
<span class="ln">36</span><span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">_</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ok</span><span class="p">.</span>
<span class="ln">37</span><span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVsn</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</code></pre></div><p>改进：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 2</span><span class="c">%%% @author bnaod1
</span><span class="ln"> 3</span><span class="c">%%% @copyright (C) 2024, 
</span><span class="ln"> 4</span><span class="c">%%% @doc
</span><span class="ln"> 5</span><span class="c">%%%
</span><span class="ln"> 6</span><span class="c">%%% @end
</span><span class="ln"> 7</span><span class="c">%%% Created : 2024 12月26. 14:47
</span><span class="ln"> 8</span><span class="c">%%%-------------------------------------------------------------------
</span><span class="ln"> 9</span><span class="c"></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">chat</span><span class="p">).</span>
<span class="ln">10</span><span class="p">-</span><span class="ni">author</span><span class="p">(</span><span class="s">&#34;赵枭奇&#34;</span><span class="p">).</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">gen_server</span><span class="p">).</span>
<span class="ln">13</span><span class="c">%% API
</span><span class="ln">14</span><span class="c"></span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">15</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">handle_cast</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
<span class="ln">16</span>
<span class="ln">17</span><span class="p">-</span><span class="ni">compile</span><span class="p">(</span><span class="n">export_all</span><span class="p">).</span>
<span class="ln">18</span><span class="c">%%-define(SERVER, server).
</span><span class="ln">19</span><span class="c"></span>
<span class="ln">20</span><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">state</span><span class="p">,</span> <span class="p">{</span><span class="n">conn_pid</span><span class="p">}).</span>
<span class="ln">21</span>
<span class="ln">22</span><span class="c">%% 创建genserver
</span><span class="ln">23</span><span class="c"></span><span class="nf">start</span><span class="p">(</span><span class="nv">SName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">gen_server</span><span class="p">:</span><span class="nf">start_link</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">SName</span><span class="p">},</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]).</span>
<span class="ln">24</span>
<span class="ln">25</span><span class="c">%% 交流前先握手获取Pid
</span><span class="ln">26</span><span class="c"></span><span class="nf">handshake</span><span class="p">(</span><span class="nv">FromName</span><span class="p">,</span> <span class="nv">ToName</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">27</span>  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;prepare handshake</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">),</span>
<span class="ln">28</span>  <span class="nn">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">FromName</span><span class="p">},</span> <span class="p">{</span><span class="n">quest</span><span class="p">,</span> <span class="nv">ToName</span><span class="p">}).</span>
<span class="ln">29</span>
<span class="ln">30</span><span class="c">%% 停止genserver
</span><span class="ln">31</span><span class="c"></span><span class="nf">stop</span><span class="p">(</span><span class="nv">SName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">gen_server</span><span class="p">:</span><span class="nf">cast</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">SName</span><span class="p">},</span> <span class="n">stop</span><span class="p">).</span>
<span class="ln">32</span>
<span class="ln">33</span><span class="c">%% 调试
</span><span class="ln">34</span><span class="c"></span><span class="nf">is_alive</span><span class="p">(</span><span class="nv">SName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">SName</span><span class="p">},</span> <span class="n">is_alive</span><span class="p">).</span>
<span class="ln">35</span>
<span class="ln">36</span><span class="c">%% 正式交流
</span><span class="ln">37</span><span class="c"></span><span class="nf">ask</span><span class="p">(</span><span class="nv">SName</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">gen_server</span><span class="p">:</span><span class="nf">cast</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">SName</span><span class="p">},</span> <span class="p">{</span><span class="n">ask</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">}).</span>
<span class="ln">38</span>
<span class="ln">39</span><span class="c">%% 初始化
</span><span class="ln">40</span><span class="c"></span><span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nl">#state</span><span class="p">{</span><span class="n">conn_pid</span> <span class="o">=</span> <span class="n">null</span><span class="p">}}.</span>
<span class="ln">41</span>
<span class="ln">42</span><span class="nf">handle_call</span><span class="p">({</span><span class="n">quest</span><span class="p">,</span> <span class="nv">SName</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">43</span>  <span class="nn">gen_server</span><span class="p">:</span><span class="nf">cast</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">SName</span><span class="p">},</span> <span class="p">{</span><span class="n">handshake</span><span class="p">,</span> <span class="n">self</span><span class="p">()}),</span>
<span class="ln">44</span>  <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="n">starting_handshake</span><span class="p">,</span> <span class="nv">State</span><span class="p">};</span>
<span class="ln">45</span><span class="nf">handle_call</span><span class="p">(</span><span class="n">is_alive</span><span class="p">,</span> <span class="nv">From</span><span class="p">,</span> <span class="nl">#state</span><span class="p">{</span><span class="n">conn_pid</span> <span class="o">=</span> <span class="nv">Pid</span><span class="p">}</span> <span class="o">=</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">46</span>  <span class="nv">Reply</span> <span class="o">=</span> <span class="p">{</span><span class="n">alive</span><span class="p">,</span> <span class="n">connected_process_is_</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">},</span>
<span class="ln">47</span>  <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
<span class="ln">48</span>
<span class="ln">49</span><span class="nf">handle_cast</span><span class="p">({</span><span class="n">handshake</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">},</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">50</span>  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;reply handshake</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">),</span>
<span class="ln">51</span>  <span class="nn">gen_server</span><span class="p">:</span><span class="nf">cast</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="p">{</span><span class="n">ack</span><span class="p">,</span> <span class="n">self</span><span class="p">()}),</span> 
<span class="ln">52</span>  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nl">#state</span><span class="p">{</span><span class="n">conn_pid</span> <span class="o">=</span> <span class="nv">Pid</span><span class="p">}};</span>
<span class="ln">53</span><span class="nf">handle_cast</span><span class="p">({</span><span class="n">ack</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">},</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">54</span>  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;handshake complete</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">),</span>
<span class="ln">55</span>  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nl">#state</span><span class="p">{</span><span class="n">conn_pid</span> <span class="o">=</span> <span class="nv">Pid</span><span class="p">}};</span>
<span class="ln">56</span><span class="nf">handle_cast</span><span class="p">({</span><span class="n">ask</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">},</span> <span class="nl">#state</span><span class="p">{</span><span class="n">conn_pid</span> <span class="o">=</span> <span class="nv">Pid</span><span class="p">}</span> <span class="o">=</span> <span class="nv">State</span><span class="p">)</span><span class="o">-&gt;</span>
<span class="ln">57</span>  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;send msg from </span><span class="si">~p</span><span class="s"> to </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Pid</span><span class="p">]),</span>
<span class="ln">58</span>  <span class="nn">gen_server</span><span class="p">:</span><span class="nf">cast</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="p">{</span><span class="n">communicate</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">}),</span>
<span class="ln">59</span>  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">};</span>
<span class="ln">60</span><span class="nf">handle_cast</span><span class="p">({</span><span class="n">communicate</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">},</span> <span class="nl">#state</span><span class="p">{</span><span class="n">conn_pid</span> <span class="o">=</span> <span class="nv">Pid</span><span class="p">}</span> <span class="o">=</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">61</span>  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;get msg from </span><span class="si">~p</span><span class="s">: </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">]),</span>
<span class="ln">62</span>  <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">};</span>
<span class="ln">63</span><span class="nf">handle_cast</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">64</span>  <span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="s">&#34;ask for stop&#34;</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
<span class="ln">65</span>
<span class="ln">66</span>
<span class="ln">67</span><span class="nf">handle_info</span><span class="p">(_</span><span class="nv">Info</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
<span class="ln">68</span><span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">_</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ok</span><span class="p">.</span>
<span class="ln">69</span><span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVsn</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
<span class="ln">70</span>
</code></pre></div><h3 id="练习-18">练习</h3>
<p>在下面这些练习里，我们将用job_centre模块制作一个服务器，它用gen_server实现一种任务管理服务。任务中心（job center）持有一个必须完成的任务队列，这些任务会被编号，任何人都能向队列添加任务。工人可以从队列请求任务，并告诉任务中心已经执行了某项任务。任务是由fun表示的，要执行任务F，工人必须执行F()函数。</p>
<p>(1) 实现任务中心的基本功能，它的接口如下。</p>
<ul>
<li>
<p>job_centre:start_link() -&gt; true</p>
<p>启动任务中心服务器。</p>
</li>
<li>
<p>job_centre:add_job(F) -&gt; JobNumber</p>
<p>添加任务F到任务队列，然后返回一个整数任务编号。</p>
</li>
<li>
<p>job_centre:work_wanted() -&gt; {JobNumber,F} | no</p>
<p>请求任务。如果工人想要一个任务，就调用job_centre:work_wanted()。如果队列里有任务，就会返回一个{JobNumber, F}元组。工人执行F()来完成任务。如果队列里没有任务，则会返回no。请确保同一项任务每次只分配给一个工人，并确保系统是公平的，意思是任务按照请求的顺序进行分配。</p>
</li>
<li>
<p>job_centre:job_done(JobNumber)</p>
<p>发出任务完成的信号。如果工人完成了某一项任务，就必须调用job_centre:job_done (JobNumber)。</p>
</li>
</ul>
<p>(2) 添加一个名为job_centre:statistics()的统计函数，让它报告队列内、进行中和已完成任务的状态。</p>
<p>(3) 添加监视工人进程的代码。如果某个工人进程挂了，请确保它所执行的任务被返回到等待完成的任务池里。</p>
<p>(4) 检查是否有懒惰的工人，也就是接受工作但不按时完成的进程。把任务请求函数修改为返回{JobNumber, JobTime, F}，其中JobTime是工人必须完成任务的秒数。如果工人在JobTime- 1时还未完成任务，服务器就应当向其发送一个hurry_up（快点儿）消息，而在JobTime + 1时应该用调用exit(Pid, youre_fired)（你被解雇了）来杀掉这个工人进程。</p>
<p>(5) 可选练习：实现一个工会服务器来监督工人的权利，防止他们没收到警告就被解雇。提示：使用进程跟踪基本函数来实现它。</p>
<h2 id="第23章-用otp构建系统">第23章 用OTP构建系统</h2>
<p>这一章也是非常重要。</p>
<h3 id="通用事件处理程序">通用事件处理程序</h3>
<p>event_handler.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">event_handler</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">make</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">add_handler</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">event</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="c">%% 制作一个名为Name的新事件处理器
</span><span class="ln"> 5</span><span class="c">%% 处理函数是no_op，代表部队事件做任何处理
</span><span class="ln"> 6</span><span class="c"></span><span class="nf">make</span><span class="p">(</span><span class="nv">Name</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>    <span class="nb">register</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">my_handler</span><span class="p">(</span><span class="k">fun</span> <span class="n">no_op</span><span class="o">/</span><span class="mi">1</span><span class="p">)</span> <span class="k">end</span><span class="p">)).</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="nf">add_handler</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Name</span> <span class="o">!</span> <span class="p">{</span><span class="n">add</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">}.</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="c">%%生成一个事件
</span><span class="ln">12</span><span class="c"></span><span class="nf">event</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Name</span> <span class="o">!</span> <span class="p">{</span><span class="n">event</span><span class="p">,</span> <span class="nv">X</span><span class="p">}.</span>
<span class="ln">13</span>
<span class="ln">14</span><span class="nf">my_handler</span><span class="p">(</span><span class="nv">Fun</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">15</span>    <span class="k">receive</span>
<span class="ln">16</span>        <span class="p">{</span><span class="n">add</span><span class="p">,</span> <span class="nv">Fun1</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">17</span>            <span class="n">my_handler</span><span class="p">(</span><span class="nv">Fun1</span><span class="p">);</span>
<span class="ln">18</span>        <span class="p">{</span><span class="n">event</span><span class="p">,</span> <span class="nv">Any</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">19</span>            <span class="p">(</span><span class="k">catch</span> <span class="nv">Fun</span><span class="p">(</span><span class="nv">Any</span><span class="p">)),</span>
<span class="ln">20</span>            <span class="n">my_handler</span><span class="p">(</span><span class="nv">Fun</span><span class="p">)</span>
<span class="ln">21</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">22</span>
<span class="ln">23</span><span class="nf">no_op</span><span class="p">(_)</span> <span class="o">-&gt;</span> <span class="n">void</span><span class="p">.</span>
</code></pre></div><p>motor_controller.erl: 定义错误处理函数</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">motor_controller</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">add_event_handler</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">add_event_handler</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">5</span>    <span class="nn">event_handler</span><span class="p">:</span><span class="nf">add_handler</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="k">fun</span> <span class="n">controller</span><span class="o">/</span><span class="mi">1</span><span class="p">).</span>
<span class="ln">6</span><span class="nf">controller</span><span class="p">(</span><span class="n">too_hot</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">7</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Turn off the motor</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln">8</span><span class="nf">controller</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">9</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;</span><span class="si">~w</span><span class="s"> ignored event: </span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="nv">X</span><span class="p">]).</span>
</code></pre></div><p>测试：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>1&gt; event_handler:make(errors).
<span class="ln"> 2</span>true
<span class="ln"> 3</span>2&gt; event_handler:event(errors, hi).
<span class="ln"> 4</span>{event,hi}
<span class="ln"> 5</span>3&gt; c(motor_controller).
<span class="ln"> 6</span>{ok, motor_controller}
<span class="ln"> 7</span>4&gt; motor_controller:add_event_handler().
<span class="ln"> 8</span>{add,#Fun...}
<span class="ln"> 9</span>5&gt; event_handler:event(errors, cool).
<span class="ln">10</span>motor_controller ignored event: cool
<span class="ln">11</span>{event, cool}
<span class="ln">12</span>6&gt; event_handler:event(errors, too_hot).
<span class="ln">13</span>Turn off the motor
<span class="ln">14</span>{event, too_hot}
</code></pre></div><h3 id="错误记录器">错误记录器</h3>
<p>OTP系统自带一个可定制的错误记录器。</p>
<p>错误记录器会生成多种报告类型。</p>
<ul>
<li>监控器报告
这些报告会在OTP监控器启动或停止被监控进程时生成（参见23.5节）。</li>
<li>进度报告
这些报告会在OTP监控器启动或停止时生成。</li>
<li>崩溃报告
如果某个被OTP行为启动的进程因为normal或shutdown以外的原因终止，这些报告就会
生成。</li>
</ul>
<p>这三种报告会自动生成，程序员无须做任何事。
另外，还可以显式调用error_logger模块里的方法来生成三种类型的日志报告。这让我们能够记录错误、警告和信息消息。这三个名词没什么语义含义，只是一些标签，程序员用它们来提示错误日志条目的性质。</p>
<h4 id="api">API</h4>
<ul>
<li>
<p><code>-spec error_logger:error_msg(String) -&gt; ok</code></p>
<p>向错误记录器发送一个错误消息。</p>
</li>
<li>
<p><code>-spec error_logger:error_msg(Format, Data) -&gt; ok</code></p>
<p>向错误记录器发送一个错误消息。它的参数和io:format(Format, Data)相同。</p>
</li>
<li>
<p><code>-spec error_logger:error_report(Report) -&gt; ok</code></p>
<p>向错误记录器发送一个标准错误报告。</p>
<p><code>-type Report = [{Tag, Data} | term() | string() ].</code></p>
<p><code>-type Tag = term().</code>
<code>-type Data = term().</code></p>
</li>
</ul>
<h4 id="配置">配置</h4>
<ol>
<li>标准错误记录器</li>
</ol>
<p>它会创建一个适合进行程序开发的环境，只提供一种简单的错误记录形式。（不带启动参数的erl命令就等于erl -boot start_clean。）：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl -boot start_clean
</code></pre></div><p>它会创建一个适合运行生产系统的环境。系统架构支持库（System Architecture SupportLibraries，简称SASL）将负责错误记录和过载保护等工作。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl -boot start_sasl
</code></pre></div><p>日志文件的配置最好通过配置文件实现，因为没人能记住记录器的全部参数。</p>
<ol start="2">
<li>无配置SASL</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl -boot start_sasl
</code></pre></div><ol start="3">
<li>配置错误记录器</li>
</ol>
<p>下面的配置文件启动系统，就只会得到错误报告，不会有进度和其他报告。所有这些错误报告只会出现在shell里。</p>
<p>elog1.config:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="c">%% 无tty
</span><span class="ln">2</span><span class="c"></span><span class="p">[{</span><span class="n">sasl</span><span class="p">,</span> <span class="p">[</span>
<span class="ln">3</span>         <span class="p">{</span><span class="n">sasl_error_logger</span><span class="p">,</span> <span class="n">false</span><span class="p">}</span>
<span class="ln">4</span>        <span class="p">]}].</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl -boot start_sasl -config elog1
</code></pre></div><p>下面的配置在shell里列出错误报告，所有的进度报告则会保存在一个文件里。</p>
<p>elog2.config:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="c">%% 单文本文件，最小化tty
</span><span class="ln">2</span><span class="c"></span>
<span class="ln">3</span><span class="p">[{</span><span class="n">sasl</span><span class="p">,</span> <span class="p">[</span>
<span class="ln">4</span>         <span class="c">%% 所有报告都写入这个文件
</span><span class="ln">5</span><span class="c"></span>         <span class="p">{</span><span class="n">sasl_error_logger</span><span class="p">,</span> <span class="p">{</span><span class="n">file</span><span class="p">,</span> <span class="s">&#34;/Users/joe/error_logs/THELOG&#34;</span><span class="p">}}</span>
<span class="ln">6</span>        <span class="p">]}].</span>
</code></pre></div><p>下面的配置既能提供shell输出，又能把写入shell的所有信息复制到一个滚动日志文件里。</p>
<p>elog3.config:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">[{</span><span class="n">sasl</span><span class="p">,</span> <span class="p">[</span>
<span class="ln"> 2</span>         <span class="p">{</span><span class="n">sasl_error_logger</span><span class="p">,</span> <span class="n">false</span><span class="p">},</span>
<span class="ln"> 3</span>         <span class="c">%% 定义滚动日志的参数
</span><span class="ln"> 4</span><span class="c"></span>         <span class="c">%% 日志文件目录
</span><span class="ln"> 5</span><span class="c"></span>         <span class="p">{</span><span class="n">error_logger_mf_dir</span><span class="p">,</span> <span class="s">&#34;/Users/joe/error_logs&#34;</span><span class="p">},</span>
<span class="ln"> 6</span>         <span class="c">%% 每个文件的字节数 10MB
</span><span class="ln"> 7</span><span class="c"></span>         <span class="p">{</span><span class="n">error_logger_mf_maxbytes</span><span class="p">,</span> <span class="mi">10485760</span><span class="p">},</span> 
<span class="ln"> 8</span>         <span class="c">%% 日志文件的最大数量
</span><span class="ln"> 9</span><span class="c"></span>         <span class="p">{</span><span class="n">error_logger_mf_maxfiles</span><span class="p">,</span> <span class="mi">10</span><span class="p">}</span>
<span class="ln">10</span>        <span class="p">]}].</span>
</code></pre></div><p>在生产环境里，我们真正感兴趣的只有错误，而非进度或信息报告，所以只让错误记录器报告错误。</p>
<p>elog4.config:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">[{</span><span class="n">sasl</span><span class="p">,</span> <span class="p">[</span>
<span class="ln"> 2</span>         <span class="c">%% 最小化shell错误记录
</span><span class="ln"> 3</span><span class="c"></span>         <span class="p">{</span><span class="n">sasl_error_logger</span><span class="p">,</span> <span class="n">false</span><span class="p">},</span>
<span class="ln"> 4</span>         <span class="c">%% 只报告错误
</span><span class="ln"> 5</span><span class="c"></span>         <span class="p">{</span><span class="n">errlog_type</span><span class="p">,</span> <span class="n">error</span><span class="p">},</span>
<span class="ln"> 6</span>         <span class="c">%% 定义滚动日志的参数
</span><span class="ln"> 7</span><span class="c"></span>         <span class="c">%% 日志文件目录
</span><span class="ln"> 8</span><span class="c"></span>         <span class="p">{</span><span class="n">error_logger_mf_dir</span><span class="p">,</span><span class="s">&#34;/User/joe/error_lgos&#34;</span><span class="p">},</span>
<span class="ln"> 9</span>         <span class="c">%% 每个日志文件的字节数
</span><span class="ln">10</span><span class="c"></span>         <span class="p">{</span><span class="n">error_logger_mf_maxbytes</span><span class="p">,</span><span class="mi">10485760</span><span class="p">},</span>
<span class="ln">11</span>         <span class="c">%% 日志文件的最大数量
</span><span class="ln">12</span><span class="c"></span>         <span class="p">{</span><span class="n">error_logger_mf_maxfiles</span><span class="p">,</span> <span class="mi">10</span><span class="p">}</span>
<span class="ln">13</span>        <span class="p">]}].</span>
</code></pre></div><h4 id="分析错误">分析错误</h4>
<p>阅读错误日志是rb模块的责任</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>erl -boot start_sasl -config elog3
<span class="ln"> 2</span>%% 首先必须用正确的配置文件启动Erlang，这样才能定位错误日志
<span class="ln"> 3</span>rb:help().
<span class="ln"> 4</span>
<span class="ln"> 5</span>%% 启动报告浏览器
<span class="ln"> 6</span>rb:start().
<span class="ln"> 7</span>
<span class="ln"> 8</span>%% 告诉它要读取多少日志条目
<span class="ln"> 9</span>rb:start([{max,20}]).
<span class="ln">10</span>
<span class="ln">11</span>%% 列出日志里的条目
<span class="ln">12</span>rb:list().
<span class="ln">13</span>
<span class="ln">14</span>%% 检查第8条
<span class="ln">15</span>rb:show(8).
</code></pre></div><p>要分离出某个错误，可以使用rb:grep(RegExp)这样的命令，它会找出所有匹配正则表达式RegExp的报告。</p>
<p>rb模块里有一些函数能选择特定类型的错误或把它们提取到文件里。因此，分析错误日志的过程可以实现完全自动化。</p>
<h3 id="警报管理">警报管理</h3>
<p>这个警报处理器是OTPgen_event行为的回调模块</p>
<p>my_alarm_handler.erl</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">my_alarm_handler</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">gen_event</span><span class="p">).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">handle_event</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="c">%% init必须返回{ok, State}
</span><span class="ln"> 7</span><span class="c"></span><span class="nf">init</span><span class="p">(</span><span class="nv">Args</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 8</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;*** my_alarm_handler init:</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Args</span><span class="p">]),</span>
<span class="ln"> 9</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="mi">0</span><span class="p">}.</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="nf">handle_event</span><span class="p">({</span><span class="n">set_alarm</span><span class="p">,</span> <span class="n">tooHot</span><span class="p">},</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">12</span>    <span class="nn">error_logger</span><span class="p">:</span><span class="nf">error_msg</span><span class="p">(</span><span class="s">&#34;*** Tell the Engineer to turn on the fan</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">),</span>
<span class="ln">13</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">N</span><span class="p">};</span>
<span class="ln">14</span><span class="nf">handle_event</span><span class="p">({</span><span class="n">clear_alarm</span><span class="p">,</span> <span class="n">tooHot</span><span class="p">},</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">15</span>    <span class="nn">error_logger</span><span class="p">:</span><span class="nf">error_msg</span><span class="p">(</span><span class="s">&#34;*** Danger over. Turn off the fan</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">),</span>
<span class="ln">16</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">N</span><span class="p">};</span>
<span class="ln">17</span><span class="nf">handle_event</span><span class="p">(</span><span class="nv">Event</span><span class="p">,</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">18</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;*** unmatched event:</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Event</span><span class="p">]),</span>
<span class="ln">19</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">N</span><span class="p">}.</span>
<span class="ln">20</span>
<span class="ln">21</span><span class="nf">handle_call</span><span class="p">(_</span><span class="nv">Request</span><span class="p">,</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Reply</span> <span class="o">=</span> <span class="nv">N</span><span class="p">,</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">N</span><span class="p">}.</span>
<span class="ln">22</span><span class="nf">handle_info</span><span class="p">(_</span><span class="nv">Info</span><span class="p">,</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">N</span><span class="p">}.</span>
<span class="ln">23</span>
<span class="ln">24</span><span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">_</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ok</span><span class="p">.</span>
<span class="ln">25</span><span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVsn</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</code></pre></div><p>这段代码非常像之前在22.3节里看到的 gen_server 回调代码。其中值得注意的方法是handle_event(Event, State) ，它应当返回 {ok, NewState} 。 Event 是一个 {EventType,Event-Arg}形式的元组，其中EventType是set_event或clear_event，而EventArg是一个用户提供的参数。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>erl -boot start_sasl -config elog3
<span class="ln"> 2</span>&gt; alarm_handler:set_alarm(tooHot).
<span class="ln"> 3</span>ok
<span class="ln"> 4</span>=INFO REPORT=====
<span class="ln"> 5</span>alarm:handler: {set,tooHot}
<span class="ln"> 6</span>&gt; gen_event:swap_handler(alarm_handler, {alarm_handler, swap},
<span class="ln"> 7</span>										{my_alarm_handler, xyz}).
<span class="ln"> 8</span>&gt; alarm_handler:set_alarm(tooHot).
<span class="ln"> 9</span>ok
<span class="ln">10</span>=ERROR ERPORT ====
<span class="ln">11</span>*** Tell the Engineet to turn on the fan
<span class="ln">12</span>&gt; alarm_handler:clear_alarm(tooHot).
<span class="ln">13</span>ok
<span class="ln">14</span>=ERROR ERPORT ====
<span class="ln">15</span>*** Danger over. Turn off the fan
</code></pre></div><h3 id="应用程序服务器">应用程序服务器</h3>
<p>两个gen_server服务器，不抄了。</p>
<h3 id="监控树">监控树</h3>
<p>监控树是一种由进程组成的树形结构。树的上级进程（监控器）监视着下级进程（工作器），
如果下级进程挂了就会重启它们。监控树有两种：</p>
<ul>
<li>一对一监控树
在一对一监控里，如果某个工作器崩溃了，就会被监控器重启。</li>
<li>一对多监控树
在一对多监控里，如果任何一个工作器崩溃了，所有工作进程都会被终止（通过调用相
应回调模块里的terminate/2函数）然后重启。</li>
</ul>
<p>监控器是用OTP supervisor行为创建的。这个行为用一个回调模块作为参数，里面指定了监
控策略以及如何启动监控树里的各个工作进程。监控树通过以下形式的函数指定：</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nf">init</span><span class="p">(...)</span> <span class="o">-&gt;</span>
<span class="ln">2</span>            <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">{</span>
<span class="ln">3</span>                  <span class="p">{</span><span class="nv">RestartStrategy</span><span class="p">,</span> <span class="nv">MaxRestarts</span><span class="p">,</span> <span class="nv">Time</span><span class="p">},</span>
<span class="ln">4</span>                  <span class="p">[</span><span class="nv">Worker1</span><span class="p">,</span> <span class="nv">Worker2</span><span class="p">,</span> <span class="p">...]</span>
<span class="ln">5</span>                 <span class="p">}}.</span>
</code></pre></div><ul>
<li>RestartStrategy是原子one_for_one或one_for_all</li>
<li>MaxRestarts和Time则指定“重启频率”。如果一个监控器在Time秒内执行了超过MaxRestarts次重启，那么这个监控器就会终止所有工作进程然后退出。这是为了防止出现一种情形，即某个进程崩溃、被重启，然后又因为相同原因崩溃而形成的无限循环。</li>
<li>Worker1和Worker2这些是描述如何启动各个工作进程的元组</li>
</ul>
<p>示例：</p>
<p>sellaprime_supervisor.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">sellaprime_supervisor</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">supervisor</span><span class="p">).</span>
<span class="ln"> 3</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_in_shell_for_testing</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_link</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>         	<span class="nn">supervisor</span><span class="p">:</span><span class="nf">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">},</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">_</span><span class="nv">Arg</span> <span class="o">=</span> <span class="p">[])</span>
<span class="ln"> 8</span>         <span class="k">end</span><span class="p">).</span>
<span class="ln"> 9</span><span class="nf">start_in_shell_for_testing</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln">10</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">}</span> <span class="o">=</span> <span class="nn">supervisor</span><span class="p">:</span><span class="nf">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">},</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">_</span><span class="nv">Arg</span> <span class="o">=</span> <span class="p">[]),</span>
<span class="ln">11</span>    <span class="nb">unlink</span><span class="p">(</span><span class="nv">Pid</span><span class="p">).</span>
<span class="ln">12</span><span class="nf">start_link</span><span class="p">(</span><span class="nv">Args</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">13</span>    <span class="nn">supervisor</span><span class="p">:</span><span class="nf">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">},</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="nv">Args</span><span class="p">).</span>
<span class="ln">14</span>
<span class="ln">15</span><span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span>
<span class="ln">16</span>    <span class="nn">gen_event</span><span class="p">:</span><span class="nf">swap_handler</span><span class="p">(</span><span class="n">alarm_handler</span><span class="p">,</span>
<span class="ln">17</span>                           <span class="p">{</span><span class="n">alarm_handler</span><span class="p">,</span> <span class="n">swap</span><span class="p">},</span>
<span class="ln">18</span>                           <span class="p">{</span><span class="n">my_alarm_handler</span><span class="p">,</span> <span class="n">xyz</span><span class="p">}),</span>
<span class="ln">19</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">{{</span><span class="n">one_for_one</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span>
<span class="ln">20</span>          <span class="p">[{</span><span class="n">tag1</span><span class="p">,</span>
<span class="ln">21</span>           	<span class="p">{</span><span class="n">area_server</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[]},</span>
<span class="ln">22</span>            <span class="n">permanet</span><span class="p">,</span>
<span class="ln">23</span>           	<span class="mi">10000</span><span class="p">,</span>
<span class="ln">24</span>            <span class="n">worker</span><span class="p">,</span>
<span class="ln">25</span>            <span class="p">[</span><span class="n">area_server</span><span class="p">]},</span>
<span class="ln">26</span>           <span class="p">{</span><span class="n">tag2</span><span class="p">,</span>
<span class="ln">27</span>           	<span class="p">{</span><span class="n">prime_server</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[]},</span>
<span class="ln">28</span>            <span class="n">permanet</span><span class="p">,</span>
<span class="ln">29</span>           	<span class="mi">10000</span><span class="p">,</span>
<span class="ln">30</span>            <span class="n">worker</span><span class="p">,</span>
<span class="ln">31</span>            <span class="p">[</span><span class="n">prime_server</span><span class="p">]}</span>
<span class="ln">32</span>          <span class="p">]}}.</span>
</code></pre></div><ul>
<li>
<p>init/1返回的数据结构定义了一种监控策略。</p>
</li>
<li>
<p>Worker中的参数的意义</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>{Tag, {Mod, Func, ArgList},
<span class="ln">2</span>     Restart,
<span class="ln">3</span>     Shutdown,
<span class="ln">4</span>     Type,
<span class="ln">5</span>     [Mod1]}
</code></pre></div><p><code>Tag</code>：这是一个原子类型的标签，将来可以用它指代工作进程（如果有必要的话）。</p>
<p><code>{Mod, Func, ArgList}</code>：定义了监控器用于启动工作器的函数，将被用作apply(Mod, Fun, ArgList)的参数。</p>
<p><code>Restart = permanent | transient | temporary</code>：permanent（永久）进程总是会被重启transient（过渡）进程只有在以非正常退出值终止时才会被重启。temporary（临时）进程不会被重启。</p>
<p><code>Shutdown</code>：这是关闭时间，也就是工作器终止过程允许耗费的最长时间。如果超过这个时间，工作进程就会被杀掉。</p>
<p><code>Type = worker | supervisor</code>：这是被监控进程的类型。可以用监控进程代替工作进程来构建一个由监控器组成的树。</p>
<p><code>[Mod1]</code>：如果子进程是监控器或者gen_server行为的回调模块，就在这里指定回调模块名。</p>
</li>
</ul>
<h3 id="启动系统">启动系统</h3>
<p>后面才是真正的启动。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl -boot start_sasl -config elog3
<span class="ln">2</span>1&gt; sellaprime_supervisor:start_in_shell_for_testing().
<span class="ln">3</span>2&gt; area_server:area({square,10}).
<span class="ln">4</span>3&gt; area_server:area({rectangle,10,20}).
<span class="ln">5</span>4&gt; area_server:area({square,25}).
<span class="ln">6</span>5&gt; prime_server:new_prime(20).
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>rb:start([{max,20}]).
<span class="ln">2</span>rb:list().
<span class="ln">3</span>rb:show(5).
</code></pre></div><h3 id="应用程序">应用程序</h3>
<h4 id="最后的工作">最后的工作</h4>
<p>编写一个扩展名为.app的文件，它包含关于这个应用程序的信息。</p>
<p>这是应用程序资源文件，用于&rsquo;base&rsquo;应用程序。</p>
<p>sellaprime.app:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>{application, sellaprime,
<span class="ln">2</span> [{description, &#34;The Prime Number Shop&#34;},
<span class="ln">3</span>  {vsn, &#34;1.0&#34;},
<span class="ln">4</span>  {modules, [sellaprime_app, sellaprime_supervisor, area_server, prime_server, lib_lin, lib_primes, my_alarm_handler]},
<span class="ln">5</span>  {registered, [area_server, prime_server, sellaprime_super]},
<span class="ln">6</span>  {applications, [kernel, stdlib]},
<span class="ln">7</span>  {mod, {sellaprime_app, []}},
<span class="ln">8</span>  {start_phases, []}
<span class="ln">9</span> ]}.
</code></pre></div><p>现在必须编写一个回调模块，它的名称与前面文件里的mod文件名相同</p>
<p>sellaprime_app.erl</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">sellaprime_app</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">application</span><span class="p">).</span>
<span class="ln">3</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">stop</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">4</span><span class="nf">start</span><span class="p">(_</span><span class="nv">Type</span><span class="p">,</span> <span class="nv">StartArgs</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">5</span>    <span class="nn">sellaprime_supervisor</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(</span><span class="nv">StartArgs</span><span class="p">).</span>
<span class="ln">6</span><span class="nf">stop</span><span class="p">(_</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">7</span>    <span class="n">ok</span><span class="p">.</span>
</code></pre></div><p>它必须导出函数start/2和stop/1。做完这一切之后，就可以在shell里启动和停止应用程序了。</p>
<p>启动！:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl -boot start_sasl -config elog3
<span class="ln">2</span>1&gt; application:loaded_applications().
<span class="ln">3</span>2&gt; application:load(sellaprime).
<span class="ln">4</span>3&gt; application:loaded_applications().
<span class="ln">5</span>4&gt; application:start(sellaprime).
<span class="ln">6</span>5&gt; application:stop(sellaprime).
<span class="ln">7</span>6&gt; application:unload(sellaprime).
</code></pre></div><p>现在它就是一个功能完备的OTP应用程序了。我们在第2行里载入了应用程序，这么做会载入全部代码，但不会启动应用程序。第4行启动了应用程序，第5行则停止了它。请注意，启动和停止应用程序时我们能看到打印输出，因为它调用了面积服务器和质数服务器里相应的回调函数。在第6行卸载了应用程序，这样应用程序里的所有模块代码都被移除了。用OTP构建复杂的系统时，会把它们打包成应用程序。这样我们就能统一启动、停止和管理它们。</p>
<h4 id="调用路径">调用路径</h4>
<table>
<thead>
<tr>
<th>文件</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>area_server.erl</td>
<td>面积服务器（gen_server回调模块）</td>
</tr>
<tr>
<td>prime_server.erl</td>
<td>质数服务器（gen_server回调模块）</td>
</tr>
<tr>
<td>sellaprime_supervisor.erl</td>
<td>监控器回调模块</td>
</tr>
<tr>
<td>sellaprime_app.erl</td>
<td>应用程序回调模块</td>
</tr>
<tr>
<td>my_alam_handler.erl</td>
<td>用于gen_event的事件回调模块</td>
</tr>
<tr>
<td>sellaprime.app</td>
<td>应用程序规范</td>
</tr>
<tr>
<td>elog4.config</td>
<td>错误记录器配置文件</td>
</tr>
</tbody>
</table>
<p>(1) 用下列命令启动系统：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>erl -boot -start_sasl -config elog4.config
<span class="ln">2</span>1&gt; application:start(sellaprime).
</code></pre></div><p>sellaprime.app文件必须位于Erlang的启动根目录或它的子目录里。
应用程序控制器随后在sellaprime.app里寻找一个{mod, &hellip;}声明。它包含应用程序控制器的名称，在这个案例里是模块sellaprime_app。</p>
<p>(2) 回调方法sellaprime_app:start/2被调用。</p>
<p>(3) sellaprime_app:start/2 调 用 sellaprime_supervisor:start_link/2 ， 启 动sellaprime监控器。</p>
<p>(4) 监控器回调函数sellaprime_supervisor:init/1被调用，它会安装一个错误处理器，然后返回一个监控规范。这个监控规范说明了如何启动面积服务器和质数服务器。</p>
<p>(5) sellaprime监控器启动面积服务器和质数服务器，两者都是gen_server的回调模块。停止这一切很容易，只需要调用application:stop(sellaprime)或init:stop()。</p>
<h3 id="应用程序监视器">应用程序监视器</h3>
<p>应用程序监视器是一个用来查看应用程序的GUI。appmon:start()命令会启动应用程序查看器。</p>
<h3 id="练习-19">练习</h3>
<p>(1) 制作一个名为prime_tester_server的gen_server，让它测试给定的数字是否是质数。你可以使用lib_primes.erl里的is_prime/2函数来处理（或者自己实现一个更好的质数测试函数）。把它添加sellaprime_supervisor.erl的监控树里。</p>
<p>(2) 制作由10个质数测试服务器组成的进程池。制作一个队列服务器来把请求加入队列，直到其中一个质数测试服务器处于空闲状态为止。当质数测试服务器空闲时，向它发送一个请求来测试某个数字是否是质数。</p>
<p>(3) 修改质数测试服务器的代码，让它们各自维护一个请求队列，然后移除队列服务器。编写一个负载均衡器来记录各个质数测试服务器中正在进行的任务和待完成请求。测试新质数的请求现在应该发送到负载均衡器。安排负载均衡器把请求发送给负载最小的服务器。</p>
<p>(4) 实现一种监控层级体系，使任何质数测试服务器崩溃后都能被重启。如果负载均衡器崩溃了，就让所有质数测试服务器都崩溃，然后全体重启。</p>
<p>(5) 使全体重启所需的数据在两台机器上同步复制。</p>
<p>(6) 实现一种重启策略，使整台机器崩溃后也能全体重启。</p>
<h2 id="第24章-编程术语">第24章 编程术语</h2>
<p>counter.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">counter</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">bump</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">read</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">bump</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="p">{</span><span class="n">counter</span><span class="p">,</span> <span class="nv">K</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">counter</span><span class="p">,</span> <span class="nv">N</span> <span class="o">+</span> <span class="nv">K</span><span class="p">}.</span>
<span class="ln">5</span><span class="nf">read</span><span class="p">({</span><span class="n">counter</span><span class="p">,</span> <span class="nv">N</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="nv">N</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>1&gt; c(counter).
<span class="ln"> 2</span>{ok, counter}
<span class="ln"> 3</span>
<span class="ln"> 4</span>2&gt; C = {counter, 2}.
<span class="ln"> 5</span>{counter, 2}
<span class="ln"> 6</span>
<span class="ln"> 7</span>3&gt; C:read().
<span class="ln"> 8</span>2
<span class="ln"> 9</span>
<span class="ln">10</span>4&gt; C1 = C:bump(3).
<span class="ln">11</span>{counter, 5}
<span class="ln">12</span>
<span class="ln">13</span>5&gt; C1:read().
<span class="ln">14</span>5
</code></pre></div><p>对元组C和C1的调用代码来说，模块名counter和状态变量都是隐藏的。</p>
<p>adapter_db1.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">adapter_db1</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">new</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">store</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">lookup</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">new</span><span class="p">(</span><span class="n">dict</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="p">{</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">dict</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">new</span><span class="p">()};</span>
<span class="ln"> 6</span><span class="nf">new</span><span class="p">(</span><span class="n">lists</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>    <span class="p">{</span><span class="o">&gt;</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="p">[]}.</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="nf">store</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">,</span> <span class="p">{_,</span> <span class="n">dict</span><span class="p">,</span> <span class="nv">D</span><span class="p">})</span> <span class="o">-&gt;</span>
<span class="ln">10</span>    <span class="nv">D1</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">store</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">,</span> <span class="nv">D</span><span class="p">),</span>
<span class="ln">11</span>    <span class="p">{</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">dict</span><span class="p">,</span> <span class="nv">D1</span><span class="p">};</span>
<span class="ln">12</span><span class="nf">store</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">,</span> <span class="p">{_,</span> <span class="n">list</span><span class="p">,</span> <span class="nv">L</span><span class="p">})</span> <span class="o">-&gt;</span>
<span class="ln">13</span>    <span class="nv">L1</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">keystore</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">L</span><span class="p">,</span> <span class="p">{</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">}),</span>
<span class="ln">14</span>    <span class="p">{</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="nv">L1</span><span class="p">}.</span>
<span class="ln">15</span>
<span class="ln">16</span><span class="nf">lookup</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="p">{_,</span> <span class="n">dict</span><span class="p">,</span> <span class="nv">D</span><span class="p">})</span> <span class="o">-&gt;</span>
<span class="ln">17</span>    <span class="nn">dict</span><span class="p">:</span><span class="nf">find</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">D</span><span class="p">);</span>
<span class="ln">18</span><span class="nf">lookup</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="p">{_,</span> <span class="n">list</span><span class="p">,</span> <span class="nv">L</span><span class="p">})</span> <span class="o">-&gt;</span>
<span class="ln">19</span>    <span class="k">case</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">keysearch</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">20</span>        <span class="p">{</span><span class="n">value</span><span class="p">,</span> <span class="p">{</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">}}</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Val</span><span class="p">};</span>
<span class="ln">21</span>        <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">error</span>
<span class="ln">22</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>adapter_db1_test.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">adapter_db1_test</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">test</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln"> 3</span><span class="p">-</span><span class="ni">import</span><span class="p">(</span><span class="n">adapter_db1</span><span class="p">,</span> <span class="p">[</span><span class="n">new</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">store</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">lookup</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="nf">test</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="nv">M0</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">dict</span><span class="p">),</span>
<span class="ln"> 7</span>    <span class="nv">M1</span> <span class="o">=</span> <span class="nv">M0</span><span class="p">:</span><span class="nf">store</span><span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="n">val1</span><span class="p">),</span>
<span class="ln"> 8</span>    <span class="nv">M2</span> <span class="o">=</span> <span class="nv">M1</span><span class="p">:</span><span class="nf">store</span><span class="p">(</span><span class="n">key2</span><span class="p">,</span> <span class="n">val2</span><span class="p">),</span>
<span class="ln"> 9</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">val1</span><span class="p">}</span> <span class="o">=</span> <span class="nv">M2</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="n">key1</span><span class="p">),</span>
<span class="ln">10</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">val2</span><span class="p">}</span> <span class="o">=</span> <span class="nv">M2</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="n">key2</span><span class="p">),</span>
<span class="ln">11</span>    <span class="n">error</span> <span class="o">=</span> <span class="nv">M2</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="n">nokey</span><span class="p">),</span>
<span class="ln">12</span>    
<span class="ln">13</span>    <span class="nv">N0</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">lists</span><span class="p">),</span>
<span class="ln">14</span>    <span class="nv">N1</span> <span class="o">=</span> <span class="nv">N0</span><span class="p">:</span><span class="nf">store</span><span class="p">(</span><span class="nv">Key1</span><span class="p">,</span> <span class="n">val1</span><span class="p">),</span>
<span class="ln">15</span>    <span class="nv">N2</span> <span class="o">=</span> <span class="nv">N1</span><span class="p">:</span><span class="nf">store</span><span class="p">(</span><span class="n">key2</span><span class="p">,</span> <span class="n">val2</span><span class="p">),</span>
<span class="ln">16</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">val1</span><span class="p">}</span> <span class="o">=</span> <span class="nv">N2</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="n">key1</span><span class="p">),</span>
<span class="ln">17</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">val2</span><span class="p">}</span> <span class="o">=</span> <span class="nv">N2</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="n">key2</span><span class="p">),</span>
<span class="ln">18</span>    <span class="n">error</span> <span class="o">=</span> <span class="nv">N2</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="n">nokey</span><span class="p">),</span>
<span class="ln">19</span>    <span class="n">ok</span><span class="p">.</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nn">dict</span><span class="p">:</span><span class="nf">fetch</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">=</span> <span class="nv">Val</span> <span class="p">|</span> <span class="nv">EXIT</span>
<span class="ln">2</span><span class="nn">dict</span><span class="p">:</span><span class="nf">search</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">found</span><span class="p">,</span> <span class="nv">Val</span><span class="p">}</span> <span class="p">|</span> <span class="n">not_found</span><span class="p">.</span>
<span class="ln">3</span><span class="nn">dict</span><span class="p">:</span><span class="nf">is_key</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">=</span> <span class="nv">Boolean</span>
</code></pre></div><h3 id="练习-20">练习</h3>
<p>(1) 扩展adapter_db1里的适配器，使调用adapter_db1:new(persistent)能创建一个持久性数据存储的元组模块。</p>
<p>(2) 编写一种键值存储，让它把较小的值放入内存，把较大的值放入磁盘。制作一个适配器模块来实现它，并让这个模块与本章前面的适配器具有相同的接口。</p>
<p>(3) 编写一种键值存储，让它把各个键值对分为易失性存储和非易失性存储。调用put(Key,memory, Val)会把一个Key, Val对放入内存，put(Key, disk, Val)则会把数据存入磁盘。用一对进程来做这件事，一个用于易失性存储，另一个用于非易失性存储。重用本章前面的代码。</p>
<h2 id="第25章-第三方程序">第25章 第三方程序</h2>
<h3 id="rebar">rebar</h3>
<p>rebar涉及的东西只是23章的东西的一部分自动化。</p>
<h4 id="创建应用">创建应用</h4>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>rebar create-app appid=bertie
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">bertie</span><span class="p">).</span>
<span class="ln">2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln">3</span>
<span class="ln">4</span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Hello my name is Bertie</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">).</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>rebar compile
</code></pre></div><h4 id="整合外部程序与我们的代码">整合外部程序与我们的代码</h4>
<p>bertie/bertie.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">bertie</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
<span class="ln"> 5</span>    <span class="nv">Handle</span> <span class="o">=</span> <span class="nn">bitcask</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="s">&#34;bertie_database&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">read_write</span><span class="p">]),</span>
<span class="ln"> 6</span>    <span class="nv">N</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">(</span><span class="nv">Handle</span><span class="p">),</span>
<span class="ln"> 7</span>    <span class="n">store</span><span class="p">(</span><span class="nv">Handle</span><span class="p">,</span> <span class="nv">N</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
<span class="ln"> 8</span>    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Bertie has benn run </span><span class="si">~p</span><span class="s"> times</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="nv">N</span><span class="p">]),</span>
<span class="ln"> 9</span>    <span class="nn">bitcask</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Handle</span><span class="p">),</span>
<span class="ln">10</span>    <span class="nn">init</span><span class="p">:</span><span class="nf">stop</span><span class="p">().</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="nf">store</span><span class="p">(</span><span class="nv">Handle</span><span class="p">,</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">13</span>    <span class="nn">bitcask</span><span class="p">:</span><span class="nb">put</span><span class="p">(</span><span class="nv">Handle</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&#34;bertie_executions&#34;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nb">term_to_binary</span><span class="p">(</span><span class="nv">N</span><span class="p">)).</span>
<span class="ln">14</span><span class="nf">fetch</span><span class="p">(</span><span class="nv">Handle</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">15</span>    <span class="k">case</span> <span class="nn">bitcask</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="nv">Handle</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&#34;bertie_executions&#34;</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">16</span>        <span class="n">not_found</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">17</span>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)</span>
<span class="ln">18</span>    <span class="k">end</span><span class="p">.</span>
</code></pre></div><p>bertie/rebar.config:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>{deps, [
<span class="ln">2</span>	{bitcask, &#34;.*&#34;, {git, &#34;git://github.com/basho/bitcask.git&#34;, &#34;master&#34;}}
<span class="ln">3</span>]}.
</code></pre></div><p>bertie/Makefile:</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln">1</span><span class="nf">all</span><span class="o">:</span>
<span class="ln">2</span>	<span class="nb">test</span> -d deps <span class="o">||</span> rebar get-deps
<span class="ln">3</span>	rebar compile
<span class="ln">4</span>	@erl -noshell -pa <span class="s1">&#39;./deps/bitcask/ebin&#39;</span> -pa <span class="s1">&#39;./ebin&#39;</span> -s bertie start
</code></pre></div><p>rebar get-deps命令从GitHub获取bitcask并把它保存在名为deps的子目录里。bitcask自身需要一个名为meck的程序用于测试，这就是所谓的递归依赖。rebar会递归获取bitcask所需的各个依赖项，并把它们保存在deps子目录里。</p>
<p>makefile给命令行添加了一个-pa &lsquo;deps/bitcask/ebin&rsquo;标识，这样当程序启动时，bertie就能自动载入bitcask的代码。</p>
<h4 id="生成依赖项本地副本">生成依赖项本地副本</h4>
<p>~joe/nobackup/erlang_imports/rebar.config:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>{deps, [
<span class="ln">2</span>	{cowboy, &#34;.*&#34;, {git, &#34;git://..&#34;}},
<span class="ln">3</span>	{ranch, &#34;.*&#34;, {git, &#34;git://...&#34;}},
<span class="ln">4</span>	{bitcask, &#34;.*&#34;, {git, &#34;git://...&#34;}}
<span class="ln">5</span>]}.
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>rebar get-deps
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="nv">Home</span> <span class="o">=</span> <span class="nn">os</span><span class="p">:</span><span class="nf">getenv</span><span class="p">(</span><span class="s">&#34;HOME&#34;</span><span class="p">).</span>
<span class="ln">2</span><span class="nv">Dir</span> <span class="o">=</span> <span class="nv">Home</span> <span class="o">++</span> <span class="s">&#34;/nobackup/erlang_imports/deps&#34;</span><span class="p">,</span>
<span class="ln">3</span>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">L</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">list_dir</span><span class="p">(</span><span class="nv">Dir</span><span class="p">).</span>
<span class="ln">4</span><span class="nn">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">5</span>               <span class="nv">Path</span> <span class="o">=</span> <span class="nv">Dir</span> <span class="o">++</span> <span class="s">&#34;/&#34;</span> <span class="o">++</span> <span class="nv">I</span> <span class="o">++</span> <span class="s">&#34;/ebin&#34;</span><span class="p">,</span>
<span class="ln">6</span>               <span class="nn">code</span><span class="p">:</span><span class="nf">add_path</span><span class="p">(</span><span class="nv">Path</span><span class="p">)</span>
<span class="ln">7</span>           <span class="k">end</span><span class="p">,</span> <span class="nv">L</span><span class="p">).</span>
</code></pre></div><h3 id="练习-21">练习</h3>
<p>(1) 注册一个GitHub账号，然后按照本章开头的步骤来创建你自己的项目。</p>
<p>(2) 第二个cowboy示例可能是不安全的。用户可以通过CGI调用接口请求执行任意的Erlang模块。重新设计这个接口，让它只允许调用一组事先定义的模块。</p>
<p>(3) 对cowboy示例做一次安全审计，因为它的代码里有许多安全问题。例如被请求文件的值未经检查，这样用户就能访问Web服务器目录结构以外的文件。找到并修复这些安全问题。</p>
<p>(4) 任何主机都能连接到cowboy服务器。修改它的代码，让它只允许来自已知IP地址的主机连接。把这些主机保存到某种持久性数据库里，比如Mnesia或bitcask。记录某个特定主机进行了多少次连接。制作一个主机黑名单，登记那些在给定时间段内连接过于频繁的主机。</p>
<p>(5) 修改Web服务器，让它允许对通过CGI接口调用的模块进行动态重编译。在我们的示例里，echo.erl模块必须先编译才能调用。当某个模块通过CGI接口被调用时，读取其beam文件的时间戳并与对应.erl的时间戳进行比较，如有必要就重新编译和载入Erlang代码。</p>
<p>(6) rebar是把Erlang程序作为“独立”二进制文件分发的优秀范例。请把rebar的可执行文件复制到一个空白目录并重命名为rebar.zip（rebar其实是一个zip文件），然后解压缩并检查里面的内容。用cowboy示例代码制作你自己的自执行二进制文件。</p>
<h2 id="第26章-多核cpu编程">第26章 多核CPU编程</h2>
<h3 id="多核高效运行">多核高效运行</h3>
<h4 id="使用大量进程">使用大量进程</h4>
<h4 id="避免副作用">避免副作用</h4>
<p>通过在ets:new里使用某个选项，就能创建出一个public类型的表。如果你还记得的话，它的效果如下：
创建一个公共表，任何知道此表标识符的进程都能读取和写入这个表。这么做可能很危险，只有在以下条件得到满足时才是安全的：</p>
<ul>
<li>每次只能有一个进程写入表，其他进程可以读取表；</li>
<li>写入ETS表的进程是正确的，不会把错误数据写入表。</li>
</ul>
<p>系统一般不能满足这些条件，而是要靠程序逻辑。</p>
<p>注意1：ETS表的每一种操作都是原子式的，但一系列ETS操作无法作为一个原子单元执行。虽然不会损坏ETS表里的数据，但如果多个进程试图同时更新一个共享表而又没有协调好，就可能出现逻辑上不一致的表。
注意2：ETS表类型protected的安全性要高得多。只有一个进程（即所有者）能写入表，但可以有多个进程读取这个表。这一点由系统保证。但是请记住，即使只有一个进程能写入ETS表，如果它损坏了表里的数据，也会影响到所有读取这个表的进程。
如果你使用的ETS表类型是private，那么你的程序就是安全的。上述结论也适用于DETS。可以创建能被多个不同进程写入的共享式DETS表，但不鼓励这种做法。</p>
<p>ETS和DETS原本并不是为了独立使用而创建的，而是为了实现Mnesia。原本的意图是如果应用程序想要模拟进程间共享内存，就应该使用Mnesia的事务机制。</p>
<h4 id="避免顺序瓶颈">避免顺序瓶颈</h4>
<p>当我们使程序并行化，确保有大量进程并且没有共享内存操作后，接下来的问题就是思考顺序瓶颈。有些事情本来就是顺序的，如果问题本身具有“顺序性”，我们是无法改变这一点的。在很多时候，解决顺序瓶颈的唯一方式就是改变相关的算法，没有其他捷径可走。必须把非分布式算法修改成分布式算法。</p>
<p>要避免单个代理的瓶颈，可以设置两个订票代理。在销售开始时，第一个订票代理会得到所有偶数编号的票，第二个订票代理会得到所有奇数编号的票。通过这种方式，就能确保代理们不会两次销售同一张票。</p>
<p>这种把单个订票代理替换成n个分布式代理（n可以随时间而变），并且各个代理可以加入和离开售票网络以及随时崩溃的做法是当前热门的分布式计算研究领域。这个研究领域被称为分布式散列表（distributed hash tables）。</p>
<h3 id="并行的map函数及测试">并行的map函数及测试</h3>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">pmap</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="nv">S</span> <span class="o">=</span> <span class="n">self</span><span class="p">(),</span>
<span class="ln"> 3</span>    <span class="c">%% make_ref() 返回一个唯一的引用
</span><span class="ln"> 4</span><span class="c"></span>    <span class="nv">Ref</span> <span class="o">=</span> <span class="nn">erlang</span><span class="p">:</span><span class="nf">make_ref</span><span class="p">(),</span>
<span class="ln"> 5</span>    <span class="nv">Pids</span> <span class="o">=</span> <span class="n">map</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>               	<span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">do_f</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">I</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span>
<span class="ln"> 7</span>               <span class="k">end</span><span class="p">,</span> <span class="nv">L</span><span class="p">),</span>
<span class="ln"> 8</span>    <span class="c">%% 收集结果
</span><span class="ln"> 9</span><span class="c"></span>    <span class="n">gather</span><span class="p">(</span><span class="nv">Pids</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">).</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="nf">do_f</span><span class="p">(</span><span class="nv">Parent</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">12</span>    <span class="nv">Parent</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Ref</span><span class="p">,</span> <span class="p">(</span><span class="k">catch</span> <span class="nv">F</span><span class="p">(</span><span class="nv">I</span><span class="p">))}.</span>
<span class="ln">13</span><span class="nf">gather</span><span class="p">([</span><span class="nv">Pid</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">Ref</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">14</span>    <span class="k">receive</span>
<span class="ln">15</span>        <span class="p">{</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">,</span> <span class="nv">Ret</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">Ret</span><span class="p">|</span><span class="n">gather</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span><span class="nv">Ref</span><span class="p">)]</span>
<span class="ln">16</span>    <span class="k">end</span><span class="p">;</span>
<span class="ln">17</span><span class="nf">gather</span><span class="p">([],</span> <span class="p">_)</span> <span class="o">-&gt;</span>
<span class="ln">18</span>    <span class="p">[].</span>
</code></pre></div><p>gather函数里的选择性receive会确保返回值里的参数顺序符合原始列表的顺序</p>
<p>具有副作用的代码不能简单地用pmap取代map调用来实现并行。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="nf">pmap</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 2</span>    <span class="nv">S</span> <span class="o">=</span> <span class="n">self</span><span class="p">(),</span>
<span class="ln"> 3</span>    <span class="c">%% make_ref() 返回一个唯一的引用
</span><span class="ln"> 4</span><span class="c"></span>    <span class="nv">Ref</span> <span class="o">=</span> <span class="nn">erlang</span><span class="p">:</span><span class="nf">make_ref</span><span class="p">(),</span>
<span class="ln"> 5</span>    <span class="n">foreach</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>               	<span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">do_f1</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">I</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span>
<span class="ln"> 7</span>               <span class="k">end</span><span class="p">,</span> <span class="nv">L</span><span class="p">),</span>
<span class="ln"> 8</span>    <span class="c">%% 收集结果
</span><span class="ln"> 9</span><span class="c"></span>    <span class="n">gather</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nv">L</span><span class="p">),</span> <span class="nv">Ref</span><span class="p">,</span> <span class="p">[]).</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="nf">do_f1</span><span class="p">(</span><span class="nv">Parent</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">12</span>    <span class="nv">Parent</span> <span class="o">!</span> <span class="p">{</span><span class="nv">Ref</span><span class="p">,</span> <span class="p">(</span><span class="k">catch</span> <span class="nv">F</span><span class="p">(</span><span class="nv">I</span><span class="p">))}.</span>
<span class="ln">13</span><span class="nf">gather1</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">_,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">L</span><span class="p">;</span>
<span class="ln">14</span><span class="nf">gather1</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">15</span>    <span class="k">receive</span>
<span class="ln">16</span>        <span class="p">{</span><span class="n">ef</span><span class="p">,</span> <span class="nv">Ret</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">gather1</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nv">Ref</span><span class="p">,</span> <span class="p">[</span><span class="nv">Ret</span><span class="p">|</span><span class="nv">L</span><span class="p">])]</span>
<span class="ln">17</span>    <span class="k">end</span><span class="p">;</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="cp">#!/bin/sh
</span><span class="ln">2</span><span class="cp"></span><span class="nb">echo</span> <span class="s2">&#34;&#34;</span> &gt; results
<span class="ln">3</span><span class="k">for</span> i in <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> 7...<span class="se">\
</span><span class="ln">4</span><span class="se"></span>		 <span class="m">17</span> <span class="m">18</span> ... <span class="m">32</span>
<span class="ln">5</span><span class="k">do</span>
<span class="ln">6</span>	<span class="nb">echo</span> <span class="nv">$i</span>
<span class="ln">7</span>	erl -boot start_clean -noshell -smp +S <span class="nv">$i</span><span class="se">\
</span><span class="ln">8</span><span class="se"></span>		-s ptests tests <span class="nv">$i</span> &gt;&gt; results
<span class="ln">9</span><span class="k">done</span>
</code></pre></div><p>ptests.erl:</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">ptests</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">tests</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">fib</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="ln"> 3</span><span class="p">-</span><span class="ni">import</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span> <span class="p">[</span><span class="n">map</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 4</span><span class="p">-</span><span class="ni">import</span><span class="p">(</span><span class="n">lib_misc</span><span class="p">,</span> <span class="p">[</span><span class="n">pmap</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="nf">tests</span><span class="p">([</span><span class="nv">N</span><span class="p">])</span> <span class="o">-&gt;</span>
<span class="ln"> 7</span>    <span class="nv">Nsched</span> <span class="o">=</span> <span class="nb">list_to_integer</span><span class="p">(</span><span class="n">atom_to_lists</span><span class="p">(</span><span class="nv">N</span><span class="p">)),</span>
<span class="ln"> 8</span>    <span class="n">run_tests</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">Nsched</span><span class="p">).</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="c">%% 一次运行test 1 2 3
</span><span class="ln">11</span><span class="c"></span><span class="nf">run_tests</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Nsched</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">12</span>    <span class="k">case</span> <span class="n">test</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">13</span>        <span class="n">stop</span> <span class="o">-&gt;</span>
<span class="ln">14</span>            <span class="nn">init</span><span class="p">:</span><span class="nf">stop</span><span class="p">();</span>
<span class="ln">15</span>        <span class="nv">Val</span> <span class="o">-&gt;</span>
<span class="ln">16</span>            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;</span><span class="si">~p</span><span class="s">.</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">[{</span><span class="nv">Nsched</span><span class="p">,</span> <span class="nv">Val</span><span class="p">}]),</span>
<span class="ln">17</span>            <span class="n">run_tests</span><span class="p">(</span><span class="nv">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">Nsched</span><span class="p">)</span>
<span class="ln">18</span>                
<span class="ln">19</span><span class="nf">test</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">20</span>    <span class="n">seed</span><span class="p">(),</span>
<span class="ln">21</span>    <span class="nv">S</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span>
<span class="ln">22</span>    <span class="nv">L</span> <span class="o">=</span> <span class="n">map</span><span class="p">(</span><span class="k">fun</span><span class="p">(_)</span> <span class="o">-&gt;</span> <span class="n">mkList</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">S</span><span class="p">),</span>
<span class="ln">23</span>    <span class="p">{</span><span class="nv">Time1</span><span class="p">,</span> <span class="nv">S1</span><span class="p">}</span> <span class="o">=</span> <span class="nn">timer</span><span class="p">:</span><span class="nf">tc</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="p">[</span><span class="k">fun</span> <span class="nn">lists</span><span class="p">:</span><span class="n">sort</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nv">L</span><span class="p">]),</span>
<span class="ln">24</span>    <span class="p">{</span><span class="nv">Time2</span><span class="p">,</span> <span class="nv">S2</span><span class="p">}</span> <span class="o">=</span> <span class="nn">timer</span><span class="p">:</span><span class="nf">tc</span><span class="p">(</span><span class="n">lib_misc</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span> <span class="p">[</span><span class="k">fun</span> <span class="nn">lists</span><span class="p">:</span><span class="n">sort</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nv">L</span><span class="p">]),</span>
<span class="ln">25</span>    <span class="p">{</span><span class="n">sort</span><span class="p">,</span> <span class="nv">Time1</span><span class="p">,</span> <span class="nv">Time2</span><span class="p">,</span> <span class="n">euqal</span><span class="p">(</span><span class="nv">S1</span><span class="p">,</span> <span class="nv">S2</span><span class="p">)};</span>
<span class="ln">26</span><span class="nf">test</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">27</span>    <span class="nv">L</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">duplicate</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span>
<span class="ln">28</span>    <span class="p">{</span><span class="nv">Time1</span><span class="p">,</span> <span class="nv">S1</span><span class="p">}</span> <span class="o">=</span> <span class="nn">timer</span><span class="p">:</span><span class="nf">tc</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="p">[</span><span class="k">fun</span> <span class="nn">ptests</span><span class="p">:</span><span class="n">fib</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nv">L</span><span class="p">]),</span>
<span class="ln">29</span>    <span class="p">{</span><span class="nv">Time2</span><span class="p">,</span> <span class="nv">S2</span><span class="p">}</span> <span class="o">=</span> <span class="nn">timer</span><span class="p">:</span><span class="nf">tc</span><span class="p">(</span><span class="n">lib_misc</span><span class="p">,</span> <span class="n">pmap</span><span class="p">,</span> <span class="p">[</span><span class="k">fun</span> <span class="nn">lists</span><span class="p">:</span><span class="n">sort</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nv">L</span><span class="p">]),</span>
<span class="ln">30</span>    <span class="p">{</span><span class="n">fib</span><span class="p">,</span> <span class="nv">Time1</span><span class="p">,</span> <span class="nv">Time2</span><span class="p">,</span> <span class="n">euqal</span><span class="p">(</span><span class="nv">S1</span><span class="p">,</span> <span class="nv">S2</span><span class="p">)};</span>
<span class="ln">31</span><span class="nf">test</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">32</span>    <span class="n">stop</span><span class="p">.</span>
<span class="ln">33</span>
<span class="ln">34</span><span class="c">%% 测试map和pmap的计算结果时候相等
</span><span class="ln">35</span><span class="c"></span><span class="nf">equal</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span><span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">true</span><span class="p">;</span>
<span class="ln">36</span><span class="nf">equal</span><span class="p">(</span><span class="nv">S1</span><span class="p">,</span> <span class="nv">S2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">differ</span><span class="p">,</span> <span class="nv">S1</span><span class="p">,</span> <span class="nv">S2</span><span class="p">}.</span>
<span class="ln">37</span>
<span class="ln">38</span><span class="nf">fib</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">39</span><span class="nf">fib</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">40</span><span class="nf">fib</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">fib</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">2</span><span class="p">).</span>
<span class="ln">41</span>
<span class="ln">42</span><span class="c">%% 重置随机数生成器，这样每次测试都能获得相同的随机数序列
</span><span class="ln">43</span><span class="c"></span><span class="nf">seed</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">random</span><span class="p">:</span><span class="nf">seed</span><span class="p">(</span><span class="mi">44</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">66</span><span class="p">).</span>
<span class="ln">44</span>
<span class="ln">45</span><span class="nf">mkList</span><span class="p">(</span><span class="nv">K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mkList</span><span class="p">(</span><span class="nv">K</span><span class="p">,</span> <span class="p">[]).</span>
<span class="ln">46</span>
<span class="ln">47</span><span class="nf">mkList</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">L</span><span class="p">;</span>
<span class="ln">48</span><span class="nf">mkList</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mkList</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="nn">random</span><span class="p">:</span><span class="nf">uniform</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span> <span class="p">|</span> <span class="nv">L</span><span class="p">]).</span>
</code></pre></div><h3 id="mapreduce">mapreduce</h3>
<p>mapreduce的基本概念：这些映射（map）进程会生成由{Key,Value}对组成的消息流，并发送给一个化简（reduce）进程进行合并，后者会把具有相同键的对组合在一起。</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln">1</span><span class="p">-</span><span class="ni">spec</span> <span class="n">mapreduce</span><span class="p">(</span><span class="nv">F1</span><span class="p">,</span> <span class="nv">F2</span><span class="p">,</span> <span class="nv">Acc0</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Acc</span>
<span class="ln">2</span>    <span class="nv">F1</span> <span class="o">=</span> <span class="n">funn</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">void</span>
<span class="ln">3</span>    <span class="nv">F2</span> <span class="o">=</span> <span class="k">fun</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="p">[</span><span class="nv">Value</span><span class="p">],</span> <span class="nv">Acc0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Acc</span>
<span class="ln">4</span>    <span class="nv">L</span> <span class="o">=</span> <span class="p">[</span><span class="nv">X</span><span class="p">]</span>
<span class="ln">5</span>    <span class="nv">Acc</span> <span class="o">=</span> <span class="nv">X</span> <span class="o">=</span> <span class="n">term</span><span class="p">()</span>
</code></pre></div><ul>
<li>F1(Pid, X)是映射函数。
F1的任务是发送一个{Key, Value}消息流到Pid进程，然后终止。mapreduce会为列表L里的每一个X值分裂出一个全新进程。</li>
<li>F2(Key, [Value], Acc0) -&gt; Acc是化简函数。
当所有映射进程都终止时，化简函数就应该已经合并某个键的所有值了。mapreduce随后对收集的各个{Key, [Value]}元组调用F2(Key, [Value], Acc)。Acc是一个初始值为Acc0 的归集器， F2 会返回一个新的归集器。（另一种描述方式是 F2 对收集的 {Key, [Value]}元组执行了折叠操作。）
Acc0是归集器的初始值，在调用F2时使用。</li>
<li>L是一个由X值组成的列表。
F1(Pid, X)会被用于L里的每一个X值。Pid是化简进程的标识符，它是由mapreduce创建的。</li>
</ul>
<p>mapreduce是在phofs（parallel higher-order functions的简写，即并行高阶函数）模块里定
义的：phofs.erl</p>
<div class="highlight"><pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="ln"> 1</span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">phofs</span><span class="p">).</span>
<span class="ln"> 2</span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">mapreduce</span><span class="o">/</span><span class="mi">4</span><span class="p">]).</span>
<span class="ln"> 3</span><span class="p">-</span><span class="ni">import</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span> <span class="p">[</span><span class="n">foreach</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="nf">mapreduce</span><span class="p">(</span><span class="nv">F1</span><span class="p">,</span> <span class="nv">F2</span><span class="p">,</span> <span class="nv">Acc0</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln"> 6</span>    <span class="nv">S</span> <span class="o">=</span> <span class="n">self</span><span class="p">(),</span>
<span class="ln"> 7</span>    <span class="nv">Pid</span><span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">reduce</span><span class="p">(</span><span class="nv">S</span><span class="p">,</span> <span class="nv">F1</span><span class="p">,</span> <span class="nv">F2</span><span class="p">,</span> <span class="nv">Acc0</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
<span class="ln"> 8</span>    <span class="k">receive</span>
<span class="ln"> 9</span>        <span class="p">{</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Result</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">10</span>            <span class="nv">Result</span>
<span class="ln">11</span>    <span class="k">end</span><span class="p">.</span>
<span class="ln">12</span>
<span class="ln">13</span><span class="nf">reduce</span><span class="p">(</span><span class="nv">Parent</span><span class="p">,</span> <span class="nv">F1</span><span class="p">,</span> <span class="nv">F2</span><span class="p">,</span> <span class="nv">Acc0</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">14</span>    <span class="nb">process_flag</span><span class="p">(</span><span class="n">trap_exit</span><span class="p">,</span> <span class="n">true</span><span class="p">),</span>
<span class="ln">15</span>    <span class="nv">ReducePid</span> <span class="o">=</span> <span class="n">self</span><span class="p">(),</span>
<span class="ln">16</span>    <span class="n">foreach</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">17</span>           		<span class="nb">spawn_link</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">do_job</span><span class="p">(</span><span class="nv">ReducePid</span><span class="p">,</span> <span class="nv">F1</span><span class="p">,</span> <span class="nv">X</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span>
<span class="ln">18</span>            <span class="k">end</span><span class="p">,</span> <span class="nv">L</span><span class="p">),</span>
<span class="ln">19</span>    <span class="nv">N</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="nv">L</span><span class="p">),</span>
<span class="ln">20</span>    <span class="nv">Dict0</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">new</span><span class="p">(),</span>
<span class="ln">21</span>    <span class="nv">Dict1</span> <span class="o">=</span> <span class="n">collect_replies</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Dict0</span><span class="p">),</span>
<span class="ln">22</span>    <span class="nv">Acc</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">fold</span><span class="p">(</span><span class="nv">F2</span><span class="p">,</span> <span class="nv">Acc0</span><span class="p">,</span> <span class="nv">Dict1</span><span class="p">),</span>
<span class="ln">23</span>    <span class="nv">Parent</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">Acc</span><span class="p">}.</span>
<span class="ln">24</span>
<span class="ln">25</span><span class="nf">collect_replies</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">26</span>    <span class="nv">Dict</span><span class="p">;</span>
<span class="ln">27</span><span class="nf">collect_replies</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">28</span>    <span class="k">receive</span>
<span class="ln">29</span>        <span class="p">{</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">30</span>            <span class="k">case</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">is_key</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span> <span class="k">of</span>
<span class="ln">31</span>                <span class="n">true</span> <span class="o">-&gt;</span>
<span class="ln">32</span>                    <span class="nv">Dict1</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">append</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">),</span>
<span class="ln">33</span>                    <span class="n">collect_replies</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Dict1</span><span class="p">);</span>
<span class="ln">34</span>                <span class="n">false</span> <span class="o">-&gt;</span>
<span class="ln">35</span>                    <span class="nv">Dict1</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="nf">store</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="p">[</span><span class="nv">Val</span><span class="p">],</span> <span class="nv">Dict</span><span class="p">),</span>
<span class="ln">36</span>                    <span class="n">collect_replies</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Dict1</span><span class="p">)</span>
<span class="ln">37</span>             <span class="k">end</span><span class="p">;</span>
<span class="ln">38</span>        <span class="p">{</span><span class="n">&#39;EXIT&#39;</span><span class="p">,</span> <span class="p">_,</span> <span class="p">_</span><span class="nv">Why</span><span class="p">}</span> <span class="o">-&gt;</span>
<span class="ln">39</span>            <span class="n">collect_replies</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">Dict</span><span class="p">)</span>
<span class="ln">40</span>     <span class="k">end</span><span class="p">.</span>
<span class="ln">41</span>
<span class="ln">42</span><span class="nf">do_job</span><span class="p">(</span><span class="nv">ReducePid</span><span class="p">,</span> <span class="nv">F</span><span class="p">,</span> <span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="ln">43</span>    <span class="nv">F</span><span class="p">(</span><span class="nv">ReducePid</span><span class="p">,</span> <span class="nv">X</span><span class="p">).</span>
</code></pre></div><h3 id="练习-22">练习</h3>
<p>(1) 我们在17.1.1节里编写了一个获取网页的程序。修改这个程序，用HEAD命令取代GET命令。可以通过发送HTTP HEAD命令来测量网站的响应时间。服务器响应HEAD命令时只会返回网页的头部，不会返回主体。编写一个名为web_profiler:ping(URL, Timeout)的函数来测量URL这个网站地址的响应速度。它应当返回{time, T}或者timeout。</p>
<p>(2) 制作一个包含大量网站的列表 L ，记录 lists:map(fun(I) -&gt; web_profiler:ping(URL, Timeout) end, L) 所 花 费 的 时 间 。 它 也 许 会 运 行 很 久 ， 最 坏 情 况 下 是 Timeout xlength(L)。</p>
<p>(3) 用pmap代替map重复刚才的计时。现在所有的HEAD请求都应当是并行的。因此，最坏情况下的响应时间就是Timeout。</p>
<p>(4) 把结果保存在一个数据库里，然后制作一个Web接口来查询这个数据库。可以从第24章里开发的数据库和Web服务器代码入手。</p>
<p>(5) 如果你用一个超长的元素列表调用pmap，就可能会创建出过多的并行进程。编写一个名为pmap(F, L, Max)的函数来并行计算列表[F(I) || I &lt;- L]，但限制它同时最多只能运行Max个并行进程。</p>
<p>(6) 编写一个新版的pmap，让它能工作在分布式Erlang上，把任务分派给多个Erlang节点</p>
<p>(7) 编写一个新版的pmap，让它能工作在分布式Erlang上，把任务分派给多个Erlang节点，并且实现各个节点之间的任务负载均衡。</p>
<h2 id="第27章-福尔摩斯的最后一案">第27章 福尔摩斯的最后一案</h2></div><hr /><div class="post-navs d-flex mb-3 justify-content-between">
  <div class="post-nav w-50"><div class="prev-post btn btn-sm">
      <a href="/posts/other/2024/">2024年终总结和来年展望
</a>
    </div></div>
  <div class="post-nav flex-row-reverse"><div class="next-post btn btn-sm">
      <a href="/posts/tech/media-rebar2/">rebar2构建工具学习
</a>
    </div></div>
</div><section class="related-posts">
    <h3>相关文章</h3>
    <ul class="related-posts"><li><a href="/posts/tech/media-computer-systems/">《深入理解计算机系统》
</a></li><li><a href="/posts/other/physics-computer/">计算机和物理的一点感悟
</a></li><li><a href="/posts/tech/media-ffmpeg/">FFmpeg媒体处理软件学习
</a></li><li><a href="/posts/tech/media-sox/">Sox媒体处理软件基本使用
</a></li><li><a href="/posts/tech/media-pcmu/">pcmu编码学习
</a></li></ul>
  </section></article>




<div id="vcomments" class="post-comments surface row">
</div>
    <script>
        new Valine({
            el: '#vcomments',
            appId: '18xpdRPZMKmyTjmjtMIK8zyB-gzGzoHsz',
            appKey: 'haH3Ysz9ic7RFcoqbIvPDh8H',
            avatar:'retro',
            visitor:true,
            placeholder:'有什么想说的吗？'

        });

        var count = 0;
        var domTimer = setInterval(function () {
            if (++count > 50) clearInterval(domTimer);
            if (document.querySelector('#veditor')) {
                clearInterval(domTimer);
                var cdraw = new CaveDraw({
                    element: "#veditor",
                    readOnlyMode: false, 
                    afterUpdateEditor: ()=>{ 
                        document.querySelector('#veditor').focus();
                        document.querySelector('#veditor').blur();
                    },
                    controls: ['brush', 'eraser', 'bucket', 'clear', 'undo', 'redo', 'save']
                });
            }
        }, 200);
    </script></div>
</div><aside class="col-lg-4 sidebar d-flex">
  <div class="container"><section class="profile surface row">
  <div class="col-xl-6 d-flex align-items-center justify-content-center">
    <img class="profile-avatar img-fluid" src="/images/profile2.jpg" alt="理想奈" loading="lazy">
  </div>
  <div class="col-xl-6">
    <h5 class="profile-name my-2">理想奈</h5><div class="profile-bio mb-2">我目前通过计算机赚钱，其他时候搞数学、阅读、美食。</div>
    
  </div>
</section><section class="recent-posts row surface">
  <h4>最近文章</h4>
  <ul><li><a href="/posts/tech/media-erlang-eunit/">eunit测试框架学习
</a></li><li><a href="/posts/tech/media-tcpdump/">tcpdump抓包工具学习
</a></li><li><a href="/posts/tech/media-msml/">MSML语言学习
</a></li><li><a href="/posts/tech/media-netpackage-observe/">观察SIP， SDP，RTP包及MSML
</a></li><li><a href="/posts/tech/media-sipp/">SIPP测试工具学习
</a></li><li><a href="/posts/tech/media-sip/">SIP协议学习
</a></li><li><a href="/posts/tech/media-rebar2/">rebar2构建工具学习
</a></li><li><a href="/posts/tech/media-erlang/">《Erlang程序设计》
</a></li><li><a href="/posts/other/2024/">2024年终总结和来年展望
</a></li><li><a href="/posts/tech/media-computer-systems/">《深入理解计算机系统》
</a></li><li><a href="/posts/other/physics-computer/">计算机和物理的一点感悟
</a></li><li><a href="/posts/tech/media-ffmpeg/">FFmpeg媒体处理软件学习
</a></li><li><a href="/posts/tech/media-pcmu/">pcmu编码学习
</a></li></ul>
</section><section class="taxonomy-categories row surface">
      <h4>
        <a href="/categories">分类</a>
      </h4>
      <div><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="计算机">
          计算机 <span class="badge rounded-pill">43</span>
        </a><a href="/categories/%E4%BA%8C%E6%AC%A1%E5%85%83/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="二次元">
          二次元 <span class="badge rounded-pill">24</span>
        </a><a href="/categories/%E6%99%AE%E9%80%9A%E7%B1%BB/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="普通类">
          普通类 <span class="badge rounded-pill">9</span>
        </a><a href="/categories/%E6%96%87%E5%AD%97%E7%B1%BB/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="文字类">
          文字类 <span class="badge rounded-pill">6</span>
        </a><a href="/categories/%E6%95%B0%E5%AD%A6%E7%B1%BB/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="数学类">
          数学类 <span class="badge rounded-pill">2</span>
        </a></div>
    </section><section class="taxonomy-series row surface">
      <h4>
        <a href="/series">专栏</a>
      </h4>
      <div><a href="/series/%E5%AA%92%E4%BD%93%E5%BC%80%E5%8F%91/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="媒体开发">
          媒体开发 <span class="badge rounded-pill">28</span>
        </a><a href="/series/%E5%8A%A8%E6%BC%AB%E6%AD%8C%E6%9B%B2/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="动漫歌曲">
          动漫歌曲 <span class="badge rounded-pill">21</span>
        </a><a href="/series/galgame/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Galgame">
          Galgame <span class="badge rounded-pill">10</span>
        </a><a href="/series/java/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Java">
          Java <span class="badge rounded-pill">10</span>
        </a><a href="/series/%E9%9A%8F%E6%84%8F%E6%80%9D%E8%80%83/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="随意思考">
          随意思考 <span class="badge rounded-pill">2</span>
        </a></div>
    </section></div>
</aside>
</div>
    </main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav my-2 justify-content-center"></nav>
<div class="copyright mb-2">
  Copyright © 2021-2025 Unaybaryl. All Rights Reserved.
</div>
</footer>
<a id="btnScrollToTop" class="btn-scroll-to-top">
  <i class="fas fa-fw fa-chevron-circle-up fa-2x"></i>
</a>



              
            </body>
</html>
