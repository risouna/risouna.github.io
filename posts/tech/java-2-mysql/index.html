<!doctype html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MySQL学习笔记 - 理想奈的博客</title><link rel="apple-touch-icon" href="/images/favicons/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/images/favicons/favicon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="/images/favicons/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/images/favicons/manifest.json">
<link rel="icon" href="/images/favicons/favicon.ico">
<meta name="keywords" content="" />
<meta name="description" content="" /><meta itemprop="name" content="MySQL学习笔记">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2024-05-25T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2024-05-25T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="23539">
<meta itemprop="keywords" content=",,," /><meta property="og:title" content="MySQL学习笔记" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/tech/java-2-mysql/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-05-25T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2024-05-25T00:00:00&#43;00:00" /><meta property="og:site_name" content="理想奈的博客" />
<meta property="og:see_also" content="/posts/tech/java-0-audition-4/" /><meta property="og:see_also" content="/posts/tech/java-0-audition-3/" /><meta property="og:see_also" content="/posts/tech/java-0-audition-2/" /><meta property="og:see_also" content="/posts/tech/java-6-autoconfiguration/" /><meta property="og:see_also" content="/posts/tech/java-5-algorithm/" /><meta property="og:see_also" content="/posts/tech/java-4-basic/" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MySQL学习笔记"/>
<meta name="twitter:description" content=""/>
<meta data-name="palette" content="blue"><link rel=stylesheet href="/css/bundle.min.d63d5781d5b3b2441c3e0c8ba081eb171c0ae292f799670fe6d38f68e3a2816d.css" integrity="sha256-1j1XgdWzskQcPgyLoIHrFxwK4pL3mWcP5tOPaOOigW0=" crossorigin="anonymous"><script src="/js/bundle.min.1c471eeba442e80350b91324d765b69b27af83f0de35d552aa2a410bac6ee793.js" integrity="sha256-HEce66RC6ANQuRMk12W2myevg/DeNdVSqipBC6xu55M=" crossorigin="anonymous"></script>
<script type="text/javascript">
	document.addEventListener("DOMContentLoaded", function() {
  renderMathInElement(document.body, {
    delimiters: [
      {left: "$$", right: "$$", display: true},
      {left: "$", right: "$", display: false}
    ],
    macros: {
      "\\ge": "\\geqslant",
      "\\le": "\\leqslant",
      "\\geq": "\\geqslant",
      "\\leq": "\\leqslant"
	}
  });
}); 
</script>
<meta property="og:type" content="index"/>
<meta property="og:title" content="Unzybaryl`s Sekai" />
<meta property="og:image" content="https://eustia.me/images/profile1.jpg" />
<meta property="og:url" content="https://eustia.me/" />





<script type="text/javascript" src="/js/Valine.min.js"></script>
<script type="text/javascript" src="/js/cave-draw.min.js"></script>
<link rel="stylesheet" type="text/css" href="/js/katex.min.css">
<script type="text/javascript" src="/js/katex.min.js"></script>
<script type="text/javascript" src="/js/auto-render.min.js"></script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" type="text/css" href="/js/font.css">

</head><body><header><nav class="navbar navbar-expand-xl fixed-top">
  <div class="container">
    <a class="navbar-brand" href="/">
      
      
      さぁ、君、取りたまえ
      
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-1 mb-2 mb-lg-0"><form class="search-bar d-flex ms-1" action="/search">
  <div class="input-group input-group-sm">
    <button class="btn btn-search disabled position-absolute left-0" type="submit"><i class="fas fa-fw fa-search"></i></button>
    <input class="form-control rounded-pill" id="searchQuery" name="q" type="search" aria-label="Search">
  </div>
</form></ul><ul class="navbar-nav me-1 mb-2 mb-lg-0 me-1 ms-auto"><li class="nav-item">
          <a class="nav-link" href="/archives">
            <i class="fas fa-fw fa-file-archive"></i>归档
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/about/">
            <i class="fas fa-fw fa-info-circle"></i>关于
          </a>
        </li><li class="nav-item">
          <a class="nav-link" href="/bin/">
            <i class="fas fa-fw fa-bookmark"></i>废案
          </a>
        </li><li class="nav-item">
  <a class="nav-link" data-bs-toggle="offcanvas" href="#offcanvasSettings" role="button"
    aria-controls="offcanvasSettings">
    <i class="fas fa-fw fa-sliders-h"></i> 设置
  </a>
</li>

<div class="offcanvas offcanvas-end surface h-100" tabindex="-1" id="offcanvasSettings"
  aria-labelledby="offcanvasSettingsLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" w id="offcanvasSettingsLabel"><i class="fas fa-fw fa-sliders-h"></i> 设置</h5>
    <a role="button" data-bs-dismiss="offcanvas" aria-label="Close">
      <span class="fas fa-2x fa-fw fa-times"></span>
    </a>
  </div>
  <div class="offcanvas-body"><section class="setting">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-adjust"></i> 模式</label>
    </div>
    <div class="col-auto ms-auto">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="modeSwitcher">
      </div>
    </div>
  </form>
</section>
<section class="setting">
  <form class="font-size-switcher-form row">
    <div class="col-auto">
      <label for="fontSize" class="form-label"><i class="fas fa-fw fa-font"></i> 字体大小</label>
    </div>
    <div class="col-auto ms-auto">
      <input type="range" class="form-range" min="-2" max="2" id="fontSize">
    </div>
  </form>
</section>

</div>
</div></ul>
    </div>
  </div>
</nav>
</header>
<main role="main" class="container">
      <div class="row content">
<div class="col-lg-8">
  <div class="container"><nav class="row" aria-label="breadcrumb">
  <ol class="breadcrumb surface"><li class="breadcrumb-item"><a href="/">主页</a></li><li class="breadcrumb-item"><a href="/posts/">文章</a></li><li class="breadcrumb-item"><a href="/posts/tech/">Tech</a></li><li class="breadcrumb-item active">MySQL学习笔记</li></ol>
</nav><article class="post row surface"><div class="post-panel-wrapper">
  <div class="post-panel d-flex flex-column">
    <a id="sidebarToggler" class="action d-none d-lg-block" role="button">
  <i class="fas fa-fw fa-expand-alt fa-rotate-45"></i>
</a>
  
    

    
    <a class="action" data-bs-container="body" data-bs-toggle="popover" data-bs-html="true" data-bs-placement="bottom"
  data-bs-trigger="focus" tabindex="0"
  data-bs-content="&lt;a target=&#34;_blank&#34; rel=&#34;license&#34; href=&#34;https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh&#34;&gt;CC BY-NC-ND 4.0 &lt;i class=&#34;fab fa-fw fa-creative-commons&#34;&gt;&lt;/i&gt;&lt;i class=&#34;fab fa-fw fa-creative-commons-by&#34;&gt;&lt;/i&gt;&lt;i class=&#34;fab fa-fw fa-creative-commons-nc&#34;&gt;&lt;/i&gt;&lt;i class=&#34;fab fa-fw fa-creative-commons-nd&#34;&gt;&lt;/i&gt;&lt;/a&gt;
">
  <i class="fas fa-fw fa-copyright"></i>
</a>
    <a id="btnTOC" class="fas fa-fw fa-list-alt" data-bs-toggle="offcanvas" href="#offcanvasTOC" aria-controls="offcanvasTOC" role="button">
</a>
  </div>
</div>
<h1 class="post-title my-3">MySQL学习笔记
</h1><div class="post-meta mb-3">
  <span class="post-date me-2">
    <i class="fas fa-fw fa-calendar-alt"></i>2024-05-25
  </span>
  <span class="post-reading-time me-2">
    <i class="fas fa-fw fa-coffee"></i>47 分钟阅读
  </span>
<a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" class="post-taxonomy">#计算机</a><a href="/series/java/" class="post-taxonomy">#Java</a></div>



                
                <div class="addthis_inline_share_toolbox"></div>
            <div class="offcanvas offcanvas-end surface" tabindex="-1" id="offcanvasTOC" aria-labelledby="offcanvasTOCLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasTOCLabel">目录</h5>
    <a role="button" data-bs-dismiss="offcanvas" aria-label="Close">
      <span class="fas fa-2x fa-fw fa-times"></span>
    </a>
  </div>
  <div class="offcanvas-body">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#sql语法">SQL语法</a>
      <ul>
        <li><a href="#ddl">DDL</a></li>
        <li><a href="#dml">DML</a></li>
        <li><a href="#dql">DQL</a></li>
        <li><a href="#dcl">DCL</a></li>
      </ul>
    </li>
    <li><a href="#函数">函数</a>
      <ul>
        <li><a href="#字符串函数">字符串函数</a></li>
        <li><a href="#数值函数">数值函数</a></li>
        <li><a href="#日期函数">日期函数</a></li>
        <li><a href="#流程控制函数">流程控制函数</a></li>
      </ul>
    </li>
    <li><a href="#约束">约束</a>
      <ul>
        <li><a href="#外键">外键</a></li>
        <li><a href="#删除更新行为">删除更新行为</a></li>
      </ul>
    </li>
    <li><a href="#多表查询">多表查询</a>
      <ul>
        <li><a href="#连接查询">连接查询</a></li>
        <li><a href="#联合查询">联合查询</a></li>
        <li><a href="#子查询">子查询</a></li>
      </ul>
    </li>
    <li><a href="#事务">事务</a>
      <ul>
        <li><a href="#管理事务">管理事务</a></li>
        <li><a href="#事务的四大特性acid">事务的四大特性ACID</a></li>
        <li><a href="#并发事务问题">并发事务问题</a></li>
        <li><a href="#事务的隔离级别">事务的隔离级别</a></li>
        <li><a href="#模拟并发问题">模拟并发问题</a></li>
      </ul>
    </li>
    <li><a href="#索引">索引</a>
      <ul>
        <li><a href="#存储引擎的特点">存储引擎的特点</a></li>
        <li><a href="#索引-1">索引</a></li>
        <li><a href="#索引结构">索引结构</a></li>
        <li><a href="#索引分类">索引分类</a></li>
        <li><a href="#索引语法">索引语法</a></li>
        <li><a href="#sql性能分析">SQL性能分析</a></li>
        <li><a href="#索引使用">索引使用</a></li>
      </ul>
    </li>
    <li><a href="#sql优化">SQL优化</a>
      <ul>
        <li><a href="#插入数据-insert优化">插入数据, insert优化</a></li>
        <li><a href="#主键优化">主键优化</a></li>
        <li><a href="#order-by-优化">order by 优化</a></li>
        <li><a href="#group-by-优化">group by 优化</a></li>
        <li><a href="#limit优化">limit优化</a></li>
        <li><a href="#count优化">count优化</a></li>
        <li><a href="#update优化">update优化</a></li>
      </ul>
    </li>
    <li><a href="#视图">视图</a></li>
    <li><a href="#存储过程函数触发器">存储过程/函数/触发器</a></li>
    <li><a href="#锁">锁</a>
      <ul>
        <li><a href="#全局锁">全局锁</a></li>
        <li><a href="#表级锁">表级锁</a></li>
        <li><a href="#行级锁">行级锁</a></li>
      </ul>
    </li>
    <li><a href="#innodb引擎事务原理mvcc">Innodb引擎/事务原理/MVCC</a></li>
  </ul>
</nav>
  </div>
</div><div class="post-content mb-3" ><h2 id="sql语法">SQL语法</h2>
<h3 id="ddl">DDL</h3>
<h4 id="ddl-数据库操作">DDL 数据库操作</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">SHOW</span> <span class="k">DATABASES</span><span class="p">;</span> <span class="c1">-- 查询所有数据库
</span><span class="ln">2</span><span class="c1"></span><span class="k">SELECT</span> <span class="k">DATABASE</span><span class="p">();</span> <span class="c1">-- 查询当前数据库
</span><span class="ln">3</span><span class="c1"></span><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">learndatabase</span> <span class="k">DEFAULT</span> <span class="kp">CHARSET</span> <span class="n">utf8mb4</span><span class="p">;</span> <span class="c1">-- 创建数据库
</span><span class="ln">4</span><span class="c1"></span><span class="k">USE</span> <span class="n">learndatabase</span><span class="p">;</span> <span class="c1">-- 使用数据库
</span><span class="ln">5</span><span class="c1"></span><span class="k">DROP</span> <span class="k">DATABASE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">learndatabase</span><span class="p">;</span> <span class="c1">-- 删除数据库
</span></code></pre></div><h4 id="ddl-表结构">DDL 表结构</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="k">SHOW</span> <span class="kp">TABLES</span><span class="p">;</span> <span class="c1">-- 查询数据库所有的表
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">DESC</span> <span class="n">tableName</span><span class="p">;</span> <span class="c1">-- 查询表结构
</span><span class="ln"> 3</span><span class="c1"></span><span class="k">SHOW</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">tableName</span><span class="p">;</span> <span class="c1">-- 查询表的建表语句
</span><span class="ln"> 4</span><span class="c1"></span>
<span class="ln"> 5</span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nf">tableName</span><span class="p">(</span> <span class="c1">-- 创建表
</span><span class="ln"> 6</span><span class="c1"></span>                          <span class="n">id</span> <span class="kt">INT</span> <span class="n">COMMENT</span> <span class="s1">&#39;编号&#39;</span><span class="p">,</span>
<span class="ln"> 7</span>                          <span class="n">name</span> <span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="n">COMMENT</span> <span class="s1">&#39;姓名&#39;</span><span class="p">,</span>
<span class="ln"> 8</span>                          <span class="n">age</span> <span class="kt">INT</span> <span class="n">COMMENT</span> <span class="s1">&#39;年龄&#39;</span><span class="p">,</span>
<span class="ln"> 9</span>                          <span class="n">gender</span> <span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">COMMENT</span> <span class="s1">&#39;性别&#39;</span>
<span class="ln">10</span><span class="p">)</span> <span class="n">COMMENT</span> <span class="s1">&#39;用户表&#39;</span><span class="p">;</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">tableName</span> <span class="k">ADD</span> <span class="n">nickname</span> <span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="n">COMMENT</span> <span class="s1">&#39;昵称&#39;</span><span class="p">;</span> <span class="c1">-- 修改表,添加字段
</span><span class="ln">13</span><span class="c1"></span><span class="k">alter</span> <span class="k">table</span> <span class="n">tb</span> <span class="k">add</span> <span class="kt">date</span> <span class="kt">DATE</span> <span class="n">comment</span> <span class="s1">&#39;入职日期&#39;</span><span class="p">;</span>
<span class="ln">14</span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">tableName</span> <span class="k">CHANGE</span> <span class="n">nickname</span> <span class="n">username</span> <span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="n">COMMENT</span> <span class="s1">&#39;用户名&#39;</span><span class="p">;</span> <span class="c1">-- 修改字段名,同时修改字段类型
</span><span class="ln">15</span><span class="c1"></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">tableName</span> <span class="n">MODIFY</span> <span class="n">username</span> <span class="kt">CHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span> <span class="c1">-- 修改数据类型
</span><span class="ln">16</span><span class="c1"></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">tableName</span> <span class="k">DROP</span> <span class="n">username</span><span class="p">;</span> <span class="c1">-- 删除字段username
</span><span class="ln">17</span><span class="c1"></span>
<span class="ln">18</span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">tableName</span> <span class="k">RENAME</span> <span class="k">TO</span> <span class="n">tb</span><span class="p">;</span> <span class="c1">-- 修改表名
</span><span class="ln">19</span><span class="c1"></span>
<span class="ln">20</span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">tableName</span><span class="p">;</span> <span class="c1">-- 删除表
</span><span class="ln">21</span><span class="c1"></span><span class="n">TRUNCATE</span> <span class="k">TABLE</span> <span class="n">tableName</span><span class="p">;</span> <span class="c1">-- 删除表,重新创建该表;其实就是清空数据
</span></code></pre></div><h4 id="数据类型">数据类型</h4>
<p>三大类:数值,字符串,日期.</p>
<ul>
<li>TINYINT 1byte 取值在-128,127,无符号在0,255. 于是age字段就可以这样: age TINYINT UNSIGNED</li>
<li>DOUBLE(4,1) 最长4为,允许出现1位小数 于是成绩字段score DOUBLE(4,1)</li>
<li>CHAR 定长字符串,性能高,没有的部分用空格填补,适合用变化不大的字段,如gender CHAR(1)</li>
<li>VARCHAR 变长字符串,对于字符串长度变化很大的字段比较适合,如 username VARCHAR(50)</li>
<li>DATE是年月日</li>
<li>TIME是时分秒</li>
<li>YEAR就是年;</li>
<li>DATETIME是年月日时分秒, birthday DATE</li>
<li>TIMESTAMP也是年月日时分秒,但是最大范围是2038年</li>
</ul>
<h3 id="dml">DML</h3>
<p>DML 数据操作语言INSERT UPDATE DELETE</p>
<h4 id="dml-insert">DML INSERT</h4>
<p>添加字符串,日期要加引号; 数据范围要符合要求</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 选择字段插入
</span><span class="ln">2</span><span class="c1"></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nf">tb</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="kt">date</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;赵四&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;男&#39;</span><span class="p">,</span> <span class="s1">&#39;四娘&#39;</span><span class="p">,</span> <span class="s1">&#39;2001-05-28&#39;</span><span class="p">);</span>
<span class="ln">3</span><span class="c1">-- 全部字段插入
</span><span class="ln">4</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">tb</span> <span class="k">values</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;张三&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;女&#39;</span><span class="p">,</span> <span class="s1">&#39;三爹&#39;</span><span class="p">,</span> <span class="s1">&#39;2005-05-05&#39;</span><span class="p">);</span>
<span class="ln">5</span><span class="c1">-- 插入多条数据
</span><span class="ln">6</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">tb</span> <span class="k">values</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;王五&#39;</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="s1">&#39;女&#39;</span><span class="p">,</span> <span class="s1">&#39;五爹&#39;</span><span class="p">,</span> <span class="s1">&#39;1998-12-15&#39;</span><span class="p">),(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;李四&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;男&#39;</span><span class="p">,</span> <span class="s1">&#39;四爹&#39;</span><span class="p">,</span> <span class="s1">&#39;1970-01-30&#39;</span><span class="p">);</span>
</code></pre></div><h4 id="dml-update">DML UPDATE</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">--  修改
</span><span class="ln">2</span><span class="c1"></span><span class="k">update</span> <span class="n">tb</span> <span class="kt">set</span> <span class="kt">date</span><span class="o">=</span><span class="s1">&#39;2010-09-01&#39;</span> <span class="k">where</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;赵四&#39;</span><span class="p">;</span>
<span class="ln">3</span><span class="k">update</span> <span class="n">tb</span> <span class="kt">set</span> <span class="n">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="kt">date</span><span class="o">=</span><span class="s1">&#39;2001-05-28&#39;</span> <span class="k">where</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;三爹&#39;</span><span class="p">;</span>
<span class="ln">4</span><span class="c1">-- 没有加where, 改所有数据
</span><span class="ln">5</span><span class="c1"></span><span class="k">update</span> <span class="n">tb</span> <span class="kt">set</span> <span class="kt">date</span><span class="o">=</span><span class="s1">&#39;2000-01-01&#39;</span>
</code></pre></div><h4 id="dml-delete">DML DELETE</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">--  删除
</span><span class="ln">2</span><span class="c1"></span><span class="k">delete</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">1</span> <span class="k">and</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;赵四&#39;</span><span class="p">;</span>
<span class="ln">3</span><span class="c1">-- 删除索引
</span><span class="ln">4</span><span class="c1"></span><span class="k">delete</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
</code></pre></div><h3 id="dql">DQL</h3>
<p>DQL 数据查询语言</p>
<ul>
<li>select 字段列表</li>
<li>from 表名列表</li>
<li>where 条件列表</li>
<li>group by 分组字段列表</li>
<li>having 分组后的条件列表</li>
<li>order by 排序字段列表</li>
<li>limit 分页参数</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 查询多个字段
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
<span class="ln">3</span><span class="c1">-- 查询所有, 写*效率不高,最好写出所有字段,清晰明了
</span><span class="ln">4</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
<span class="ln">5</span><span class="c1">-- 设置别名
</span><span class="ln">6</span><span class="c1"></span><span class="k">select</span> <span class="n">id</span> <span class="k">as</span> <span class="s1">&#39;爱迪&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="k">as</span> <span class="s1">&#39;姓名&#39;</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
<span class="ln">7</span><span class="c1">-- 查询去重
</span><span class="ln">8</span><span class="c1"></span><span class="k">select</span> <span class="k">distinct</span>  <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
</code></pre></div><h4 id="条件查询">条件查询</h4>
<ul>
<li>&gt;=, &lt;, &lt;= , = , !=(&lt;&gt;),  between and,  in, like(_单个字符,%任意字符), is null</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="c1">-- and or not, &amp;&amp; || !
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
<span class="ln"> 3</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span>
<span class="ln"> 4</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">;</span>
<span class="ln"> 5</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">username</span> <span class="k">is</span> <span class="no">null</span> <span class="p">;</span> <span class="c1">-- 查询没有username字段的数据
</span><span class="ln"> 6</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">username</span> <span class="k">is</span> <span class="k">not</span> <span class="no">null</span> <span class="p">;</span> <span class="c1">-- 查询有username字段的数据
</span><span class="ln"> 7</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">age</span> <span class="o">!=</span> <span class="mi">13</span><span class="p">;</span>
<span class="ln"> 8</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">age</span> <span class="o">&lt;&gt;</span> <span class="mi">13</span><span class="p">;</span>
<span class="ln"> 9</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">;</span>
<span class="ln">10</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">20</span> <span class="k">and</span> <span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">;</span>
<span class="ln">11</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">age</span> <span class="k">between</span> <span class="mi">10</span> <span class="k">and</span> <span class="mi">20</span><span class="p">;</span> <span class="c1">-- between and 包括最大值和最小值
</span><span class="ln">12</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">age</span><span class="o">=</span><span class="mi">10</span> <span class="k">or</span> <span class="n">age</span><span class="o">=</span><span class="mi">13</span> <span class="k">or</span> <span class="n">age</span><span class="o">=</span><span class="mi">20</span><span class="p">;</span>
<span class="ln">13</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">age</span> <span class="k">in</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span> <span class="c1">-- age在in里面的数其一即可
</span><span class="ln">14</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;__&#39;</span><span class="p">;</span> <span class="c1">-- 查询姓名只有两个字符的数据
</span><span class="ln">15</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">username</span> <span class="k">like</span>  <span class="s1">&#39;%x&#39;</span><span class="p">;</span> <span class="c1">-- 查询username最后一位是x的数据
</span></code></pre></div><h4 id="聚合函数">聚合函数</h4>
<p>聚合函数,将一列数据作为整体, 纵向计算</p>
<p>count-数量,  max min, avg-平均值, sum-求和</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 聚合函数不计算null值
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="nf">sum</span><span class="p">(</span><span class="n">age</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
<span class="ln">3</span><span class="k">select</span> <span class="nf">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
<span class="ln">4</span><span class="k">select</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
<span class="ln">5</span><span class="k">select</span> <span class="nf">avg</span><span class="p">(</span><span class="n">age</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
<span class="ln">6</span><span class="k">select</span> <span class="nf">max</span><span class="p">(</span><span class="n">age</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
<span class="ln">7</span><span class="k">select</span> <span class="nf">sum</span><span class="p">(</span><span class="n">age</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</code></pre></div><h4 id="分组查询">分组查询</h4>
<p>分组查询 group by, 分组之后一般查询分组字段和聚合函数, 其他的无意义</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">select</span> <span class="n">gender</span><span class="p">,</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">group</span> <span class="k">by</span> <span class="n">gender</span><span class="p">;</span> <span class="c1">-- 根据性别分组,分组后统计数量,相当于对每个组分别处理
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="n">gender</span><span class="p">,</span> <span class="nf">avg</span><span class="p">(</span><span class="n">age</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">group</span> <span class="k">by</span> <span class="n">gender</span><span class="p">;</span> <span class="c1">-- 性别分组,统计男女的平均年龄
</span><span class="ln">3</span><span class="c1"></span>
<span class="ln">4</span><span class="c1">-- where在分组前进行过滤, having在分组后过滤,having可以对聚合函数过滤,where不行.
</span><span class="ln">5</span><span class="c1">-- 虽然组合在一起的sql语句很麻烦,但是一步一步地加条件来看,就不麻烦了,sql就是在简单查询结果基础上一步一步处理的.
</span><span class="ln">6</span><span class="c1">-- 先where得到有条件的表,然后group by得到两行分组后的数据,最后对这两行数据进行having筛选.
</span><span class="ln">7</span><span class="c1"></span><span class="k">select</span> <span class="n">gender</span><span class="p">,</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">age</span><span class="o">&lt;=</span> <span class="mi">30</span> <span class="k">and</span> <span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="k">group</span> <span class="k">by</span> <span class="n">gender</span> <span class="k">having</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">;</span>
<span class="ln">8</span><span class="c1">-- 给聚合起别名
</span><span class="ln">9</span><span class="c1"></span><span class="k">select</span> <span class="n">gender</span><span class="p">,</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">gender_count</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">where</span> <span class="n">age</span><span class="o">&lt;=</span> <span class="mi">30</span> <span class="k">and</span> <span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="k">group</span> <span class="k">by</span> <span class="n">gender</span> <span class="k">having</span> <span class="n">gender_count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">;</span>
</code></pre></div><h4 id="排序查询">排序查询</h4>
<p>排序查询 order by</p>
<p>order by多字段,当第一个字段相同则按照第二个字段排序, asc升序 desc降序</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">order</span> <span class="k">by</span> <span class="n">age</span> <span class="k">asc</span><span class="p">;</span>
<span class="ln">2</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">order</span> <span class="k">by</span> <span class="n">age</span> <span class="k">desc</span><span class="p">;</span>
<span class="ln">3</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">order</span> <span class="k">by</span> <span class="kt">date</span> <span class="k">desc</span><span class="p">;</span>
<span class="ln">4</span><span class="c1">-- 先按照age升序,age相同再按照date降序排序
</span><span class="ln">5</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">order</span> <span class="k">by</span> <span class="n">age</span> <span class="k">asc</span> <span class="p">,</span><span class="kt">date</span> <span class="k">desc</span><span class="p">;</span>
</code></pre></div><h4 id="分页查询">分页查询</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 分页查询 limit 起始索引,查询记录数
</span><span class="ln">2</span><span class="c1">-- 起始索引从0开始, 起始索引=(查询页码-1)*每页记录数
</span><span class="ln">3</span><span class="c1">-- 如果是第一页数据,可以省略
</span><span class="ln">4</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">limit</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">;</span>
<span class="ln">5</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">limit</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">;</span>
</code></pre></div><p>DQL执行顺序:</p>
<p>编写顺序: select from where group by having order by limit</p>
<p>执行顺序: from where group by having select order by limit</p>
<h3 id="dcl">DCL</h3>
<p>DCL 数据控制语言 管理用户,控制访问</p>
<h4 id="dcl-管理用户">DCL 管理用户</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="c1">-- 查询用户
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">use</span> <span class="n">mysql</span><span class="p">;</span>
<span class="ln"> 3</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span><span class="p">;</span>
<span class="ln"> 4</span><span class="c1">-- 创建用户 用户名@主机名 后面是密码,创建的用户没有权限
</span><span class="ln"> 5</span><span class="c1">-- 创建用户bnaod,只能在当前主机访问,密码password
</span><span class="ln"> 6</span><span class="c1"></span><span class="k">create</span> <span class="k">user</span> <span class="s1">&#39;bnaod&#39;</span><span class="o">@</span><span class="s1">&#39;localhost&#39;</span> <span class="k">identified</span> <span class="k">by</span> <span class="s1">&#39;password&#39;</span><span class="p">;</span>
<span class="ln"> 7</span><span class="c1">-- 创建用户,在任意主机访问
</span><span class="ln"> 8</span><span class="c1"></span><span class="k">create</span> <span class="k">user</span> <span class="s1">&#39;bnaod&#39;</span><span class="o">@</span><span class="s1">&#39;%&#39;</span> <span class="k">identified</span> <span class="k">by</span> <span class="s1">&#39;password&#39;</span><span class="p">;</span>
<span class="ln"> 9</span><span class="c1">-- 修改用户密码
</span><span class="ln">10</span><span class="c1"></span><span class="k">alter</span> <span class="k">user</span> <span class="s1">&#39;bnaod&#39;</span><span class="o">@</span><span class="s1">&#39;localhost&#39;</span> <span class="k">identified</span> <span class="k">with</span> <span class="n">mysql_native_password</span> <span class="k">by</span> <span class="s1">&#39;newpassword&#39;</span><span class="p">;</span>
<span class="ln">11</span><span class="c1">-- 删除用户
</span><span class="ln">12</span><span class="c1"></span><span class="k">drop</span> <span class="k">user</span> <span class="s1">&#39;bnaod&#39;</span><span class="o">@</span><span class="s1">&#39;localhost&#39;</span><span class="p">;</span>
</code></pre></div><h4 id="dcl-权限控制">DCL 权限控制</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 查询权限
</span><span class="ln">2</span><span class="c1"></span><span class="k">show</span> <span class="n">grants</span> <span class="k">for</span> <span class="s1">&#39;bnaod&#39;</span><span class="o">@</span><span class="s1">&#39;localhost&#39;</span><span class="p">;</span>
<span class="ln">3</span><span class="c1">-- 授予权限 on后接数据库名.表名 *代替全部 如*.*表示所有数据库的所有表 后面是用户
</span><span class="ln">4</span><span class="c1"></span><span class="k">grant</span> <span class="k">all</span> <span class="k">on</span> <span class="n">learndatabase</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">&#39;bnaod&#39;</span><span class="o">@</span><span class="s1">&#39;localhost&#39;</span><span class="p">;</span>
<span class="ln">5</span><span class="c1">-- 撤销权限
</span><span class="ln">6</span><span class="c1"></span><span class="k">revoke</span> <span class="k">all</span> <span class="k">on</span> <span class="n">learndatabase</span><span class="p">.</span><span class="o">*</span> <span class="k">from</span> <span class="s1">&#39;bnaod&#39;</span><span class="o">@</span><span class="s1">&#39;localhost&#39;</span><span class="p">;</span>
</code></pre></div><h2 id="函数">函数</h2>
<h3 id="字符串函数">字符串函数</h3>
<ul>
<li>concat字符串拼接函数, lower转小写, upper转大写\</li>
<li>lpad(str,n,pad) 左填充,用字符串pad对str左边填充,达到n长度</li>
<li>rpad(str,n,pad) 右填充,用字符串pad对str右边填充,达到n长度</li>
<li>trim 去掉字符串头部和尾部的空格</li>
<li>substring(str,start,len)返回字符串str从start位置起的len个长度的字符串</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">select</span> <span class="nf">concat</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39; mysql&#39;</span><span class="p">);</span>
<span class="ln">2</span><span class="k">select</span> <span class="nf">lower</span><span class="p">(</span><span class="s1">&#39;HEllo&#39;</span><span class="p">);</span>
<span class="ln">3</span><span class="k">select</span> <span class="nf">upper</span><span class="p">(</span><span class="s1">&#39;HEllo&#39;</span><span class="p">);</span>
<span class="ln">4</span><span class="k">select</span> <span class="nf">lpad</span><span class="p">(</span><span class="s1">&#39;01&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;@&#39;</span><span class="p">);</span>
<span class="ln">5</span><span class="k">select</span> <span class="nf">rpad</span><span class="p">(</span><span class="s1">&#39;01&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;@&#39;</span><span class="p">);</span>
<span class="ln">6</span><span class="k">select</span> <span class="nf">trim</span><span class="p">(</span><span class="s1">&#39; HELLO  MYSQL &#39;</span><span class="p">);</span>
<span class="ln">7</span><span class="k">select</span> <span class="nf">substring</span><span class="p">(</span><span class="s1">&#39;HELLO,MYSQL&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span> <span class="c1">-- 这个不是字符串下标,就是单纯的第一个
</span><span class="ln">8</span><span class="c1">-- 将编号补成5位数,如1-&gt;00001
</span><span class="ln">9</span><span class="c1"></span><span class="k">select</span> <span class="nf">lpad</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
</code></pre></div><h3 id="数值函数">数值函数</h3>
<ul>
<li>ceil(x) 向上取整</li>
<li>floor(x) 向下取整</li>
<li>mod(x,y) 返回x/y的模</li>
<li>rand() 返回0~1的随机数</li>
<li>round(x,y) 对x四舍五入,保留y位小数</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">select</span> <span class="nf">ceil</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span><span class="p">);</span>
<span class="ln">2</span><span class="k">select</span> <span class="nf">floor</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span><span class="p">);</span>
<span class="ln">3</span><span class="k">select</span> <span class="k">mod</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<span class="ln">4</span><span class="k">select</span> <span class="k">mod</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<span class="ln">5</span><span class="k">select</span> <span class="nf">rand</span><span class="p">();</span>
<span class="ln">6</span><span class="k">select</span> <span class="nf">round</span><span class="p">(</span><span class="nf">pi</span><span class="p">(),</span> <span class="mi">7</span><span class="p">);</span>
<span class="ln">7</span><span class="c1">-- 生成6位随机验证码
</span><span class="ln">8</span><span class="c1"></span><span class="k">select</span> <span class="nf">lpad</span><span class="p">(</span><span class="mi">1000000</span> <span class="o">*</span> <span class="nf">round</span><span class="p">(</span><span class="nf">rand</span><span class="p">(),</span><span class="mi">6</span><span class="p">),</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">);</span>
</code></pre></div><h3 id="日期函数">日期函数</h3>
<ul>
<li>curdate() 当前日期</li>
<li>curtime() 当前时间</li>
<li>now() 当前日期+时间</li>
<li>year(date) 取得date的年</li>
<li>month(date) 取得date的月</li>
<li>day(date) 取得date的日</li>
<li>date_add(date, INTERVAL expr type) 返回日期/时间加上一个时间间隔expr后的时间值</li>
<li>datediff(date1, date2) 返回结束date1和起始date2之间的天数(day)</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="k">select</span> <span class="nf">curdate</span><span class="p">();</span>
<span class="ln"> 2</span><span class="k">select</span> <span class="nf">curtime</span><span class="p">();</span>
<span class="ln"> 3</span><span class="k">select</span> <span class="nf">now</span><span class="p">();</span>
<span class="ln"> 4</span><span class="k">select</span> <span class="kt">year</span><span class="p">(</span><span class="nf">now</span><span class="p">());</span>
<span class="ln"> 5</span><span class="k">select</span> <span class="kt">year</span><span class="p">(</span><span class="kt">date</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
<span class="ln"> 6</span><span class="k">select</span> <span class="nf">month</span><span class="p">(</span><span class="kt">date</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
<span class="ln"> 7</span><span class="k">select</span> <span class="nf">day</span><span class="p">(</span><span class="kt">date</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb</span><span class="p">;</span>
<span class="ln"> 8</span><span class="k">select</span> <span class="nf">date_add</span><span class="p">(</span><span class="nf">now</span><span class="p">(),</span> <span class="k">INTERVAL</span> <span class="mi">70</span> <span class="n">DAY</span> <span class="p">);</span>
<span class="ln"> 9</span><span class="k">select</span> <span class="nf">date_add</span><span class="p">(</span><span class="nf">now</span><span class="p">(),</span> <span class="k">INTERVAL</span> <span class="mi">70</span> <span class="n">MONTH</span> <span class="p">);</span>
<span class="ln">10</span><span class="k">select</span> <span class="nf">date_add</span><span class="p">(</span><span class="nf">now</span><span class="p">(),</span> <span class="k">INTERVAL</span> <span class="mi">70</span> <span class="kt">YEAR</span> <span class="p">);</span>
<span class="ln">11</span><span class="k">select</span> <span class="nf">datediff</span><span class="p">(</span><span class="nf">now</span><span class="p">(),</span> <span class="s1">&#39;2001-05-28&#39;</span><span class="p">);</span>
<span class="ln">12</span><span class="k">select</span> <span class="nf">datediff</span><span class="p">(</span><span class="nf">now</span><span class="p">(),</span> <span class="s1">&#39;1992-08-17&#39;</span><span class="p">);</span>
<span class="ln">13</span><span class="c1">-- 员工入职天数降序排列
</span><span class="ln">14</span><span class="c1"></span><span class="k">select</span> <span class="nf">datediff</span><span class="p">(</span><span class="nf">now</span><span class="p">(),</span> <span class="kt">date</span><span class="p">)</span> <span class="k">as</span> <span class="n">jointime</span> <span class="k">from</span> <span class="n">tb</span> <span class="k">order</span> <span class="k">by</span> <span class="n">jointime</span> <span class="k">desc</span> <span class="p">;</span>
</code></pre></div><h3 id="流程控制函数">流程控制函数</h3>
<ul>
<li>if(value, t, f)</li>
<li>ifnull(value1, value2) 如果value1不为空返回value1,否则返回value2</li>
<li>case when [val1] then [res1] else [default] end 如果val1为true,返回res1,&hellip;,否则返回default 这个相对于if elseif结构</li>
<li>case [expr] when [val1] then [res1] else [default] end 如果expr等于val1返回res1,&hellip;.,否则返回default 这个相对于switch结构</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="k">select</span> <span class="k">if</span><span class="p">(</span><span class="no">true</span><span class="p">,</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="ln"> 2</span><span class="k">select</span> <span class="k">if</span><span class="p">(</span><span class="no">false</span><span class="p">,</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="k">select</span> <span class="nf">ifnull</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">);</span>
<span class="ln"> 5</span><span class="k">select</span> <span class="nf">ifnull</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">);</span>
<span class="ln"> 6</span><span class="k">select</span> <span class="nf">ifnull</span><span class="p">(</span><span class="no">null</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">);</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="k">select</span> <span class="k">case</span> <span class="k">when</span> <span class="no">true</span> <span class="k">then</span> <span class="s1">&#39;res1&#39;</span> <span class="k">else</span> <span class="s1">&#39;default&#39;</span> <span class="n">end</span><span class="p">;</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="c1">-- 查询员工年龄,如果大于50就显示老毕登, 如果大于15就显示中壁灯, 如果小于15就显示小壁灯
</span><span class="ln">11</span><span class="c1"></span><span class="k">select</span> <span class="n">id</span><span class="p">,</span>
<span class="ln">12</span>       <span class="n">name</span><span class="p">,</span>
<span class="ln">13</span>       <span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="n">age</span><span class="o">&gt;=</span><span class="mi">50</span> <span class="k">then</span> <span class="s1">&#39;老毕登&#39;</span> <span class="k">when</span> <span class="n">age</span><span class="o">&gt;=</span><span class="mi">15</span> <span class="k">then</span><span class="s1">&#39;中壁灯&#39;</span> <span class="k">else</span> <span class="s1">&#39;小壁灯&#39;</span> <span class="n">end</span><span class="p">)</span> <span class="k">as</span> <span class="n">nickname</span>
<span class="ln">14</span><span class="k">from</span> <span class="n">tb</span> <span class="p">;</span>
</code></pre></div><h2 id="约束">约束</h2>
<p>这些东西idea可以直接图像界面改动.</p>
<ul>
<li>非空约束 不能为null NOT NULL</li>
<li>唯一约束 数据是唯一的 UNIQUE</li>
<li>主键约束 一行数据唯一标识,要求非空且唯一 PRIMARY KEY</li>
<li>默认约束 未指定该字段的值,则采用默认值 DEFAULT</li>
<li>检查约束 保证字段满足一个条件 CHECK</li>
<li>外键约束 用来建立两个表的连接 FOREIGN KEY</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="k">create</span> <span class="k">table</span> <span class="k">user</span><span class="p">(</span>
<span class="ln"> 2</span>    <span class="n">id</span> <span class="kt">int</span> <span class="k">primary</span> <span class="k">key</span> <span class="kp">auto_increment</span><span class="p">,</span> <span class="c1">-- 主键,且自动增长
</span><span class="ln"> 3</span><span class="c1"></span>    <span class="n">name</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">not</span> <span class="no">null</span> <span class="k">unique</span> <span class="p">,</span> <span class="c1">-- 不为null,唯一
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="n">age</span> <span class="kt">int</span> <span class="k">check</span> <span class="p">(</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">and</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">120</span> <span class="p">),</span> <span class="c1">-- 年龄在0到120之间
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="n">status</span> <span class="kt">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">default</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="c1">-- 默认为1
</span><span class="ln"> 6</span><span class="c1"></span>    <span class="n">gender</span> <span class="kt">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="ln"> 7</span><span class="p">)</span> <span class="n">comment</span> <span class="s1">&#39;user table&#39;</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="k">desc</span> <span class="k">user</span><span class="p">;</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="k">insert</span> <span class="k">into</span> <span class="k">user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;tom1&#39;</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;男&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;tom2&#39;</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;男&#39;</span><span class="p">);</span>
<span class="ln">12</span><span class="k">insert</span> <span class="k">into</span> <span class="k">user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="no">null</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;女&#39;</span><span class="p">);</span>
<span class="ln">13</span><span class="k">insert</span> <span class="k">into</span> <span class="k">user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;tom1&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;女&#39;</span><span class="p">);</span>
<span class="ln">14</span><span class="k">insert</span> <span class="k">into</span> <span class="k">user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;tom3&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;女&#39;</span><span class="p">);</span>
<span class="ln">15</span><span class="k">insert</span> <span class="k">into</span> <span class="k">user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;tom3&#39;</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span><span class="s1">&#39;女&#39;</span><span class="p">);</span>
</code></pre></div><h3 id="外键">外键</h3>
<p>有外键的是子表,关联的是父表, 建立外键保证数据的一致性和完整性.</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="c1">-- 准备
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">create</span> <span class="k">table</span> <span class="nf">dept</span><span class="p">(</span>
<span class="ln"> 3</span>    <span class="n">id</span> <span class="kt">int</span> <span class="kp">auto_increment</span> <span class="k">primary</span> <span class="k">key</span> <span class="p">,</span>
<span class="ln"> 4</span>    <span class="n">name</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">not</span> <span class="no">null</span>
<span class="ln"> 5</span><span class="p">);</span>
<span class="ln"> 6</span><span class="k">insert</span> <span class="k">into</span> <span class="nf">dept</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;研发部&#39;</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;市场部&#39;</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;财务部&#39;</span><span class="p">),(</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;销售部&#39;</span><span class="p">),(</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;总经办&#39;</span><span class="p">);</span>
<span class="ln"> 7</span><span class="k">alter</span> <span class="k">table</span> <span class="k">user</span> <span class="k">add</span> <span class="n">dept_id</span> <span class="kt">int</span><span class="p">;</span>
<span class="ln"> 8</span><span class="k">alter</span> <span class="k">table</span> <span class="k">user</span> <span class="k">add</span> <span class="n">manager_id</span> <span class="kt">int</span><span class="p">;</span>
<span class="ln"> 9</span><span class="k">insert</span> <span class="k">into</span> <span class="k">user</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">dept_id</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="no">null</span><span class="p">,</span> <span class="s1">&#39;jerry2&#39;</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;女&#39;</span><span class="p">,</span> <span class="no">null</span><span class="p">);</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="c1">-- 添加外键.在创建表时额外添加一行, 也可以额外修改
</span><span class="ln">12</span><span class="c1">-- constraint [外键名称] foreign key (外键字段名) references 主表(主表列名)
</span><span class="ln">13</span><span class="c1"></span><span class="k">alter</span> <span class="k">table</span> <span class="k">user</span> <span class="k">add</span> <span class="k">constraint</span> <span class="n">fk_user_dept_id</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">dept_id</span><span class="p">)</span> <span class="k">references</span> <span class="nf">dept</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="ln">14</span><span class="c1">-- 这样父表的字段不能直接删除,因为有子表外键关联
</span><span class="ln">15</span><span class="c1">-- 删除外键
</span><span class="ln">16</span><span class="c1">-- alter table 表名 drop foreign key 外键名称;
</span><span class="ln">17</span><span class="c1"></span><span class="k">alter</span> <span class="k">table</span> <span class="k">user</span> <span class="k">drop</span> <span class="k">foreign</span> <span class="k">key</span> <span class="n">fk_user_dept_id</span><span class="p">;</span>
</code></pre></div><h3 id="删除更新行为">删除更新行为</h3>
<ul>
<li>no action/restrict 父表中有更新和删除行为,检测有对应外键,有就不允许删除/更新</li>
<li>cascade 父表删除/更新,有外键,那么也会删除/更新在子表的记录</li>
<li>set null 父表删除,有外键的话,将子表的值设置为null(要求该外键可以为null)</li>
<li>set default 父表数据变成,子表将外键设置默认值(innodb不支持)</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- constraint [外键名称] foreign key (外键字段名) references 主表(主表列名) on update cascade on delete cascade
</span><span class="ln">2</span><span class="c1">-- on update在更新时要进行的行为,on delete在删除时要进行的行为
</span><span class="ln">3</span><span class="c1"></span><span class="k">alter</span> <span class="k">table</span> <span class="k">user</span> <span class="k">add</span> <span class="k">constraint</span> <span class="n">fk_user_dept_id</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">dept_id</span><span class="p">)</span> <span class="k">references</span> <span class="nf">dept</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">on</span> <span class="k">update</span> <span class="k">cascade</span> <span class="k">on</span> <span class="k">delete</span> <span class="k">cascade</span><span class="p">;</span>
<span class="ln">4</span><span class="k">alter</span> <span class="k">table</span> <span class="k">user</span> <span class="k">add</span> <span class="k">constraint</span> <span class="n">fk_user_dept_id</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">dept_id</span><span class="p">)</span> <span class="k">references</span> <span class="nf">dept</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">on</span> <span class="k">update</span> <span class="kt">set</span> <span class="no">null</span> <span class="k">on</span> <span class="k">delete</span> <span class="kt">set</span> <span class="no">null</span> <span class="p">;</span>
</code></pre></div><h2 id="多表查询">多表查询</h2>
<p>一对多,就是一个外键</p>
<p>多对多,需要维护一个中间表,两个外键</p>
<p>一对一,用作单表拆分,维护一个外键,而且该外键字段需要设置unique,保证它是一对一.</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 进行笛卡尔积, 组合的所有情况
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span><span class="p">,</span><span class="n">dept</span><span class="p">;</span>
<span class="ln">3</span><span class="c1">-- 消除笛卡尔积, 加一个条件, 这里没有外键也可以
</span><span class="ln">4</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span><span class="p">,</span><span class="n">dept</span> <span class="k">where</span> <span class="n">dept_id</span> <span class="o">=</span> <span class="n">dept</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</code></pre></div><h3 id="连接查询">连接查询</h3>
<ul>
<li>
<p>内连接:查询AB交集</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 隐式内连接
</span><span class="ln">2</span><span class="c1">-- select 字段列表 from 表1,表2 where 条件;
</span><span class="ln">3</span><span class="c1">-- 显示内连接
</span><span class="ln">4</span><span class="c1">-- select 字段列表 from 表1 inner join 表2 on 连接条件;
</span><span class="ln">5</span><span class="c1">-- 查询员工姓名,关联的部门
</span><span class="ln">6</span><span class="c1"></span><span class="k">select</span> <span class="k">user</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dept</span><span class="p">.</span><span class="n">name</span> <span class="k">from</span> <span class="k">user</span><span class="p">,</span> <span class="n">dept</span> <span class="k">where</span> <span class="k">user</span><span class="p">.</span><span class="n">dept_id</span><span class="o">=</span><span class="n">dept</span><span class="p">.</span><span class="n">id</span><span class="p">;</span> <span class="c1">-- 隐式内连接
</span><span class="ln">7</span><span class="c1"></span><span class="k">select</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">name</span> <span class="k">from</span> <span class="k">user</span> <span class="n">u</span><span class="p">,</span> <span class="n">dept</span> <span class="n">d</span> <span class="k">where</span> <span class="n">u</span><span class="p">.</span><span class="n">dept_id</span><span class="o">=</span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="p">;</span> <span class="c1">-- 取别名
</span><span class="ln">8</span><span class="c1"></span><span class="k">select</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">name</span> <span class="k">from</span> <span class="k">user</span> <span class="n">u</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">dept</span> <span class="n">d</span> <span class="k">on</span> <span class="n">u</span><span class="p">.</span><span class="n">dept_id</span><span class="o">=</span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="p">;</span> <span class="c1">-- 显式内连接
</span></code></pre></div></li>
<li>
<p>左外连接:查询左表的所有数据,包括AB交集</p>
</li>
<li>
<p>右外连接:查询右表的所有数据,包括AB交集</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 左外连接 完全包含左表(即便没有外键值),还有交集
</span><span class="ln">2</span><span class="c1">-- select 字段列表 from 表1 left [outer] join 表2 on 条件;
</span><span class="ln">3</span><span class="c1">-- 右外连接 完全包含右表(即便没有外键值),还有交集
</span><span class="ln">4</span><span class="c1">-- select 字段列表 from 表1 right [outer] join 表2 on 条件;
</span><span class="ln">5</span><span class="c1"></span><span class="k">select</span> <span class="n">u</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">name</span> <span class="k">from</span> <span class="k">user</span> <span class="n">u</span> <span class="k">left</span> <span class="k">outer</span> <span class="k">join</span> <span class="n">dept</span> <span class="n">d</span> <span class="k">on</span> <span class="n">d</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">dept_id</span><span class="p">;</span> <span class="c1">-- 左外
</span><span class="ln">6</span><span class="c1"></span><span class="k">select</span> <span class="n">d</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span> <span class="k">from</span> <span class="k">user</span> <span class="n">u</span> <span class="k">right</span> <span class="k">outer</span> <span class="k">join</span> <span class="n">dept</span> <span class="n">d</span> <span class="k">on</span> <span class="n">d</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">dept_id</span><span class="p">;</span> <span class="c1">-- 右外
</span><span class="ln">7</span><span class="c1"></span><span class="k">select</span> <span class="n">d</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span> <span class="k">from</span> <span class="n">dept</span> <span class="n">d</span> <span class="k">left</span> <span class="k">join</span> <span class="k">user</span> <span class="n">u</span> <span class="k">on</span> <span class="n">d</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">dept_id</span><span class="p">;</span> <span class="c1">-- 将右外改为左外
</span></code></pre></div></li>
<li>
<p>自连接:当前表与自身连接查询</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 自连接
</span><span class="ln">2</span><span class="c1">-- select 字段列表 from 表A 别名A join 表A 别名B ON 条件;
</span><span class="ln">3</span><span class="c1">-- 查询员工及其所属领导(员工和领导在同一表中), 将他们看做两张表,员工表和领导表
</span><span class="ln">4</span><span class="c1"></span><span class="k">select</span> <span class="n">u1</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">u2</span><span class="p">.</span><span class="n">name</span> <span class="k">from</span> <span class="k">user</span> <span class="n">u1</span> <span class="k">join</span> <span class="k">user</span> <span class="n">u2</span> <span class="k">on</span> <span class="n">u1</span><span class="p">.</span><span class="n">manager_id</span><span class="o">=</span><span class="n">u2</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="ln">5</span><span class="c1">-- 即便没有领导也查询
</span><span class="ln">6</span><span class="c1"></span><span class="k">select</span> <span class="n">u1</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">u2</span><span class="p">.</span><span class="n">name</span> <span class="k">from</span> <span class="k">user</span> <span class="n">u1</span> <span class="k">left</span> <span class="k">join</span> <span class="k">user</span> <span class="n">u2</span> <span class="k">on</span> <span class="n">u1</span><span class="p">.</span><span class="n">manager_id</span><span class="o">=</span><span class="n">u2</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</code></pre></div></li>
</ul>
<h3 id="联合查询">联合查询</h3>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 联合查询 union union all,将多次查询的结果合并起来, 列数必须保持一致
</span><span class="ln">2</span><span class="c1">-- select from union [all] select from
</span><span class="ln">3</span><span class="c1">-- 将年龄小于50岁 和 状态为1 的员工查询出来
</span><span class="ln">4</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="k">union</span> <span class="k">all</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">-- 结果有重复,直接将查询结果合并
</span><span class="ln">5</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="k">union</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">-- 结果没重复,合并后去重
</span></code></pre></div><h3 id="子查询">子查询</h3>
<p>子查询, 在select中嵌套select,又称嵌套查询</p>
<p>这部分最重要的就是一部分一部分来, 查询一个阶段再将结果作为另一个阶段</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span> <span class="k">where</span> <span class="n">column1</span><span class="o">=</span><span class="p">(</span><span class="k">select</span> <span class="n">column1</span> <span class="k">from</span> <span class="n">t2</span><span class="p">)</span> <span class="err">外部可以是</span><span class="n">select</span><span class="o">/</span><span class="k">update</span><span class="o">/</span><span class="k">insert</span><span class="o">/</span><span class="k">delete</span>
</code></pre></div><p>子查询分类:</p>
<ol>
<li>
<p>标量子查询(结果为单值), 操作符一般是&gt; &gt;= 之类</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 查询单个部门的员工信息,(select id from dept where name = &#39;研发部&#39;)只有一条记录
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">dept_id</span><span class="o">=</span><span class="p">(</span><span class="k">select</span> <span class="n">id</span> <span class="k">from</span> <span class="n">dept</span> <span class="k">where</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;研发部&#39;</span><span class="p">);</span>
</code></pre></div></li>
<li>
<p>列子查询, 操作符是in, not in, any/some, all</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- any some是任意有一个满足即可
</span><span class="ln">2</span><span class="c1">-- all是子查询返回的列表的所有值都要满足
</span><span class="ln">3</span><span class="c1">-- 查询两个部门的员工信息
</span><span class="ln">4</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">dept_id</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">id</span> <span class="k">from</span> <span class="n">dept</span> <span class="k">where</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;研发部&#39;</span> <span class="k">or</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;市场部&#39;</span><span class="p">);</span>
<span class="ln">5</span><span class="c1">-- 查询比市场部所有人年龄都小的员工
</span><span class="ln">6</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="k">all</span> <span class="p">(</span><span class="k">select</span> <span class="n">age</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">dept_id</span><span class="o">=</span><span class="p">(</span><span class="k">select</span> <span class="n">id</span> <span class="k">from</span> <span class="n">dept</span> <span class="k">where</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;总经办&#39;</span><span class="p">));</span>
</code></pre></div></li>
<li>
<p>行子查询, 操作符= &lt;&gt; in not in</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 查询和编号2员工的年龄与状态相同的员工,行元素对应
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="n">age</span><span class="p">,</span> <span class="n">status</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
<span class="ln">3</span><span class="c1">-- 表子查询,操作符in
</span><span class="ln">4</span><span class="c1">-- 查询与编号1,编号2员工的年龄和状态相同的员工,也是每一行对应一个,用in
</span><span class="ln">5</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">age</span><span class="p">,</span> <span class="n">status</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">1</span> <span class="k">or</span> <span class="n">id</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span>
<span class="ln">6</span><span class="c1">-- 查询年龄小于50的员工信息和部门信息
</span><span class="ln">7</span><span class="c1"></span><span class="k">select</span> <span class="n">e</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="o">*</span> <span class="k">from</span> <span class="p">(</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span> <span class="n">e</span> <span class="k">left</span> <span class="k">join</span> <span class="n">dept</span> <span class="n">d</span> <span class="k">on</span> <span class="n">e</span><span class="p">.</span><span class="n">dept_id</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</code></pre></div></li>
</ol>
<h2 id="事务">事务</h2>
<p>准备:</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="k">create</span> <span class="k">table</span> <span class="nf">account</span><span class="p">(</span>
<span class="ln"> 2</span>    <span class="n">id</span> <span class="kt">int</span> <span class="kp">auto_increment</span> <span class="k">primary</span> <span class="k">key</span> <span class="p">,</span>
<span class="ln"> 3</span>    <span class="n">name</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="p">,</span>
<span class="ln"> 4</span>    <span class="n">money</span> <span class="kt">int</span>
<span class="ln"> 5</span><span class="p">);</span>
<span class="ln"> 6</span><span class="k">insert</span> <span class="k">into</span> <span class="nf">account</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">money</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="no">null</span><span class="p">,</span> <span class="s1">&#39;lisan&#39;</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
<span class="ln"> 7</span><span class="k">insert</span> <span class="k">into</span> <span class="nf">account</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">money</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="no">null</span><span class="p">,</span> <span class="s1">&#39;wangsan&#39;</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
<span class="ln"> 8</span><span class="c1">-- 恢复数据
</span><span class="ln"> 9</span><span class="c1"></span><span class="k">update</span> <span class="n">account</span> <span class="kt">set</span> <span class="n">money</span> <span class="o">=</span> <span class="mi">2000</span> <span class="k">where</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lisan&#39;</span> <span class="k">or</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;wangsan&#39;</span><span class="p">;</span>
<span class="ln">10</span><span class="c1">-- 查询lisan余额
</span><span class="ln">11</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">account</span> <span class="k">where</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lisan&#39;</span><span class="p">;</span>
<span class="ln">12</span><span class="c1">-- 转账操作
</span><span class="ln">13</span><span class="c1"></span><span class="k">update</span> <span class="n">account</span> <span class="kt">set</span> <span class="n">money</span> <span class="o">=</span> <span class="n">money</span> <span class="o">-</span> <span class="mi">1000</span> <span class="k">where</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lisan&#39;</span><span class="p">;</span>
<span class="ln">14</span><span class="k">update</span> <span class="n">account</span> <span class="kt">set</span> <span class="n">money</span> <span class="o">=</span> <span class="n">money</span> <span class="o">+</span> <span class="mi">1000</span> <span class="k">where</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;wangsan&#39;</span><span class="p">;</span>
</code></pre></div><h3 id="管理事务">管理事务</h3>
<h4 id="方式一">方式一</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="c1">-- 查看事务的提交方式
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">select</span> <span class="o">@@</span><span class="n">autocommit</span><span class="p">;</span>
<span class="ln"> 3</span><span class="c1">-- 设置为手动提交, 0为手动,1为自动
</span><span class="ln"> 4</span><span class="c1"></span><span class="kt">set</span> <span class="o">@@</span><span class="n">autocommit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">-- 设置为手动
</span><span class="ln"> 5</span><span class="c1"></span><span class="kt">set</span> <span class="o">@@</span><span class="n">autocommit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">-- 设置为自动
</span><span class="ln"> 6</span><span class="c1">-- 操作
</span><span class="ln"> 7</span><span class="c1"></span><span class="k">update</span> <span class="n">account</span> <span class="kt">set</span> <span class="n">money</span> <span class="o">=</span> <span class="n">money</span> <span class="o">-</span> <span class="mi">1000</span> <span class="k">where</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lisan&#39;</span><span class="p">;</span>
<span class="ln"> 8</span><span class="k">update</span> <span class="n">account</span> <span class="kt">set</span> <span class="n">money</span> <span class="o">=</span> <span class="n">money</span> <span class="o">+</span> <span class="mi">1000</span> <span class="k">where</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;wangsan&#39;</span><span class="p">;</span>
<span class="ln"> 9</span><span class="c1">-- 提交事务
</span><span class="ln">10</span><span class="c1"></span><span class="n">commit</span><span class="p">;</span>
<span class="ln">11</span><span class="c1">-- 回滚事务, 如果出错了就回滚
</span><span class="ln">12</span><span class="c1"></span><span class="n">rollback</span><span class="p">;</span>
</code></pre></div><h4 id="方式二">方式二</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 开启事务
</span><span class="ln">2</span><span class="c1"></span><span class="n">start</span> <span class="n">transaction</span><span class="p">;</span>
<span class="ln">3</span><span class="n">begin</span><span class="p">;</span>
<span class="ln">4</span><span class="c1">-- 提交事务
</span><span class="ln">5</span><span class="c1"></span><span class="n">commit</span><span class="p">;</span>
<span class="ln">6</span><span class="c1">-- 回滚
</span><span class="ln">7</span><span class="c1"></span><span class="n">rollback</span><span class="p">;</span>
</code></pre></div><h3 id="事务的四大特性acid">事务的四大特性ACID</h3>
<ul>
<li>原子性atomicity: 不可分割的最小操作,一起成功,一起失败</li>
<li>一致性consistency: 事务完成,数据保持一致状态,比如余额是一定的</li>
<li>隔离性isolation: 数据库提供的隔离机制, 事务不受外部并发操作影响独立环境执行</li>
<li>持久性durability: 事务一旦提交或回滚, 对数据的改变是永久的</li>
</ul>
<h3 id="并发事务问题">并发事务问题</h3>
<ul>
<li>脏读:事务读取来另一个事务没有提交的数据</li>
<li>不可重复读: 事务先后读取同一数据,两次读取的数据不同</li>
<li>幻读:查询时没有这行数据,但是插入时又存在这行数据</li>
</ul>
<h3 id="事务的隔离级别">事务的隔离级别</h3>
<ul>
<li>read uncommitted 脏读会出现 不可重复读会出现 幻读会出现  性能最高</li>
<li>read committed(oracle默认) 脏读不会出现</li>
<li>repeatable read(mysql默认) 脏读,不可重复读不会出现</li>
<li>serializable 脏读,不可重复读,幻读不会出现   性能最差</li>
</ul>
<p>事务隔离级别越高,数据越安全,性能越低.</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 查看事务隔离级别
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="o">@@</span><span class="n">transaction_isolation</span><span class="p">;</span>
<span class="ln">3</span><span class="c1">-- 设置事务隔离级别
</span><span class="ln">4</span><span class="c1">-- set [session|global] transaction isolation level {read uncommitted|read committed|repeatable read|serializable};
</span><span class="ln">5</span><span class="c1"></span><span class="kt">set</span> <span class="n">session</span> <span class="n">transaction</span> <span class="n">isolation</span> <span class="n">level</span> <span class="n">serializable</span> <span class="p">;</span>
<span class="ln">6</span><span class="kt">set</span> <span class="n">session</span> <span class="n">transaction</span> <span class="n">isolation</span> <span class="n">level</span> <span class="n">repeatable</span> <span class="k">read</span> <span class="p">;</span>
</code></pre></div><h3 id="模拟并发问题">模拟并发问题</h3>
<h4 id="模拟脏读">模拟脏读</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 模拟脏读
</span><span class="ln">2</span><span class="c1">-- 窗口1
</span><span class="ln">3</span><span class="c1"></span><span class="kt">set</span> <span class="n">session</span> <span class="n">transaction</span> <span class="n">isolation</span> <span class="n">level</span> <span class="k">read</span> <span class="n">uncommitted</span> <span class="p">;</span>
<span class="ln">4</span><span class="n">start</span> <span class="n">transaction</span> <span class="p">;</span>
<span class="ln">5</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">account</span><span class="p">;</span> <span class="c1">-- 这时候可以看到lisan减了1000块,就是因为可以读到未提交的(read uncommitted)
</span><span class="ln">6</span><span class="c1">-- 窗口2
</span><span class="ln">7</span><span class="c1"></span><span class="n">start</span> <span class="n">transaction</span> <span class="p">;</span>
<span class="ln">8</span><span class="k">update</span> <span class="n">account</span> <span class="kt">set</span> <span class="n">money</span> <span class="o">=</span> <span class="n">money</span> <span class="o">-</span> <span class="mi">1000</span> <span class="k">where</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lisan&#39;</span><span class="p">;</span>
</code></pre></div><h4 id="模拟不可重复读">模拟不可重复读</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="c1">-- 模拟不可重复读
</span><span class="ln"> 2</span><span class="c1">-- 窗口1
</span><span class="ln"> 3</span><span class="c1"></span><span class="kt">set</span> <span class="n">session</span> <span class="n">transaction</span> <span class="n">isolation</span> <span class="n">level</span> <span class="k">read</span> <span class="n">committed</span> <span class="p">;</span>
<span class="ln"> 4</span><span class="n">start</span> <span class="n">transaction</span> <span class="p">;</span>
<span class="ln"> 5</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">account</span><span class="p">;</span> <span class="c1">-- 在commit之前查询
</span><span class="ln"> 6</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">account</span><span class="p">;</span> <span class="c1">-- 在commit之后查询, 可以查询到变更的.
</span><span class="ln"> 7</span><span class="c1"></span><span class="n">commit</span> <span class="p">;</span>
<span class="ln"> 8</span><span class="c1">-- 窗口2
</span><span class="ln"> 9</span><span class="c1"></span><span class="n">start</span> <span class="n">transaction</span> <span class="p">;</span>
<span class="ln">10</span><span class="k">update</span> <span class="n">account</span> <span class="kt">set</span> <span class="n">money</span> <span class="o">=</span> <span class="n">money</span> <span class="o">+</span> <span class="mi">1000</span> <span class="k">where</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lisan&#39;</span><span class="p">;</span>
<span class="ln">11</span><span class="n">commit</span> <span class="p">;</span>
</code></pre></div><h4 id="模拟幻读">模拟幻读</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="c1">-- 模拟幻读
</span><span class="ln"> 2</span><span class="c1">-- 窗口1
</span><span class="ln"> 3</span><span class="c1"></span><span class="kt">set</span> <span class="n">session</span> <span class="n">transaction</span> <span class="n">isolation</span> <span class="n">level</span> <span class="n">repeatable</span> <span class="k">read</span> <span class="p">;</span>
<span class="ln"> 4</span><span class="n">start</span> <span class="n">transaction</span> <span class="p">;</span>
<span class="ln"> 5</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">account</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span> <span class="c1">-- 1查不到
</span><span class="ln"> 6</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="nf">account</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">money</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="no">null</span><span class="p">,</span> <span class="s1">&#39;zangsan&#39;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span> <span class="c1">-- 4这边后执行,发现插入不了
</span><span class="ln"> 7</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">account</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span> <span class="c1">-- 5再次查询,还是没有, 这是因为已经解决了不可重复读了.
</span><span class="ln"> 8</span><span class="c1">-- 窗口2
</span><span class="ln"> 9</span><span class="c1"></span><span class="n">start</span> <span class="n">transaction</span> <span class="p">;</span>
<span class="ln">10</span><span class="k">insert</span> <span class="k">into</span> <span class="nf">account</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">money</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="no">null</span><span class="p">,</span> <span class="s1">&#39;zangsan&#39;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span> <span class="c1">-- 2这边先insert
</span><span class="ln">11</span><span class="c1"></span><span class="n">commit</span> <span class="p">;</span> <span class="c1">-- 3先提交,这时已经有这一行了.
</span></code></pre></div><h2 id="索引">索引</h2>
<p>mysql体系结构: 连接池(授权认证), 服务层(sql接口,sql分析优化,函数执行), 引擎层(数据存储和提取), 存储层</p>
<p>存储引擎: 存储数据,建立索引,更新/查询数据等技术的视线方式. 存储引擎是基于表的而不是库.</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="c1">-- 查询建表语句,默认innodb
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">show</span> <span class="k">create</span> <span class="k">table</span> <span class="n">account</span><span class="p">;</span>
<span class="ln"> 3</span><span class="c1"># CREATE TABLE `account` (
</span><span class="ln"> 4</span><span class="c1">#                            `id` int NOT NULL AUTO_INCREMENT,
</span><span class="ln"> 5</span><span class="c1">#                            `name` varchar(50) DEFAULT NULL,
</span><span class="ln"> 6</span><span class="c1">#                            `money` int DEFAULT NULL,
</span><span class="ln"> 7</span><span class="c1">#                            PRIMARY KEY (`id`)
</span><span class="ln"> 8</span><span class="c1"># ) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
</span><span class="ln"> 9</span><span class="c1"></span>
<span class="ln">10</span><span class="c1">-- 查询当前数据库支持的存储引擎
</span><span class="ln">11</span><span class="c1"></span><span class="k">show</span> <span class="n">engines</span><span class="p">;</span>
<span class="ln">12</span><span class="c1">-- 创建表,指定引擎为MyISAM
</span><span class="ln">13</span><span class="c1"></span><span class="k">create</span> <span class="k">table</span> <span class="nf">my_myisam</span><span class="p">(</span>
<span class="ln">14</span>    <span class="n">id</span> <span class="kt">int</span> <span class="kp">auto_increment</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
<span class="ln">15</span>    <span class="n">name</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="ln">16</span><span class="p">)</span><span class="kp">engine</span> <span class="o">=</span> <span class="n">MyISAM</span><span class="p">;</span>
<span class="ln">17</span><span class="c1">-- 创建表,指定引擎为MEMORY
</span><span class="ln">18</span><span class="c1"></span><span class="k">create</span> <span class="k">table</span> <span class="nf">my_memory</span><span class="p">(</span>
<span class="ln">19</span>    <span class="n">id</span> <span class="kt">int</span> <span class="kp">auto_increment</span> <span class="k">primary</span> <span class="k">key</span> <span class="p">,</span>
<span class="ln">20</span>    <span class="n">name</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="ln">21</span><span class="p">)</span><span class="kp">engine</span> <span class="o">=</span> <span class="n">Momory</span><span class="p">;</span>
</code></pre></div><h3 id="存储引擎的特点">存储引擎的特点</h3>
<ol>
<li>
<p>innodb是mysql5.5之后默认的存储引擎,
特点:DML遵循ACID模型,<strong>支持事务; 行级锁,提高并发性能; 支持外键foreign key</strong>
文件:xxx.ibd, 每张表都会对应一个表空间文件,存储改变的表结构(frm,sdi),数据和索引.
逻辑存储结构:一个表空间TableSpace包含很多Segment段,一个段包含很多Extent区,一个区包含很多Page页,一个页包含很多Row行(行数据).
一个row包含trx id,roll pointer, col1, col2,
适用于并发条件下要求数据的一致性, 除了插入查询还有很多的更新删除操作</p>
</li>
<li>
<p>MyISAM, mysql早期的默认存储引擎.
不支持事务,不支持外键, <strong>支持表锁</strong>, 不支持行锁,访问速度快
文件: sdi表结构信息,myd数据,myi索引
<strong>读操作和插入操作为主</strong>, 更新和删除较少时选用</p>
</li>
<li>
<p>Memory, 存储在内存,只能作为临时表或缓存
<strong>内存存放,访问速度快</strong>, hash索引
<strong>通常做缓存</strong></p>
</li>
</ol>
<p>innodb与MyISAM区别:innodb支持外键,是行锁,支持事务.MyISAM是表锁</p>
<h3 id="索引-1">索引</h3>
<p>索引: 高效获取数据的数据结构(有序)</p>
<p>优点:提高检索效率,降低数据库io成本;通过索引进行排序,降低数据排序的成本</p>
<p>缺点:费空间,提高了查询效率但是降低了更新效率</p>
<h3 id="索引结构">索引结构</h3>
<p>有B+Tree索引(常见), Hash索引(性能高,不支持范围查询),R-tree(空间索引),Full-text(全文索引)</p>
<p>二叉树:顺序插入时形成链表,层级深</p>
<p>红黑树:自平衡二叉树,但是数据量大的时候层级也深.</p>
<p>B-Tree(多路平衡查找), 从下面往上面走的.</p>
<p>B+Tree:相比B-Tree,所有的元素会出现的叶子结点(向上分裂的同时保留自己),叶子节点会形成单向链表</p>
<p>MySQL在B+Tree的基础上,将叶子节点的链表变为了双向循环链表,提高区间访问性能.</p>
<p>Hash索引:将键值换算成Hash值,映射在对应的槽位,存储在Hash表中.如果Hash冲突就增加链表.(就是HashSet原理), 只能用于对等比较= in,不能范围查询; 无法排序; 查询效率高. Memory支持hash索引.</p>
<h3 id="索引分类">索引分类</h3>
<p>主键索引(primary, 只能有一个), 唯一索引(unique), 常规索引, 全文索引(fulltext)</p>
<p>根据存储形式分类:聚集索引(数据存储和索引一块,叶子结点保存行数据,必须要,只能有一个), 二级索引(数据和索引分开, 叶子结点是主键,可以多个)</p>
<p>索引选取规则:</p>
<ol>
<li>如果存在主键, 主键索引就是聚集索引</li>
<li>没有主键, 选取第一个unique唯一索引作为聚集索引</li>
<li>都没有,Innodb自动生成rowid作为隐藏的聚集索引</li>
</ol>
<p>如select * from user where name = &lsquo;li&rsquo;; 先从二级索引找主键,再从聚集索引找数据.这就是回表查询</p>
<h3 id="索引语法">索引语法</h3>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="c1">-- 创建索引 create [unique|fulltext] index index_name on table_name (index_col_name,..)
</span><span class="ln"> 2</span><span class="c1">-- 查看索引 show index from table_name;
</span><span class="ln"> 3</span><span class="c1"></span><span class="k">show</span> <span class="k">index</span> <span class="k">from</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span><span class="p">;</span>
<span class="ln"> 4</span><span class="c1">-- 删除索引 drop index index_name on table_name;
</span><span class="ln"> 5</span><span class="c1">-- 为name字段创建索引,该字段可能重复(常规索引)
</span><span class="ln"> 6</span><span class="c1"></span><span class="k">create</span> <span class="k">index</span> <span class="n">idx_user_name</span> <span class="k">on</span> <span class="k">user</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="ln"> 7</span><span class="c1">-- 为phone创建唯一索引(唯一索引, 单列索引)
</span><span class="ln"> 8</span><span class="c1"></span><span class="k">create</span> <span class="k">unique</span> <span class="k">index</span> <span class="n">idx_user_phone</span> <span class="k">on</span> <span class="k">user</span><span class="p">(</span><span class="n">phone</span><span class="p">);</span>
<span class="ln"> 9</span><span class="c1">-- 为多个字段创建索引(联合索引),使用最频繁的字段放左侧(最左前缀原则)
</span><span class="ln">10</span><span class="c1"></span><span class="k">create</span> <span class="k">index</span> <span class="n">idx_user_name_phone_age</span> <span class="k">on</span> <span class="k">user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">age</span><span class="p">);</span>
</code></pre></div><h3 id="sql性能分析">SQL性能分析</h3>
<h4 id="sql执行频率">SQL执行频率</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- show [session|global] status;
</span><span class="ln">2</span><span class="c1">-- 查看select, update, delete, insert等执行次数
</span><span class="ln">3</span><span class="c1"></span><span class="k">show</span> <span class="n">global</span> <span class="n">status</span> <span class="k">like</span> <span class="s1">&#39;Com_______&#39;</span><span class="p">;</span>
</code></pre></div><h4 id="慢查询日志">慢查询日志</h4>
<p>慢查询日志: 记录执行时间超过指定参数long_time_query,默认10秒的日志</p>
<p>记录位置: /var/lib/mysql/localhost-slow.log</p>
<p>默认没有开启,在MySQL配置文件/etc/my.cnf配置, slow_query_log=1 1表示开, long_time_query=2 2秒</p>
<div class="highlight"><pre class="chroma"><code class="language-MYSQL" data-lang="MYSQL"><span class="ln">1</span><span class="c1">-- 查看是否开启
</span><span class="ln">2</span><span class="c1"></span><span class="k">show</span> <span class="n">variables</span> <span class="k">like</span> <span class="s1">&#39;slow_query_log&#39;</span><span class="p">;</span>
</code></pre></div><h4 id="查看时间耗费">查看时间耗费</h4>
<p>show profiles能够在做sql优化的时候帮助我们了解时间耗费到哪去了</p>
<p>have_profiling参数查看是否支持profile</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="k">select</span> <span class="o">@@</span><span class="n">have_profiling</span><span class="p">;</span>
<span class="ln"> 2</span><span class="c1">-- 查看是否开启
</span><span class="ln"> 3</span><span class="c1"></span><span class="k">select</span> <span class="o">@@</span><span class="n">profiling</span><span class="p">;</span>
<span class="ln"> 4</span><span class="c1">-- 设置开启
</span><span class="ln"> 5</span><span class="c1"></span><span class="kt">set</span> <span class="n">profiling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln"> 6</span><span class="c1">-- 查看耗时情况
</span><span class="ln"> 7</span><span class="c1"></span><span class="k">show</span> <span class="n">profiles</span><span class="p">;</span>
<span class="ln"> 8</span><span class="c1">-- 查看指定query_id的sql语句每个阶段的耗时情况
</span><span class="ln"> 9</span><span class="c1">-- show profile for query [query_id];
</span><span class="ln">10</span><span class="c1"></span><span class="k">show</span> <span class="n">profile</span> <span class="k">for</span> <span class="n">query</span> <span class="mi">3</span><span class="p">;</span>
</code></pre></div><h4 id="查看sql语句的执行计划">查看sql语句的执行计划</h4>
<p>explain[/desc] 查看sql语句的执行计划, 如何执行的</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">where</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span>
</code></pre></div><ul>
<li>id字段:id相同,执行顺序从上往下, id越大越先执行</li>
<li>select_type:SIMPLE简单表(不使用表连接或子查询),primary(主查询,即外层的查询), union(union中第二个或者后面的查询语句), subquery(select或where之后包含的子查询)</li>
<li>type:连接类型. 性能由好到坏是NULL(不查任何表), system, const(唯一索引), eq_ref, ref(非唯一性索引), range, index(扫描索引), all(全表扫描)</li>
<li>possible_key:可能用到的索引</li>
<li>key:实际用到的索引</li>
<li>key_len:使用索引的字节数</li>
<li>rows:必须要执行查询的行数</li>
<li>filtered:返回结果的行数占需读取行数的百分比,越大越好</li>
</ul>
<h3 id="索引使用">索引使用</h3>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 验证索引效率:先执行一条没有索引的sql,再创建索引再执行
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb_sku</span> <span class="k">where</span> <span class="n">sn</span><span class="o">=</span><span class="s1">&#39;100001&#39;</span><span class="p">;</span>
<span class="ln">3</span><span class="k">create</span> <span class="k">index</span> <span class="n">idx_sku_sn</span> <span class="k">on</span> <span class="nf">tb_sku</span><span class="p">(</span><span class="n">sn</span><span class="p">);</span>
<span class="ln">4</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb_sku</span> <span class="k">where</span> <span class="n">sn</span><span class="o">=</span><span class="s1">&#39;100001&#39;</span><span class="p">;</span>
</code></pre></div><p>最左前缀法则: 查询从索引最左列开始, 并且不跳过索引中的列; 如果跳过某列, 索引将部分失效(后面的字段失效)</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 假设创建了联合索引且顺序为profession,age,status,那么
</span><span class="ln">2</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span> <span class="k">and</span> <span class="n">age</span><span class="o">=</span><span class="mi">31</span> <span class="k">and</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">;</span> <span class="c1">-- 会用到索引,所有字段都走索引
</span><span class="ln">3</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span> <span class="k">and</span> <span class="n">age</span><span class="o">=</span><span class="mi">31</span><span class="p">;</span> <span class="c1">-- 会用到索引,所有字段都走索引
</span><span class="ln">4</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span> <span class="c1">-- 会用到索引,所有字段都走索引
</span><span class="ln">5</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">age</span><span class="o">=</span><span class="mi">31</span> <span class="k">and</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">;</span> <span class="c1">-- 不会用到索引
</span><span class="ln">6</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span> <span class="k">and</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">;</span> <span class="c1">-- 只有profession会用到索引
</span><span class="ln">7</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">age</span><span class="o">=</span><span class="mi">31</span> <span class="k">and</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span> <span class="k">and</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">;</span> <span class="c1">-- 会用到索引,这个sql语句的顺序无关,只需要存在
</span></code></pre></div><p>范围查询: 联合索引中, 出现范围查询(&lt;.&gt;),那么范围查询右侧的列索引失效</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span> <span class="k">and</span> <span class="n">age</span><span class="o">&lt;</span><span class="mi">31</span> <span class="k">and</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">;</span> <span class="c1">-- profession和age走索引,status不走
</span><span class="ln">2</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span> <span class="k">and</span> <span class="n">age</span><span class="o">&lt;=</span><span class="mi">31</span> <span class="k">and</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">;</span> <span class="c1">-- 都走,其实只有=那里都走
</span></code></pre></div><h4 id="索引失效">索引失效</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="c1">-- 索引列运算操作, 会导致索引失效
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="nf">substring</span><span class="p">(</span><span class="n">phone</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;15&#39;</span><span class="p">;</span> <span class="c1">-- 没用索引
</span><span class="ln"> 3</span><span class="c1">-- 字符串没加引号, 会导致索引失效
</span><span class="ln"> 4</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">name</span> <span class="o">=</span> <span class="n">lisan</span><span class="p">;</span>
<span class="ln"> 5</span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span> <span class="k">and</span> <span class="n">age</span><span class="o">=</span><span class="mi">31</span> <span class="k">and</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="c1">-- status没有走索引
</span><span class="ln"> 6</span><span class="c1">-- 模糊查询, 如果仅仅是尾部模糊, 索引不会失效; 头部模糊匹配会失效
</span><span class="ln"> 7</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">profession</span> <span class="k">like</span> <span class="s1">&#39;软件%&#39;</span><span class="p">;</span> <span class="c1">-- 走索引
</span><span class="ln"> 8</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">profession</span> <span class="k">like</span> <span class="s1">&#39;%软件&#39;</span><span class="p">;</span> <span class="c1">-- 不走
</span><span class="ln"> 9</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">profession</span> <span class="k">like</span> <span class="s1">&#39;%件%&#39;</span><span class="p">;</span> <span class="c1">-- 不走
</span><span class="ln">10</span><span class="c1">-- or连接的条件: 前面列有索引,后面列没索引,那么索引都不会用到; 只有都有索引才会用到
</span><span class="ln">11</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">phone</span><span class="o">=</span><span class="s1">&#39;17712312310&#39;</span> <span class="k">or</span> <span class="n">age</span><span class="o">=</span><span class="mi">13</span><span class="p">;</span> <span class="c1">-- age没索引,所以没有用任何索引
</span><span class="ln">12</span><span class="c1">-- 数据分布影响: 如果MySQL评估使用索引比全表更慢,则不使用索引
</span><span class="ln">13</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">phone</span><span class="o">&gt;</span><span class="s1">&#39;17700000000&#39;</span><span class="p">;</span> <span class="c1">-- 绝大部分数据都满足,这时就没用索引
</span><span class="ln">14</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">phone</span> <span class="k">is</span> <span class="k">not</span> <span class="no">null</span><span class="p">;</span> <span class="c1">-- 绝大部分都满足,没走索引
</span><span class="ln">15</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">phone</span> <span class="k">is</span> <span class="no">null</span><span class="p">;</span> <span class="c1">-- 绝大部分都不满足,走索引
</span></code></pre></div><h4 id="sql提示">SQL提示</h4>
<p>给mysql说想要什么索引(如果有多个可用的)之类,达到优化操作的目的</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 比如既有单个索引,又有联合索引的情况.
</span><span class="ln">2</span><span class="c1">-- use index: 建议用哪个索引 ignore index: 不用哪个索引 force index:必须用哪个索引
</span><span class="ln">3</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">use</span> <span class="k">index</span><span class="p">(</span><span class="n">idx_user_pro</span><span class="p">)</span> <span class="k">where</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span><span class="p">;</span>
<span class="ln">4</span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">ignore</span> <span class="k">index</span><span class="p">(</span><span class="n">idx_user_pro</span><span class="p">)</span> <span class="k">where</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span><span class="p">;</span>
<span class="ln">5</span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">user</span> <span class="k">force</span> <span class="k">index</span><span class="p">(</span><span class="n">idx_user_pro</span><span class="p">)</span> <span class="k">where</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span><span class="p">;</span>
</code></pre></div><h4 id="覆盖索引">覆盖索引</h4>
<p>查询使用索引, 并且需要返回的列, 在该索引中已经全部能够找到, 这样只需要查联合索引即可, 不需要回表查询</p>
<p>所以需要减少select *的使用, 这样可以提高效率</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 如现有索引profession, age, status的联合索引
</span><span class="ln">2</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">profession</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">status</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span> <span class="k">and</span> <span class="n">age</span><span class="o">=</span><span class="mi">31</span> <span class="k">and</span> <span class="n">stauts</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">;</span> <span class="c1">-- 效率高
</span><span class="ln">3</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">profession</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="k">user</span> <span class="k">where</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span> <span class="k">and</span> <span class="n">age</span><span class="o">=</span><span class="mi">31</span> <span class="k">and</span> <span class="n">stauts</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">;</span> <span class="c1">-- 效率低
</span></code></pre></div><h4 id="前缀索引">前缀索引</h4>
<p>索引很长的字符串,让索引变得很大,查询时浪费大量磁盘IO. 此时将字符串的一部分前缀建立索引,节约索引空间</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">create</span> <span class="k">index</span> <span class="n">idx_xxxx</span> <span class="k">on</span> <span class="nf">table_name</span><span class="p">(</span><span class="k">column</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
</code></pre></div><p>前缀长度的选取: 根据选择性决定. 选择性是不重复的所有值比上记录总数, 选择性越高效率越高, 唯一索引的选择性是1.</p>
<p>一般是根据需求选择, 不需要必须选择性为1, 0.9的效率也可以.</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">select</span> <span class="nf">count</span><span class="p">(</span><span class="k">distinct</span> <span class="n">email</span><span class="p">)</span> <span class="o">/</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb_user</span><span class="p">;</span> <span class="c1">-- 全部字段的选择性
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="nf">count</span><span class="p">(</span><span class="k">distinct</span> <span class="nf">substring</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="o">/</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">tv_user</span><span class="p">;</span> <span class="c1">-- email字段截取前5个的选择性
</span></code></pre></div><p>在查询的时候, 查索引, 然后回表对比是否一致; 继续查索引链表的下一个看看是否一致. 这是以时间换空间.</p>
<h4 id="总结">总结</h4>
<p>单列索引和联合索引的选择: 存在多个查询条件, 考虑针对查询字段建立索引时, 建议建立联合索引</p>
<p>索引设计原则:</p>
<ol>
<li>数据量大(一百万), 查询频繁建立索引</li>
<li>常作为查询条件where, 排序order by, 分组group by操作的字段建立索引</li>
<li>尽量选择区分度高(效率高)的列作为索引, 尽量建立唯一索引</li>
<li>字符串类型字段,长度长的话可以建立前缀索引</li>
<li>尽量使用联合索引. 查询时联合索引很多时候可以覆盖索引, 节省存储空间, 避免回表</li>
<li>控制索引数量, 索引越多, 维护代价越大, 影响增删改效率</li>
<li>如果索引列不能存储NULL值, 创建表时使用NOT NULL约束它. 当优化器知道每列是否包含null值时, 它可以更好确定那个索引最有效用于查询</li>
</ol>
<h2 id="sql优化">SQL优化</h2>
<h3 id="插入数据-insert优化">插入数据, insert优化</h3>
<ol>
<li>
<p>批量插入, 一次性插入500-1000条, 特别大量的插入分成多个insert</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">insert</span> <span class="k">into</span> <span class="n">tb_test</span> <span class="k">values</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;tom&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;cat&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;jerry&#39;</span><span class="p">);</span>
</code></pre></div></li>
<li>
<p>手动事务提交</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="n">start</span> <span class="n">transaction</span> <span class="p">;</span>
<span class="ln">2</span><span class="k">insert</span> <span class="k">into</span> <span class="p">;</span>
<span class="ln">3</span><span class="k">insert</span> <span class="k">into</span> <span class="p">;</span>
<span class="ln">4</span><span class="n">commit</span> <span class="p">;</span>
</code></pre></div></li>
<li>
<p>主键顺序插入</p>
</li>
<li>
<p>使用load指令(大批量数据)</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>①连接mysql加参数--local-infile
<span class="ln">2</span>mysql --local-infile -u root -p
<span class="ln">3</span>②设置全局参数local_file为1, 开启从本地加载文件导入数据的开关
<span class="ln">4</span><span class="nb">set</span> global <span class="nv">local_infile</span> <span class="o">=</span>1<span class="p">;</span>
<span class="ln">5</span>③执行load指令. fields terminated by <span class="s1">&#39;,&#39;</span>表示列之间的分隔符, lines terminated by <span class="s1">&#39;\n&#39;</span>表示行数据的分隔符
<span class="ln">6</span>load data <span class="nb">local</span> infile <span class="s1">&#39;/root/sql1.log&#39;</span> into table <span class="s1">&#39;tb_user&#39;</span> fields terminated by <span class="s1">&#39;,&#39;</span> lines terminated by <span class="s1">&#39;\n&#39;</span><span class="p">;</span>
</code></pre></div></li>
</ol>
<h3 id="主键优化">主键优化</h3>
<p>页分裂: 当一个数据插入到页已经满的地方时, 就会页分裂. 这时复制后50%到另一个页里面, 然后将数据插入另一个页, 最后再修改页指针执行新的页</p>
<p>页合并: 当删除一行记录, 并没有真正地被物理删除, 只是标记删除并且它的空间允许其他记录使用. 当删除页达到MERGE_THRESHOLD(默认页50%), Innodb开始寻找最靠近的页 看看是否可以将两个页合并以优化空间使用.</p>
<p>主键设计原则:</p>
<ol>
<li>尽量降低主键长度(辅助索引叶子节点挂的都是主键, 会导致空间占用很多)</li>
<li>插入数据尽量顺序插入, 选择使用AUTO_INCREMENT自增主键</li>
<li>尽量不要使用UUID做主键或者其他自然主键, 如身份证</li>
<li>业务操作避免对主键的修改.</li>
</ol>
<h3 id="order-by-优化">order by 优化</h3>
<p>using filesort: 通过表的索引或全表扫描, 读取满足条件的数据行, 然后在排序缓冲区sort buffer中完成排序操作.</p>
<p>所有不是通过索引直接返回排序结果的排序都叫filesort排序, 覆盖索引是前提.</p>
<p>using index: 通过有序索引顺序扫描直接返回有序数据, 不需要额外排序, 操作效率高.</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="k">explain</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">phone</span> <span class="k">from</span> <span class="n">tb_user</span> <span class="k">order</span> <span class="k">by</span> <span class="n">age</span><span class="p">,</span> <span class="n">phone</span> <span class="c1">-- 没有索引时, using filesort
</span><span class="ln"> 2</span><span class="c1"></span>
<span class="ln"> 3</span><span class="k">create</span> <span class="k">index</span> <span class="n">idx_user_age_phone_aa</span> <span class="k">on</span> <span class="nf">tb_user</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">phone</span><span class="p">);</span> <span class="c1">-- 创建两个升序索引
</span><span class="ln"> 4</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">phone</span> <span class="k">from</span> <span class="n">tb_user</span> <span class="k">order</span> <span class="k">by</span> <span class="n">age</span><span class="p">,</span> <span class="n">phone</span><span class="p">;</span> <span class="c1">-- 有索引时, using index
</span><span class="ln"> 5</span><span class="c1"></span>
<span class="ln"> 6</span><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb_user</span> <span class="k">order</span> <span class="k">by</span> <span class="n">age</span><span class="p">,</span> <span class="n">phone</span><span class="p">;</span> <span class="c1">-- 没用索引, using filesort, 这时不是覆盖查询了, 回表了.
</span><span class="ln"> 7</span><span class="c1"></span>
<span class="ln"> 8</span><span class="k">explain</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">phone</span> <span class="k">from</span> <span class="n">tb_user</span> <span class="k">order</span> <span class="k">by</span> <span class="n">age</span> <span class="k">desc</span><span class="p">,</span> <span class="n">phone</span> <span class="k">desc</span><span class="p">;</span> <span class="c1">-- 反向利用索引, using index
</span><span class="ln"> 9</span><span class="c1"></span>
<span class="ln">10</span><span class="k">explain</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">phone</span> <span class="k">from</span> <span class="n">tb_user</span> <span class="k">order</span> <span class="k">by</span> <span class="n">age</span> <span class="k">asc</span><span class="p">,</span> <span class="n">phone</span> <span class="k">desc</span><span class="p">;</span> <span class="c1">-- 没有用到索引 using filesort
</span><span class="ln">11</span><span class="c1"></span>
<span class="ln">12</span><span class="k">create</span> <span class="k">index</span> <span class="n">idx_user_age_phone_ad</span> <span class="k">on</span> <span class="nf">tb_user</span><span class="p">(</span><span class="n">age</span> <span class="k">asc</span><span class="p">,</span> <span class="n">phone</span> <span class="k">desc</span><span class="p">);</span> <span class="c1">-- 创建一个升序,一个降序索引
</span><span class="ln">13</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">phone</span> <span class="k">from</span> <span class="n">tb_user</span> <span class="k">order</span> <span class="k">by</span> <span class="n">age</span> <span class="k">asc</span><span class="p">,</span> <span class="n">phone</span> <span class="k">desc</span><span class="p">;</span> <span class="c1">-- 用到索引 using index
</span></code></pre></div><p>OrderBy优化:</p>
<ol>
<li>根据排序字段建立合适的索引, 多字段排序时, 遵循最左前缀法则.</li>
<li>尽量使用覆盖索引</li>
<li>多字段排序, 一个升序一个降序, 此时需要注意联合所以在创建时的规则, show index中的collation就是排序规则,A升D降</li>
<li>如果不可避免的出现filesort, 大数据量排序时, 可以适当增大排序缓冲区大小sort_buffer_size(默认256k)</li>
</ol>
<h3 id="group-by-优化">group by 优化</h3>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">explain</span> <span class="k">select</span> <span class="n">profession</span><span class="p">,</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb_user</span> <span class="k">group</span> <span class="k">by</span> <span class="n">profession</span><span class="p">;</span> <span class="c1">-- 没有查询的时候, 用临时表
</span><span class="ln">2</span><span class="c1"></span><span class="k">create</span> <span class="k">index</span> <span class="n">idx_user_pro_age_sta</span> <span class="k">on</span> <span class="nf">tb_user</span><span class="p">(</span><span class="n">profession</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span> <span class="c1">-- 创建联合索引
</span><span class="ln">3</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="n">profession</span><span class="p">,</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb_user</span> <span class="k">group</span> <span class="k">by</span> <span class="n">profession</span><span class="p">;</span> <span class="c1">-- 用了联合索引
</span><span class="ln">4</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="n">age</span><span class="p">,</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb_user</span> <span class="k">group</span> <span class="k">by</span> <span class="n">age</span><span class="p">;</span> <span class="c1">-- 违反最左前缀法则, 用到临时表
</span><span class="ln">5</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="n">profession</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb_user</span> <span class="k">group</span> <span class="k">by</span> <span class="n">profession</span><span class="p">,</span> <span class="n">age</span><span class="p">;</span> <span class="c1">-- 用联合索引
</span><span class="ln">6</span><span class="c1"></span><span class="k">explain</span> <span class="k">select</span> <span class="n">age</span><span class="p">,</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">tb_user</span> <span class="k">where</span> <span class="n">profession</span><span class="o">=</span><span class="s1">&#39;软件工程&#39;</span> <span class="k">group</span> <span class="k">by</span> <span class="n">age</span><span class="p">;</span> <span class="c1">-- 用到联合索引, 最左前缀
</span></code></pre></div><h3 id="limit优化">limit优化</h3>
<p>limit 1000000, 10 此时MySQL需要排序前1000010条记录, 仅仅返回1000000-1000010的记录, 其他丢弃</p>
<p>一般分页查询时, 通过创建覆盖索引能够较好地提高性能, 可以通过覆盖查询+子查询的形式进行优化</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb_sku</span> <span class="k">limit</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">10</span><span class="p">;</span>  <span class="c1">-- 19s
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="n">t</span><span class="p">.</span><span class="o">*</span> <span class="k">from</span> <span class="n">tb_sku</span> <span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="k">select</span>  <span class="n">id</span> <span class="k">from</span> <span class="n">tb_sku</span> <span class="k">order</span> <span class="k">by</span> <span class="n">id</span> <span class="k">limit</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="n">a</span> <span class="k">where</span> <span class="n">t</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">;</span> <span class="c1">-- 11s
</span><span class="ln">3</span><span class="c1"></span>
</code></pre></div><h3 id="count优化">count优化</h3>
<p>MyISAM引擎把一个表总行数存在了磁盘上, 因此执行count(*)的时候直接返回这个数, 效率很高</p>
<p>Innodb执行count(*)需要把数据一行行从引擎里面读出来, 累积计数.</p>
<ul>
<li>
<p>count()是一个聚合函数, 对于返回结果集, 一行行判断. 如果count函数的参数不是null, 累计数+1, 否则不加. 最后返回累计值</p>
</li>
<li>
<p>count(*): Innodb并不会把全部字段取出来, 专门做了优化, 不取值, 服务层直接按行进行累加.</p>
</li>
<li>
<p>count(1): Innodb遍历整张表, 但不取值, 服务层对于返回的每一行, 放一个数'1&rsquo;进去, 直接按行进行累加. 当然其他数都可以</p>
</li>
<li>
<p>count(主键): Innodb遍历整张表, 把每一行的主键id取出来, 返回服务层, 服务层拿到主键直接按行进行累加(主键没有null)</p>
</li>
<li>
<p>count(字段): 没有not null的字段, 取出来之后到服务层, 服务层需要判断是否是null, 不为null计数累加</p>
</li>
<li>
<p>count(字段): 有not null的字段, 取出来之后到服务层, 服务层直接按行进行累加</p>
</li>
</ul>
<p>效率: count(*) ≈ count(1) &gt; count(主键) &gt; count(字段)</p>
<h3 id="update优化">update优化</h3>
<p>Innodb的行锁是针对索引加的锁, 不是针对记录加的锁, 使用的条件一定要有索引不然就是表锁; 该索引不能失效, 否则行锁变为列锁</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 使用主键索引
</span><span class="ln">2</span><span class="c1"></span><span class="k">update</span> <span class="n">student</span> <span class="kt">set</span> <span class="n">no</span><span class="o">=</span><span class="s1">&#39;20010101&#39;</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="c1">-- 此时事务加的行锁, 对其他并发事务修改其他行没有影响
</span><span class="ln">3</span><span class="c1"></span><span class="k">update</span> <span class="n">student</span> <span class="kt">set</span> <span class="n">no</span><span class="o">=</span><span class="s1">&#39;20010101&#39;</span> <span class="k">where</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;韦一笑&#39;</span><span class="p">;</span> <span class="c1">-- 当name字段没有索引时,此时加的是表锁, 对表的其他行均不能使用update变更
</span></code></pre></div><h2 id="视图">视图</h2>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="c1">-- 视图
</span><span class="ln"> 2</span><span class="c1">-- 介绍: 视图是一种虚拟存在的表. 视图中的数据并不在数据库中实际存在, 行和列数据来定义自定义视图的查询中使用的表, 并且是在使用视图时动态生成的
</span><span class="ln"> 3</span><span class="c1">-- 作用: 1.简单:简化用户对数据的理解, 也可以简化他们的操作. 那些被经常使用的查询可以被定义为视图
</span><span class="ln"> 4</span><span class="c1">--      2.安全:数据库可以授权,但不能授权到数据库特定的行和列上. 通过视图用户只能查询和修改他们所能见到的数据
</span><span class="ln"> 5</span><span class="c1">--      3.数据独立: 视图可帮助用户屏蔽真实表结构带来的影响.
</span><span class="ln"> 6</span><span class="c1"></span>
<span class="ln"> 7</span><span class="c1">-- 创建: create [or replace] view 视图名称[(列名列表)] as select语句 [with [cascaded|local] check option]
</span><span class="ln"> 8</span><span class="c1"></span><span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="n">view</span> <span class="n">stu_v_1</span> <span class="k">as</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span><span class="n">name</span> <span class="k">from</span> <span class="n">student</span> <span class="k">where</span> <span class="n">id</span><span class="o">&lt;=</span><span class="mi">10</span><span class="p">;</span>
<span class="ln"> 9</span><span class="c1">-- 查询: 查看视图创建语句 show create view 视图名称;
</span><span class="ln">10</span><span class="c1">--      查看视图数据 select * from 视图名称....;
</span><span class="ln">11</span><span class="c1"></span><span class="k">show</span> <span class="k">create</span> <span class="n">view</span> <span class="n">stu_v_1</span><span class="p">;</span>
<span class="ln">12</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">stu_v_1</span><span class="p">;</span>
<span class="ln">13</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">stu_v_1</span> <span class="k">where</span> <span class="n">id</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span>
<span class="ln">14</span><span class="c1">-- 修改: 方式一:create [or replace] view 视图名称[(列名列表)] as select语句 [with [cascaded|local] check option]
</span><span class="ln">15</span><span class="c1">--      方式二:alter view 视图名称[(列名列表)] as select语句 [with [cascaded|local] check option]
</span><span class="ln">16</span><span class="c1"></span><span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="n">view</span> <span class="n">stu_v_1</span> <span class="k">as</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">no</span> <span class="k">from</span> <span class="n">student</span> <span class="k">where</span> <span class="n">id</span><span class="o">&lt;=</span><span class="mi">10</span><span class="p">;</span>
<span class="ln">17</span><span class="k">alter</span> <span class="n">view</span> <span class="n">stu_v_1</span> <span class="k">as</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span><span class="n">name</span> <span class="k">from</span> <span class="n">student</span> <span class="k">where</span> <span class="n">id</span><span class="o">&lt;=</span><span class="mi">10</span><span class="p">;</span>
<span class="ln">18</span><span class="c1">-- 删除: drop view [if exist] 视图名称 [,视图名称]...
</span><span class="ln">19</span><span class="c1"></span><span class="k">drop</span> <span class="n">view</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">stu_v_1</span><span class="p">;</span>
<span class="ln">20</span>
<span class="ln">21</span>
<span class="ln">22</span><span class="c1">-- 检查选项 with [cascaded|local] check option
</span><span class="ln">23</span><span class="c1">-- 当使用with check option子句创建视图, mysql会通过视图检查正在更改的每个行, 如插入,删除,更新, 使其符合试图定义
</span><span class="ln">24</span><span class="c1">-- mysql允许基于另一个视图创建视图, 它还会检查依赖视图中的规则以保持一致性. 为了确定检查范围提供了两个选项cascaded和local, 默认cascaded
</span><span class="ln">25</span><span class="c1">-- 没有check的视图, 可以随便插入数据
</span><span class="ln">26</span><span class="c1"></span><span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="n">view</span> <span class="n">stu_v_1</span> <span class="k">as</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">student</span> <span class="k">where</span> <span class="n">id</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span>
<span class="ln">27</span><span class="k">insert</span> <span class="k">into</span> <span class="n">stu_v_1</span> <span class="k">values</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;tom&#39;</span><span class="p">);</span> <span class="c1">-- 可以插入
</span><span class="ln">28</span><span class="c1">-- 普通的with check option的作用:
</span><span class="ln">29</span><span class="c1"></span><span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="n">view</span> <span class="n">stu_v_1</span> <span class="k">as</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">student</span> <span class="k">where</span> <span class="n">id</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="k">with</span> <span class="n">local</span> <span class="k">check</span> <span class="k">option</span> <span class="p">;</span>
<span class="ln">30</span><span class="k">insert</span> <span class="k">into</span> <span class="n">stu_v_1</span> <span class="k">values</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;tom&#39;</span><span class="p">);</span> <span class="c1">-- 可以插入,满足要求
</span><span class="ln">31</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">stu_v_1</span> <span class="k">values</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="s1">&#39;tom&#39;</span><span class="p">);</span> <span class="c1">-- 不能插入, 不满足&lt;=10的要求
</span><span class="ln">32</span><span class="c1">-- cascaded选项, 级联的意思, 就是向下的视图不管有没有check选项都要检查
</span><span class="ln">33</span><span class="c1"></span><span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="n">view</span> <span class="n">stu_v_1</span> <span class="k">as</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">student</span> <span class="k">where</span> <span class="n">id</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">;</span> <span class="c1">-- 视图1, 没有check
</span><span class="ln">34</span><span class="c1"></span><span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="n">view</span> <span class="n">stu_v_2</span> <span class="k">as</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">stu_v_1</span> <span class="k">where</span> <span class="n">id</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="k">with</span> <span class="n">cascaded</span> <span class="k">check</span> <span class="k">option</span> <span class="p">;</span> <span class="c1">-- 视图2, 级联检查
</span><span class="ln">35</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">stu_v_2</span> <span class="k">values</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;tom&#39;</span><span class="p">);</span> <span class="c1">-- 不行, 不满足视图2的要求
</span><span class="ln">36</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">stu_v_2</span> <span class="k">values</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="s1">&#39;tom&#39;</span><span class="p">);</span> <span class="c1">-- 不行, 不满足视图1的要求
</span><span class="ln">37</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">stu_v_2</span> <span class="k">values</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="s1">&#39;tom&#39;</span><span class="p">);</span> <span class="c1">-- 可以
</span><span class="ln">38</span><span class="c1">-- 再在基础上新增一个视图3, 这时cascaded不会影响上层视图
</span><span class="ln">39</span><span class="c1"></span><span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="n">view</span> <span class="n">stu_v_3</span> <span class="k">as</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">stu_v_2</span> <span class="k">where</span> <span class="n">id</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">;</span>
<span class="ln">40</span><span class="k">insert</span> <span class="k">into</span> <span class="n">stu_v_3</span> <span class="k">values</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="s1">&#39;tom&#39;</span><span class="p">);</span> <span class="c1">-- 满足视图1和2的要求, 可以. 视图3的要求没有check所以条件无所谓
</span><span class="ln">41</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">stu_v_3</span> <span class="k">values</span> <span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="s1">&#39;tom&#39;</span><span class="p">);</span> <span class="c1">-- 满足要求, 可以
</span><span class="ln">42</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">stu_v_3</span> <span class="k">values</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="s1">&#39;tom&#39;</span><span class="p">);</span> <span class="c1">-- 不满足
</span><span class="ln">43</span><span class="c1">-- LOCAL选项: 它只影响本视图, 不会影响上下.
</span><span class="ln">44</span><span class="c1"></span>
<span class="ln">45</span><span class="c1">-- 视图的更新: 要使视图更新, 视图中的行与基础表的行之间必须存在一对一的关系
</span><span class="ln">46</span><span class="c1">-- 视图包含以下任一项 视图不可更新
</span><span class="ln">47</span><span class="c1">-- 1.聚合函数或窗口函数(sum, min, max count等)
</span><span class="ln">48</span><span class="c1">-- 2.distinct
</span><span class="ln">49</span><span class="c1">-- 3.group by
</span><span class="ln">50</span><span class="c1">-- 4.having
</span><span class="ln">51</span><span class="c1">-- 5.union或union all
</span><span class="ln">52</span><span class="c1"></span>
<span class="ln">53</span>
<span class="ln">54</span><span class="c1">-- 视图案例
</span><span class="ln">55</span><span class="c1">-- 1.为了保证数据库安全, 开发人员在操作tb_user表时, 只能看到用户的基本字段,屏蔽手机号和邮箱两个字段
</span><span class="ln">56</span><span class="c1"></span><span class="k">create</span> <span class="n">view</span> <span class="n">tb_user_view</span> <span class="k">as</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">profession</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">create_time</span> <span class="k">from</span> <span class="n">tb_user</span><span class="p">;</span>
<span class="ln">57</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tb_user_view</span><span class="p">;</span>
<span class="ln">58</span><span class="c1">-- 2.查询学生选修的课程(三表联查),为了简化操作,定义视图
</span><span class="ln">59</span><span class="c1"></span><span class="k">create</span> <span class="n">view</span> <span class="n">tb_stu_cource_view</span> <span class="k">as</span> <span class="k">select</span> <span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="n">student_name</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">no</span> <span class="n">student_no</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">name</span> <span class="n">course_name</span> <span class="k">from</span> <span class="n">student</span> <span class="n">s</span><span class="p">,</span> <span class="n">student_course</span> <span class="n">sc</span><span class="p">,</span> <span class="n">course</span> <span class="n">c</span> <span class="k">where</span> <span class="n">s</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">sc</span><span class="p">.</span><span class="n">studentid</span> <span class="k">and</span> <span class="n">sc</span><span class="p">.</span><span class="n">courseid</span><span class="o">=</span><span class="n">c</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</code></pre></div><h2 id="存储过程函数触发器">存储过程/函数/触发器</h2>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">  1</span><span class="c1">-- 存储过程: 事先经过编译并存储在数据库中的一段SQL语句的集合, 调用存储过程可以简化应用开发人员的很多工作,
</span><span class="ln">  2</span><span class="c1">-- 减少数据在数据库和应用服务器之间的传输,对提高数据处理的效率有好处
</span><span class="ln">  3</span><span class="c1">-- 存储过程的思想很简单, 就是数据库SQL语言层面的代码封装与重用
</span><span class="ln">  4</span><span class="c1">-- 特点: 封装复用; 可以接收参数, 返回数据; 减少网络交互提升效率
</span><span class="ln">  5</span><span class="c1"></span>
<span class="ln">  6</span>
<span class="ln">  7</span><span class="c1">-- 创建存储过程
</span><span class="ln">  8</span><span class="c1"># create procedure 存储过程名称([参数列表])
</span><span class="ln">  9</span><span class="c1"># begin
</span><span class="ln"> 10</span><span class="c1">#  -- sql语句
</span><span class="ln"> 11</span><span class="c1"># end;
</span><span class="ln"> 12</span><span class="c1"></span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p1</span><span class="p">()</span>
<span class="ln"> 13</span><span class="n">begin</span>
<span class="ln"> 14</span>    <span class="k">select</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="k">user</span><span class="p">;</span>
<span class="ln"> 15</span><span class="n">end</span><span class="p">;</span>
<span class="ln"> 16</span><span class="c1">-- 如果在命令行中创建存储过程, 需要指定sql语句的结束符, 通过delimiter
</span><span class="ln"> 17</span><span class="c1">-- delimiter $$   设置结束以$$结束
</span><span class="ln"> 18</span><span class="c1"># create procedure p1()
</span><span class="ln"> 19</span><span class="c1"># begin
</span><span class="ln"> 20</span><span class="c1">#     select count(*) from user;
</span><span class="ln"> 21</span><span class="c1"># end$$
</span><span class="ln"> 22</span><span class="c1"></span>
<span class="ln"> 23</span><span class="c1">-- 调用
</span><span class="ln"> 24</span><span class="c1">-- call 名称([参数]);
</span><span class="ln"> 25</span><span class="c1"></span><span class="k">call</span> <span class="nf">p1</span><span class="p">();</span>
<span class="ln"> 26</span><span class="c1">-- 查看存储过程
</span><span class="ln"> 27</span><span class="c1">-- select * from information_schema.ROUTINES where ROUTINE_SCHEMA=&#39;数据库名字&#39;; -- 查询指定数据库存储过程及状态信息
</span><span class="ln"> 28</span><span class="c1">-- show create procedure 存储过程名称; -- 查询某个存储过程定义
</span><span class="ln"> 29</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">ROUTINES</span> <span class="k">where</span> <span class="n">ROUTINE_SCHEMA</span><span class="o">=</span><span class="s1">&#39;bbs&#39;</span><span class="p">;</span>
<span class="ln"> 30</span><span class="k">show</span> <span class="k">create</span> <span class="k">procedure</span> <span class="n">p1</span><span class="p">;</span>
<span class="ln"> 31</span><span class="c1">-- 删除
</span><span class="ln"> 32</span><span class="c1">-- drop procedure if exists 存储过程名称;
</span><span class="ln"> 33</span><span class="c1"></span><span class="k">drop</span> <span class="k">procedure</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">p1</span><span class="p">;</span>
<span class="ln"> 34</span>
<span class="ln"> 35</span>
<span class="ln"> 36</span><span class="c1">-- 变量
</span><span class="ln"> 37</span><span class="c1"></span>
<span class="ln"> 38</span><span class="c1">-- 系统变量是是MySQL服务器提供的, 不是用户定义的, 属于服务器层面. 分为全局变量(global)和会话变量(session)
</span><span class="ln"> 39</span><span class="c1">-- 全局变量在所有MySQL会话都有效, 会话变量只在当前会话有效
</span><span class="ln"> 40</span><span class="c1">-- 查看系统变量, 默认都是session
</span><span class="ln"> 41</span><span class="c1">-- 查看所有系统变量 show [global|session] variables;
</span><span class="ln"> 42</span><span class="c1">-- 通过模糊匹配查看变量 show [global|session] variables like &#39;....&#39;;
</span><span class="ln"> 43</span><span class="c1">-- 查看指定变量 select @@[global|session]系统变量名;
</span><span class="ln"> 44</span><span class="c1"></span><span class="k">show</span> <span class="n">variables</span> <span class="p">;</span>
<span class="ln"> 45</span><span class="k">show</span> <span class="n">session</span> <span class="n">variables</span> <span class="p">;</span>
<span class="ln"> 46</span><span class="k">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="p">;</span>
<span class="ln"> 47</span><span class="k">show</span> <span class="n">variables</span> <span class="k">like</span> <span class="s1">&#39;auto%&#39;</span><span class="p">;</span>
<span class="ln"> 48</span><span class="k">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="k">like</span> <span class="s1">&#39;auto%&#39;</span><span class="p">;</span>
<span class="ln"> 49</span><span class="k">select</span> <span class="o">@@</span><span class="n">autocommit</span><span class="p">;</span>
<span class="ln"> 50</span><span class="k">select</span> <span class="o">@@</span><span class="n">session</span><span class="p">.</span><span class="n">autocommit</span><span class="p">;</span>
<span class="ln"> 51</span><span class="k">select</span> <span class="o">@@</span><span class="n">global</span><span class="p">.</span><span class="n">autocommit</span><span class="p">;</span>
<span class="ln"> 52</span>
<span class="ln"> 53</span><span class="c1">-- 设置系统变量, MySQL服务重启后, 所设置的全局变量会失效, 要想不失效,可以在/etc/my.cnf中配置
</span><span class="ln"> 54</span><span class="c1">-- set [session|global] 系统变量名=值;
</span><span class="ln"> 55</span><span class="c1">-- set @@[session|global] 系统变量名=值;
</span><span class="ln"> 56</span><span class="c1"></span><span class="kt">set</span> <span class="n">session</span> <span class="n">autocommit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln"> 57</span><span class="kt">set</span> <span class="n">global</span> <span class="n">autocommit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln"> 58</span>
<span class="ln"> 59</span><span class="c1">-- 用户定义变量: 不用提前声明, 用的时候直接用@变量名
</span><span class="ln"> 60</span><span class="c1">-- 作用域是当前会话, 其他会话用不了.
</span><span class="ln"> 61</span><span class="c1">-- 赋值, 推荐使用:=, 因为=可以作为比较运算符
</span><span class="ln"> 62</span><span class="c1">-- set @var_name =expr [,@var_name=expr]...;
</span><span class="ln"> 63</span><span class="c1">-- set @var_name :=expr [,@var_name:=expr]...;
</span><span class="ln"> 64</span><span class="c1">-- select @var_name :=expr [,@var_name :=expr] ...;
</span><span class="ln"> 65</span><span class="c1">-- select 字段名 into @var_name from 表名;
</span><span class="ln"> 66</span><span class="c1"></span><span class="kt">set</span> <span class="o">@</span><span class="n">caonima</span><span class="o">=</span><span class="s1">&#39;cnm&#39;</span><span class="p">;</span>
<span class="ln"> 67</span><span class="kt">set</span> <span class="o">@</span><span class="n">mygender</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;男&#39;</span><span class="p">,</span> <span class="o">@</span><span class="n">myhobby</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;java&#39;</span><span class="p">;</span>
<span class="ln"> 68</span><span class="k">select</span> <span class="o">@</span><span class="n">cnm</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">;</span>
<span class="ln"> 69</span><span class="k">select</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">into</span> <span class="o">@</span><span class="n">usercount</span> <span class="k">from</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span><span class="p">;</span>
<span class="ln"> 70</span><span class="c1">-- 使用
</span><span class="ln"> 71</span><span class="c1">-- select @var_name;
</span><span class="ln"> 72</span><span class="c1"></span><span class="k">select</span> <span class="o">@</span><span class="n">caonima</span><span class="p">;</span>
<span class="ln"> 73</span><span class="k">select</span> <span class="o">@</span><span class="n">mygender</span><span class="p">,</span> <span class="o">@</span><span class="n">myhobby</span><span class="p">,</span> <span class="o">@</span><span class="n">usercount</span><span class="p">;</span>
<span class="ln"> 74</span><span class="k">select</span> <span class="o">@</span><span class="n">abc</span><span class="p">;</span> <span class="c1">-- 没声明赋值,结果是null
</span><span class="ln"> 75</span><span class="c1"></span>
<span class="ln"> 76</span><span class="c1">-- 局部变量: 需要定义的在局部生效的变量, 访问需要declare声明. 可用作存储过程的局部变量和输入参数
</span><span class="ln"> 77</span><span class="c1">-- 局部变量的范围是在其内声明的begin and块.
</span><span class="ln"> 78</span><span class="c1">-- 声明, 没有@符号了
</span><span class="ln"> 79</span><span class="c1">-- declare 变量名 变量类型 [default...];
</span><span class="ln"> 80</span><span class="c1">-- 变量类型: int, bigint, char, varchar, date, time等
</span><span class="ln"> 81</span><span class="c1">-- 赋值, 没有@符号.
</span><span class="ln"> 82</span><span class="c1">-- set 变量名=值;
</span><span class="ln"> 83</span><span class="c1">-- set 变量名:=值;
</span><span class="ln"> 84</span><span class="c1">-- select 字段 into 变量名 from 表名;
</span><span class="ln"> 85</span><span class="c1"></span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p2</span><span class="p">()</span>
<span class="ln"> 86</span><span class="n">begin</span>
<span class="ln"> 87</span>    <span class="k">declare</span> <span class="n">stu_count</span> <span class="kt">int</span> <span class="k">default</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln"> 88</span>    <span class="k">select</span> <span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">into</span> <span class="n">stu_count</span> <span class="k">from</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span><span class="p">;</span>
<span class="ln"> 89</span>    <span class="k">select</span> <span class="n">stu_count</span><span class="p">;</span>
<span class="ln"> 90</span><span class="n">end</span><span class="p">;</span>
<span class="ln"> 91</span><span class="k">call</span> <span class="nf">p2</span><span class="p">();</span>
<span class="ln"> 92</span>
<span class="ln"> 93</span>
<span class="ln"> 94</span><span class="c1">-- 流程控制结构
</span><span class="ln"> 95</span><span class="c1">-- if语法
</span><span class="ln"> 96</span><span class="c1"># if 条件1 then
</span><span class="ln"> 97</span><span class="c1">#     ...
</span><span class="ln"> 98</span><span class="c1"># elseif 条件2 then
</span><span class="ln"> 99</span><span class="c1">#     ...
</span><span class="ln">100</span><span class="c1"># else
</span><span class="ln">101</span><span class="c1">#     ...
</span><span class="ln">102</span><span class="c1"># end if;
</span><span class="ln">103</span><span class="c1"></span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p3</span><span class="p">()</span>
<span class="ln">104</span><span class="n">begin</span>
<span class="ln">105</span>    <span class="k">declare</span> <span class="n">score</span> <span class="kt">int</span> <span class="k">default</span> <span class="mi">59</span><span class="p">;</span>
<span class="ln">106</span>    <span class="k">declare</span> <span class="n">result</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="ln">107</span>
<span class="ln">108</span>    <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">85</span> <span class="k">then</span>
<span class="ln">109</span>        <span class="kt">set</span> <span class="n">result</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;优秀&#39;</span><span class="p">;</span>
<span class="ln">110</span>    <span class="k">elseif</span> <span class="n">score</span> <span class="o">&gt;=</span><span class="mi">60</span> <span class="k">then</span>
<span class="ln">111</span>        <span class="kt">set</span> <span class="n">result</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;及格&#39;</span><span class="p">;</span>
<span class="ln">112</span>    <span class="k">else</span>
<span class="ln">113</span>        <span class="kt">set</span> <span class="n">result</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;不及格&#39;</span><span class="p">;</span>
<span class="ln">114</span>    <span class="n">end</span> <span class="k">if</span><span class="p">;</span>
<span class="ln">115</span>
<span class="ln">116</span>    <span class="k">select</span> <span class="n">result</span><span class="p">;</span>
<span class="ln">117</span><span class="n">end</span><span class="p">;</span>
<span class="ln">118</span>
<span class="ln">119</span><span class="k">call</span> <span class="nf">p3</span><span class="p">();</span>
<span class="ln">120</span>
<span class="ln">121</span><span class="c1">-- 参数
</span><span class="ln">122</span><span class="c1">-- 类型: IN 作为输入的参数, 需要调用时传值, 此为默认
</span><span class="ln">123</span><span class="c1">--      OUT 作为输出的参数, 该参数可以作为返回值
</span><span class="ln">124</span><span class="c1">--      INOUT 既可以作为输入, 也可以作为输出的参数
</span><span class="ln">125</span><span class="c1"># create procedure 存储过程名称([in/out/inout 参数名 参数类型])
</span><span class="ln">126</span><span class="c1"># begin
</span><span class="ln">127</span><span class="c1">#     -- sql
</span><span class="ln">128</span><span class="c1"># end;
</span><span class="ln">129</span><span class="c1">-- 判断成绩的存储过程
</span><span class="ln">130</span><span class="c1"></span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p4</span><span class="p">(</span><span class="k">in</span> <span class="n">score</span> <span class="kt">int</span><span class="p">,</span> <span class="k">out</span> <span class="n">result</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="ln">131</span><span class="n">begin</span>
<span class="ln">132</span>    <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">85</span> <span class="k">then</span>
<span class="ln">133</span>        <span class="kt">set</span> <span class="n">result</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;优秀&#39;</span><span class="p">;</span>
<span class="ln">134</span>    <span class="k">elseif</span> <span class="n">score</span> <span class="o">&gt;=</span><span class="mi">60</span> <span class="k">then</span>
<span class="ln">135</span>        <span class="kt">set</span> <span class="n">result</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;及格&#39;</span><span class="p">;</span>
<span class="ln">136</span>    <span class="k">else</span>
<span class="ln">137</span>        <span class="kt">set</span> <span class="n">result</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;不及格&#39;</span><span class="p">;</span>
<span class="ln">138</span>    <span class="n">end</span> <span class="k">if</span><span class="p">;</span>
<span class="ln">139</span><span class="n">end</span><span class="p">;</span>
<span class="ln">140</span><span class="k">call</span> <span class="nf">p4</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">@</span><span class="n">result</span><span class="p">);</span>
<span class="ln">141</span><span class="k">select</span> <span class="o">@</span><span class="n">result</span><span class="p">;</span>
<span class="ln">142</span>
<span class="ln">143</span><span class="c1">-- 将传入的200分制的分数, 换算成100分制的分数
</span><span class="ln">144</span><span class="c1"></span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p5</span><span class="p">(</span><span class="k">inout</span> <span class="n">score</span> <span class="kt">double</span><span class="p">)</span>
<span class="ln">145</span><span class="n">begin</span>
<span class="ln">146</span>    <span class="kt">set</span> <span class="n">score</span><span class="p">:</span><span class="o">=</span><span class="n">score</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
<span class="ln">147</span><span class="n">end</span><span class="p">;</span>
<span class="ln">148</span><span class="kt">set</span> <span class="o">@</span><span class="n">score</span><span class="p">:</span><span class="o">=</span><span class="mi">199</span><span class="p">.</span><span class="mi">8</span><span class="p">;</span>
<span class="ln">149</span><span class="k">call</span> <span class="nf">p5</span><span class="p">(</span><span class="o">@</span><span class="n">score</span><span class="p">);</span>
<span class="ln">150</span><span class="k">select</span> <span class="o">@</span><span class="n">score</span><span class="p">;</span>
<span class="ln">151</span>
<span class="ln">152</span><span class="c1">-- case
</span><span class="ln">153</span><span class="c1">-- 语法1
</span><span class="ln">154</span><span class="c1"># case case_value
</span><span class="ln">155</span><span class="c1">#     when when_value1 then statement_list1 -- 当case_value=value1时执行when之后的sql语句
</span><span class="ln">156</span><span class="c1">#     [when when_value2 then statement_list2]...
</span><span class="ln">157</span><span class="c1">#     [else statement_list] -- 都不满足时执行的sql语句
</span><span class="ln">158</span><span class="c1"># end case;
</span><span class="ln">159</span><span class="c1">-- 语法2
</span><span class="ln">160</span><span class="c1"># case
</span><span class="ln">161</span><span class="c1">#     when search_condition1 then statement_list1 -- 当search_condition1为true时执行
</span><span class="ln">162</span><span class="c1">#     [when search_condition2 then statement_list2]...
</span><span class="ln">163</span><span class="c1">#     [else statement_list] -- 都不满足时执行的sql语句
</span><span class="ln">164</span><span class="c1"># end case;
</span><span class="ln">165</span><span class="c1">-- 根据传入的月份,判断月份所属的季节
</span><span class="ln">166</span><span class="c1"></span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p6</span><span class="p">(</span><span class="k">in</span> <span class="n">month</span> <span class="kt">int</span><span class="p">)</span>
<span class="ln">167</span><span class="n">begin</span>
<span class="ln">168</span>    <span class="k">declare</span> <span class="n">result</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="ln">169</span>    <span class="k">case</span>
<span class="ln">170</span>        <span class="k">when</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">and</span> <span class="n">month</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="k">then</span> <span class="kt">set</span> <span class="n">result</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;第一季度&#39;</span><span class="p">;</span>
<span class="ln">171</span>        <span class="k">when</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">and</span> <span class="n">month</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="k">then</span> <span class="kt">set</span> <span class="n">result</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;第二季度&#39;</span><span class="p">;</span>
<span class="ln">172</span>        <span class="k">when</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">7</span> <span class="k">and</span> <span class="n">month</span> <span class="o">&lt;=</span> <span class="mi">9</span> <span class="k">then</span> <span class="kt">set</span> <span class="n">result</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;第三季度&#39;</span><span class="p">;</span>
<span class="ln">173</span>        <span class="k">when</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="k">and</span> <span class="n">month</span> <span class="o">&lt;=</span> <span class="mi">12</span> <span class="k">then</span> <span class="kt">set</span> <span class="n">result</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;第四季度&#39;</span><span class="p">;</span>
<span class="ln">174</span>        <span class="k">else</span> <span class="kt">set</span> <span class="n">result</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;错误输入!&#39;</span><span class="p">;</span>
<span class="ln">175</span>    <span class="n">end</span> <span class="k">case</span><span class="p">;</span>
<span class="ln">176</span>    <span class="k">select</span> <span class="nf">concat</span><span class="p">(</span><span class="s1">&#39;输入的月份为&#39;</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="s1">&#39;, 它所属的季度为: &#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="ln">177</span><span class="n">end</span><span class="p">;</span>
<span class="ln">178</span><span class="k">call</span> <span class="nf">p6</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="ln">179</span>
<span class="ln">180</span><span class="c1">-- while循环: 有条件的循环, 满足条件才循环
</span><span class="ln">181</span><span class="c1"># while 条件 DO
</span><span class="ln">182</span><span class="c1">#     sql...;
</span><span class="ln">183</span><span class="c1"># end while;
</span><span class="ln">184</span><span class="c1">-- 计算1累加到n
</span><span class="ln">185</span><span class="c1"></span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p7</span><span class="p">(</span><span class="k">in</span> <span class="n">count</span> <span class="kt">int</span><span class="p">)</span>
<span class="ln">186</span><span class="n">begin</span>
<span class="ln">187</span>    <span class="k">declare</span> <span class="n">i</span> <span class="kt">int</span> <span class="k">default</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">188</span>    <span class="k">declare</span> <span class="n">res</span> <span class="kt">int</span> <span class="k">default</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">189</span>    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">count</span> <span class="n">do</span>
<span class="ln">190</span>        <span class="kt">set</span> <span class="n">res</span> <span class="p">:</span><span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
<span class="ln">191</span>        <span class="kt">set</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">192</span>    <span class="n">end</span> <span class="k">while</span><span class="p">;</span>
<span class="ln">193</span>    <span class="k">select</span> <span class="n">res</span><span class="p">;</span>
<span class="ln">194</span><span class="n">end</span><span class="p">;</span>
<span class="ln">195</span>
<span class="ln">196</span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p7</span><span class="p">(</span><span class="k">in</span> <span class="n">count</span> <span class="kt">int</span><span class="p">)</span>
<span class="ln">197</span><span class="n">begin</span>
<span class="ln">198</span>    <span class="k">declare</span> <span class="n">res</span> <span class="kt">int</span> <span class="k">default</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">199</span>    <span class="k">while</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">do</span>
<span class="ln">200</span>            <span class="kt">set</span> <span class="n">res</span> <span class="p">:</span><span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
<span class="ln">201</span>            <span class="kt">set</span> <span class="n">count</span> <span class="p">:</span><span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">202</span>        <span class="n">end</span> <span class="k">while</span><span class="p">;</span>
<span class="ln">203</span>    <span class="k">select</span> <span class="n">res</span><span class="p">;</span>
<span class="ln">204</span><span class="n">end</span><span class="p">;</span>
<span class="ln">205</span><span class="k">drop</span> <span class="k">procedure</span> <span class="n">p7</span><span class="p">;</span>
<span class="ln">206</span><span class="k">call</span> <span class="nf">p7</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="ln">207</span>
<span class="ln">208</span><span class="c1">-- repeat循环: 满足循环退出
</span><span class="ln">209</span><span class="c1"># repeat
</span><span class="ln">210</span><span class="c1">#     sql...;
</span><span class="ln">211</span><span class="c1">#     until 条件; -- 当条件为真,退出循环
</span><span class="ln">212</span><span class="c1"># end repeat;
</span><span class="ln">213</span><span class="c1">-- 1加到n
</span><span class="ln">214</span><span class="c1"></span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p8</span><span class="p">(</span><span class="k">in</span> <span class="n">count</span> <span class="kt">int</span><span class="p">)</span>
<span class="ln">215</span><span class="n">begin</span>
<span class="ln">216</span>    <span class="k">declare</span> <span class="n">res</span> <span class="kt">int</span> <span class="k">default</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">217</span>    <span class="k">repeat</span>
<span class="ln">218</span>        <span class="kt">set</span> <span class="n">res</span><span class="p">:</span><span class="o">=</span><span class="n">res</span><span class="o">+</span><span class="n">count</span><span class="p">;</span>
<span class="ln">219</span>        <span class="kt">set</span> <span class="n">count</span><span class="p">:</span><span class="o">=</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">220</span>    <span class="n">until</span> <span class="n">count</span> <span class="o">&lt;</span><span class="mi">0</span> <span class="n">end</span> <span class="k">repeat</span><span class="p">;</span>
<span class="ln">221</span>    <span class="k">select</span> <span class="n">res</span><span class="p">;</span>
<span class="ln">222</span><span class="n">end</span><span class="p">;</span>
<span class="ln">223</span><span class="k">call</span> <span class="nf">p8</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="ln">224</span>
<span class="ln">225</span><span class="c1">-- loop循环: 简单循环, 如果不增加退出循环条件那么就是死循环, 它配合leave和iterate使用
</span><span class="ln">226</span><span class="c1">-- leave: 退出循环
</span><span class="ln">227</span><span class="c1">-- iterate: 必须用在循环中, 作用是跳过当前循环剩下语句进入下循环
</span><span class="ln">228</span><span class="c1"># [begin_label:] loop -- 指定标识label
</span><span class="ln">229</span><span class="c1">#     sql...;
</span><span class="ln">230</span><span class="c1">#     leave label; -- 退出循环
</span><span class="ln">231</span><span class="c1">#     iterate label; -- 跳到下次循环
</span><span class="ln">232</span><span class="c1"># end loop [end_label];
</span><span class="ln">233</span><span class="c1">-- 实现1累加n
</span><span class="ln">234</span><span class="c1"></span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p9</span><span class="p">(</span><span class="k">in</span> <span class="n">count</span> <span class="kt">int</span><span class="p">)</span>
<span class="ln">235</span><span class="n">begin</span>
<span class="ln">236</span>    <span class="k">declare</span> <span class="n">res</span> <span class="kt">int</span> <span class="k">default</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">237</span>    <span class="n">loop_label</span><span class="p">:</span> <span class="k">loop</span>
<span class="ln">238</span>        <span class="kt">set</span> <span class="n">res</span> <span class="p">:</span><span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
<span class="ln">239</span>        <span class="kt">set</span> <span class="n">count</span> <span class="p">:</span><span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">240</span>        <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">then</span>
<span class="ln">241</span>            <span class="k">leave</span> <span class="n">loop_label</span><span class="p">;</span>
<span class="ln">242</span>        <span class="n">end</span> <span class="k">if</span><span class="p">;</span>
<span class="ln">243</span>    <span class="n">end</span> <span class="k">loop</span> <span class="n">loop_label</span><span class="p">;</span>
<span class="ln">244</span>    <span class="k">select</span> <span class="n">res</span><span class="p">;</span>
<span class="ln">245</span><span class="n">end</span><span class="p">;</span>
<span class="ln">246</span><span class="k">call</span> <span class="nf">p9</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="ln">247</span><span class="c1">-- 计算1-n的偶数累加
</span><span class="ln">248</span><span class="c1"></span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p10</span><span class="p">(</span><span class="k">in</span> <span class="n">count</span> <span class="kt">int</span><span class="p">)</span>
<span class="ln">249</span><span class="n">begin</span>
<span class="ln">250</span>    <span class="k">declare</span> <span class="n">res</span> <span class="kt">int</span> <span class="k">default</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">251</span>    <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span>
<span class="ln">252</span>        <span class="kt">set</span> <span class="n">count</span><span class="p">:</span><span class="o">=</span> <span class="n">count</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">253</span>    <span class="n">end</span> <span class="k">if</span><span class="p">;</span>
<span class="ln">254</span>    <span class="n">odd_sum</span><span class="p">:</span><span class="k">loop</span>
<span class="ln">255</span>        <span class="kt">set</span> <span class="n">res</span> <span class="p">:</span><span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
<span class="ln">256</span>        <span class="kt">set</span> <span class="n">count</span> <span class="p">:</span><span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
<span class="ln">257</span>        <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">then</span>
<span class="ln">258</span>            <span class="k">leave</span> <span class="n">odd_sum</span><span class="p">;</span>
<span class="ln">259</span>        <span class="n">end</span> <span class="k">if</span><span class="p">;</span>
<span class="ln">260</span>    <span class="n">end</span> <span class="k">loop</span> <span class="n">odd_sum</span><span class="p">;</span>
<span class="ln">261</span>    <span class="k">select</span> <span class="n">res</span><span class="p">;</span>
<span class="ln">262</span><span class="n">end</span><span class="p">;</span>
<span class="ln">263</span>
<span class="ln">264</span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p10</span><span class="p">(</span><span class="k">in</span> <span class="n">count</span> <span class="kt">int</span><span class="p">)</span>
<span class="ln">265</span><span class="n">begin</span>
<span class="ln">266</span>    <span class="k">declare</span> <span class="n">res</span> <span class="kt">int</span> <span class="k">default</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">267</span>    <span class="n">odd_sum</span><span class="p">:</span> <span class="k">loop</span>
<span class="ln">268</span>        <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">then</span>
<span class="ln">269</span>            <span class="k">leave</span> <span class="n">odd_sum</span><span class="p">;</span>
<span class="ln">270</span>        <span class="n">end</span> <span class="k">if</span><span class="p">;</span>
<span class="ln">271</span>        <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span>
<span class="ln">272</span>            <span class="kt">set</span> <span class="n">count</span> <span class="p">:</span><span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">273</span>            <span class="k">iterate</span> <span class="n">odd_sum</span><span class="p">;</span>
<span class="ln">274</span>        <span class="n">end</span> <span class="k">if</span><span class="p">;</span>
<span class="ln">275</span>        <span class="kt">set</span> <span class="n">res</span> <span class="p">:</span><span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
<span class="ln">276</span>        <span class="kt">set</span> <span class="n">count</span> <span class="p">:</span><span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">277</span>    <span class="n">end</span> <span class="k">loop</span> <span class="n">odd_sum</span><span class="p">;</span>
<span class="ln">278</span>    <span class="k">select</span> <span class="n">res</span><span class="p">;</span>
<span class="ln">279</span><span class="n">end</span><span class="p">;</span>
<span class="ln">280</span>
<span class="ln">281</span><span class="k">drop</span> <span class="k">procedure</span> <span class="n">p10</span><span class="p">;</span>
<span class="ln">282</span><span class="k">call</span> <span class="nf">p10</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="ln">283</span>
<span class="ln">284</span>
<span class="ln">285</span><span class="c1">-- 游标: 存储查询结果集的数据类型, 在存储过程和函数中可以使用游标对结果集进行循环处理
</span><span class="ln">286</span><span class="c1">-- 声明游标: declare 游标名称 cursor for 查询语句;
</span><span class="ln">287</span><span class="c1">-- 打开游标: open 游标名称;
</span><span class="ln">288</span><span class="c1">-- 获取游标记录: fetch 游标名称 into 变量[,变量];
</span><span class="ln">289</span><span class="c1">-- 关闭游标: close 游标名称;
</span><span class="ln">290</span><span class="c1">-- 案例: 根据传入的参数uage, 查询用户表中所有年龄小于uage的用户姓名name和专业profession, 然后将name和profession插入新表
</span><span class="ln">291</span><span class="c1"></span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p11</span><span class="p">(</span><span class="k">in</span> <span class="n">uage</span> <span class="kt">int</span><span class="p">)</span>
<span class="ln">292</span><span class="n">begin</span>
<span class="ln">293</span>    <span class="k">declare</span> <span class="n">uname</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="ln">294</span>    <span class="k">declare</span> <span class="n">ugender</span> <span class="kt">char</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="ln">295</span>    <span class="k">declare</span> <span class="n">u_cursor</span> <span class="k">cursor</span> <span class="k">for</span> <span class="k">select</span> <span class="n">name</span><span class="p">,</span> <span class="n">gender</span> <span class="k">from</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">where</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="n">uage</span><span class="p">;</span>
<span class="ln">296</span>
<span class="ln">297</span>    <span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">tb_user_gender</span><span class="p">;</span>
<span class="ln">298</span>    <span class="k">create</span> <span class="k">table</span> <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="nf">tb_user_gender</span><span class="p">(</span>
<span class="ln">299</span>        <span class="n">id</span> <span class="kt">int</span> <span class="k">primary</span> <span class="k">key</span> <span class="kp">auto_increment</span><span class="p">,</span>
<span class="ln">300</span>        <span class="n">name</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="ln">301</span>        <span class="n">gender</span> <span class="kt">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="ln">302</span>    <span class="p">);</span>
<span class="ln">303</span>    <span class="n">open</span> <span class="n">u_cursor</span><span class="p">;</span>
<span class="ln">304</span>    <span class="k">while</span> <span class="no">true</span> <span class="n">do</span> <span class="c1">-- 这里不知道什么时候结束
</span><span class="ln">305</span><span class="c1"></span>        <span class="k">fetch</span> <span class="n">u_cursor</span> <span class="k">into</span> <span class="n">uname</span><span class="p">,</span> <span class="n">ugender</span><span class="p">;</span>
<span class="ln">306</span>        <span class="k">insert</span> <span class="k">into</span> <span class="n">tb_user_gender</span> <span class="k">values</span> <span class="p">(</span><span class="no">null</span><span class="p">,</span> <span class="n">uname</span><span class="p">,</span> <span class="n">ugender</span><span class="p">);</span>
<span class="ln">307</span>    <span class="n">end</span> <span class="k">while</span><span class="p">;</span>
<span class="ln">308</span>    <span class="n">close</span> <span class="n">u_cursor</span><span class="p">;</span>
<span class="ln">309</span>
<span class="ln">310</span><span class="n">end</span><span class="p">;</span>
<span class="ln">311</span>
<span class="ln">312</span><span class="c1">-- 条件处理程序(异常): 定义在流程控制结构执行过程中遇到的问题时相应的处理步骤
</span><span class="ln">313</span><span class="c1">-- declare handler_action handler for condition_value[,condition_value] ... statement;
</span><span class="ln">314</span><span class="c1">-- handler_action: continue:继续执行当前程序, exit:终止执行当前程序
</span><span class="ln">315</span><span class="c1">-- condition_value: sqlstate sqlstate_value: 状态码, 如02000
</span><span class="ln">316</span><span class="c1">--                  sqlwarning: 所有以01开头的sqlstate代码的简写
</span><span class="ln">317</span><span class="c1">--                  not found: 所有以02开头的sqlstate代码的简写
</span><span class="ln">318</span><span class="c1">--                  sqlexception: 所有没有被sqlwarning和not found捕获的sqlstate代码的简写
</span><span class="ln">319</span><span class="c1"></span><span class="k">create</span> <span class="k">procedure</span> <span class="nf">p11</span><span class="p">(</span><span class="k">in</span> <span class="n">uage</span> <span class="kt">int</span><span class="p">)</span>
<span class="ln">320</span><span class="n">begin</span>
<span class="ln">321</span>    <span class="k">declare</span> <span class="n">uname</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="ln">322</span>    <span class="k">declare</span> <span class="n">ugender</span> <span class="kt">char</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="ln">323</span>    <span class="k">declare</span> <span class="n">u_cursor</span> <span class="k">cursor</span> <span class="k">for</span> <span class="k">select</span> <span class="n">name</span><span class="p">,</span> <span class="n">gender</span> <span class="k">from</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">where</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="n">uage</span><span class="p">;</span>
<span class="ln">324</span>    <span class="k">declare</span> <span class="k">exit</span> <span class="n">handler</span> <span class="k">for</span> <span class="k">sqlstate</span> <span class="s1">&#39;02000&#39;</span> <span class="n">close</span> <span class="n">u_cursor</span><span class="p">;</span> <span class="c1">-- 满足状态码为02000触发退出, 退出时将游标关闭
</span><span class="ln">325</span><span class="c1"></span>    <span class="c1">-- declare exit handler for not found close u_cursor;
</span><span class="ln">326</span><span class="c1"></span>
<span class="ln">327</span>    <span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">tb_user_gender</span><span class="p">;</span>
<span class="ln">328</span>    <span class="k">create</span> <span class="k">table</span> <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="nf">tb_user_gender</span><span class="p">(</span>
<span class="ln">329</span>        <span class="n">id</span> <span class="kt">int</span> <span class="k">primary</span> <span class="k">key</span> <span class="kp">auto_increment</span><span class="p">,</span>
<span class="ln">330</span>        <span class="n">name</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="ln">331</span>        <span class="n">gender</span> <span class="kt">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="ln">332</span>    <span class="p">);</span>
<span class="ln">333</span>    <span class="n">open</span> <span class="n">u_cursor</span><span class="p">;</span>
<span class="ln">334</span>    <span class="k">while</span> <span class="no">true</span> <span class="n">do</span> <span class="c1">-- 现在最后一次循环后, 下面的语句会报错, 被handler抓取退出.
</span><span class="ln">335</span><span class="c1"></span>    <span class="k">fetch</span> <span class="n">u_cursor</span> <span class="k">into</span> <span class="n">uname</span><span class="p">,</span> <span class="n">ugender</span><span class="p">;</span>
<span class="ln">336</span>    <span class="k">insert</span> <span class="k">into</span> <span class="n">tb_user_gender</span> <span class="k">values</span> <span class="p">(</span><span class="no">null</span><span class="p">,</span> <span class="n">uname</span><span class="p">,</span> <span class="n">ugender</span><span class="p">);</span>
<span class="ln">337</span>        <span class="n">end</span> <span class="k">while</span><span class="p">;</span>
<span class="ln">338</span>    <span class="n">close</span> <span class="n">u_cursor</span><span class="p">;</span>
<span class="ln">339</span>
<span class="ln">340</span><span class="n">end</span><span class="p">;</span>
<span class="ln">341</span><span class="k">call</span> <span class="nf">p11</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
<span class="ln">342</span>
<span class="ln">343</span>
<span class="ln">344</span><span class="c1">-- 存储函数: 有返回值的存储过程, 参数只能是in类型的.
</span><span class="ln">345</span><span class="c1"># create function 函数名称([参数列表])
</span><span class="ln">346</span><span class="c1"># returns type [characteristic...]
</span><span class="ln">347</span><span class="c1"># begin
</span><span class="ln">348</span><span class="c1">#     --sql
</span><span class="ln">349</span><span class="c1">#     return ... ;
</span><span class="ln">350</span><span class="c1"># end;
</span><span class="ln">351</span><span class="c1">-- characteristic说明:
</span><span class="ln">352</span><span class="c1">-- determinstic:相同的输入总是产生相同的结果
</span><span class="ln">353</span><span class="c1">-- no sql:不包含sql语句
</span><span class="ln">354</span><span class="c1">-- reads sql data:包含读取sql的语句, 不包含写入数据的语句
</span><span class="ln">355</span><span class="c1">-- 案例: 1累加到n
</span><span class="ln">356</span><span class="c1"></span><span class="k">create</span> <span class="n">function</span> <span class="nf">fun1</span><span class="p">(</span><span class="n">n</span> <span class="kt">int</span><span class="p">)</span>
<span class="ln">357</span><span class="n">returns</span> <span class="kt">int</span> <span class="k">deterministic</span>
<span class="ln">358</span><span class="n">begin</span>
<span class="ln">359</span>    <span class="k">declare</span> <span class="n">res</span> <span class="kt">int</span> <span class="k">default</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">360</span>    <span class="k">while</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">0</span> <span class="n">do</span>
<span class="ln">361</span>        <span class="kt">set</span> <span class="n">res</span><span class="p">:</span><span class="o">=</span><span class="n">res</span><span class="o">+</span><span class="n">n</span><span class="p">;</span>
<span class="ln">362</span>        <span class="kt">set</span> <span class="n">n</span><span class="p">:</span><span class="o">=</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">363</span>    <span class="n">end</span> <span class="k">while</span><span class="p">;</span>
<span class="ln">364</span>    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="ln">365</span><span class="n">end</span><span class="p">;</span>
<span class="ln">366</span>
<span class="ln">367</span>
<span class="ln">368</span><span class="c1">-- 触发器: 在insert/update/delete之前或之后, 触发并执行触发器中定义的sql语句集合
</span><span class="ln">369</span><span class="c1">-- 确保数据完整性, 日志记录, 数据校验等操作.
</span><span class="ln">370</span><span class="c1">-- 使用别名old和new来引用触发器中发生变化的记录内容
</span><span class="ln">371</span><span class="c1">-- insert触发器:new表示将要或已经新增的数据
</span><span class="ln">372</span><span class="c1">-- update触发器:old表示修改之前的数据, new表示将要或已经修改后的数据
</span><span class="ln">373</span><span class="c1">-- delete触发器:old表示将要或已经删除掉的数据
</span><span class="ln">374</span><span class="c1">-- 现在只支持行级触发器(每行触发一次), 不支持语句级触发器(不管影响多少行,只执行一次)
</span><span class="ln">375</span><span class="c1"></span>
<span class="ln">376</span><span class="c1">-- 创建触发器
</span><span class="ln">377</span><span class="c1"># create trigger trigger_name
</span><span class="ln">378</span><span class="c1"># before/after insert/update/delete
</span><span class="ln">379</span><span class="c1"># on tbl_name for each row -- 行级触发器
</span><span class="ln">380</span><span class="c1"># begin
</span><span class="ln">381</span><span class="c1">#     trigger_statement;
</span><span class="ln">382</span><span class="c1"># end;
</span><span class="ln">383</span><span class="c1">-- 查看
</span><span class="ln">384</span><span class="c1"></span><span class="k">show</span> <span class="n">triggers</span> <span class="p">;</span>
<span class="ln">385</span><span class="c1">-- 删除
</span><span class="ln">386</span><span class="c1"># drop trigger [schama_name.]trigger_name; -- 没有指定数据库名默认为当前数据库
</span><span class="ln">387</span><span class="c1"></span>
<span class="ln">388</span><span class="c1">-- 需求, 记录tb_user表数据变更日志, 插入到日志表user_logs中, 包含增加,修改,删除
</span><span class="ln">389</span><span class="c1"></span><span class="k">create</span> <span class="k">table</span> <span class="nf">user_logs</span><span class="p">(</span>
<span class="ln">390</span>    <span class="n">id</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">not</span> <span class="no">null</span> <span class="kp">auto_increment</span><span class="p">,</span>
<span class="ln">391</span>    <span class="n">operation</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">not</span> <span class="no">null</span> <span class="p">,</span>
<span class="ln">392</span>    <span class="n">operation_time</span> <span class="kt">datetime</span> <span class="k">not</span> <span class="no">null</span> <span class="p">,</span>
<span class="ln">393</span>    <span class="n">operation_id</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">not</span> <span class="no">null</span> <span class="p">,</span>
<span class="ln">394</span>    <span class="n">operation_params</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="p">,</span>
<span class="ln">395</span>    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="ln">396</span><span class="p">)</span><span class="kp">engine</span> <span class="o">=</span><span class="n">innodb</span> <span class="k">default</span> <span class="kp">charset</span> <span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="ln">397</span>
<span class="ln">398</span><span class="c1">-- 定义三个触发器
</span><span class="ln">399</span><span class="c1"></span><span class="o">--</span><span class="n">insert触发器</span>
<span class="ln">400</span><span class="k">create</span> <span class="k">trigger</span> <span class="n">insert_trigger</span>
<span class="ln">401</span>    <span class="n">after</span> <span class="k">insert</span> <span class="k">on</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">for</span> <span class="k">each</span> <span class="n">row</span>
<span class="ln">402</span><span class="n">begin</span>
<span class="ln">403</span>    <span class="k">insert</span> <span class="k">into</span> <span class="nf">user_logs</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">operation_time</span><span class="p">,</span> <span class="n">operation_id</span><span class="p">,</span> <span class="n">operation_params</span><span class="p">)</span> <span class="k">values</span>
<span class="ln">404</span>        <span class="p">(</span><span class="no">null</span><span class="p">,</span> <span class="s1">&#39;insert&#39;</span><span class="p">,</span> <span class="nf">now</span><span class="p">(),</span> <span class="n">new</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nf">concat</span><span class="p">(</span><span class="s1">&#39;插入的数据内容: &#39;</span><span class="p">,</span> <span class="n">new</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">new</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new</span><span class="p">.</span><span class="n">gender</span><span class="p">,</span> <span class="n">new</span><span class="p">.</span><span class="n">gender</span><span class="p">));</span>
<span class="ln">405</span><span class="n">end</span><span class="p">;</span>
<span class="ln">406</span><span class="k">show</span> <span class="n">triggers</span> <span class="p">;</span>
<span class="ln">407</span><span class="k">drop</span> <span class="k">trigger</span> <span class="n">insert_trigger</span><span class="p">;</span>
<span class="ln">408</span><span class="k">insert</span> <span class="k">into</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">values</span> <span class="p">(</span><span class="no">null</span><span class="p">,</span> <span class="s1">&#39;rurushu&#39;</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;男&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="ln">409</span><span class="c1">-- update触发器
</span><span class="ln">410</span><span class="c1"></span><span class="k">create</span> <span class="k">trigger</span> <span class="n">update_trigger</span>
<span class="ln">411</span>    <span class="n">after</span> <span class="k">insert</span> <span class="k">on</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">for</span> <span class="k">each</span> <span class="n">row</span>
<span class="ln">412</span><span class="n">begin</span>
<span class="ln">413</span>    <span class="k">insert</span> <span class="k">into</span> <span class="nf">user_logs</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">operation_time</span><span class="p">,</span> <span class="n">operation_id</span><span class="p">,</span> <span class="n">operation_params</span><span class="p">)</span> <span class="k">values</span>
<span class="ln">414</span>        <span class="p">(</span><span class="no">null</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nf">now</span><span class="p">(),</span> <span class="n">new</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nf">concat</span><span class="p">(</span><span class="s1">&#39;更新前数据: &#39;</span><span class="p">,</span> <span class="n">old</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">old</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">old</span><span class="p">.</span><span class="n">gender</span><span class="p">,</span> <span class="n">old</span><span class="p">.</span><span class="n">gender</span><span class="p">,</span>
<span class="ln">415</span>                                               <span class="s1">&#39;更新后数据: &#39;</span><span class="p">,</span> <span class="n">new</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">new</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new</span><span class="p">.</span><span class="n">gender</span><span class="p">,</span> <span class="n">new</span><span class="p">.</span><span class="n">gender</span><span class="p">));</span>
<span class="ln">416</span><span class="n">end</span><span class="p">;</span>
<span class="ln">417</span><span class="c1">-- delete触发器
</span><span class="ln">418</span><span class="c1"></span><span class="k">create</span> <span class="k">trigger</span> <span class="n">delete_trigger</span>
<span class="ln">419</span>    <span class="n">after</span> <span class="k">insert</span> <span class="k">on</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">for</span> <span class="k">each</span> <span class="n">row</span>
<span class="ln">420</span><span class="n">begin</span>
<span class="ln">421</span>    <span class="k">insert</span> <span class="k">into</span> <span class="nf">user_logs</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">operation_time</span><span class="p">,</span> <span class="n">operation_id</span><span class="p">,</span> <span class="n">operation_params</span><span class="p">)</span> <span class="k">values</span>
<span class="ln">422</span>        <span class="p">(</span><span class="no">null</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="nf">now</span><span class="p">(),</span> <span class="n">old</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nf">concat</span><span class="p">(</span><span class="s1">&#39;删除前数据: &#39;</span><span class="p">,</span> <span class="n">old</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">old</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">old</span><span class="p">.</span><span class="n">gender</span><span class="p">,</span> <span class="n">old</span><span class="p">.</span><span class="n">gender</span><span class="p">));</span>
<span class="ln">423</span><span class="n">end</span><span class="p">;</span>
</code></pre></div><h2 id="锁">锁</h2>
<p>分类: 全局锁, 表级锁, 行级锁.</p>
<h3 id="全局锁">全局锁</h3>
<p>全局锁: 对整个数据库实例加锁, 加锁后处于只读状态, 后续的DML写, DDL, 已经更新操作的事务提交语句都被阻塞</p>
<p>使用场景: 做全库的逻辑备份 从而获取一致性视图, 保证数据完整性&hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">flush</span> <span class="kp">tables</span> <span class="k">with</span> <span class="k">read</span> <span class="k">lock</span> <span class="p">;</span>
<span class="ln">2</span><span class="n">mysqldump</span> <span class="o">-</span><span class="n">uroot</span> <span class="o">-</span><span class="n">proot</span> <span class="n">learndatabase</span> <span class="o">&gt;</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">sql</span>
<span class="ln">3</span><span class="k">unlock</span> <span class="kp">tables</span> <span class="p">;</span>
</code></pre></div><p>特点:</p>
<ol>
<li>主库备份, 备份期间不能执行更新操作, 业务基本停摆</li>
<li>从库备份, 备份期间不能执行主库同步过来的二进制日志, 导致主从延迟</li>
</ol>
<p>Innodb中, 备份时加上参数&ndash;single-transaction参数来完成不加锁的一致性数据备份(快照读实现)</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="n">mysqldump</span> <span class="o">--</span><span class="n">single</span><span class="o">-</span><span class="n">transaction</span> <span class="o">-</span><span class="n">uroot</span> <span class="o">-</span><span class="n">proot</span> <span class="n">learndatabase</span> <span class="o">&gt;</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">sql</span>
</code></pre></div><h3 id="表级锁">表级锁</h3>
<p>表级锁: 发生锁冲突的概率最高, 并发度最低. 应用在MyISAM,Innodb,BDB等存储引擎</p>
<p>分类: 表锁, 元数据锁, 意向锁</p>
<h4 id="表锁">表锁</h4>
<p>表锁: 分为表共享读锁(read lock, 所有客户端只能读不能写), 表独占写锁(write lock, 只有自己能读能写, 别的客户端不能读不能写)</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 加锁 
</span><span class="ln">2</span><span class="c1"></span><span class="k">lock</span> <span class="kp">tables</span> <span class="err">表名</span><span class="p">...</span> <span class="k">read</span><span class="o">/</span><span class="k">write</span>
<span class="ln">3</span><span class="c1">-- 释放锁 
</span><span class="ln">4</span><span class="c1"></span><span class="k">unlock</span> <span class="kp">tables</span> <span class="err">或者</span> <span class="err">客户端断开连接</span>
</code></pre></div><h4 id="元数据锁">元数据锁</h4>
<p>元数据锁: 系统自动控制不需要显示使用, 访问一张表自动加上. 主要是<strong>维护表元数据的一致性</strong>,有活动事务时不可对元数据进行写入操作</p>
<p>元数据大概就是表结构</p>
<p>在MySQL5.5后, 对表进行增删改查,加MDL读锁(共享);当对表结构变更时,加MDL写锁(排它), 这两个锁是冲突的.</p>
<p>比如两个终端,事务1使用了select加MDL读锁,那么事务2使用alter就会等待,因为这两个锁是排斥的,加不了MDL写锁.</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 查看元数据锁
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="n">object_type</span><span class="p">,</span> <span class="n">object_schema</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">lock_type</span><span class="p">,</span> <span class="n">lock_duration</span> <span class="k">from</span> <span class="n">performance_schema</span><span class="p">.</span><span class="n">metadata_locks</span><span class="p">;</span>
</code></pre></div><h4 id="意向锁">意向锁</h4>
<p>意向锁: 为了避免DML在执行时加的行锁和表锁的冲突(不能同时加),Innodb中引入了意向锁, 使得表锁不用检查每行数据是否加锁,使用意向锁减少表锁的检查</p>
<p>意向共享锁(IS):由select&hellip; lock in share mode添加; 与表锁共享锁(read)兼容,与表锁排它锁(write)互斥.</p>
<p>意向排它锁(IX):由insert,update,delete,select&hellip;for update添加; 与表锁共享锁和表锁排它锁都互斥, 这样就可以保证数据一致性.</p>
<p>意向锁之间不会互斥</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 例子:
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">lock</span> <span class="k">in</span> <span class="n">share</span> <span class="n">mode</span> <span class="p">;</span> <span class="c1">-- 这句话加上行锁共享锁和意向共享锁
</span><span class="ln">3</span><span class="c1"></span><span class="k">lock</span> <span class="kp">tables</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">read</span><span class="p">;</span> <span class="c1">-- 这时可以加表共享读锁, 因为这两个锁兼容; 都可以读嘛
</span><span class="ln">4</span><span class="c1"></span><span class="k">lock</span> <span class="kp">tables</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">write</span><span class="p">;</span> <span class="c1">-- 这时不能加表独占写锁, 互斥的; 因为如果允许的话, 别个就可以改数据了,读的东西不一致.
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="n">begin</span> <span class="p">;</span> <span class="c1">-- 客户端1开启事务
</span><span class="ln">2</span><span class="c1"></span><span class="k">update</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="kt">set</span> <span class="n">gender</span><span class="o">=</span><span class="s1">&#39;女&#39;</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="c1">-- 加上行锁和意向排它锁
</span><span class="ln">3</span><span class="c1"></span><span class="k">lock</span> <span class="kp">tables</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">read</span><span class="p">;</span> <span class="c1">-- 客户端2加锁, 不行
</span><span class="ln">4</span><span class="c1"></span><span class="k">lock</span> <span class="kp">tables</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">write</span><span class="p">;</span> <span class="c1">-- 客户端2加锁, 不行
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 查看意向锁及行锁的加锁情况
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="n">object_schema</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">lock_type</span><span class="p">,</span> <span class="n">lock_mode</span><span class="p">,</span> <span class="n">lock_data</span> <span class="k">from</span> <span class="n">performance_schema</span><span class="p">.</span><span class="n">data_locks</span><span class="p">;</span>
</code></pre></div><h3 id="行级锁">行级锁</h3>
<p>行级锁: 发生锁冲突的概率最低, 并发度最高, 应用在Innodb中.</p>
<p>Innodb的数据是基于索引组织的, 行锁是往索引上的索引项加锁, 不是对记录加锁</p>
<p>行级锁分为三类:</p>
<ol>
<li>行锁(record lock): 锁定单行记录, 防止其他事务进行update, delete. 在rc(read committed),rr(repeatable read)隔离级别下都支持</li>
<li>间隙锁(gap lock): 锁定记录与记录之间的间隙(不含记录), 确保索引记录间隙不变, 防止其他事务在这个间隙insert,产生幻读, 在rr隔离级别下都支持.</li>
<li>临键锁(next-key lock): 行锁和间隙锁的组合, 同时锁住数据,并锁住数据前面的间隙gap.在rr隔离级别下支持, 防止幻读</li>
</ol>
<p>这些锁和事务的隔离级别相辅相成.</p>
<h4 id="行锁">行锁</h4>
<p>Innodb实现了两种类型行锁:</p>
<ol>
<li>共享锁(s): 允许一个事务去读一行, 阻止其他事务获得相同数据集的排它锁, commit后就释放了(防不可重复读, 脏读)</li>
<li>排它锁(x): 允许获取排它锁的事务更新数据, 阻止其他事务获得相同数据集的共享锁和排它锁.</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- insert, update, delete 获得排它锁, 系统自动加锁不需要控制
</span><span class="ln">2</span><span class="c1">-- select 不加任何锁
</span><span class="ln">3</span><span class="c1">-- select ... lock in share mode 共享锁
</span><span class="ln">4</span><span class="c1">-- select ... for update 排它锁
</span><span class="ln">5</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="c1">-- id=1这一行的共享锁, 那么其他事务对这一行数据不能获得排它锁
</span><span class="ln">6</span><span class="c1"></span><span class="k">update</span> <span class="n">stu</span> <span class="kt">set</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lei&#39;</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="c1">-- 排它锁
</span></code></pre></div><p>针对唯一索引进行检索时, 对已存在的记录进行等值匹配, 将会自动优化为行锁.</p>
<p>Innodb的行锁是针对索引加的锁, 不通过索引条件检索数据, 那么Innodb将对表的所有记录加锁, 行锁升级为表锁.</p>
<p>update优化的原理就是这个:</p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="k">update</span> <span class="n">stu</span> <span class="kt">set</span> <span class="n">name</span> <span class="o">=</span><span class="s1">&#39;lei&#39;</span> <span class="k">where</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lily&#39;</span><span class="p">;</span> <span class="c1">-- 事务1,第8行数据. 加的表锁.因为此时name没有索引,没有走索引
</span><span class="ln">2</span><span class="c1"></span><span class="k">update</span> <span class="n">stu</span> <span class="kt">set</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lei&#39;</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="c1">-- 事务2, 即便是第一行数据也不能更改, 因为这时已经是表锁了.
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">1</span><span class="c1">-- 查询行锁
</span><span class="ln">2</span><span class="c1"></span><span class="k">select</span> <span class="n">object_schema</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">lock_type</span><span class="p">,</span> <span class="n">lock_mode</span><span class="p">,</span> <span class="n">lock_data</span> <span class="k">from</span> <span class="n">performance_schema</span><span class="p">.</span><span class="n">data_locks</span><span class="p">;</span>
</code></pre></div><h4 id="间隙锁临键锁">间隙锁/临键锁</h4>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln"> 1</span><span class="c1">-- 1. 索引上给等值查询(唯一索引), 给不存在的记录加锁, 优化为间隙锁
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">update</span> <span class="n">stu</span> <span class="kt">set</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="c1">-- 事务1 表中只有3和8,之间没有数据, 这时加间隙锁, 锁住(3.8]这个空隙
</span><span class="ln"> 3</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">stu</span> <span class="k">values</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;lili&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span> <span class="c1">-- 事务2 这时再往里插入, 插入不了被锁住了.
</span><span class="ln"> 4</span><span class="c1"></span>
<span class="ln"> 5</span><span class="c1">-- 2. 索引上的等值查询(普通索引), 向右遍历时最后一个值不满足查询条件时, next-key lock退化为间隙
</span><span class="ln"> 6</span><span class="c1">-- 这里age字段就不是唯一索引可能有多个相同的值, 那么它会加11及后面17之间的锁(11后就是17)
</span><span class="ln"> 7</span><span class="c1"></span><span class="k">create</span> <span class="k">index</span> <span class="n">index_idx_stu_age</span> <span class="k">on</span> <span class="nf">stu</span><span class="p">(</span><span class="n">age</span><span class="p">);</span>
<span class="ln"> 8</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">stu</span> <span class="k">where</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">11</span> <span class="k">lock</span> <span class="k">in</span> <span class="n">share</span> <span class="n">mode</span> <span class="p">;</span> <span class="c1">-- 事务1, 首先对3记录加共享行锁S,其次还要对17加临键锁,锁住本身和其间隙, 防止幻读
</span><span class="ln"> 9</span><span class="c1"></span>
<span class="ln">10</span><span class="c1">-- 3. 索引上的范围查询(唯一索引), 会访问到不满足条件的第一个值为止.
</span><span class="ln">11</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="n">form</span> <span class="n">stu</span> <span class="k">where</span> <span class="n">id</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">;</span> <span class="c1">-- 唯一索引范围查询. 假设查出来的有31 50 ,那么会给31加S锁, 还会给50加临键锁, 还会将50到正无穷也加S锁
</span><span class="ln">12</span><span class="c1">-- 间隙锁的目的是防止其他事务插入间隙, 间隙锁可以共存, 一个事务采用的间隙锁不会阻止另一个事务在同一间隙采用间隙锁.
</span></code></pre></div><h2 id="innodb引擎事务原理mvcc">Innodb引擎/事务原理/MVCC</h2>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="ln">  1</span><span class="c1">-- Innodb引擎
</span><span class="ln">  2</span><span class="c1">-- 逻辑存储结构
</span><span class="ln">  3</span><span class="c1">-- 表空间tablespace: ibd文件, 一个mysql实例可以对应多个表空间, 用于存储记录, 索引等数据.
</span><span class="ln">  4</span><span class="c1">-- 段segment: 分为数据段, 索引段, 回滚段. Innodb是索引组织表, 数据段就是B+Tree的叶子结点, 索引段即为B+Tree的非叶子节点. 段用来管理多个Extent区
</span><span class="ln">  5</span><span class="c1">-- 区extent: 表空间的单元结构, 每个区的大小为1m, 默认情况下, Innodb存储引擎页大小为16k, 即一个区中一共有64个连续的页.
</span><span class="ln">  6</span><span class="c1">-- 页page: 是Innodb存储引擎磁盘管理的最小单元, 每个页的大小默认是16kb. 为了保证页的连续性, Innodb存储引擎每次从磁盘申请4-5个区
</span><span class="ln">  7</span><span class="c1">-- 行row: Innodb存储引擎数据是按行进行存放的. 行的数据结构:
</span><span class="ln">  8</span><span class="c1">--      Trx_id: 每次对每条记录进行改动时, 都会把对应的事务id赋值给trx_id隐藏列
</span><span class="ln">  9</span><span class="c1">--      Roll_pointer: 每次对每条记录进行改动时, 都会把旧的版本写入到undo日志中, 然后这个隐藏列就相当于一个指针, 可以用它找到该记录修改前的信息
</span><span class="ln"> 10</span><span class="c1">--      col1, col2, ...
</span><span class="ln"> 11</span><span class="c1"></span>
<span class="ln"> 12</span>
<span class="ln"> 13</span><span class="c1">-- 架构
</span><span class="ln"> 14</span><span class="c1">-- 内存架构
</span><span class="ln"> 15</span><span class="c1">-- 1.buffer pool: 缓冲池是主内存的一个区域, 里面可以缓存磁盘上经常操作的真实数据, 在执行增删改查操作时, 先操作缓冲池中的数据(没有数据就从磁盘加载并缓存)
</span><span class="ln"> 16</span><span class="c1">--              然后再以一定频率刷新到磁盘, 从而减少磁盘io, 加快处理速度.
</span><span class="ln"> 17</span><span class="c1">-- 缓冲池以页page为单位, 底层采用链表数据结构管理page, page分为三类:
</span><span class="ln"> 18</span><span class="c1">--      free page: 空闲page, 没有使用过
</span><span class="ln"> 19</span><span class="c1">--      clean page: 被使用page, 数据没有被修改过
</span><span class="ln"> 20</span><span class="c1">--      dirty page: 脏页, 被使用page, 数据被修改过, 页中数据与磁盘数据产生了不一致
</span><span class="ln"> 21</span><span class="c1">-- 2.change buffer: 更改缓冲区(针对非唯一二级索引页), 在执行DML语句时, 如果这些数据page没有在buffer pool中, 不会直接操作磁盘, 而会将数据变更
</span><span class="ln"> 22</span><span class="c1">--                存在更改缓冲区change buffer中, 在未来数据被读取时, 再将数据合并恢复到buffer pool中, 然后再将合并后的数据刷新到磁盘中
</span><span class="ln"> 23</span><span class="c1">-- 好处: 与聚集索引不同, 二级索引通常是非唯一的, 并且以相对随机的顺序插入二级索引. 同样删除和更新可能会影响索引树种不相邻的二级索引页, 如果每次都
</span><span class="ln"> 24</span><span class="c1">--      操作磁盘, 会造成大量磁盘io, 有了change buffer之后, 我们可以在缓冲池中进行合并处理, 减少磁盘io
</span><span class="ln"> 25</span><span class="c1">-- 3.adaptive hash index: 自适应哈希索引, 用于优化对buffer pool数据的查询. Innodb存储引擎会监控对表上各索引页的查询, 如果观察到hash索引可以
</span><span class="ln"> 26</span><span class="c1">--                      提升速度, 则建立hash索引, 称之为自适应hash索引.
</span><span class="ln"> 27</span><span class="c1">-- 自适应哈希索引, 无需人工干预, 是系统根据情况自动完成
</span><span class="ln"> 28</span><span class="c1">-- 参数adaptive_hash_index
</span><span class="ln"> 29</span><span class="c1">-- 4.log buffer: 日志缓冲区, 用来保存要写入到磁盘中的log日志数据(redo log, undo log), 默认大小16MB, 日志缓存区的日志会定期刷新到磁盘中. 如果
</span><span class="ln"> 30</span><span class="c1">--             需要更新,插入,删除许多行的事务, 增加日志缓冲区的大小可以节省磁盘io
</span><span class="ln"> 31</span><span class="c1">-- 参数innodb_log_buffer_size: 缓冲区大小, innodb_flush_log_at_trx_commit: 日志刷新到磁盘的时机(0:每秒将日志写入并刷新到磁盘; 1:日志在每次事务提交时写入并刷新到磁盘; 2:日志在每次事务提交后写入,并每秒刷新到磁盘一次)
</span><span class="ln"> 32</span><span class="c1"></span>
<span class="ln"> 33</span>
<span class="ln"> 34</span><span class="c1">-- 磁盘架构
</span><span class="ln"> 35</span><span class="c1">-- 这些文件系统里面都可以找得到.
</span><span class="ln"> 36</span><span class="c1">-- System tablespace: 系统表空间是更改缓冲区的存储区域, 如果表是在系统表空间而不是每一个表文件或通用表空间中创建的, 它也可能包含表和索引数据
</span><span class="ln"> 37</span><span class="c1">-- 参数:innodb_data_file_path
</span><span class="ln"> 38</span><span class="c1">-- File-per-table tablespace: 每个表的文件表空间包含单个Innodb表的数据和索引, 并存储在文件系统上的单个数据文件中.
</span><span class="ln"> 39</span><span class="c1">-- 参数:innodb_file_per_table
</span><span class="ln"> 40</span><span class="c1">-- general tablespace: 通用表空间, 需要通过create tablespace语法创建通用表空间, 在创建表时, 可以指定该表空间.
</span><span class="ln"> 41</span><span class="c1"></span><span class="k">create</span> <span class="n">tablespace</span> <span class="n">ts_name</span> <span class="k">add</span> <span class="n">datafile</span> <span class="s1">&#39;file_name.ibd&#39;</span> <span class="kp">engine</span> <span class="o">=</span><span class="n">innodb</span><span class="p">;</span>
<span class="ln"> 42</span><span class="k">create</span> <span class="k">table</span> <span class="nf">a</span><span class="p">(</span><span class="n">id</span> <span class="kt">int</span> <span class="k">primary</span> <span class="k">key</span> <span class="kp">auto_increment</span><span class="p">,</span> <span class="n">name</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="kp">engine</span> <span class="o">=</span><span class="n">innodb</span> <span class="n">tablespace</span> <span class="n">ts_name</span><span class="p">;</span>
<span class="ln"> 43</span><span class="c1">-- undo tablespace: 撤销表空间, mysql实例在初始化时会自动创建两个默认的undo表空间(undo_001,undo_002)初始大小为16M, 用于存储undo log日志.
</span><span class="ln"> 44</span><span class="c1">-- temporary tablespace: 临时表空间, Innodb使用会话临时表空间和全局临时表空间,存储用户创建的临时表等数据.
</span><span class="ln"> 45</span><span class="c1">-- doublewirte buffer files: 双写缓冲区, Innodb将数据页从buffer pool刷新到磁盘前, 为了保证数据安全, 先将数据写入双写缓冲区文件中, 便于系统异常时恢复数据.
</span><span class="ln"> 46</span><span class="c1">-- redo log: 重做日志, 用来实现事务持久性. 该日志由两部分组成:重做日志缓冲(redo log buffer, 内存中), 重做日志文件(redo log, 磁盘中, ib_logfile0, ib_logfile1),
</span><span class="ln"> 47</span><span class="c1">-- 当事务提交之后会把所有修改信息都会存到该日志中, 用于在刷新脏页到磁盘时发生错误进行数据恢复. 这文件循环写, 事务提交里面的数据没有意义了
</span><span class="ln"> 48</span><span class="c1"></span>
<span class="ln"> 49</span>
<span class="ln"> 50</span><span class="c1">-- 后台线程
</span><span class="ln"> 51</span><span class="c1">-- 1. master thread: 核心后台线程, 负责调度其他线程, 还负责将缓冲池中的数据异步刷新到磁盘中, 保持数据一致性, 还包括脏页的刷新, 合并插入缓存, undo页的回收
</span><span class="ln"> 52</span><span class="c1">-- 2. io thread: Innodb引擎中大量使用了aio来处理io请求, 可以极大提升数据库性能, 而io thread主要负责这些io请求的回调.
</span><span class="ln"> 53</span><span class="c1">--      read thread: 默认4个, 负责读操作
</span><span class="ln"> 54</span><span class="c1">--      write thread: 默认4个, 负责写操作
</span><span class="ln"> 55</span><span class="c1">--      log thread: 默认1个, 负责将日志缓冲区刷新到磁盘
</span><span class="ln"> 56</span><span class="c1">--      insert buffer thread: 默认1个, 负责将写缓冲区的内容刷新到磁盘
</span><span class="ln"> 57</span><span class="c1">-- 查看Innodb引擎的状态信息, 里面有线程信息
</span><span class="ln"> 58</span><span class="c1"></span><span class="k">show</span> <span class="kp">engine</span> <span class="n">innodb</span> <span class="n">status</span> <span class="p">;</span>
<span class="ln"> 59</span><span class="c1">-- 3. purge thread: 用于回收事务已经提交的undo log. 事务提交后undo log可能不用了,用它回收.
</span><span class="ln"> 60</span><span class="c1">-- 4. page cleaner thread: 协助master thread刷新脏页到磁盘的线程, 减轻master thread的压力, 减少阻塞.
</span><span class="ln"> 61</span><span class="c1"></span>
<span class="ln"> 62</span>
<span class="ln"> 63</span><span class="c1">-- 事务原理
</span><span class="ln"> 64</span><span class="c1">-- 事务的原子性, 一致性, 持久性由redo log和undo log保证
</span><span class="ln"> 65</span><span class="c1">-- 事务的隔离性由锁和MVCC(多版本并发控制)保证
</span><span class="ln"> 66</span><span class="c1"></span>
<span class="ln"> 67</span><span class="c1">-- redo log(保证持久性)
</span><span class="ln"> 68</span><span class="c1">-- redo log: 重做日志, 记录的是事务提交时数据页的物理修改, 用来实现事务持久性. 该日志由两部分组成:重做日志缓冲(redo log buffer, 内存中), 重做日志文件(redo log, 磁盘中),
</span><span class="ln"> 69</span><span class="c1">-- 当事务提交之后会把所有修改信息都会存到该日志中, 用于在刷新脏页到磁盘时发生错误进行数据恢复. 这文件循环写, 事务提交, 里面的数据没有意义了
</span><span class="ln"> 70</span><span class="c1">-- 流程: 对缓冲区buffer pool数据进行增删改, 这时页面变成脏页, 同时将增删改的数据记录在redolog buffer记录数据页物理变化, 事务提交时将log buffer刷新到磁盘文件中ib_logfile0/1
</span><span class="ln"> 71</span><span class="c1">--      之后脏页刷新到磁盘. 如果脏页刷新到磁盘失败了, 可以通过redo log恢复
</span><span class="ln"> 72</span><span class="c1"></span>
<span class="ln"> 73</span><span class="c1">-- undo log(保证原子性)
</span><span class="ln"> 74</span><span class="c1">-- 回滚日志, 用于记录数据被修改前的信息, 作用包含两个:提供回滚和MVCC
</span><span class="ln"> 75</span><span class="c1">-- undo log和redo log记录物理日志不一样, 它是逻辑日志. 可以认为当delete一条记录时, undo log中会记录一条对应的insert记录, 反制一番, 当update一条记录时,
</span><span class="ln"> 76</span><span class="c1">-- 它记录一条对应相反的update记录. 当执行rollback时, 就可以从undo log中逻辑记录读取到相应的内容并进行回滚
</span><span class="ln"> 77</span><span class="c1">-- undo log销毁: undo log在事务执行时产生, 事务提交时, 并不会立即删除undo log, 因为这些日志可能还用于mvcc
</span><span class="ln"> 78</span><span class="c1">-- undo log存储: undo log采用段的方式进行管理和记录, 存放在rollback segment回滚段中, 内部包含1024个undo log segment
</span><span class="ln"> 79</span><span class="c1"></span>
<span class="ln"> 80</span>
<span class="ln"> 81</span>
<span class="ln"> 82</span><span class="c1">-- MVCC
</span><span class="ln"> 83</span><span class="c1">-- 基本概念
</span><span class="ln"> 84</span><span class="c1">-- 当前读: 读取的是记录的最新版本, 读取时还要保证其他并发事务不能修改当前记录, 会对读取的记录进行加锁.
</span><span class="ln"> 85</span><span class="c1">-- 如select ... lock in share mode(共享锁), select ... for update , update, insert, delete(排它锁)都是一种当前读
</span><span class="ln"> 86</span><span class="c1"></span><span class="n">begin</span><span class="p">;</span>
<span class="ln"> 87</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span><span class="p">;</span> <span class="c1">-- 在别的事务commit之前和之后去读到的都是同样的数据, 可重复读
</span><span class="ln"> 88</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span> <span class="k">lock</span> <span class="k">in</span> <span class="n">share</span> <span class="n">mode</span> <span class="p">;</span> <span class="c1">-- 别的事务commit之后可以读取到最新的数据.
</span><span class="ln"> 89</span><span class="c1">-- 快照读: 简单的select(不加锁)就是快照读, 快照读, 读取的是记录数据的可见版本, 有可能是历史数据, 不加锁, 是非阻塞读
</span><span class="ln"> 90</span><span class="c1"></span><span class="n">begin</span><span class="p">;</span>
<span class="ln"> 91</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span><span class="p">;</span> <span class="c1">-- 在别的事务commit之前去读,生成一个快照
</span><span class="ln"> 92</span><span class="c1"></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">learndatabase</span><span class="p">.</span><span class="k">user</span><span class="p">;</span> <span class="c1">-- 在别的事务commit之后读, 依旧读的是之前的快照
</span><span class="ln"> 93</span><span class="c1">-- read committed: 每次select都生成一个快照读
</span><span class="ln"> 94</span><span class="c1">-- repeatable read: 开启事务后第一个select语句才是快照读的地方.
</span><span class="ln"> 95</span><span class="c1">-- serializable: 快照读退化成当前读, 每次读取都会加锁.
</span><span class="ln"> 96</span><span class="c1">-- MVCC: 维护一个数据的多个版本, 使得读写操作没有冲突, 快照读为mysql实现MVCC提供了一个非阻塞读功能, 还需要依赖与数据库记录中的三个隐式字段, undo log日志, readview.
</span><span class="ln"> 97</span><span class="c1"></span>
<span class="ln"> 98</span>
<span class="ln"> 99</span><span class="c1">-- 实现原理
</span><span class="ln">100</span><span class="c1">-- 记录中的隐藏字段
</span><span class="ln">101</span><span class="c1">-- 1.DB_TRX_ID: 最近修改事务ID. 记录插入这条记录或最后一次修改该记录的事务ID(事务ID是从1自增的)
</span><span class="ln">102</span><span class="c1">-- 2.DB_ROLL_PTR: 回滚指针. 指向这条记录的上一个版本, 用于配合undo log, 指向上个版本.
</span><span class="ln">103</span><span class="c1">-- 3.DB_ROW_ID: 隐藏主键. 当表结构没有指定主键时会生成该隐藏字段.
</span><span class="ln">104</span><span class="c1">-- 查看隐藏字段
</span><span class="ln">105</span><span class="c1"></span><span class="n">ibd2sdi</span> <span class="k">user</span><span class="p">.</span><span class="n">ibd</span>
<span class="ln">106</span>
<span class="ln">107</span><span class="c1">-- uodo log: 回滚日志, 在insert, update, delete的时候产生的便于数据回滚的日志
</span><span class="ln">108</span><span class="c1">-- 当insert时, 产生的undo log只在回滚时需要, 在事务提交后便被立即删除
</span><span class="ln">109</span><span class="c1">-- 当update, delete时, undo log不止在回滚时需要, 在快照读时也需要, 不会被立刻删除
</span><span class="ln">110</span><span class="c1"></span>
<span class="ln">111</span><span class="c1">-- undo log版本链
</span><span class="ln">112</span><span class="c1">-- 不同事务或相同事务对同一条记录进行修改, 会导致该记录的undo log生成一条记录版本链表, 头部是最新的旧记录, 尾部是最早的旧记录.
</span><span class="ln">113</span><span class="c1">-- undo log记得是旧记录的所有东西, 里面就包括了DB_ROLL_PTR指针, 所以旧记录的该字段指向的是下一条旧记录
</span><span class="ln">114</span><span class="c1"></span>
<span class="ln">115</span><span class="c1">-- readview: 读视图. 是快照读sql执行的MVCC提取数据的依据, 记录并维护系统当前活跃的事务(未提交的)id
</span><span class="ln">116</span><span class="c1">-- 包含四个核心字段:
</span><span class="ln">117</span><span class="c1">-- 1.m_ids:当前活跃的事物ID集合(没有commit的事务id)
</span><span class="ln">118</span><span class="c1">-- 2.min_trx_id: 最小活跃事物ID(m_ids中的最小值)
</span><span class="ln">119</span><span class="c1">-- 3.max_trx_id: 预分配事务ID, 当前最大事务ID+1(事务是自增的, 下一个就是+1)
</span><span class="ln">120</span><span class="c1">-- 4.creator_trx_id: readview创建者的事务ID.
</span><span class="ln">121</span><span class="c1">-- 版本链数据访问规则: (trx_id代表当前这条记录对应的事务的id, 就是db_trx_id)
</span><span class="ln">122</span><span class="c1">-- 1. trx_id == creatr_trx_id时 可以访问该版本. (说明数据是当前事务更改的)
</span><span class="ln">123</span><span class="c1">-- 2. trx_id &lt; min_trx_id时 可以访问该版本 (说明事务已经提交了)
</span><span class="ln">124</span><span class="c1">-- 3. trx_id &gt; max_trx_id时 不可以访问该版本. (说明该事务是在readview生成后才开启, 这里感觉可以取等)
</span><span class="ln">125</span><span class="c1">-- 4. min_trx_id &lt;= trx_id &lt;= max_trx_id且trx_id不在m_ids中 可以访问该版本 (说明数据已经提交)
</span><span class="ln">126</span><span class="c1">-- 不同的隔离级别, 生成readview的时机不同:
</span><span class="ln">127</span><span class="c1">-- read committed: 在事务中每次执行快照读时生成readview
</span><span class="ln">128</span><span class="c1">-- repeatable read: 仅在事务第一次执行快照读时生成readview, 后续复用该readview
</span><span class="ln">129</span><span class="c1"></span>
<span class="ln">130</span><span class="c1">-- 原理分析(rc级别)
</span><span class="ln">131</span><span class="c1">-- read committed: 在事务中每次执行快照读时生成readview
</span><span class="ln">132</span><span class="c1">-- 简单来说就沿着undo log日志, 从新往旧每一条记录的db_trx_id去和规则作对比, 如果都不能访问则沿着版本链往下继续找直到满足条件为止.
</span><span class="ln">133</span><span class="c1">-- 原理分析(rr级别)
</span><span class="ln">134</span><span class="c1">-- 与rr唯一不同就是两次查询的readview不同罢了. 所以rc两次查询可能不同, rr都是一样的. 可重复读嘛
</span></code></pre></div></div><hr /><div class="post-navs d-flex mb-3 justify-content-between">
  <div class="post-nav w-50"><div class="prev-post btn btn-sm">
      <a href="/posts/tech/java-3-spring-cloud/">SpringCloud学习笔记
</a>
    </div></div>
  <div class="post-nav flex-row-reverse"><div class="next-post btn btn-sm">
      <a href="/posts/tech/java-4-basic/">Java基础查漏补缺
</a>
    </div></div>
</div><section class="related-posts">
    <h3>相关文章</h3>
    <ul class="related-posts"><li><a href="/posts/tech/java-3-spring-cloud/">SpringCloud学习笔记
</a></li><li><a href="/posts/tech/java-1-thread/">Java多线程
</a></li><li><a href="/posts/anime/bokugashinouto/">僕が死のうと思ったのは
</a></li><li><a href="/posts/anime/shinainaru/"> 親愛なる世界へ
</a></li><li><a href="/posts/anime/kimigahikarini/">君が光に変えて行く
</a></li></ul>
  </section></article>




<div id="vcomments" class="post-comments surface row">
</div>
    <script>
        new Valine({
            el: '#vcomments',
            appId: '18xpdRPZMKmyTjmjtMIK8zyB-gzGzoHsz',
            appKey: 'haH3Ysz9ic7RFcoqbIvPDh8H',
            avatar:'retro',
            visitor:true,
            placeholder:'有什么想说的吗？'

        });

        var count = 0;
        var domTimer = setInterval(function () {
            if (++count > 50) clearInterval(domTimer);
            if (document.querySelector('#veditor')) {
                clearInterval(domTimer);
                var cdraw = new CaveDraw({
                    element: "#veditor",
                    readOnlyMode: false, 
                    afterUpdateEditor: ()=>{ 
                        document.querySelector('#veditor').focus();
                        document.querySelector('#veditor').blur();
                    },
                    controls: ['brush', 'eraser', 'bucket', 'clear', 'undo', 'redo', 'save']
                });
            }
        }, 200);
    </script></div>
</div><aside class="col-lg-4 sidebar d-flex">
  <div class="container"><section class="profile surface row">
  <div class="col-xl-6 d-flex align-items-center justify-content-center">
    <img class="profile-avatar img-fluid" src="/images/profile2.jpg" alt="理想奈" loading="lazy">
  </div>
  <div class="col-xl-6">
    <h5 class="profile-name my-2">理想奈</h5><div class="profile-bio mb-2">所感所喜所爱所恨所愿，即行之所往。</div>
    
  </div>
</section><section class="recent-posts row surface">
  <h4>最近文章</h4>
  <ul><li><a href="/posts/tech/media-rebar2/">rebar2学习
</a></li><li><a href="/posts/tech/media-erlang/">《Erlang程序设计》
</a></li><li><a href="/posts/other/2024/">2024年终总结和来年展望
</a></li><li><a href="/posts/math/estimate/">量化交易系统设想
</a></li><li><a href="/posts/math/beginner/">量化交易初学
</a></li><li><a href="/posts/tech/media-computer-systems/">《深入理解计算机系统》
</a></li><li><a href="/posts/other/physics-computer/">计算机和物理的一点感悟
</a></li><li><a href="/posts/tech/media-ffmpeg/">FFmpeg学习
</a></li><li><a href="/posts/tech/media-pcmu/">pcmu编码
</a></li><li><a href="/posts/tech/media-sox/">Sox基本使用
</a></li><li><a href="/posts/other/human-mind-weekness/">上头与下头与suicide
</a></li><li><a href="/posts/other/everyweek-english/">每周一篇经济学人
</a></li><li><a href="/posts/tech/media-automake/">automake使用
</a></li></ul>
</section><section class="taxonomy-categories row surface">
      <h4>
        <a href="/categories">分类</a>
      </h4>
      <div><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="计算机">
          计算机 <span class="badge rounded-pill">37</span>
        </a><a href="/categories/%E4%BA%8C%E6%AC%A1%E5%85%83/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="二次元">
          二次元 <span class="badge rounded-pill">24</span>
        </a><a href="/categories/%E6%99%AE%E9%80%9A%E7%B1%BB/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="普通类">
          普通类 <span class="badge rounded-pill">9</span>
        </a><a href="/categories/%E6%96%87%E5%AD%97%E7%B1%BB/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="文字类">
          文字类 <span class="badge rounded-pill">6</span>
        </a><a href="/categories/%E6%95%B0%E5%AD%A6/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="数学">
          数学 <span class="badge rounded-pill">4</span>
        </a></div>
    </section><section class="taxonomy-series row surface">
      <h4>
        <a href="/series">专栏</a>
      </h4>
      <div><a href="/series/%E5%AA%92%E4%BD%93%E5%BC%80%E5%8F%91/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="媒体开发">
          媒体开发 <span class="badge rounded-pill">22</span>
        </a><a href="/series/%E5%8A%A8%E6%BC%AB%E6%AD%8C%E6%9B%B2/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="动漫歌曲">
          动漫歌曲 <span class="badge rounded-pill">21</span>
        </a><a href="/series/galgame/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Galgame">
          Galgame <span class="badge rounded-pill">10</span>
        </a><a href="/series/java/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Java">
          Java <span class="badge rounded-pill">10</span>
        </a><a href="/series/%E9%87%8F%E5%8C%96%E4%BA%A4%E6%98%93/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="量化交易">
          量化交易 <span class="badge rounded-pill">2</span>
        </a><a href="/series/%E9%9A%8F%E6%84%8F%E6%80%9D%E8%80%83/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="随意思考">
          随意思考 <span class="badge rounded-pill">2</span>
        </a></div>
    </section></div>
</aside>
</div>
    </main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav my-2 justify-content-center"></nav>
<div class="copyright mb-2">
  Copyright © 2021-2025 Unaybaryl. All Rights Reserved.
</div>
</footer>
<a id="btnScrollToTop" class="btn-scroll-to-top">
  <i class="fas fa-fw fa-chevron-circle-up fa-2x"></i>
</a>



              
            </body>
</html>
